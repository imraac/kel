{"file_contents":{"client/src/pages/feed-management.tsx":{"content":"import { useEffect, useState, useMemo } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Wheat, TrendingDown, AlertTriangle, Plus, Menu, Package, Calculator } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useForm, useWatch } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { insertFeedInventorySchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Separator } from \"@/components/ui/separator\";\n\nconst feedFormSchema = z.object({\n  recordType: z.enum([\"bags\", \"kilograms\"], { required_error: \"Please select how to record the feed\" }),\n  feedType: z.string().min(1, \"Feed type is required\"),\n  supplier: z.string().optional(),\n  // Bag-based inputs\n  bagSize: z.string().optional(),\n  numberOfBags: z.string().optional(),\n  // Direct kg input\n  quantityKg: z.string().optional(),\n  // Common fields\n  unitPrice: z.string().optional(),\n  purchaseDate: z.string().min(1, \"Purchase date is required\"),\n  expiryDate: z.string().optional(),\n}).superRefine((data, ctx) => {\n  // Validate based on record type\n  if (data.recordType === \"bags\") {\n    if (!data.bagSize) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"Bag size is required when recording by bags\",\n        path: [\"bagSize\"],\n      });\n    }\n    if (!data.numberOfBags || parseFloat(data.numberOfBags) <= 0) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"Number of bags must be greater than 0\",\n        path: [\"numberOfBags\"],\n      });\n    }\n  } else if (data.recordType === \"kilograms\") {\n    if (!data.quantityKg || parseFloat(data.quantityKg) <= 0) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"Quantity must be greater than 0 kg\",\n        path: [\"quantityKg\"],\n      });\n    }\n  }\n  \n  // Validate expiry date is after purchase date\n  if (data.expiryDate && data.purchaseDate) {\n    const purchaseDate = new Date(data.purchaseDate);\n    const expiryDate = new Date(data.expiryDate);\n    if (expiryDate <= purchaseDate) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"Expiry date must be after purchase date\",\n        path: [\"expiryDate\"],\n      });\n    }\n  }\n  \n  // Validate unit price is non-negative if provided\n  if (data.unitPrice && parseFloat(data.unitPrice) < 0) {\n    ctx.addIssue({\n      code: z.ZodIssueCode.custom,\n      message: \"Unit price cannot be negative\",\n      path: [\"unitPrice\"],\n    });\n  }\n});\n\ntype FeedFormData = z.infer<typeof feedFormSchema>;\n\nexport default function FeedManagement() {\n  const { toast } = useToast();\n  const { isLoading, isAuthenticated } = useAuth();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [feedDialogOpen, setFeedDialogOpen] = useState(false);\n  const queryClient = useQueryClient();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: feedInventory, error: inventoryError } = useQuery({\n    queryKey: [\"/api/feed-inventory\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/feed-inventory?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch feed inventory');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: dailyRecords, error: recordsError } = useQuery({\n    queryKey: [\"/api/daily-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/daily-records?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch daily records');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Get unique suppliers for autocomplete\n  const uniqueSuppliers = useMemo(() => {\n    if (!Array.isArray(feedInventory)) return [];\n    const suppliers = feedInventory\n      .map((feed: any) => feed.supplier)\n      .filter((supplier: string) => supplier && supplier.trim() !== \"\")\n      .filter((supplier: string, index: number, arr: string[]) => arr.indexOf(supplier) === index)\n      .sort();\n    return suppliers;\n  }, [feedInventory]);\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if ((inventoryError && isUnauthorizedError(inventoryError)) || (recordsError && isUnauthorizedError(recordsError))) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [inventoryError, recordsError, toast]);\n\n  const feedForm = useForm<FeedFormData>({\n    resolver: zodResolver(feedFormSchema),\n    defaultValues: {\n      recordType: \"kilograms\",\n      feedType: \"\",\n      supplier: \"\",\n      bagSize: \"\",\n      numberOfBags: \"\",\n      quantityKg: \"\",\n      unitPrice: \"\",\n      purchaseDate: new Date().toISOString().split('T')[0],\n      expiryDate: \"\",\n    },\n  });\n\n  // Watch form values for auto-calculation\n  const watchRecordType = useWatch({ control: feedForm.control, name: \"recordType\" });\n  const watchBagSize = useWatch({ control: feedForm.control, name: \"bagSize\" });\n  const watchNumberOfBags = useWatch({ control: feedForm.control, name: \"numberOfBags\" });\n  const watchQuantityKg = useWatch({ control: feedForm.control, name: \"quantityKg\" });\n  const watchUnitPrice = useWatch({ control: feedForm.control, name: \"unitPrice\" });\n\n  // Auto-calculate total kg when using bags\n  const calculatedKg = useMemo(() => {\n    if (watchRecordType === \"bags\" && watchBagSize && watchNumberOfBags) {\n      const bagSizeNum = parseFloat(watchBagSize);\n      const numBags = parseFloat(watchNumberOfBags);\n      if (!isNaN(bagSizeNum) && !isNaN(numBags)) {\n        return bagSizeNum * numBags;\n      }\n    }\n    return 0;\n  }, [watchRecordType, watchBagSize, watchNumberOfBags]);\n\n  // Calculate total cost for summary\n  const totalCost = useMemo(() => {\n    const unitPrice = parseFloat(watchUnitPrice || \"0\");\n    if (!isNaN(unitPrice) && unitPrice > 0) {\n      if (watchRecordType === \"bags\") {\n        // Price per bag × number of bags\n        const numBags = parseFloat(watchNumberOfBags || \"0\");\n        if (!isNaN(numBags) && numBags > 0) {\n          return numBags * unitPrice;\n        }\n      } else {\n        // Price per kg × quantity in kg\n        const quantity = parseFloat(watchQuantityKg || \"0\");\n        if (!isNaN(quantity) && quantity > 0) {\n          return quantity * unitPrice;\n        }\n      }\n    }\n    return 0;\n  }, [watchRecordType, watchNumberOfBags, watchQuantityKg, watchUnitPrice]);\n\n  const createFeedMutation = useMutation({\n    mutationFn: async (data: FeedFormData) => {\n      // Calculate final quantity in kg as string (backend expects strings)\n      let finalQuantityKgStr: string;\n      if (data.recordType === \"bags\") {\n        const bagSize = parseFloat(data.bagSize || \"0\");\n        const numberOfBags = parseFloat(data.numberOfBags || \"0\");\n        const calculatedKg = bagSize * numberOfBags;\n        finalQuantityKgStr = calculatedKg.toFixed(2); // Convert to string with 2 decimal places\n      } else {\n        // Use the direct kg input as string\n        const quantity = parseFloat(data.quantityKg || \"0\");\n        finalQuantityKgStr = quantity.toFixed(2);\n      }\n\n      // Calculate unit price per kg (backend expects per-kg pricing)\n      let finalUnitPrice: string | undefined;\n      if (data.unitPrice && data.unitPrice.trim() !== \"\") {\n        const unitPriceValue = parseFloat(data.unitPrice);\n        if (data.recordType === \"bags\") {\n          // Convert from per-bag to per-kg\n          const bagSize = parseFloat(data.bagSize || \"1\");\n          const unitPricePerKg = unitPriceValue / bagSize;\n          finalUnitPrice = unitPricePerKg.toFixed(2);\n        } else {\n          // Direct per-kg pricing\n          finalUnitPrice = unitPriceValue.toFixed(2);\n        }\n      }\n\n      const feedData = {\n        feedType: data.feedType,\n        supplier: data.supplier || undefined, // Convert empty string to undefined\n        quantityKg: finalQuantityKgStr,\n        unitPrice: finalUnitPrice,\n        purchaseDate: data.purchaseDate,\n        expiryDate: data.expiryDate && data.expiryDate.trim() !== \"\" ? data.expiryDate : undefined,\n      };\n      const feedDataWithFarm = { ...feedData, farmId: activeFarmId };\n      await apiRequest(\"POST\", \"/api/feed-inventory\", feedDataWithFarm);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed-inventory\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\", activeFarmId] });\n      toast({\n        title: \"Success\",\n        description: \"Feed inventory added successfully\",\n      });\n      feedForm.reset();\n      setFeedDialogOpen(false);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add feed inventory\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading feed management data...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  const feedRecords = (Array.isArray(dailyRecords) ? dailyRecords : []).filter((record: any) => record.feedConsumed && parseFloat(record.feedConsumed) > 0);\n  const totalStock = (Array.isArray(feedInventory) ? feedInventory : []).reduce((sum: number, feed: any) => sum + parseFloat(feed.quantityKg || '0'), 0);\n  const lowStockItems = (Array.isArray(feedInventory) ? feedInventory : []).filter((feed: any) => parseFloat(feed.quantityKg || '0') < 500);\n  const expiringSoon = (Array.isArray(feedInventory) ? feedInventory : []).filter((feed: any) => {\n    if (!feed.expiryDate) return false;\n    const expiryDate = new Date(feed.expiryDate);\n    const monthFromNow = new Date();\n    monthFromNow.setMonth(monthFromNow.getMonth() + 1);\n    return expiryDate <= monthFromNow;\n  });\n\n  // Calculate daily consumption average\n  const weekRecords = feedRecords.filter((record: any) => {\n    const recordDate = new Date(record.recordDate);\n    const weekAgo = new Date();\n    weekAgo.setDate(weekAgo.getDate() - 7);\n    return recordDate >= weekAgo;\n  });\n  const weekConsumption = weekRecords.reduce((sum: number, record: any) => sum + parseFloat(record.feedConsumed || '0'), 0);\n  const dailyAverage = weekConsumption / 7;\n  const daysRemaining = dailyAverage > 0 ? Math.floor(totalStock / dailyAverage) : 0;\n\n  const onSubmitFeed = (data: FeedFormData) => {\n    console.log(\"Feed form submitted with data:\", data);\n    console.log(\"Feed form errors:\", feedForm.formState.errors);\n    createFeedMutation.mutate(data);\n  };\n\n  const getStockStatus = (quantity: number) => {\n    if (quantity < 200) return { status: \"Critical\", variant: \"destructive\" as const };\n    if (quantity < 500) return { status: \"Low\", variant: \"secondary\" as const };\n    return { status: \"Good\", variant: \"default\" as const };\n  };\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Header */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Feed Management</h2>\n                <p className=\"text-sm text-muted-foreground\">Manage feed inventory and consumption tracking</p>\n              </div>\n            </div>\n            \n            <Dialog open={feedDialogOpen} onOpenChange={setFeedDialogOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-add-feed\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Add Feed\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-lg\">\n                <DialogHeader>\n                  <DialogTitle>Add Feed Inventory</DialogTitle>\n                </DialogHeader>\n                <Form {...feedForm}>\n                  <form onSubmit={feedForm.handleSubmit(onSubmitFeed)} className=\"space-y-6\">\n                    <FormField\n                      control={feedForm.control}\n                      name=\"feedType\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Feed Type</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-feed-type\">\n                                <SelectValue placeholder=\"Select feed type\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"layer-mash\">Layer Mash</SelectItem>\n                              <SelectItem value=\"layer-pellets\">Layer Pellets</SelectItem>\n                              <SelectItem value=\"chick-starter\">Chick Starter</SelectItem>\n                              <SelectItem value=\"broiler-starter\">Broiler Starter</SelectItem>\n                              <SelectItem value=\"grower-mash\">Grower Mash</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={feedForm.control}\n                      name=\"supplier\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Supplier</FormLabel>\n                          <FormControl>\n                            {uniqueSuppliers.length > 0 ? (\n                              <Select onValueChange={(value) => field.onChange(value === \"other\" ? \"\" : value)} defaultValue={field.value}>\n                                <SelectTrigger data-testid=\"select-supplier\">\n                                  <SelectValue placeholder=\"Select or enter supplier name\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  {uniqueSuppliers.map((supplier) => (\n                                    <SelectItem key={supplier} value={supplier}>{supplier}</SelectItem>\n                                  ))}\n                                  <SelectItem value=\"other\">Other (enter manually)</SelectItem>\n                                </SelectContent>\n                              </Select>\n                            ) : (\n                              <Input {...field} placeholder=\"Enter supplier name\" data-testid=\"input-supplier\" />\n                            )}\n                          </FormControl>\n                          {uniqueSuppliers.length > 0 && !uniqueSuppliers.includes(field.value || \"\") && (\n                            <Input \n                              value={field.value || \"\"} \n                              onChange={field.onChange}\n                              placeholder=\"Enter new supplier name\" \n                              className=\"mt-2\"\n                              data-testid=\"input-supplier-manual\"\n                            />\n                          )}\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <Separator />\n\n                    <div className=\"space-y-4\">\n                      <FormField\n                        control={feedForm.control}\n                        name=\"recordType\"\n                        render={({ field }) => (\n                          <FormItem className=\"space-y-3\">\n                            <FormLabel>Record by:</FormLabel>\n                            <FormControl>\n                              <RadioGroup\n                                onValueChange={field.onChange}\n                                defaultValue={field.value}\n                                className=\"flex space-x-6\"\n                                data-testid=\"radio-record-type\"\n                              >\n                                <div className=\"flex items-center space-x-2\">\n                                  <RadioGroupItem value=\"bags\" id=\"bags\" data-testid=\"radio-bags\" />\n                                  <Label htmlFor=\"bags\">Bags</Label>\n                                </div>\n                                <div className=\"flex items-center space-x-2\">\n                                  <RadioGroupItem value=\"kilograms\" id=\"kilograms\" data-testid=\"radio-kilograms\" />\n                                  <Label htmlFor=\"kilograms\">Kilograms</Label>\n                                </div>\n                              </RadioGroup>\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      {watchRecordType === \"bags\" ? (\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={feedForm.control}\n                            name=\"bagSize\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Bag Size</FormLabel>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-bag-size\">\n                                      <SelectValue placeholder=\"Select bag size\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"50\">50 kg</SelectItem>\n                                    <SelectItem value=\"70\">70 kg</SelectItem>\n                                    <SelectItem value=\"90\">90 kg</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={feedForm.control}\n                            name=\"numberOfBags\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Number of Bags (pieces)</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    type=\"number\" \n                                    step=\"1\" \n                                    min=\"1\"\n                                    {...field} \n                                    placeholder=\"20\"\n                                    data-testid=\"input-number-of-bags\"\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      ) : (\n                        <FormField\n                          control={feedForm.control}\n                          name=\"quantityKg\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Quantity (kg)</FormLabel>\n                              <FormControl>\n                                <Input \n                                  type=\"number\" \n                                  step=\"0.01\" \n                                  min=\"0\"\n                                  {...field} \n                                  placeholder=\"1000.00\"\n                                  data-testid=\"input-quantity\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      )}\n\n                      {watchRecordType === \"bags\" && calculatedKg > 0 && (\n                        <div className=\"p-3 bg-muted rounded-lg\" data-testid=\"calculated-total\">\n                          <div className=\"flex items-center space-x-2 text-sm font-medium\">\n                            <Calculator className=\"h-4 w-4\" />\n                            <span>Total (kg): {calculatedKg.toLocaleString()} kg</span>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n\n                    <FormField\n                      control={feedForm.control}\n                      name=\"unitPrice\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>\n                            Unit Price ({watchRecordType === \"bags\" ? \"KSh/bag\" : \"KSh/kg\"})\n                          </FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"number\" \n                              step=\"0.01\" \n                              min=\"0\"\n                              {...field} \n                              placeholder={watchRecordType === \"bags\" ? \"3500.00\" : \"45.00\"}\n                              data-testid=\"input-unit-price\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={feedForm.control}\n                        name=\"purchaseDate\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Purchase Date</FormLabel>\n                            <FormControl>\n                              <Input type=\"date\" {...field} data-testid=\"input-purchase-date\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={feedForm.control}\n                        name=\"expiryDate\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Expiry Date (optional)</FormLabel>\n                            <FormControl>\n                              <Input type=\"date\" {...field} data-testid=\"input-expiry-date\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    {/* Inline Summary */}\n                    {((watchRecordType === \"bags\" && calculatedKg > 0) || (watchRecordType === \"kilograms\" && parseFloat(watchQuantityKg || \"0\") > 0)) && totalCost > 0 && (\n                      <div className=\"p-4 bg-primary/10 border border-primary/20 rounded-lg space-y-2\" data-testid=\"form-summary\">\n                        <h4 className=\"font-medium text-sm text-primary\">Summary</h4>\n                        <div className=\"text-sm space-y-1\">\n                          <p>\n                            You're adding <span className=\"font-medium\">\n                              {watchRecordType === \"bags\" ? calculatedKg.toLocaleString() : parseFloat(watchQuantityKg || \"0\").toLocaleString()} kg\n                            </span> of feed\n                            {watchUnitPrice && (\n                              <> at <span className=\"font-medium\">\n                                KSh {parseFloat(watchUnitPrice).toFixed(2)}/{watchRecordType === \"bags\" ? \"bag\" : \"kg\"}\n                              </span></>\n                            )}\n                          </p>\n                          {watchRecordType === \"bags\" && watchNumberOfBags && (\n                            <p className=\"text-xs text-muted-foreground\">\n                              ({parseFloat(watchNumberOfBags)} bags × KSh {parseFloat(watchUnitPrice || \"0\").toFixed(2)}/bag)\n                            </p>\n                          )}\n                          <p className=\"font-medium text-primary\">\n                            Total Cost: KSh {totalCost.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                          </p>\n                        </div>\n                      </div>\n                    )}\n\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full\" \n                      disabled={createFeedMutation.isPending}\n                      data-testid=\"button-submit-feed\"\n                    >\n                      {createFeedMutation.isPending ? (\n                        <div className=\"flex items-center space-x-2\">\n                          <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin\" />\n                          <span>Adding...</span>\n                        </div>\n                      ) : (\n                        \"Add Feed Inventory\"\n                      )}\n                    </Button>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          {/* Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n            <Card data-testid=\"card-total-stock\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Total Stock</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{(totalStock / 1000).toFixed(1)} tons</p>\n                    <p className=\"text-xs text-muted-foreground\">{totalStock.toLocaleString()} kg</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <Wheat className=\"h-6 w-6 text-primary\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-daily-consumption\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Daily Average</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{Math.round(dailyAverage)} kg</p>\n                    <p className=\"text-xs text-muted-foreground\">Consumption</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <TrendingDown className=\"h-6 w-6 text-chart-2\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-days-remaining\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Days Remaining</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{daysRemaining}</p>\n                    <p className={`text-xs ${daysRemaining < 7 ? 'text-red-600' : daysRemaining < 14 ? 'text-orange-600' : 'text-green-600'}`}>\n                      {daysRemaining < 7 ? '⚠ Critical' : daysRemaining < 14 ? '⚠ Low' : '✓ Good'}\n                    </p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center\">\n                    <AlertTriangle className=\"h-6 w-6 text-orange-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-low-stock-alerts\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Low Stock Items</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{lowStockItems.length}</p>\n                    <p className=\"text-xs text-red-600\">Need attention</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center\">\n                    <Package className=\"h-6 w-6 text-red-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Alerts */}\n          {(lowStockItems.length > 0 || expiringSoon.length > 0) && (\n            <Card data-testid=\"card-feed-alerts\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <AlertTriangle className=\"h-5 w-5 text-orange-600\" />\n                  <span>Feed Alerts</span>\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3\">\n                  {lowStockItems.map((feed: any) => (\n                    <div key={feed.id} className=\"flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n                      <div>\n                        <p className=\"font-medium text-foreground\">{feed.feedType} - Low Stock</p>\n                        <p className=\"text-sm text-muted-foreground\">Only {parseFloat(feed.quantityKg).toLocaleString()} kg remaining</p>\n                      </div>\n                      <Badge variant=\"secondary\">Low</Badge>\n                    </div>\n                  ))}\n                  {expiringSoon.map((feed: any) => (\n                    <div key={`exp-${feed.id}`} className=\"flex items-center justify-between p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg\">\n                      <div>\n                        <p className=\"font-medium text-foreground\">{feed.feedType} - Expiring Soon</p>\n                        <p className=\"text-sm text-muted-foreground\">Expires: {new Date(feed.expiryDate).toLocaleDateString()}</p>\n                      </div>\n                      <Badge variant=\"secondary\">Expiring</Badge>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          <Tabs defaultValue=\"inventory\" className=\"space-y-4\">\n            <TabsList>\n              <TabsTrigger value=\"inventory\">Current Inventory</TabsTrigger>\n              <TabsTrigger value=\"consumption\">Consumption Records</TabsTrigger>\n              <TabsTrigger value=\"suppliers\">Suppliers</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"inventory\">\n              <Card data-testid=\"card-feed-inventory\">\n                <CardHeader>\n                  <CardTitle>Feed Inventory</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {!feedInventory || !Array.isArray(feedInventory) || feedInventory.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <Wheat className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No feed inventory found</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Add feed inventory to start tracking</p>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Feed Type</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Supplier</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Stock (kg)</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Unit Price</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Purchase Date</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Status</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {(Array.isArray(feedInventory) ? feedInventory : []).map((feed: any) => {\n                            const quantity = parseFloat(feed.quantityKg || '0');\n                            const stockStatus = getStockStatus(quantity);\n                            \n                            return (\n                              <tr key={feed.id} className=\"border-b border-border/50\" data-testid={`row-feed-${feed.id}`}>\n                                <td className=\"p-2 font-medium\">{feed.feedType}</td>\n                                <td className=\"p-2\">{feed.supplier || \"-\"}</td>\n                                <td className=\"p-2\">{quantity.toLocaleString()}</td>\n                                <td className=\"p-2\">KSh {parseFloat(feed.unitPrice || '0').toLocaleString()}</td>\n                                <td className=\"p-2\">{feed.purchaseDate ? new Date(feed.purchaseDate).toLocaleDateString() : \"-\"}</td>\n                                <td className=\"p-2\">\n                                  <Badge variant={stockStatus.variant}>\n                                    {stockStatus.status}\n                                  </Badge>\n                                </td>\n                              </tr>\n                            );\n                          })}\n                        </tbody>\n                      </table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"consumption\">\n              <Card data-testid=\"card-consumption-records\">\n                <CardHeader>\n                  <CardTitle>Feed Consumption Records</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {feedRecords.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <TrendingDown className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No consumption records found</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Start recording daily feed consumption</p>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Date</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Feed Type</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Consumed (kg)</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Notes</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {feedRecords.slice(0, 10).map((record: any) => (\n                            <tr key={record.id} className=\"border-b border-border/50\" data-testid={`row-consumption-${record.id}`}>\n                              <td className=\"p-2\">{new Date(record.recordDate).toLocaleDateString()}</td>\n                              <td className=\"p-2\">{record.feedType || \"-\"}</td>\n                              <td className=\"p-2 font-medium\">{parseFloat(record.feedConsumed).toLocaleString()}</td>\n                              <td className=\"p-2 max-w-xs truncate\">{record.notes || \"-\"}</td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"suppliers\">\n              <Card data-testid=\"card-suppliers\">\n                <CardHeader>\n                  <CardTitle>Feed Suppliers</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {/* This would normally come from a suppliers API endpoint */}\n                    <div className=\"text-center py-8\">\n                      <Package className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">Supplier management coming soon</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Track supplier information and performance</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":40805},"client/src/components/dashboard/simple-quick-actions.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Egg, Skull, Wheat, Coins, Heart, Receipt } from \"lucide-react\";\nimport SimpleQuickEggForm from \"@/components/forms/simple-quick-egg-form\";\nimport SimpleMortalityForm from \"@/components/forms/simple-mortality-form\";\nimport SimpleFeedForm from \"@/components/forms/simple-feed-form\"; \nimport SimpleSalesForm from \"@/components/forms/simple-sales-form\";\nimport SimpleHealthForm from \"@/components/forms/simple-health-form\";\nimport SimpleExpenseForm from \"@/components/forms/simple-expense-form\";\n\nconst actions = [\n  {\n    id: \"record-eggs\",\n    title: \"Record Eggs\",\n    description: \"Daily egg collection\",\n    icon: Egg,\n    color: \"bg-chart-3/10 text-chart-3\",\n  },\n  {\n    id: \"add-mortality\",\n    title: \"Record Mortality\",\n    description: \"Track bird losses\",\n    icon: Skull,\n    color: \"bg-red-100 text-red-600\",\n  },\n  {\n    id: \"update-feed\",\n    title: \"Update Feed\",\n    description: \"Log feed consumption\",\n    icon: Wheat,\n    color: \"bg-orange-100 text-orange-600\",\n  },\n  {\n    id: \"record-sale\",\n    title: \"Record Sale\",\n    description: \"Log egg sales\",\n    icon: Coins,\n    color: \"bg-green-100 text-green-600\",\n  },\n  {\n    id: \"add-health\",\n    title: \"Health Record\",\n    description: \"Log health events\",\n    icon: Heart,\n    color: \"bg-pink-100 text-pink-600\",\n  },\n  {\n    id: \"record-expense\",\n    title: \"Record Expense\",\n    description: \"Track farm expenses\",\n    icon: Receipt,\n    color: \"bg-blue-100 text-blue-600\",\n  },\n];\n\nexport default function SimpleQuickActions() {\n  const [eggDialogOpen, setEggDialogOpen] = useState(false);\n  const [mortalityDialogOpen, setMortalityDialogOpen] = useState(false);\n  const [feedDialogOpen, setFeedDialogOpen] = useState(false);\n  const [saleDialogOpen, setSaleDialogOpen] = useState(false);\n  const [healthDialogOpen, setHealthDialogOpen] = useState(false);\n  const [expenseDialogOpen, setExpenseDialogOpen] = useState(false);\n\n  const renderActionDialog = (action: typeof actions[0]) => {\n    const Icon = action.icon;\n    \n    // Record Eggs Dialog\n    if (action.id === \"record-eggs\") {\n      return (\n        <Dialog key={action.id} open={eggDialogOpen} onOpenChange={setEggDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n              <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                <Icon className=\"h-5 w-5\" />\n              </div>\n              <div className=\"text-left\">\n                <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n              </div>\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Record Eggs</DialogTitle>\n              <DialogDescription>Record today's egg collection with automatic crate calculation</DialogDescription>\n            </DialogHeader>\n            <SimpleQuickEggForm onSuccess={() => setEggDialogOpen(false)} />\n          </DialogContent>\n        </Dialog>\n      );\n    }\n    \n    // Record Mortality Dialog\n    if (action.id === \"add-mortality\") {\n      return (\n        <Dialog key={action.id} open={mortalityDialogOpen} onOpenChange={setMortalityDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n              <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                <Icon className=\"h-5 w-5\" />\n              </div>\n              <div className=\"text-left\">\n                <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n              </div>\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Record Mortality</DialogTitle>\n              <DialogDescription>Record bird losses with detailed reasons</DialogDescription>\n            </DialogHeader>\n            <SimpleMortalityForm onSuccess={() => setMortalityDialogOpen(false)} />\n          </DialogContent>\n        </Dialog>\n      );\n    }\n    \n    // Update Feed Dialog\n    if (action.id === \"update-feed\") {\n      return (\n        <Dialog key={action.id} open={feedDialogOpen} onOpenChange={setFeedDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n              <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                <Icon className=\"h-5 w-5\" />\n              </div>\n              <div className=\"text-left\">\n                <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n              </div>\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Update Feed</DialogTitle>\n              <DialogDescription>Log daily feed consumption with age-based guidance</DialogDescription>\n            </DialogHeader>\n            <SimpleFeedForm onSuccess={() => setFeedDialogOpen(false)} />\n          </DialogContent>\n        </Dialog>\n      );\n    }\n    \n    // Record Sale Dialog\n    if (action.id === \"record-sale\") {\n      return (\n        <Dialog key={action.id} open={saleDialogOpen} onOpenChange={setSaleDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n              <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                <Icon className=\"h-5 w-5\" />\n              </div>\n              <div className=\"text-left\">\n                <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n              </div>\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Record Sale</DialogTitle>\n              <DialogDescription>Record egg sales with customer details and automatic calculations</DialogDescription>\n            </DialogHeader>\n            <SimpleSalesForm onSuccess={() => setSaleDialogOpen(false)} />\n          </DialogContent>\n        </Dialog>\n      );\n    }\n\n    // Add Health Record Dialog\n    if (action.id === \"add-health\") {\n      return (\n        <Dialog key={action.id} open={healthDialogOpen} onOpenChange={setHealthDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n              <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                <Icon className=\"h-5 w-5\" />\n              </div>\n              <div className=\"text-left\">\n                <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n              </div>\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Add Health Record</DialogTitle>\n              <DialogDescription>Record vaccination, medication, treatment, or health checkup</DialogDescription>\n            </DialogHeader>\n            <SimpleHealthForm onSuccess={() => setHealthDialogOpen(false)} />\n          </DialogContent>\n        </Dialog>\n      );\n    }\n\n    // Record Expense Dialog  \n    if (action.id === \"record-expense\") {\n      return (\n        <Dialog key={action.id} open={expenseDialogOpen} onOpenChange={setExpenseDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n              <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                <Icon className=\"h-5 w-5\" />\n              </div>\n              <div className=\"text-left\">\n                <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n              </div>\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Record Expense</DialogTitle>\n              <DialogDescription>Track farm expenses and operating costs</DialogDescription>\n            </DialogHeader>\n            <SimpleExpenseForm onSuccess={() => setExpenseDialogOpen(false)} />\n          </DialogContent>\n        </Dialog>\n      );\n    }\n    \n    return null;\n  };\n\n  return (\n    <Card data-testid=\"card-quick-actions\">\n      <CardHeader>\n        <CardTitle>Quick Actions</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-3\">\n          {actions.map((action) => renderActionDialog(action))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":10026},"client/src/hooks/useSales.ts":{"content":"import { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { insertSaleSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\n\n// Type for the sale data (without farmId which is auto-injected)\ntype SaleData = Omit<z.infer<typeof insertSaleSchema>, 'farmId' | 'userId'>;\n\nexport function useSaleMutation() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeFarmId } = useFarmContext();\n\n  return useMutation({\n    mutationFn: async (data: SaleData) => {\n      // Prepare data with farmId for API\n      const saleData = {\n        ...data,\n        farmId: activeFarmId,\n      };\n      \n      console.log(\"Submitting sale record:\", saleData);\n      await apiRequest(\"POST\", \"/api/sales\", saleData);\n    },\n    onSuccess: () => {\n      // Invalidate all relevant caches with farm-scoped keys\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\", activeFarmId] });\n      \n      toast({\n        title: \"Success\",\n        description: \"Sale recorded successfully\",\n      });\n    },\n    onError: (error: any) => {\n      console.error(\"Failed to create sale:\", error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to record sale. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n}","size_bytes":1640},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --background: hsl(0 0% 100%);\n  --foreground: hsl(240 10% 3.9%);\n  --card: hsl(0 0% 100%);\n  --card-foreground: hsl(240 10% 3.9%);\n  --popover: hsl(0 0% 100%);\n  --popover-foreground: hsl(240 10% 3.9%);\n  --primary: hsl(142 76% 36%);\n  --primary-foreground: hsl(355.7 100% 97.3%);\n  --secondary: hsl(240 4.8% 95.9%);\n  --secondary-foreground: hsl(240 5.9% 10%);\n  --muted: hsl(240 4.8% 95.9%);\n  --muted-foreground: hsl(240 3.8% 46.1%);\n  --accent: hsl(45 93% 47%);\n  --accent-foreground: hsl(240 5.9% 10%);\n  --destructive: hsl(0 84.2% 60.2%);\n  --destructive-foreground: hsl(0 0% 98%);\n  --border: hsl(240 5.9% 90%);\n  --input: hsl(240 5.9% 90%);\n  --ring: hsl(142 76% 36%);\n  --chart-1: hsl(142 76% 36%);\n  --chart-2: hsl(217 91% 60%);\n  --chart-3: hsl(45 93% 47%);\n  --chart-4: hsl(262 83% 58%);\n  --chart-5: hsl(12 76% 61%);\n  --sidebar: hsl(180 6.6667% 97.0588%);\n  --sidebar-foreground: hsl(210 25% 7.8431%);\n  --sidebar-primary: hsl(203.8863 88.2845% 53.1373%);\n  --sidebar-primary-foreground: hsl(0 0% 100%);\n  --sidebar-accent: hsl(211.5789 51.3514% 92.7451%);\n  --sidebar-accent-foreground: hsl(203.8863 88.2845% 53.1373%);\n  --sidebar-border: hsl(205.0000 25.0000% 90.5882%);\n  --sidebar-ring: hsl(202.8169 89.1213% 53.1373%);\n  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: 0.5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 2px 4px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 4px 6px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 8px 10px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n}\n\n.dark {\n  --background: hsl(0 0% 0%);\n  --foreground: hsl(200 6.6667% 91.1765%);\n  --card: hsl(228 9.8039% 10%);\n  --card-foreground: hsl(0 0% 85.0980%);\n  --popover: hsl(0 0% 0%);\n  --popover-foreground: hsl(200 6.6667% 91.1765%);\n  --primary: hsl(142 76% 36%);\n  --primary-foreground: hsl(355.7 100% 97.3%);\n  --secondary: hsl(195.0000 15.3846% 94.9020%);\n  --secondary-foreground: hsl(210 25% 7.8431%);\n  --muted: hsl(0 0% 9.4118%);\n  --muted-foreground: hsl(210 3.3898% 46.2745%);\n  --accent: hsl(45 93% 47%);\n  --accent-foreground: hsl(240 5.9% 10%);\n  --destructive: hsl(0 84.2% 60.2%);\n  --destructive-foreground: hsl(0 0% 98%);\n  --border: hsl(210 5.2632% 14.9020%);\n  --input: hsl(207.6923 27.6596% 18.4314%);\n  --ring: hsl(142 76% 36%);\n  --chart-1: hsl(142 76% 36%);\n  --chart-2: hsl(217 91% 60%);\n  --chart-3: hsl(45 93% 47%);\n  --chart-4: hsl(262 83% 58%);\n  --chart-5: hsl(12 76% 61%);\n  --sidebar: hsl(228 9.8039% 10%);\n  --sidebar-foreground: hsl(0 0% 85.0980%);\n  --sidebar-primary: hsl(202.8169 89.1213% 53.1373%);\n  --sidebar-primary-foreground: hsl(0 0% 100%);\n  --sidebar-accent: hsl(205.7143 70% 7.8431%);\n  --sidebar-accent-foreground: hsl(203.7736 87.6033% 52.5490%);\n  --sidebar-border: hsl(205.7143 15.7895% 26.0784%);\n  --sidebar-ring: hsl(202.8169 89.1213% 53.1373%);\n  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: 0.5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 2px 4px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 4px 6px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 8px 10px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/* Custom scrollbar */\n.custom-scrollbar::-webkit-scrollbar {\n  width: 6px;\n}\n\n.custom-scrollbar::-webkit-scrollbar-track {\n  @apply bg-muted;\n  border-radius: 3px;\n}\n\n.custom-scrollbar::-webkit-scrollbar-thumb {\n  @apply bg-muted-foreground;\n  border-radius: 3px;\n}\n\n.custom-scrollbar::-webkit-scrollbar-thumb:hover {\n  @apply bg-foreground;\n}\n\n/* Sidebar transition */\n.sidebar-transition {\n  transition: transform 0.3s ease-in-out;\n}\n\n@media (max-width: 768px) {\n  .sidebar-closed {\n    transform: translateX(-100%);\n  }\n}\n","size_bytes":5424},"client/src/pages/customer-registration.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { ArrowLeft, User, Mail, Phone, MapPin, CheckCircle, Users, ShoppingCart, LayoutDashboard } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nconst customerRegistrationSchema = z.object({\n  name: z.string().min(2, \"Name must be at least 2 characters\"),\n  email: z.string().email(\"Please enter a valid email address\"),\n  phone: z.string().min(10, \"Phone number must be at least 10 digits\"),\n  address: z.string().min(5, \"Please enter a complete address\"),\n  city: z.string().min(2, \"City is required\"),\n  state: z.string().min(2, \"State is required\"),\n  zipCode: z.string().min(5, \"Valid ZIP code is required\"),\n  customerType: z.enum([\"individual\", \"business\"]),\n  businessName: z.string().optional(),\n  businessRegistration: z.string().optional(),\n  preferredDeliveryMethod: z.enum([\"pickup\", \"delivery\", \"both\"]),\n  notes: z.string().optional(),\n});\n\ntype CustomerRegistrationForm = z.infer<typeof customerRegistrationSchema>;\n\nexport default function CustomerRegistration() {\n  const [isSuccess, setIsSuccess] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { user, isAuthenticated, isLoading } = useAuth();\n\n  // Handle completion of registration after login redirect\n  useEffect(() => {\n    const savedFormData = sessionStorage.getItem('customerRegistrationData');\n    if (savedFormData && isAuthenticated && !isLoading) {\n      try {\n        const formData = JSON.parse(savedFormData);\n        // Clear saved data\n        sessionStorage.removeItem('customerRegistrationData');\n        \n        // Submit the saved form data\n        authenticatedRegistrationMutation.mutate(formData);\n      } catch (error) {\n        console.error('Error processing saved registration data:', error);\n        toast({\n          title: \"Registration Error\",\n          description: \"There was an issue completing your registration. Please try again.\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  }, [isAuthenticated, isLoading]);\n\n  const form = useForm<CustomerRegistrationForm>({\n    resolver: zodResolver(customerRegistrationSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      address: \"\",\n      city: \"\",\n      state: \"\",\n      zipCode: \"\",\n      customerType: \"individual\",\n      businessName: \"\",\n      businessRegistration: \"\",\n      preferredDeliveryMethod: \"both\",\n      notes: \"\",\n    },\n  });\n\n  // Helper function to transform form data\n  const transformFormData = (data: CustomerRegistrationForm) => ({\n    name: data.name,\n    email: data.email,\n    phone: data.phone,\n    address: data.address,\n    location: `${data.city}, ${data.state} ${data.zipCode}`,\n    customerType: data.customerType,\n    notes: [\n      data.notes,\n      data.businessName ? `Business: ${data.businessName}` : '',\n      data.businessRegistration ? `Registration: ${data.businessRegistration}` : '',\n      data.preferredDeliveryMethod ? `Preferred delivery: ${data.preferredDeliveryMethod}` : ''\n    ].filter(Boolean).join('\\n'),\n  });\n\n  // Authenticated registration (uses protected endpoint)\n  const authenticatedRegistrationMutation = useMutation({\n    mutationFn: async (data: CustomerRegistrationForm) => {\n      const customerData = transformFormData(data);\n      \n      const response = await fetch('/api/customers/me', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(customerData),\n        credentials: 'include', // Include cookies for authentication\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Registration failed');\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      setIsSuccess(true);\n      toast({\n        title: \"Registration Successful!\",\n        description: \"Your customer profile has been created! You can now place orders.\",\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/customers/me'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Registration Failed\",\n        description: error.message || \"Something went wrong. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Public registration (legacy endpoint for backwards compatibility)\n  const publicRegistrationMutation = useMutation({\n    mutationFn: async (data: CustomerRegistrationForm) => {\n      const customerData = transformFormData(data);\n      \n      const response = await fetch('/api/public/customers/register', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(customerData),\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Registration failed');\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      setIsSuccess(true);\n      toast({\n        title: \"Registration Submitted!\",\n        description: \"Please log in to activate your account and start placing orders.\",\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/customers'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Registration Failed\",\n        description: error.message || \"Something went wrong. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const watchCustomerType = form.watch(\"customerType\");\n\n  const onSubmit = (data: CustomerRegistrationForm) => {\n    if (isAuthenticated) {\n      // User is authenticated - submit directly to protected endpoint\n      authenticatedRegistrationMutation.mutate(data);\n    } else {\n      // User not authenticated - save form data and redirect to login\n      sessionStorage.setItem('customerRegistrationData', JSON.stringify(data));\n      toast({\n        title: \"Login Required\",\n        description: \"Please log in to complete your customer registration.\",\n      });\n      // Redirect to login with return path to come back to registration page\n      window.location.href = '/api/login?returnTo=' + encodeURIComponent('/customer-registration');\n    }\n  };\n\n  if (isSuccess) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-2xl\">\n        <Card>\n          <CardContent className=\"text-center py-12 space-y-6\">\n            <CheckCircle className=\"h-16 w-16 mx-auto text-green-500\" />\n            <div>\n              <h2 className=\"text-2xl font-bold text-green-600 mb-2\">Registration Successful!</h2>\n              <p className=\"text-gray-600 dark:text-gray-400 mb-4\">\n                Welcome to our poultry marketplace! Your customer account has been created.\n              </p>\n            </div>\n            \n            <div className=\"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg\">\n              <h3 className=\"font-semibold mb-2\">What's Next?</h3>\n              <ul className=\"text-sm text-gray-600 dark:text-gray-400 space-y-1 text-left\">\n                <li>• Browse farms and products in our marketplace</li>\n                <li>• Contact farms directly to place orders</li>\n                <li>• Build relationships with local farmers</li>\n                <li>• Get fresh, quality poultry products delivered</li>\n              </ul>\n            </div>\n\n            <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n              {isAuthenticated ? (\n                <>\n                  <Link to=\"/\">\n                    <Button size=\"lg\" data-testid=\"button-dashboard\">\n                      <LayoutDashboard className=\"mr-2 h-4 w-4\" />\n                      Go to Dashboard\n                    </Button>\n                  </Link>\n                  <Link to=\"/marketplace\">\n                    <Button variant=\"outline\" size=\"lg\" data-testid=\"button-browse-marketplace\">\n                      <ShoppingCart className=\"mr-2 h-4 w-4\" />\n                      Browse Marketplace\n                    </Button>\n                  </Link>\n                </>\n              ) : (\n                <>\n                  <Button \n                    size=\"lg\" \n                    onClick={() => window.location.href = \"/api/login\"}\n                    data-testid=\"button-login\"\n                  >\n                    <User className=\"mr-2 h-4 w-4\" />\n                    Login to Your Account\n                  </Button>\n                  <Link to=\"/marketplace\">\n                    <Button variant=\"outline\" size=\"lg\" data-testid=\"button-browse-marketplace\">\n                      <ShoppingCart className=\"mr-2 h-4 w-4\" />\n                      Browse Marketplace\n                    </Button>\n                  </Link>\n                </>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-2xl\">\n      <div className=\"space-y-6\">\n        {/* Header Navigation */}\n        <div className=\"flex items-center gap-4\">\n          <Link to=\"/marketplace\">\n            <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Back to Marketplace\n            </Button>\n          </Link>\n        </div>\n\n        {/* Registration Form */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-3\">\n              <Users className=\"h-6 w-6 text-blue-600\" />\n              Customer Registration\n            </CardTitle>\n            <p className=\"text-gray-600 dark:text-gray-400\">\n              Join our marketplace to connect with local poultry farms and place orders for fresh products.\n            </p>\n          </CardHeader>\n          <CardContent>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n                {/* Personal Information */}\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n                    <User className=\"h-5 w-5\" />\n                    Personal Information\n                  </h3>\n                  \n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"name\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Full Name *</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"John Doe\" data-testid=\"input-name\" {...field} />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    \n                    <FormField\n                      control={form.control}\n                      name=\"email\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Email Address *</FormLabel>\n                          <FormControl>\n                            <Input type=\"email\" placeholder=\"john@example.com\" data-testid=\"input-email\" {...field} />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={form.control}\n                    name=\"phone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Phone Number *</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"(555) 123-4567\" data-testid=\"input-phone\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {/* Address Information */}\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n                    <MapPin className=\"h-5 w-5\" />\n                    Address Information\n                  </h3>\n                  \n                  <FormField\n                    control={form.control}\n                    name=\"address\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Street Address *</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"123 Main Street\" data-testid=\"input-address\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"city\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>City *</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Springfield\" data-testid=\"input-city\" {...field} />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    \n                    <FormField\n                      control={form.control}\n                      name=\"state\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>State *</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"IL\" data-testid=\"input-state\" {...field} />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    \n                    <FormField\n                      control={form.control}\n                      name=\"zipCode\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>ZIP Code *</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"62701\" data-testid=\"input-zip\" {...field} />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Customer Details */}\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-lg font-semibold\">Customer Details</h3>\n                  \n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"customerType\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Customer Type *</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-customer-type\">\n                                <SelectValue placeholder=\"Select customer type\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"individual\">Individual</SelectItem>\n                              <SelectItem value=\"business\">Business</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    \n                    <FormField\n                      control={form.control}\n                      name=\"preferredDeliveryMethod\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Preferred Delivery Method *</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-delivery-method\">\n                                <SelectValue placeholder=\"Select delivery method\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"pickup\">Pickup Only</SelectItem>\n                              <SelectItem value=\"delivery\">Delivery Only</SelectItem>\n                              <SelectItem value=\"both\">Both Pickup & Delivery</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  {/* Business fields - shown only for business customers */}\n                  {watchCustomerType === \"business\" && (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      <FormField\n                        control={form.control}\n                        name=\"businessName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Business Name</FormLabel>\n                            <FormControl>\n                              <Input placeholder=\"ABC Restaurant\" data-testid=\"input-business-name\" {...field} />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      \n                      <FormField\n                        control={form.control}\n                        name=\"businessRegistration\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Business Registration Number</FormLabel>\n                            <FormControl>\n                              <Input placeholder=\"12345678\" data-testid=\"input-business-registration\" {...field} />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                  )}\n                </div>\n\n                {/* Additional Notes */}\n                <FormField\n                  control={form.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Additional Notes (Optional)</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Any specific requirements, preferences, or questions...\"\n                          className=\"min-h-[80px]\"\n                          data-testid=\"textarea-notes\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Terms Notice */}\n                <div className=\"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg\">\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                    By registering, you agree to connect directly with farms for orders and communications. \n                    We facilitate connections but orders and transactions are managed between you and the farm.\n                  </p>\n                </div>\n\n                {/* Submit Button */}\n                <Button\n                  type=\"submit\"\n                  size=\"lg\"\n                  className=\"w-full\"\n                  disabled={authenticatedRegistrationMutation.isPending || publicRegistrationMutation.isPending}\n                  data-testid=\"button-register\"\n                >\n                  {(authenticatedRegistrationMutation.isPending || publicRegistrationMutation.isPending) ? \"Registering...\" : \"Register as Customer\"}\n                </Button>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n\n        {/* Info Card */}\n        <Card className=\"bg-blue-50 dark:bg-blue-950\">\n          <CardContent className=\"py-6\">\n            <h3 className=\"font-semibold mb-2\">Why Register?</h3>\n            <ul className=\"text-sm text-gray-600 dark:text-gray-400 space-y-1\">\n              <li>• Direct connection with local poultry farms</li>\n              <li>• Access to fresh, quality products</li>\n              <li>• Support local agriculture</li>\n              <li>• Flexible pickup and delivery options</li>\n              <li>• Build relationships with trusted farmers</li>\n            </ul>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","size_bytes":22116},"client/src/pages/public-marketplace.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { MapPin, Phone, Mail, Globe, Search, ShoppingCart, Users } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\ninterface Farm {\n  id: string;\n  name: string;\n  description: string;\n  location: string;\n  address: string;\n  contactEmail: string;\n  contactPhone: string;\n  website?: string;\n  totalBirds: number;\n  avgEggsPerDay: number;\n  specialization: string;\n}\n\ninterface Product {\n  id: string;\n  farmId: string;\n  name: string;\n  category: string;\n  description: string;\n  unit: string;\n  currentPrice: string;\n  minOrderQuantity: number;\n  stockQuantity: number;\n}\n\nexport default function PublicMarketplace() {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState(\"all\");\n\n  const { data: farms = [], isLoading: farmsLoading } = useQuery<Farm[]>({\n    queryKey: ['/api/public/farms'],\n  });\n\n  const { data: products = [], isLoading: productsLoading } = useQuery<Product[]>({\n    queryKey: ['/api/public/products'],\n  });\n\n  // Filter farms based on search term\n  const filteredFarms = farms.filter(farm =>\n    farm.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    farm.location.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    farm.specialization.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  // Filter products based on category\n  const filteredProducts = products.filter(product =>\n    selectedCategory === \"all\" || product.category === selectedCategory\n  );\n\n  // Get unique categories\n  const categories = [\"all\", ...Array.from(new Set(products.map(p => p.category)))];\n\n  if (farmsLoading || productsLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"space-y-8\">\n          <div className=\"text-center space-y-2\">\n            <Skeleton className=\"h-12 w-80 mx-auto\" />\n            <Skeleton className=\"h-6 w-96 mx-auto\" />\n          </div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {[...Array(6)].map((_, i) => (\n              <Card key={i}>\n                <CardHeader>\n                  <Skeleton className=\"h-6 w-48\" />\n                  <Skeleton className=\"h-4 w-32\" />\n                </CardHeader>\n                <CardContent>\n                  <Skeleton className=\"h-32 w-full\" />\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 space-y-8\">\n      {/* Header */}\n      <div className=\"text-center space-y-4\">\n        <h1 className=\"text-4xl font-bold text-gray-900 dark:text-white\">\n          Poultry Marketplace\n        </h1>\n        <p className=\"text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto\">\n          Discover fresh, quality poultry products from verified farms in your area. \n          Connect directly with local farmers for the best prices and freshest products.\n        </p>\n        <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center max-w-lg mx-auto\">\n          <Link to=\"/customer-registration\">\n            <Button size=\"lg\" className=\"w-full sm:w-auto\" data-testid=\"button-register\">\n              <Users className=\"mr-2 h-4 w-4\" />\n              Join as Customer\n            </Button>\n          </Link>\n          <Link to=\"/farm-registration\">\n            <Button variant=\"outline\" size=\"lg\" className=\"w-full sm:w-auto\" data-testid=\"button-farm-register\">\n              Register Your Farm\n            </Button>\n          </Link>\n        </div>\n      </div>\n\n      {/* Search and Filter */}\n      <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center\">\n        <div className=\"relative max-w-md\">\n          <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n          <Input\n            placeholder=\"Search farms, locations...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search\"\n          />\n        </div>\n        <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n          <SelectTrigger className=\"w-48\" data-testid=\"select-category\">\n            <SelectValue placeholder=\"Filter by category\" />\n          </SelectTrigger>\n          <SelectContent>\n            {categories.map((category) => (\n              <SelectItem key={category} value={category}>\n                {category === \"all\" ? \"All Categories\" : category.charAt(0).toUpperCase() + category.slice(1)}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Featured Farms */}\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-2xl font-semibold text-gray-900 dark:text-white\">\n            Featured Farms\n          </h2>\n          <Badge variant=\"secondary\" data-testid=\"text-farm-count\">\n            {filteredFarms.length} farms available\n          </Badge>\n        </div>\n\n        {filteredFarms.length === 0 ? (\n          <Card>\n            <CardContent className=\"text-center py-12\">\n              <p className=\"text-gray-500 dark:text-gray-400\">\n                No farms found matching your search criteria.\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {filteredFarms.map((farm) => (\n              <Card key={farm.id} className=\"hover:shadow-lg transition-shadow\" data-testid={`card-farm-${farm.id}`}>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center justify-between\">\n                    <span data-testid={`text-farm-name-${farm.id}`}>{farm.name}</span>\n                    <Badge variant=\"outline\">{farm.specialization}</Badge>\n                  </CardTitle>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-400\">\n                    <MapPin className=\"mr-1 h-3 w-3\" />\n                    <span data-testid={`text-farm-location-${farm.id}`}>{farm.location}</span>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400 line-clamp-3\">\n                    {farm.description || \"Premium quality poultry products from local farm.\"}\n                  </p>\n                  \n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div className=\"flex items-center\">\n                      <Users className=\"mr-2 h-4 w-4 text-gray-400\" />\n                      <span>{farm.totalBirds.toLocaleString()} birds</span>\n                    </div>\n                    <div className=\"flex items-center\">\n                      <ShoppingCart className=\"mr-2 h-4 w-4 text-gray-400\" />\n                      <span>{farm.avgEggsPerDay.toLocaleString()} eggs/day</span>\n                    </div>\n                  </div>\n\n                  <div className=\"flex flex-wrap gap-2 text-xs\">\n                    {farm.contactPhone && (\n                      <div className=\"flex items-center\">\n                        <Phone className=\"mr-1 h-3 w-3 text-gray-400\" />\n                        <span>{farm.contactPhone}</span>\n                      </div>\n                    )}\n                    {farm.contactEmail && (\n                      <div className=\"flex items-center\">\n                        <Mail className=\"mr-1 h-3 w-3 text-gray-400\" />\n                        <span className=\"truncate\">{farm.contactEmail}</span>\n                      </div>\n                    )}\n                    {farm.website && (\n                      <div className=\"flex items-center\">\n                        <Globe className=\"mr-1 h-3 w-3 text-gray-400\" />\n                        <a href={farm.website} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 hover:underline\">\n                          Website\n                        </a>\n                      </div>\n                    )}\n                  </div>\n\n                  <Link to={`/farm/${farm.id}`}>\n                    <Button className=\"w-full\" data-testid={`button-view-farm-${farm.id}`}>\n                      View Farm & Products\n                    </Button>\n                  </Link>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* Featured Products */}\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-2xl font-semibold text-gray-900 dark:text-white\">\n            Featured Products\n          </h2>\n          <Badge variant=\"secondary\" data-testid=\"text-product-count\">\n            {filteredProducts.length} products available\n          </Badge>\n        </div>\n\n        {filteredProducts.length === 0 ? (\n          <Card>\n            <CardContent className=\"text-center py-12\">\n              <p className=\"text-gray-500 dark:text-gray-400\">\n                No products found in the selected category.\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n            {filteredProducts.slice(0, 8).map((product) => {\n              const farm = farms.find(f => f.id === product.farmId);\n              return (\n                <Card key={product.id} className=\"hover:shadow-md transition-shadow\" data-testid={`card-product-${product.id}`}>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-base\" data-testid={`text-product-name-${product.id}`}>\n                      {product.name}\n                    </CardTitle>\n                    <div className=\"flex items-center justify-between\">\n                      <Badge variant=\"secondary\">{product.category}</Badge>\n                      <span className=\"text-lg font-semibold text-green-600\" data-testid={`text-product-price-${product.id}`}>\n                        ${product.currentPrice}/{product.unit}\n                      </span>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {farm && (\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400 mb-2\">\n                        by {farm.name}\n                      </p>\n                    )}\n                    <p className=\"text-xs text-gray-500 mb-3\">\n                      Min order: {product.minOrderQuantity} {product.unit}\n                    </p>\n                    <p className=\"text-xs text-gray-500 mb-3\">\n                      In stock: {product.stockQuantity} {product.unit}\n                    </p>\n                    {product.description && (\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-3\">\n                        {product.description}\n                      </p>\n                    )}\n                    {farm && (\n                      <Link to={`/farm/${farm.id}`}>\n                        <Button size=\"sm\" className=\"w-full\" data-testid={`button-view-product-farm-${product.id}`}>\n                          View Farm\n                        </Button>\n                      </Link>\n                    )}\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        )}\n      </div>\n\n      {/* Call to Action */}\n      <Card className=\"bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-950 dark:to-green-950\">\n        <CardContent className=\"text-center py-8\">\n          <h3 className=\"text-xl font-semibold mb-2\">Ready to Start Shopping?</h3>\n          <p className=\"text-gray-600 dark:text-gray-400 mb-4\">\n            Register as a customer to place orders and connect with local farmers.\n          </p>\n          <Link to=\"/customer-registration\">\n            <Button size=\"lg\" data-testid=\"button-cta-register\">\n              Get Started Today\n            </Button>\n          </Link>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":12613},"client/src/hooks/useFarmAlerts.ts":{"content":"import { useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\n\nexport interface Alert {\n  id: string;\n  type: \"warning\" | \"danger\" | \"info\";\n  icon: \"triangle\" | \"skull\" | \"syringe\" | \"trending-down\";\n  title: string;\n  description: string;\n  priority: \"High\" | \"Medium\" | \"Low\";\n}\n\nexport function useFarmAlerts() {\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  // Fetch required data for alert calculations\n  const { data: metrics = {} } = useQuery<any>({\n    queryKey: [\"/api/dashboard/metrics\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/dashboard/metrics?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch metrics');\n      return response.json();\n    },\n    enabled: hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: feedInventory = [] } = useQuery<any[]>({\n    queryKey: [\"/api/feed-inventory\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/feed-inventory?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch feed inventory');\n      return response.json();\n    },\n    enabled: hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: dailyRecords = [] } = useQuery<any[]>({\n    queryKey: [\"/api/daily-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/daily-records?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch daily records');\n      return response.json();\n    },\n    enabled: hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: healthRecords = [] } = useQuery<any[]>({\n    queryKey: [\"/api/health-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/health-records?farmId=${activeFarmId}&limit=100`);\n      if (!response.ok) throw new Error('Failed to fetch health records');\n      return response.json();\n    },\n    enabled: hasActiveFarm && !!activeFarmId,\n  });\n\n  // Calculate dynamic alerts based on real farm data\n  const alerts = useMemo((): Alert[] => {\n    if (!hasActiveFarm) return [];\n\n    const calculatedAlerts: Alert[] = [];\n    const today = new Date();\n    const yesterday = new Date(today);\n    yesterday.setDate(yesterday.getDate() - 1);\n\n    // 1. Feed Stock Alert - Dynamic calculation based on actual data\n    const feedDaysRemaining = metrics?.feedDaysRemaining ?? 0;\n    const totalFeedStock = metrics?.totalFeedStock ?? 0;\n    \n    if (totalFeedStock > 0) {\n      if (feedDaysRemaining < 3) {\n        calculatedAlerts.push({\n          id: \"feed-stock-critical\",\n          type: \"danger\",\n          icon: \"triangle\",\n          title: \"Feed Stock Critical\",\n          description: `Only ${feedDaysRemaining} ${feedDaysRemaining === 1 ? 'day' : 'days'} of feed remaining! Order immediately to avoid running out.`,\n          priority: \"High\",\n        });\n      } else if (feedDaysRemaining < 7) {\n        calculatedAlerts.push({\n          id: \"feed-stock-low\",\n          type: \"warning\",\n          icon: \"triangle\",\n          title: \"Feed Stock Running Low\",\n          description: `Approximately ${feedDaysRemaining} ${feedDaysRemaining === 1 ? 'day' : 'days'} of feed remaining. Consider ordering soon.`,\n          priority: \"Medium\",\n        });\n      }\n    }\n\n    // 2. Mortality Rate Alert - Dynamic calculation from daily records (per-day aggregation)\n    if (dailyRecords.length > 0) {\n      // Get yesterday's mortality (aggregate all records for that day)\n      const yesterday = new Date(today);\n      yesterday.setDate(yesterday.getDate() - 1);\n      const yesterdayStr = yesterday.toISOString().split('T')[0];\n      \n      const yesterdayRecords = dailyRecords.filter(r => r.recordDate === yesterdayStr);\n      const yesterdayMortality = yesterdayRecords.reduce((sum, r) => sum + (r.mortalityCount || 0), 0);\n      \n      // Calculate 14-day average mortality per day (excluding yesterday)\n      const fourteenDaysAgo = new Date(today);\n      fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);\n      \n      const recentRecords = dailyRecords.filter(r => {\n        const recordDate = new Date(r.recordDate);\n        return recordDate >= fourteenDaysAgo && r.recordDate !== yesterdayStr;\n      });\n      \n      // Group by date and sum mortality per day\n      const mortalityByDate = recentRecords.reduce((acc, r) => {\n        const date = r.recordDate;\n        acc[date] = (acc[date] || 0) + (r.mortalityCount || 0);\n        return acc;\n      }, {} as Record<string, number>);\n      \n      const dailyMortalityValues = Object.values(mortalityByDate);\n      const avgMortality = dailyMortalityValues.length > 0\n        ? dailyMortalityValues.reduce((sum, val) => sum + val, 0) / dailyMortalityValues.length\n        : 0;\n      \n      // Threshold: 1% of total birds or 2x daily average (whichever is higher)\n      const totalBirds = metrics?.totalBirds ?? 0;\n      const threshold = Math.max(totalBirds * 0.01, avgMortality * 2);\n      \n      if (yesterdayMortality > threshold && yesterdayMortality > 0) {\n        calculatedAlerts.push({\n          id: \"mortality-high\",\n          type: \"danger\",\n          icon: \"skull\",\n          title: \"Mortality Rate Above Normal\",\n          description: `${yesterdayMortality} ${yesterdayMortality === 1 ? 'bird' : 'birds'} lost yesterday vs average of ${avgMortality.toFixed(1)} per day. Check for signs of disease.`,\n          priority: \"High\",\n        });\n      }\n    }\n\n    // 3. Vaccination Alert - Dynamic from health records\n    if (healthRecords.length > 0) {\n      const todayStr = today.toISOString().split('T')[0];\n      const threeDaysFromNow = new Date(today);\n      threeDaysFromNow.setDate(threeDaysFromNow.getDate() + 3);\n      \n      // Find upcoming vaccinations (nextDueDate within 7 days)\n      const upcomingVaccinations = healthRecords.filter(record => {\n        if (record.recordType !== 'vaccination' || !record.nextDueDate) return false;\n        const dueDate = new Date(record.nextDueDate);\n        const daysUntilDue = Math.floor((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n        return daysUntilDue >= 0 && daysUntilDue <= 7;\n      }).sort((a, b) => {\n        return new Date(a.nextDueDate!).getTime() - new Date(b.nextDueDate!).getTime();\n      });\n      \n      if (upcomingVaccinations.length > 0) {\n        const nextVaccination = upcomingVaccinations[0];\n        const dueDate = new Date(nextVaccination.nextDueDate!);\n        const daysUntilDue = Math.floor((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n        \n        calculatedAlerts.push({\n          id: \"vaccination-due\",\n          type: daysUntilDue <= 3 ? \"warning\" : \"info\",\n          icon: \"syringe\",\n          title: daysUntilDue === 0 ? \"Vaccination Due Today\" : \"Vaccination Due Soon\",\n          description: `${nextVaccination.title || 'Vaccination'} due in ${daysUntilDue} ${daysUntilDue === 1 ? 'day' : 'days'}.`,\n          priority: daysUntilDue <= 3 ? \"Medium\" : \"Low\",\n        });\n      }\n    }\n\n    // 4. Production Efficiency Alert - Dynamic from daily records (per-day aggregation)\n    if (dailyRecords.length > 1) {\n      // Get today's and yesterday's production (aggregate by day)\n      const todayStr = today.toISOString().split('T')[0];\n      const yesterday = new Date(today);\n      yesterday.setDate(yesterday.getDate() - 1);\n      const yesterdayStr = yesterday.toISOString().split('T')[0];\n      \n      const recentRecords = dailyRecords.filter(r => \n        r.recordDate === todayStr || r.recordDate === yesterdayStr\n      );\n      \n      const recentEggs = recentRecords.reduce((sum, r) => sum + (r.eggsCollected || 0), 0);\n      \n      // Calculate 14-day average production per day\n      const fourteenDaysAgo = new Date(today);\n      fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);\n      const twoDaysAgo = new Date(today);\n      twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);\n      \n      const historicalRecords = dailyRecords.filter(r => {\n        const recordDate = new Date(r.recordDate);\n        return recordDate >= fourteenDaysAgo && recordDate < twoDaysAgo;\n      });\n      \n      // Group by date and sum eggs per day\n      const eggsByDate = historicalRecords.reduce((acc, r) => {\n        const date = r.recordDate;\n        acc[date] = (acc[date] || 0) + (r.eggsCollected || 0);\n        return acc;\n      }, {} as Record<string, number>);\n      \n      const dailyEggValues = Object.values(eggsByDate);\n      const avgDailyProduction = dailyEggValues.length > 0\n        ? dailyEggValues.reduce((sum, val) => sum + val, 0) / dailyEggValues.length\n        : 0;\n      \n      // Compare 2-day total to 2x daily average (15% drop threshold)\n      const expectedTwoDayProduction = avgDailyProduction * 2;\n      \n      if (expectedTwoDayProduction > 0 && recentEggs < expectedTwoDayProduction * 0.85) {\n        const dropPercentage = ((expectedTwoDayProduction - recentEggs) / expectedTwoDayProduction * 100).toFixed(1);\n        calculatedAlerts.push({\n          id: \"production-drop\",\n          type: \"danger\",\n          icon: \"trending-down\",\n          title: \"Production Efficiency Drop\",\n          description: `Egg production dropped ${dropPercentage}% (${recentEggs.toFixed(0)} vs ${expectedTwoDayProduction.toFixed(0)} expected). Investigate immediately.`,\n          priority: \"High\",\n        });\n      }\n    }\n\n    return calculatedAlerts;\n  }, [feedInventory, dailyRecords, healthRecords, metrics, hasActiveFarm, activeFarmId]);\n\n  return {\n    alerts,\n    isLoading: false, // Derived from existing queries\n    error: null,\n  };\n}","size_bytes":9656},"client/src/components/layout/customer-sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Sprout, ShoppingCart, Package, User, Store, MapPin, LogOut, Settings } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface CustomerSidebarProps {\n  isOpen: boolean;\n  onToggle: () => void;\n}\n\nexport default function CustomerSidebar({ isOpen }: CustomerSidebarProps) {\n  const [location] = useLocation();\n  const { user } = useAuth();\n\n  const handleLogout = () => {\n    window.location.href = \"/api/logout\";\n  };\n\n  const navigationItems = [\n    { path: \"/\", icon: ShoppingCart, label: \"Dashboard\", id: \"dashboard\" },\n    { path: \"/marketplace\", icon: Store, label: \"Browse Products\", id: \"marketplace\" },\n  ];\n\n  const accountItems = [\n    { path: \"/customer-registration\", icon: User, label: \"My Profile\", id: \"profile\" },\n    { path: \"/settings\", icon: Settings, label: \"Settings\", id: \"settings\" },\n  ];\n\n  return (\n    <aside \n      className={cn(\n        \"fixed inset-y-0 left-0 z-50 w-64 bg-card border-r border-border transition-transform duration-300 ease-in-out md:relative md:translate-x-0\",\n        isOpen ? \"translate-x-0\" : \"-translate-x-full\"\n      )}\n      data-testid=\"customer-sidebar\"\n    >\n      <div className=\"flex flex-col h-full\">\n        {/* Logo & Customer Info */}\n        <div className=\"p-6 border-b border-border\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"w-10 h-10 bg-primary rounded-lg flex items-center justify-center\">\n              <Sprout className=\"text-primary-foreground text-lg\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-foreground\">\n                KukuHub\n              </h2>\n              <p className=\"text-sm text-muted-foreground\">Customer Portal</p>\n            </div>\n          </div>\n          \n          {user && (\n            <div className=\"mt-4 p-3 bg-muted rounded-lg\">\n              <p className=\"text-sm font-medium text-foreground truncate\">\n                {user.firstName ? `${user.firstName} ${user.lastName || ''}`.trim() : user.email}\n              </p>\n              <p className=\"text-xs text-muted-foreground\">Customer</p>\n            </div>\n          )}\n        </div>\n\n        {/* Navigation */}\n        <nav className=\"flex-1 p-4 space-y-6\">\n          {/* Main Navigation */}\n          <div>\n            <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3\">\n              Navigation\n            </h3>\n            <div className=\"space-y-1\">\n              {navigationItems.map((item) => {\n                const Icon = item.icon;\n                const isActive = location === item.path;\n                \n                return (\n                  <Link key={item.id} to={item.path}>\n                    <Button\n                      variant={isActive ? \"secondary\" : \"ghost\"}\n                      className={cn(\n                        \"w-full justify-start gap-3 h-11\",\n                        isActive && \"bg-secondary text-secondary-foreground\"\n                      )}\n                      data-testid={`nav-${item.id}`}\n                    >\n                      <Icon size={18} />\n                      {item.label}\n                    </Button>\n                  </Link>\n                );\n              })}\n            </div>\n          </div>\n\n          {/* Account Management */}\n          <div>\n            <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3\">\n              Account\n            </h3>\n            <div className=\"space-y-1\">\n              {accountItems.map((item) => {\n                const Icon = item.icon;\n                const isActive = location === item.path;\n                \n                return (\n                  <Link key={item.id} to={item.path}>\n                    <Button\n                      variant={isActive ? \"secondary\" : \"ghost\"}\n                      className={cn(\n                        \"w-full justify-start gap-3 h-11\",\n                        isActive && \"bg-secondary text-secondary-foreground\"\n                      )}\n                      data-testid={`nav-${item.id}`}\n                    >\n                      <Icon size={18} />\n                      {item.label}\n                    </Button>\n                  </Link>\n                );\n              })}\n            </div>\n          </div>\n\n          {/* Quick Actions */}\n          <div>\n            <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3\">\n              Quick Links\n            </h3>\n            <div className=\"space-y-1\">\n              <Link to=\"/marketplace\">\n                <Button\n                  variant=\"ghost\"\n                  className=\"w-full justify-start gap-3 h-11\"\n                  data-testid=\"nav-explore-farms\"\n                >\n                  <MapPin size={18} />\n                  Find Local Farms\n                </Button>\n              </Link>\n            </div>\n          </div>\n        </nav>\n\n        {/* Logout */}\n        <div className=\"p-4 border-t border-border\">\n          <Button\n            variant=\"ghost\"\n            className=\"w-full justify-start gap-3 text-muted-foreground hover:text-foreground\"\n            onClick={handleLogout}\n            data-testid=\"button-logout\"\n          >\n            <LogOut size={18} />\n            Sign Out\n          </Button>\n        </div>\n      </div>\n    </aside>\n  );\n}","size_bytes":5520},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"server/storage.ts":{"content":"import {\n  users,\n  farms,\n  flocks,\n  dailyRecords,\n  sales,\n  feedInventory,\n  healthRecords,\n  expenses,\n  breakEvenAssumptions,\n  notifications,\n  customers,\n  products,\n  orders,\n  orderItems,\n  deliveries,\n  weightRecords,\n  breedStandards,\n  type User,\n  type UpsertUser,\n  type InsertFarm,\n  type Farm,\n  type InsertFlock,\n  type Flock,\n  type InsertDailyRecord,\n  type DailyRecord,\n  type InsertSale,\n  type Sale,\n  type InsertFeedInventory,\n  type FeedInventory,\n  type InsertHealthRecord,\n  type HealthRecord,\n  type InsertExpense,\n  type Expense,\n  type InsertBreakEvenAssumptions,\n  type BreakEvenAssumptions,\n  type InsertCustomer,\n  type Customer,\n  type InsertProduct,\n  type Product,\n  type InsertOrder,\n  type Order,\n  type InsertOrderItem,\n  type OrderItem,\n  type InsertDelivery,\n  type Delivery,\n  type InsertNotification,\n  type Notification,\n  type InsertWeightRecord,\n  type WeightRecord,\n  type InsertBreedStandard,\n  type BreedStandard,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, and, or, gte, lte, sql, ne, isNotNull, isNull } from \"drizzle-orm\";\n\n// Interface for storage operations\nexport interface IStorage {\n  // Farm operations\n  createFarm(farm: InsertFarm): Promise<Farm>;\n  createFarmWithOwner(farm: InsertFarm, userId: string): Promise<{ farm: Farm; user: User }>;\n  getFarms(): Promise<Farm[]>;\n  getFarmsByUserAccess(userId: string, userRole: string): Promise<Farm[]>;\n  getFarmById(id: string): Promise<Farm | undefined>;\n  updateFarm(id: string, updates: Partial<InsertFarm>): Promise<Farm>;\n  updateFarmOwnerFields(id: string, updates: Partial<InsertFarm>): Promise<Farm>;\n  getFarmsByUserId(userId: string): Promise<Farm[]>;\n  \n  // Public API methods (no authentication required)\n  getPublicFarms(): Promise<Farm[]>;\n  getPublicFarmById(id: string): Promise<Farm | undefined>;\n\n  // User operations (mandatory for Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  getUsers(): Promise<User[]>;\n  getUsersByFarm(farmId: string): Promise<User[]>;\n  upsertUser(user: UpsertUser): Promise<User>;\n\n  // Flock operations\n  createFlock(flock: InsertFlock): Promise<Flock>;\n  getFlocks(includeDeactivated?: boolean): Promise<Flock[]>;\n  getFlockById(id: string): Promise<Flock | undefined>;\n  updateFlock(id: string, updates: Partial<InsertFlock>): Promise<Flock>;\n\n  // Daily record operations\n  createDailyRecord(record: InsertDailyRecord): Promise<DailyRecord>;\n  createDailyRecordWithReview(record: InsertDailyRecord & { reviewStatus: string; isDuplicate: boolean; duplicateOfId?: string }): Promise<DailyRecord>;\n  createDailyRecordWithNotification(record: InsertDailyRecord & { reviewStatus: string; isDuplicate: boolean; duplicateOfId?: string }, farmId: string, notificationData: { type: string; title: string; message: string; meta?: any }): Promise<DailyRecord>;\n  findDailyRecordDuplicate(userId: string, flockId: string, recordDate: string): Promise<DailyRecord | null>;\n  getDailyRecords(flockId?: string, limit?: number): Promise<DailyRecord[]>;\n  getDailyRecordsByDateRange(startDate: string, endDate: string): Promise<DailyRecord[]>;\n  updateDailyRecord(id: string, updates: Partial<InsertDailyRecord>): Promise<DailyRecord>;\n\n  // Sales operations\n  createSale(sale: InsertSale): Promise<Sale>;\n  getSales(limit?: number): Promise<Sale[]>;\n  getSalesByDateRange(startDate: string, endDate: string): Promise<Sale[]>;\n\n  // Feed inventory operations\n  createFeedInventory(feed: InsertFeedInventory): Promise<FeedInventory>;\n  getFeedInventory(farmId: string): Promise<FeedInventory[]>;\n  updateFeedInventory(id: string, updates: Partial<InsertFeedInventory>): Promise<FeedInventory>;\n  deleteFeedInventory(id: string): Promise<void>;\n\n  // Health record operations\n  createHealthRecord(record: InsertHealthRecord): Promise<HealthRecord>;\n  getHealthRecords(flockId?: string, limit?: number): Promise<HealthRecord[]>;\n\n  // Expense operations\n  createExpense(expense: InsertExpense): Promise<Expense>;\n  getExpenses(limit?: number): Promise<Expense[]>;\n  getExpensesByDateRange(startDate: string, endDate: string): Promise<Expense[]>;\n\n  // Break-Even Analysis Assumptions operations\n  createBreakEvenAssumptions(assumptions: InsertBreakEvenAssumptions): Promise<BreakEvenAssumptions>;\n  getBreakEvenAssumptionsByFarm(farmId: string, productId?: string | null): Promise<BreakEvenAssumptions | undefined>;\n  updateBreakEvenAssumptions(farmId: string, productId: string | null, updates: Partial<InsertBreakEvenAssumptions>): Promise<BreakEvenAssumptions>;\n  deleteBreakEvenAssumptions(farmId: string, productId?: string | null): Promise<void>;\n\n  // Notification operations\n  createNotification(notification: InsertNotification): Promise<Notification>;\n  createNotificationForManagers(farmId: string, notificationData: { type: string; title: string; message: string; meta?: any }): Promise<void>;\n  getNotificationsByUser(userId: string, limit?: number): Promise<Notification[]>;\n  markNotificationAsRead(notificationId: string): Promise<void>;\n\n  // Dashboard analytics\n  getDashboardMetrics(farmId: string): Promise<any>;\n  getRecentActivity(farmId: string, limit?: number): Promise<any[]>;\n\n  // Marketplace operations - Customers\n  createCustomer(customer: InsertCustomer): Promise<Customer>;\n  getCustomers(): Promise<Customer[]>;\n  getCustomerById(id: string): Promise<Customer | undefined>;\n  getCustomerByUserId(userId: string): Promise<Customer | undefined>;\n  updateCustomer(id: string, updates: Partial<InsertCustomer>): Promise<Customer>;\n  linkCustomerByEmail(email: string, userId: string): Promise<void>;\n  upsertCustomerForUser(userId: string, customerData: Omit<InsertCustomer, 'userId'>): Promise<Customer>;\n\n  // Marketplace operations - Products\n  createProduct(product: InsertProduct): Promise<Product>;\n  getProducts(): Promise<Product[]>;\n  getProductById(id: string): Promise<Product | undefined>;\n  updateProduct(id: string, updates: Partial<InsertProduct>): Promise<Product>;\n  \n  // Public product methods (no authentication required)\n  getPublicProducts(): Promise<Product[]>;\n  getPublicProductsByFarm(farmId: string): Promise<Product[]>;\n  \n  // Inventory validation and management\n  checkProductStock(productId: string, requiredQuantity: number): Promise<{ available: boolean; currentStock: number; productPrice: number; productName: string }>;\n  decrementProductStock(productId: string, quantity: number): Promise<Product>;\n  validateOrderItems(items: Array<{ productId: string; quantity: number }>): Promise<{ valid: boolean; errors: string[]; totalAmount: number; validatedItems: Array<{ productId: string; quantity: number; unitPrice: number; totalPrice: number; productName: string }> }>;\n\n  // Marketplace operations - Orders\n  createOrder(order: InsertOrder): Promise<Order>;\n  getOrders(limit?: number): Promise<Order[]>;\n  getOrderById(id: string): Promise<Order | undefined>;\n  updateOrder(id: string, updates: Partial<InsertOrder>): Promise<Order>;\n  getOrdersByCustomer(customerId: string): Promise<Order[]>;\n\n  // SECURE: Atomic order creation with server-side pricing and inventory validation\n  createOrderWithItems(orderData: {\n    farmId: string;\n    customerId: string;\n    userId: string;\n    requiredDate?: string;\n    deliveryMethod: string;\n    deliveryAddress?: string;\n    notes?: string;\n    items: Array<{ productId: string; quantity: number }>;\n  }): Promise<{\n    order: Order;\n    orderItems: OrderItem[];\n    totalAmount: number;\n  }>;\n\n  // Marketplace operations - Order Items\n  createOrderItem(orderItem: InsertOrderItem): Promise<OrderItem>;\n  getOrderItems(orderId: string): Promise<OrderItem[]>;\n\n  // Marketplace operations - Deliveries\n  createDelivery(delivery: InsertDelivery): Promise<Delivery>;\n  getDeliveries(): Promise<Delivery[]>;\n  getDeliveryByOrderId(orderId: string): Promise<Delivery | undefined>;\n  updateDelivery(id: string, updates: Partial<InsertDelivery>): Promise<Delivery>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Farm operations\n  async createFarm(farm: InsertFarm): Promise<Farm> {\n    const [newFarm] = await db.insert(farms).values(farm).returning();\n    return newFarm;\n  }\n\n  // SECURE: Atomic farm creation with user binding - prevents tenant orphaning\n  async createFarmWithOwner(farm: InsertFarm, userId: string): Promise<{ farm: Farm; user: User }> {\n    return await db.transaction(async (tx) => {\n      // Step 1: Create the farm\n      const [newFarm] = await tx.insert(farms).values(farm).returning();\n\n      // Step 2: Get current user to check if they're admin\n      const [currentUser] = await tx.select().from(users).where(eq(users.id, userId));\n      if (!currentUser) {\n        throw new Error('User not found');\n      }\n\n      // Step 3: Admin users remain global admins, others become farm owners\n      if (currentUser.role === 'admin') {\n        // Admin users create farms but remain global (no farmId binding)\n        // This satisfies the check constraint: admin role must have farmId = null\n        const [updatedUser] = await tx\n          .update(users)\n          .set({\n            updatedAt: new Date()\n          })\n          .where(eq(users.id, userId))\n          .returning();\n        \n        return { farm: newFarm, user: updatedUser };\n      } else {\n        // Regular users become farm owners and get bound to the farm\n        const [updatedUser] = await tx\n          .update(users)\n          .set({\n            farmId: newFarm.id,\n            role: 'farm_owner',\n            updatedAt: new Date()\n          })\n          .where(eq(users.id, userId))\n          .returning();\n\n        if (!updatedUser) {\n          throw new Error('Failed to bind user to farm - user not found');\n        }\n\n        return { farm: newFarm, user: updatedUser };\n      }\n    });\n  }\n\n  async getFarms(): Promise<Farm[]> {\n    return await db.select().from(farms).orderBy(desc(farms.createdAt));\n  }\n\n  // SECURE: Get farms based on user access permissions\n  async getFarmsByUserAccess(userId: string, userRole: string): Promise<Farm[]> {\n    if (userRole === 'admin') {\n      // Admins can see all farms\n      return await db.select().from(farms).orderBy(desc(farms.createdAt));\n    } else {\n      // Non-admins can only see their own farm\n      const user = await this.getUser(userId);\n      if (!user?.farmId) {\n        return [];\n      }\n      return await db\n        .select()\n        .from(farms)\n        .where(eq(farms.id, user.farmId))\n        .orderBy(desc(farms.createdAt));\n    }\n  }\n\n  async getFarmById(id: string): Promise<Farm | undefined> {\n    const [farm] = await db.select().from(farms).where(eq(farms.id, id));\n    return farm;\n  }\n\n  async updateFarm(id: string, updates: Partial<InsertFarm>): Promise<Farm> {\n    const [updatedFarm] = await db\n      .update(farms)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(farms.id, id))\n      .returning();\n    return updatedFarm;\n  }\n\n  // SECURE: Update farm with only owner-editable fields to prevent privilege escalation\n  async updateFarmOwnerFields(id: string, updates: Partial<InsertFarm>): Promise<Farm> {\n    // Only allow farm owners to update specific fields, excluding admin-only fields\n    const ownerUpdatableFields = {\n      name: updates.name,\n      description: updates.description,\n      location: updates.location,\n      address: updates.address,\n      contactEmail: updates.contactEmail,\n      contactPhone: updates.contactPhone,\n      website: updates.website,\n      totalBirds: updates.totalBirds,\n      avgEggsPerDay: updates.avgEggsPerDay,\n      specialization: updates.specialization,\n      businessRegistration: updates.businessRegistration,\n      certifications: updates.certifications\n    };\n\n    // Remove undefined fields\n    const cleanUpdates = Object.fromEntries(\n      Object.entries(ownerUpdatableFields).filter(([_, value]) => value !== undefined)\n    );\n\n    const [updatedFarm] = await db\n      .update(farms)\n      .set({ ...cleanUpdates, updatedAt: new Date() })\n      .where(eq(farms.id, id))\n      .returning();\n    return updatedFarm;\n  }\n\n  async getFarmsByUserId(userId: string): Promise<Farm[]> {\n    return await db\n      .select()\n      .from(farms)\n      .innerJoin(users, eq(users.farmId, farms.id))\n      .where(eq(users.id, userId))\n      .then(results => results.map(r => r.farms));\n  }\n\n  // Public API methods (no authentication required)\n  async getPublicFarms(): Promise<Farm[]> {\n    // Only return approved and active farms for public browsing\n    return await db\n      .select()\n      .from(farms)\n      .where(and(eq(farms.status, 'active'), eq(farms.isApproved, true)))\n      .orderBy(desc(farms.createdAt));\n  }\n\n  async getPublicFarmById(id: string): Promise<Farm | undefined> {\n    // Only return if farm is approved and active\n    const [farm] = await db\n      .select()\n      .from(farms)\n      .where(and(eq(farms.id, id), eq(farms.status, 'active'), eq(farms.isApproved, true)));\n    return farm;\n  }\n\n  // User operations (mandatory for Replit Auth)\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.email, email));\n    return user;\n  }\n\n  async getUsers(): Promise<User[]> {\n    return await db.select().from(users).orderBy(desc(users.createdAt));\n  }\n\n  async getUsersByFarm(farmId: string): Promise<User[]> {\n    return await db\n      .select()\n      .from(users)\n      .where(and(eq(users.farmId, farmId), ne(users.role, 'admin')))\n      .orderBy(desc(users.createdAt));\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  // Flock operations\n  async createFlock(flock: InsertFlock): Promise<Flock> {\n    const [newFlock] = await db.insert(flocks).values(flock).returning();\n    return newFlock;\n  }\n\n  async getFlocks(includeDeactivated: boolean = false): Promise<Flock[]> {\n    if (includeDeactivated) {\n      return await db.select().from(flocks).orderBy(desc(flocks.createdAt));\n    } else {\n      return await db.select()\n        .from(flocks)\n        .where(ne(flocks.status, 'deactivated'))\n        .orderBy(desc(flocks.createdAt));\n    }\n  }\n\n  async getFlockById(id: string): Promise<Flock | undefined> {\n    const [flock] = await db.select().from(flocks).where(eq(flocks.id, id));\n    return flock;\n  }\n\n  async updateFlock(id: string, updates: Partial<InsertFlock>): Promise<Flock> {\n    const [updatedFlock] = await db\n      .update(flocks)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(flocks.id, id))\n      .returning();\n    return updatedFlock;\n  }\n\n  // Daily record operations\n  async createDailyRecord(record: InsertDailyRecord): Promise<DailyRecord> {\n    const [newRecord] = await db.insert(dailyRecords).values(record).returning();\n    return newRecord;\n  }\n\n  async createDailyRecordWithReview(record: InsertDailyRecord & { reviewStatus: string; isDuplicate: boolean; duplicateOfId?: string }): Promise<DailyRecord> {\n    const [newRecord] = await db.insert(dailyRecords).values(record).returning();\n    return newRecord;\n  }\n\n  async createDailyRecordWithNotification(\n    record: InsertDailyRecord & { reviewStatus: string; isDuplicate: boolean; duplicateOfId?: string }, \n    farmId: string, \n    notificationData: { type: string; title: string; message: string; meta?: any }\n  ): Promise<DailyRecord> {\n    return await db.transaction(async (tx) => {\n      // Create the daily record\n      const [newRecord] = await tx.insert(dailyRecords).values(record).returning();\n\n      // Find all managers and farm_owners in this farm\n      const managers = await tx\n        .select()\n        .from(users)\n        .where(\n          and(\n            eq(users.farmId, farmId),\n            sql`${users.role} IN ('manager', 'farm_owner')`\n          )\n        );\n\n      // Create notifications for each manager\n      const notificationsToCreate = managers.map(manager => ({\n        recipientUserId: manager.id,\n        farmId,\n        type: notificationData.type,\n        title: notificationData.title,\n        message: notificationData.message,\n        meta: {\n          ...notificationData.meta,\n          recordId: newRecord.id // Add the record ID to meta\n        },\n        isRead: false\n      }));\n\n      if (notificationsToCreate.length > 0) {\n        await tx.insert(notifications).values(notificationsToCreate);\n      }\n\n      return newRecord;\n    });\n  }\n\n  async findDailyRecordDuplicate(userId: string, flockId: string, recordDate: string): Promise<DailyRecord | null> {\n    const [duplicate] = await db\n      .select()\n      .from(dailyRecords)\n      .where(\n        and(\n          eq(dailyRecords.userId, userId),\n          eq(dailyRecords.flockId, flockId),\n          eq(dailyRecords.recordDate, recordDate)\n        )\n      )\n      .orderBy(desc(dailyRecords.createdAt))\n      .limit(1);\n    return duplicate || null;\n  }\n\n  async getDailyRecords(flockId?: string, limit = 50): Promise<DailyRecord[]> {\n    if (flockId) {\n      return await db\n        .select()\n        .from(dailyRecords)\n        .where(eq(dailyRecords.flockId, flockId))\n        .orderBy(desc(dailyRecords.recordDate))\n        .limit(limit);\n    }\n    \n    return await db\n      .select()\n      .from(dailyRecords)\n      .orderBy(desc(dailyRecords.recordDate))\n      .limit(limit);\n  }\n\n  async getDailyRecordsByDateRange(startDate: string, endDate: string): Promise<DailyRecord[]> {\n    return await db\n      .select()\n      .from(dailyRecords)\n      .where(\n        and(\n          gte(dailyRecords.recordDate, startDate),\n          lte(dailyRecords.recordDate, endDate)\n        )\n      )\n      .orderBy(desc(dailyRecords.recordDate));\n  }\n\n  async updateDailyRecord(id: string, updates: Partial<InsertDailyRecord>): Promise<DailyRecord> {\n    const [updatedRecord] = await db\n      .update(dailyRecords)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(dailyRecords.id, id))\n      .returning();\n    return updatedRecord;\n  }\n\n  // Sales operations\n  async createSale(sale: InsertSale): Promise<Sale> {\n    const [newSale] = await db.insert(sales).values(sale).returning();\n    return newSale;\n  }\n\n  async getSales(limit = 50): Promise<Sale[]> {\n    return await db.select().from(sales).orderBy(desc(sales.saleDate)).limit(limit);\n  }\n\n  async getSalesByDateRange(startDate: string, endDate: string): Promise<Sale[]> {\n    return await db\n      .select()\n      .from(sales)\n      .where(\n        and(\n          gte(sales.saleDate, startDate),\n          lte(sales.saleDate, endDate)\n        )\n      )\n      .orderBy(desc(sales.saleDate));\n  }\n\n  async getSalesByFarm(farmId: string, limit = 50): Promise<Sale[]> {\n    return await db\n      .select()\n      .from(sales)\n      .where(eq(sales.farmId, farmId))\n      .orderBy(desc(sales.saleDate))\n      .limit(limit);\n  }\n\n  // Feed inventory operations\n  async createFeedInventory(feed: InsertFeedInventory): Promise<FeedInventory> {\n    const [newFeed] = await db.insert(feedInventory).values(feed).returning();\n    return newFeed;\n  }\n\n  async getFeedInventory(farmId: string): Promise<FeedInventory[]> {\n    return await db\n      .select()\n      .from(feedInventory)\n      .where(eq(feedInventory.farmId, farmId))\n      .orderBy(desc(feedInventory.createdAt));\n  }\n\n  async updateFeedInventory(id: string, updates: Partial<InsertFeedInventory>): Promise<FeedInventory> {\n    const [updatedFeed] = await db\n      .update(feedInventory)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(feedInventory.id, id))\n      .returning();\n    return updatedFeed;\n  }\n\n  async deleteFeedInventory(id: string): Promise<void> {\n    await db.delete(feedInventory).where(eq(feedInventory.id, id));\n  }\n\n  // Health record operations\n  async createHealthRecord(record: InsertHealthRecord): Promise<HealthRecord> {\n    const [newRecord] = await db.insert(healthRecords).values(record).returning();\n    return newRecord;\n  }\n\n  async getHealthRecords(flockId?: string, limit = 50): Promise<HealthRecord[]> {\n    if (flockId) {\n      return await db\n        .select()\n        .from(healthRecords)\n        .where(eq(healthRecords.flockId, flockId))\n        .orderBy(desc(healthRecords.recordDate))\n        .limit(limit);\n    }\n    \n    return await db\n      .select()\n      .from(healthRecords)\n      .orderBy(desc(healthRecords.recordDate))\n      .limit(limit);\n  }\n\n  // Expense operations\n  async createExpense(expense: InsertExpense): Promise<Expense> {\n    const [newExpense] = await db.insert(expenses).values(expense).returning();\n    return newExpense;\n  }\n\n  async getExpenses(limit = 50): Promise<Expense[]> {\n    return await db.select().from(expenses).orderBy(desc(expenses.expenseDate)).limit(limit);\n  }\n\n  async getExpensesByDateRange(startDate: string, endDate: string): Promise<Expense[]> {\n    return await db\n      .select()\n      .from(expenses)\n      .where(\n        and(\n          gte(expenses.expenseDate, startDate),\n          lte(expenses.expenseDate, endDate)\n        )\n      )\n      .orderBy(desc(expenses.expenseDate));\n  }\n\n  // Break-Even Analysis Assumptions operations\n  async createBreakEvenAssumptions(assumptions: InsertBreakEvenAssumptions): Promise<BreakEvenAssumptions> {\n    const [newAssumptions] = await db.insert(breakEvenAssumptions).values(assumptions).returning();\n    return newAssumptions;\n  }\n\n  async getBreakEvenAssumptionsByFarm(farmId: string, productId?: string | null): Promise<BreakEvenAssumptions | undefined> {\n    // When productId is undefined or null, we need to explicitly query for NULL productId\n    const conditions = productId !== undefined && productId !== null\n      ? and(eq(breakEvenAssumptions.farmId, farmId), eq(breakEvenAssumptions.productId, productId))\n      : and(eq(breakEvenAssumptions.farmId, farmId), isNull(breakEvenAssumptions.productId));\n    \n    const results = await db\n      .select()\n      .from(breakEvenAssumptions)\n      .where(conditions)\n      .limit(1);\n    \n    return results[0];\n  }\n\n  async updateBreakEvenAssumptions(farmId: string, productId: string | null, updates: Partial<InsertBreakEvenAssumptions>): Promise<BreakEvenAssumptions> {\n    const conditions = productId !== null\n      ? and(eq(breakEvenAssumptions.farmId, farmId), eq(breakEvenAssumptions.productId, productId))\n      : and(eq(breakEvenAssumptions.farmId, farmId), isNull(breakEvenAssumptions.productId));\n\n    const [updated] = await db\n      .update(breakEvenAssumptions)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(conditions)\n      .returning();\n    \n    if (!updated) {\n      throw new Error('Break-even assumptions not found');\n    }\n    \n    return updated;\n  }\n\n  async deleteBreakEvenAssumptions(farmId: string, productId?: string | null): Promise<void> {\n    const conditions = productId !== undefined && productId !== null\n      ? and(eq(breakEvenAssumptions.farmId, farmId), eq(breakEvenAssumptions.productId, productId))\n      : and(eq(breakEvenAssumptions.farmId, farmId), isNull(breakEvenAssumptions.productId));\n    \n    await db.delete(breakEvenAssumptions).where(conditions);\n  }\n\n  // Notification operations\n  async createNotification(notification: InsertNotification): Promise<Notification> {\n    const [newNotification] = await db.insert(notifications).values(notification).returning();\n    return newNotification;\n  }\n\n  async createNotificationForManagers(farmId: string, notificationData: { type: string; title: string; message: string; meta?: any }): Promise<void> {\n    // Find all managers and farm_owners in this farm\n    const managers = await db\n      .select()\n      .from(users)\n      .where(\n        and(\n          eq(users.farmId, farmId),\n          sql`${users.role} IN ('manager', 'farm_owner')`\n        )\n      );\n\n    // Create notification for each manager\n    const notificationsToCreate = managers.map(manager => ({\n      recipientUserId: manager.id,\n      farmId,\n      type: notificationData.type,\n      title: notificationData.title,\n      message: notificationData.message,\n      meta: notificationData.meta,\n      isRead: false\n    }));\n\n    if (notificationsToCreate.length > 0) {\n      await db.insert(notifications).values(notificationsToCreate);\n    }\n  }\n\n  async getNotificationsByUser(userId: string, limit = 20): Promise<Notification[]> {\n    return await db\n      .select()\n      .from(notifications)\n      .where(eq(notifications.recipientUserId, userId))\n      .orderBy(desc(notifications.createdAt))\n      .limit(limit);\n  }\n\n  async markNotificationAsRead(notificationId: string): Promise<void> {\n    await db\n      .update(notifications)\n      .set({ isRead: true, updatedAt: new Date() })\n      .where(eq(notifications.id, notificationId));\n  }\n\n  // Dashboard analytics\n  async getDashboardMetrics(farmId: string): Promise<any> {\n    // Get total birds from all active flocks for this farm (excluding deactivated)\n    const activeFlocks = await db\n      .select()\n      .from(flocks)\n      .where(\n        and(\n          eq(flocks.farmId, farmId),\n          ne(flocks.status, 'deactivated')\n        )\n      );\n    const totalBirds = activeFlocks.reduce((sum, flock) => sum + flock.currentCount, 0);\n\n    // Get the flockIds for this farm to filter daily records\n    const flockIds = activeFlocks.map(f => f.id);\n\n    // Get today's egg production (check today and yesterday to handle timezone issues)\n    const today = new Date().toISOString().split('T')[0];\n    const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];\n    const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];\n    \n    // Get records from the past 2 days for this farm's flocks\n    const recentRecords = flockIds.length > 0\n      ? await db\n          .select()\n          .from(dailyRecords)\n          .where(\n            and(\n              sql`${dailyRecords.flockId} IN (${sql.join(flockIds.map(id => sql`${id}`), sql`, `)})`,\n              or(\n                eq(dailyRecords.recordDate, yesterday),\n                eq(dailyRecords.recordDate, today),\n                eq(dailyRecords.recordDate, tomorrow)\n              )\n            )\n          )\n      : [];\n    \n    // Get the most recent date that has egg collection data\n    const recordsByDate = recentRecords.reduce((acc, record) => {\n      if (!acc[record.recordDate]) acc[record.recordDate] = [];\n      acc[record.recordDate].push(record);\n      return acc;\n    }, {} as Record<string, any[]>);\n    \n    // Find the most recent date with egg collection data\n    const sortedDates = Object.keys(recordsByDate).sort().reverse();\n    let todayEggs = 0;\n    let todayCrates = 0;\n    \n    for (const date of sortedDates) {\n      const dateRecords = recordsByDate[date];\n      const dateEggs = dateRecords.reduce((sum, record) => sum + (record.eggsCollected || 0), 0);\n      if (dateEggs > 0) {\n        todayEggs = dateEggs;\n        todayCrates = dateRecords.reduce((sum, record) => sum + (record.cratesProduced || 0), 0);\n        break;\n      }\n    }\n    \n    // If no eggs found in recent days, just use today's records (might be 0)\n    if (todayEggs === 0 && recordsByDate[today]) {\n      const todayRecords = recordsByDate[today];\n      todayEggs = todayRecords.reduce((sum, record) => sum + (record.eggsCollected || 0), 0);\n      todayCrates = todayRecords.reduce((sum, record) => sum + (record.cratesProduced || 0), 0);\n    }\n\n    // Get feed inventory total for this farm\n    const feedInventoryData = await db\n      .select()\n      .from(feedInventory)\n      .where(eq(feedInventory.farmId, farmId));\n    const totalFeedStock = feedInventoryData.reduce((sum, feed) => sum + parseFloat(feed.quantityKg || '0'), 0);\n\n    // Calculate feed days remaining based on recent consumption for this farm's flocks\n    // Get last 14 days of daily records to calculate average consumption\n    const fourteenDaysAgo = new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\n    const recentFeedRecords = flockIds.length > 0\n      ? await db\n          .select()\n          .from(dailyRecords)\n          .where(\n            and(\n              sql`${dailyRecords.flockId} IN (${sql.join(flockIds.map(id => sql`${id}`), sql`, `)})`,\n              gte(dailyRecords.recordDate, fourteenDaysAgo),\n              isNotNull(dailyRecords.feedConsumed)\n            )\n          )\n      : [];\n\n    // Calculate average daily feed consumption (industry standard: 0.11kg per bird)\n    let averageDailyConsumption = 0;\n    if (recentFeedRecords.length > 0) {\n      const totalConsumed = recentFeedRecords.reduce((sum, record) => \n        sum + parseFloat(record.feedConsumed || '0'), 0\n      );\n      averageDailyConsumption = totalConsumed / recentFeedRecords.length;\n    } else if (totalBirds > 0) {\n      // Fallback to industry standard if no recent records\n      averageDailyConsumption = totalBirds * 0.11; // 0.11kg per bird per day\n    }\n\n    // Calculate days remaining (defensive against division by zero)\n    const feedDaysRemaining = averageDailyConsumption > 0 \n      ? Math.floor(totalFeedStock / averageDailyConsumption)\n      : 0;\n\n    // Get current month revenue for this farm\n    const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];\n    const monthEnd = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString().split('T')[0];\n    const allMonthlySales = await db\n      .select()\n      .from(sales)\n      .where(\n        and(\n          eq(sales.farmId, farmId),\n          gte(sales.saleDate, monthStart),\n          lte(sales.saleDate, monthEnd)\n        )\n      );\n    const monthlyRevenue = allMonthlySales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount || '0'), 0);\n\n    // Get last month revenue for comparison for this farm\n    const lastMonthStart = new Date(new Date().getFullYear(), new Date().getMonth() - 1, 1).toISOString().split('T')[0];\n    const lastMonthEnd = new Date(new Date().getFullYear(), new Date().getMonth(), 0).toISOString().split('T')[0];\n    const allLastMonthSales = await db\n      .select()\n      .from(sales)\n      .where(\n        and(\n          eq(sales.farmId, farmId),\n          gte(sales.saleDate, lastMonthStart),\n          lte(sales.saleDate, lastMonthEnd)\n        )\n      );\n    const lastMonthRevenue = allLastMonthSales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount || '0'), 0);\n\n    // Calculate percentage change\n    const revenueChange = lastMonthRevenue > 0 \n      ? ((monthlyRevenue - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1)\n      : monthlyRevenue > 0 ? '+100' : '0';\n\n    return {\n      totalBirds,\n      todayEggs,\n      todayCrates,\n      totalFeedStock,\n      feedDaysRemaining,\n      averageDailyConsumption: Number(averageDailyConsumption.toFixed(2)),\n      monthlyRevenue,\n      revenueChange,\n      layingRate: totalBirds > 0 ? (todayEggs / totalBirds * 100).toFixed(1) : '0'\n    };\n  }\n\n  async getRecentActivity(farmId: string, limit = 10): Promise<any[]> {\n    // Get flockIds for this farm to filter daily records\n    const farmFlocks = await db\n      .select({ id: flocks.id })\n      .from(flocks)\n      .where(eq(flocks.farmId, farmId));\n    \n    const flockIds = farmFlocks.map(f => f.id);\n    \n    if (flockIds.length === 0) {\n      return [];\n    }\n\n    // Get recent records from daily records for this farm's flocks\n    const recentRecords = await db\n      .select({\n        id: dailyRecords.id,\n        type: sql`'daily_record'`.as('type'),\n        description: sql`CASE \n          WHEN ${dailyRecords.eggsCollected} IS NOT NULL THEN CONCAT('Recorded ', ${dailyRecords.eggsCollected}, ' eggs')\n          WHEN ${dailyRecords.mortalityCount} > 0 THEN CONCAT('Recorded ', ${dailyRecords.mortalityCount}, ' mortality')\n          WHEN ${dailyRecords.feedConsumed} IS NOT NULL THEN CONCAT('Updated feed consumption: ', ${dailyRecords.feedConsumed}, 'kg')\n          ELSE 'Daily record updated'\n        END`.as('description'),\n        createdAt: dailyRecords.createdAt,\n        userId: dailyRecords.userId\n      })\n      .from(dailyRecords)\n      .where(sql`${dailyRecords.flockId} IN (${sql.join(flockIds.map(id => sql`${id}`), sql`, `)})`)\n      .orderBy(desc(dailyRecords.createdAt))\n      .limit(limit);\n\n    return recentRecords;\n  }\n\n  // Marketplace operations - Customers\n  async createCustomer(customer: InsertCustomer): Promise<Customer> {\n    const [newCustomer] = await db.insert(customers).values(customer).returning();\n    return newCustomer;\n  }\n\n  async getCustomers(): Promise<Customer[]> {\n    return await db.select().from(customers).orderBy(desc(customers.createdAt));\n  }\n\n  async getCustomerById(id: string): Promise<Customer | undefined> {\n    const [customer] = await db.select().from(customers).where(eq(customers.id, id));\n    return customer;\n  }\n\n  async updateCustomer(id: string, updates: Partial<InsertCustomer>): Promise<Customer> {\n    const [updatedCustomer] = await db\n      .update(customers)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(customers.id, id))\n      .returning();\n    return updatedCustomer;\n  }\n\n  async getCustomerByUserId(userId: string): Promise<Customer | undefined> {\n    const [customer] = await db.select().from(customers).where(eq(customers.userId, userId));\n    return customer;\n  }\n\n  async linkCustomerByEmail(email: string, userId: string): Promise<void> {\n    // Only link if this user doesn't already have a customer record\n    const existingCustomer = await this.getCustomerByUserId(userId);\n    if (existingCustomer) {\n      return; // User already has a customer record, skip linking\n    }\n    \n    // Find customer with matching email that doesn't have a userId yet\n    await db\n      .update(customers)\n      .set({ userId, updatedAt: new Date() })\n      .where(and(eq(customers.email, email), sql`user_id IS NULL`));\n  }\n\n  async upsertCustomerForUser(userId: string, customerData: Omit<InsertCustomer, 'userId'>): Promise<Customer> {\n    // First try to update if customer exists for this user\n    const existingCustomer = await this.getCustomerByUserId(userId);\n    \n    if (existingCustomer) {\n      return await this.updateCustomer(existingCustomer.id, customerData);\n    }\n    \n    // Create new customer with userId\n    const [newCustomer] = await db\n      .insert(customers)\n      .values({ ...customerData, userId })\n      .returning();\n    return newCustomer;\n  }\n\n  // Marketplace operations - Products\n  async createProduct(product: InsertProduct): Promise<Product> {\n    const [newProduct] = await db.insert(products).values(product).returning();\n    return newProduct;\n  }\n\n  async getProducts(): Promise<Product[]> {\n    return await db.select().from(products).orderBy(desc(products.createdAt));\n  }\n\n  async getProductById(id: string): Promise<Product | undefined> {\n    const [product] = await db.select().from(products).where(eq(products.id, id));\n    return product;\n  }\n\n  async updateProduct(id: string, updates: Partial<InsertProduct>): Promise<Product> {\n    const [updatedProduct] = await db\n      .update(products)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(products.id, id))\n      .returning();\n    return updatedProduct;\n  }\n\n  // Public product methods (no authentication required)\n  async getPublicProducts(): Promise<Product[]> {\n    // Only return available products from approved and active farms\n    return await db\n      .select({\n        id: products.id,\n        farmId: products.farmId,\n        name: products.name,\n        category: products.category,\n        description: products.description,\n        unit: products.unit,\n        currentPrice: products.currentPrice,\n        minOrderQuantity: products.minOrderQuantity,\n        stockQuantity: products.stockQuantity,\n        isAvailable: products.isAvailable,\n        createdAt: products.createdAt,\n        updatedAt: products.updatedAt,\n      })\n      .from(products)\n      .innerJoin(farms, eq(products.farmId, farms.id))\n      .where(and(\n        eq(products.isAvailable, true),\n        eq(farms.status, 'active'),\n        eq(farms.isApproved, true)\n      ))\n      .orderBy(desc(products.createdAt));\n  }\n\n  async getPublicProductsByFarm(farmId: string): Promise<Product[]> {\n    // Only return available products if farm is approved and active\n    return await db\n      .select({\n        id: products.id,\n        farmId: products.farmId,\n        name: products.name,\n        category: products.category,\n        description: products.description,\n        unit: products.unit,\n        currentPrice: products.currentPrice,\n        minOrderQuantity: products.minOrderQuantity,\n        stockQuantity: products.stockQuantity,\n        isAvailable: products.isAvailable,\n        createdAt: products.createdAt,\n        updatedAt: products.updatedAt,\n      })\n      .from(products)\n      .innerJoin(farms, eq(products.farmId, farms.id))\n      .where(and(\n        eq(products.farmId, farmId),\n        eq(products.isAvailable, true),\n        eq(farms.status, 'active'),\n        eq(farms.isApproved, true)\n      ))\n      .orderBy(desc(products.createdAt));\n  }\n\n  // Inventory validation and management\n  async checkProductStock(productId: string, requiredQuantity: number): Promise<{ available: boolean; currentStock: number; productPrice: number; productName: string }> {\n    const [product] = await db.select().from(products).where(eq(products.id, productId));\n    \n    if (!product) {\n      throw new Error(`Product with id ${productId} not found`);\n    }\n    \n    if (!product.isAvailable) {\n      return {\n        available: false,\n        currentStock: product.stockQuantity || 0,\n        productPrice: parseFloat(product.currentPrice),\n        productName: product.name\n      };\n    }\n    \n    const currentStock = product.stockQuantity || 0;\n    const available = currentStock >= requiredQuantity;\n    \n    return {\n      available,\n      currentStock,\n      productPrice: parseFloat(product.currentPrice),\n      productName: product.name\n    };\n  }\n\n  async decrementProductStock(productId: string, quantity: number): Promise<Product> {\n    // First check if we have enough stock\n    const stockCheck = await this.checkProductStock(productId, quantity);\n    \n    if (!stockCheck.available) {\n      throw new Error(`Insufficient stock for product ${stockCheck.productName}. Required: ${quantity}, Available: ${stockCheck.currentStock}`);\n    }\n    \n    // Atomically decrement stock\n    const [updatedProduct] = await db\n      .update(products)\n      .set({ \n        stockQuantity: sql`${products.stockQuantity} - ${quantity}`,\n        updatedAt: new Date()\n      })\n      .where(and(\n        eq(products.id, productId),\n        sql`${products.stockQuantity} >= ${quantity}` // Double-check in the same transaction\n      ))\n      .returning();\n      \n    if (!updatedProduct) {\n      throw new Error(`Failed to decrement stock - insufficient quantity available`);\n    }\n    \n    return updatedProduct;\n  }\n\n  async validateOrderItems(items: Array<{ productId: string; quantity: number }>): Promise<{ \n    valid: boolean; \n    errors: string[]; \n    totalAmount: number; \n    validatedItems: Array<{ productId: string; quantity: number; unitPrice: number; totalPrice: number; productName: string }> \n  }> {\n    const errors: string[] = [];\n    const validatedItems: Array<{ productId: string; quantity: number; unitPrice: number; totalPrice: number; productName: string }> = [];\n    let totalAmount = 0;\n\n    // Validate each item\n    for (const item of items) {\n      try {\n        if (item.quantity <= 0) {\n          errors.push(`Invalid quantity ${item.quantity} for product ${item.productId}`);\n          continue;\n        }\n\n        const stockCheck = await this.checkProductStock(item.productId, item.quantity);\n        \n        if (!stockCheck.available) {\n          errors.push(`Insufficient stock for ${stockCheck.productName}. Required: ${item.quantity}, Available: ${stockCheck.currentStock}`);\n          continue;\n        }\n\n        const itemTotal = stockCheck.productPrice * item.quantity;\n        totalAmount += itemTotal;\n\n        validatedItems.push({\n          productId: item.productId,\n          quantity: item.quantity,\n          unitPrice: stockCheck.productPrice,\n          totalPrice: itemTotal,\n          productName: stockCheck.productName\n        });\n\n      } catch (error) {\n        errors.push(`Error validating product ${item.productId}: ${error instanceof Error ? error.message : 'Unknown error'}`);\n      }\n    }\n\n    return {\n      valid: errors.length === 0 && validatedItems.length > 0,\n      errors,\n      totalAmount,\n      validatedItems\n    };\n  }\n\n  // Marketplace operations - Orders\n  async createOrder(order: typeof orders.$inferInsert): Promise<Order> {\n    const [newOrder] = await db.insert(orders).values(order).returning();\n    return newOrder;\n  }\n\n  // SECURE: Atomic order creation with server-side pricing and inventory validation\n  async createOrderWithItems(orderData: {\n    farmId: string;\n    customerId: string;\n    userId: string;\n    requiredDate?: string;\n    deliveryMethod: string;\n    deliveryAddress?: string;\n    notes?: string;\n    items: Array<{ productId: string; quantity: number }>;\n  }): Promise<{\n    order: Order;\n    orderItems: OrderItem[];\n    totalAmount: number;\n  }> {\n    // Step 1: Validate all items and calculate pricing server-side\n    const validation = await this.validateOrderItems(orderData.items);\n    \n    if (!validation.valid) {\n      throw new Error(`Order validation failed: ${validation.errors.join(', ')}`);\n    }\n\n    if (validation.validatedItems.length === 0) {\n      throw new Error('No valid items in order');\n    }\n\n    // Step 2: Create order with server-calculated total amount\n    const orderNumber = `ORD-${Date.now()}-${Math.random().toString(36).substr(2, 5).toUpperCase()}`;\n    const totalAmountStr = validation.totalAmount.toFixed(2);\n    \n    console.log('Debug - orderData.farmId:', orderData.farmId);\n    console.log('Debug - full orderData:', orderData);\n    \n    const orderInsertData = {\n      orderNumber,\n      farmId: orderData.farmId,\n      customerId: orderData.customerId,\n      userId: orderData.userId,\n      requiredDate: orderData.requiredDate,\n      deliveryMethod: orderData.deliveryMethod,\n      deliveryAddress: orderData.deliveryAddress,\n      notes: orderData.notes,\n      status: 'pending' as const,\n      totalAmount: totalAmountStr,\n      paidAmount: '0.00',\n      paymentStatus: 'pending' as const\n    };\n    \n    console.log('Debug - orderInsertData:', orderInsertData);\n\n    const [newOrder] = await db.insert(orders).values(orderInsertData).returning();\n\n    // Step 3: Create order items with server-calculated pricing and decrement stock\n    const createdOrderItems: OrderItem[] = [];\n    \n    try {\n      for (const validatedItem of validation.validatedItems) {\n        // Create order item with server-calculated prices\n        const unitPriceStr = validatedItem.unitPrice.toFixed(2);\n        const totalPriceStr = validatedItem.totalPrice.toFixed(2);\n        const orderItemData = {\n          orderId: newOrder.id,\n          productId: validatedItem.productId,\n          quantity: validatedItem.quantity,\n          unitPrice: unitPriceStr,\n          totalPrice: totalPriceStr\n        };\n\n        const [orderItem] = await db.insert(orderItems).values(orderItemData).returning();\n        createdOrderItems.push(orderItem);\n\n        // Atomically decrement stock\n        await this.decrementProductStock(validatedItem.productId, validatedItem.quantity);\n      }\n\n      return {\n        order: newOrder,\n        orderItems: createdOrderItems,\n        totalAmount: validation.totalAmount\n      };\n\n    } catch (error) {\n      // If anything fails after order creation, we should ideally rollback the order\n      // For now, we'll let the error propagate and handle cleanup at a higher level\n      throw new Error(`Failed to complete order creation: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  async getOrders(limit = 50): Promise<Order[]> {\n    return await db.select().from(orders).orderBy(desc(orders.createdAt)).limit(limit);\n  }\n\n  async getOrderById(id: string): Promise<Order | undefined> {\n    const [order] = await db.select().from(orders).where(eq(orders.id, id));\n    return order;\n  }\n\n  async updateOrder(id: string, updates: Partial<InsertOrder>): Promise<Order> {\n    const [updatedOrder] = await db\n      .update(orders)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(orders.id, id))\n      .returning();\n    return updatedOrder;\n  }\n\n  async getOrdersByCustomer(customerId: string): Promise<Order[]> {\n    return await db\n      .select()\n      .from(orders)\n      .where(eq(orders.customerId, customerId))\n      .orderBy(desc(orders.createdAt));\n  }\n\n  // Marketplace operations - Order Items\n  async createOrderItem(orderItem: typeof orderItems.$inferInsert): Promise<OrderItem> {\n    const [newOrderItem] = await db.insert(orderItems).values(orderItem).returning();\n    return newOrderItem;\n  }\n\n  async getOrderItems(orderId: string): Promise<OrderItem[]> {\n    return await db\n      .select()\n      .from(orderItems)\n      .where(eq(orderItems.orderId, orderId));\n  }\n\n  // Marketplace operations - Deliveries\n  async createDelivery(delivery: InsertDelivery): Promise<Delivery> {\n    const [newDelivery] = await db.insert(deliveries).values(delivery).returning();\n    return newDelivery;\n  }\n\n  async getDeliveries(): Promise<Delivery[]> {\n    return await db.select().from(deliveries).orderBy(desc(deliveries.createdAt));\n  }\n\n  async getDeliveryByOrderId(orderId: string): Promise<Delivery | undefined> {\n    const [delivery] = await db.select().from(deliveries).where(eq(deliveries.orderId, orderId));\n    return delivery;\n  }\n\n  async updateDelivery(id: string, updates: Partial<InsertDelivery>): Promise<Delivery> {\n    const [updatedDelivery] = await db\n      .update(deliveries)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(deliveries.id, id))\n      .returning();\n    return updatedDelivery;\n  }\n\n  // Weight Records operations\n  async createWeightRecord(weightRecord: InsertWeightRecord): Promise<WeightRecord> {\n    const [newRecord] = await db.insert(weightRecords).values(weightRecord).returning();\n    return newRecord;\n  }\n\n  async getWeightRecords(limit = 50): Promise<WeightRecord[]> {\n    return await db\n      .select()\n      .from(weightRecords)\n      .orderBy(desc(weightRecords.recordDate))\n      .limit(limit);\n  }\n\n  async getWeightRecordsByFlock(flockId: string): Promise<WeightRecord[]> {\n    return await db\n      .select()\n      .from(weightRecords)\n      .where(eq(weightRecords.flockId, flockId))\n      .orderBy(desc(weightRecords.weekNumber));\n  }\n\n  async getWeightRecordsByFlockAndWeek(flockId: string, weekNumber: number): Promise<WeightRecord | undefined> {\n    const [record] = await db\n      .select()\n      .from(weightRecords)\n      .where(and(eq(weightRecords.flockId, flockId), eq(weightRecords.weekNumber, weekNumber)));\n    return record;\n  }\n\n  async updateWeightRecord(id: string, updates: Partial<InsertWeightRecord>): Promise<WeightRecord> {\n    const [updatedRecord] = await db\n      .update(weightRecords)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(weightRecords.id, id))\n      .returning();\n    return updatedRecord;\n  }\n\n  async deleteWeightRecord(id: string): Promise<void> {\n    await db.delete(weightRecords).where(eq(weightRecords.id, id));\n  }\n\n  // Helper method to calculate statistics from weights array\n  calculateWeightStatistics(weights: number[]): {\n    average: number;\n    stdDev: number;\n    uniformity: number;\n  } {\n    if (weights.length === 0) {\n      return { average: 0, stdDev: 0, uniformity: 0 };\n    }\n\n    // Calculate average\n    const average = weights.reduce((sum, weight) => sum + weight, 0) / weights.length;\n\n    // Calculate standard deviation\n    const variance = weights.reduce((sum, weight) => sum + Math.pow(weight - average, 2), 0) / weights.length;\n    const stdDev = Math.sqrt(variance);\n\n    // Calculate uniformity (percentage of birds within 10% of average weight)\n    const tolerance = average * 0.1; // 10% tolerance\n    const uniformCount = weights.filter(weight => \n      Math.abs(weight - average) <= tolerance\n    ).length;\n    const uniformity = (uniformCount / weights.length) * 100;\n\n    return {\n      average: Number(average.toFixed(2)),\n      stdDev: Number(stdDev.toFixed(2)),\n      uniformity: Number(uniformity.toFixed(2))\n    };\n  }\n\n  // Helper method to calculate current week number from hatch date\n  calculateWeekNumber(hatchDate: string): number {\n    const hatch = new Date(hatchDate);\n    const now = new Date();\n    const diffTime = Math.abs(now.getTime() - hatch.getTime());\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n    return Math.ceil(diffDays / 7);\n  }\n\n  // Breed Standards operations\n  async createBreedStandard(breedStandard: InsertBreedStandard): Promise<BreedStandard> {\n    const [newStandard] = await db.insert(breedStandards).values(breedStandard).returning();\n    return newStandard;\n  }\n\n  async getBreedStandards(): Promise<BreedStandard[]> {\n    return await db\n      .select()\n      .from(breedStandards)\n      .orderBy(breedStandards.breedName, breedStandards.weekNumber);\n  }\n\n  async getBreedStandardsByBreed(breedName: string): Promise<BreedStandard[]> {\n    return await db\n      .select()\n      .from(breedStandards)\n      .where(eq(breedStandards.breedName, breedName))\n      .orderBy(breedStandards.weekNumber);\n  }\n\n  async getBreedStandardByBreedAndWeek(breedName: string, weekNumber: number): Promise<BreedStandard | undefined> {\n    const [standard] = await db\n      .select()\n      .from(breedStandards)\n      .where(and(eq(breedStandards.breedName, breedName), eq(breedStandards.weekNumber, weekNumber)));\n    return standard;\n  }\n\n  async updateBreedStandard(id: string, updates: Partial<InsertBreedStandard>): Promise<BreedStandard> {\n    const [updatedStandard] = await db\n      .update(breedStandards)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(breedStandards.id, id))\n      .returning();\n    return updatedStandard;\n  }\n\n  async deleteBreedStandard(id: string): Promise<void> {\n    await db.delete(breedStandards).where(eq(breedStandards.id, id));\n  }\n\n  // Helper method to compare weight against breed standard\n  async compareWithBreedStandard(\n    breedName: string,\n    weekNumber: number,\n    averageWeight: number\n  ): Promise<{\n    comparisonResult: 'below_standard' | 'within_standard' | 'above_standard';\n    expectedWeight: number | null;\n    weightDeviation: number | null;\n  }> {\n    const standard = await this.getBreedStandardByBreedAndWeek(breedName, weekNumber);\n    \n    if (!standard) {\n      return {\n        comparisonResult: 'within_standard',\n        expectedWeight: null,\n        weightDeviation: null\n      };\n    }\n\n    const expectedWeight = Number(standard.standardWeight);\n    const toleranceLower = Number(standard.toleranceLower);\n    const toleranceUpper = Number(standard.toleranceUpper);\n    const weightDeviation = averageWeight - expectedWeight;\n\n    let comparisonResult: 'below_standard' | 'within_standard' | 'above_standard';\n\n    if (averageWeight < (expectedWeight - toleranceLower)) {\n      comparisonResult = 'below_standard';\n    } else if (averageWeight > (expectedWeight + toleranceUpper)) {\n      comparisonResult = 'above_standard';\n    } else {\n      comparisonResult = 'within_standard';\n    }\n\n    return {\n      comparisonResult,\n      expectedWeight,\n      weightDeviation: Number(weightDeviation.toFixed(2))\n    };\n  }\n\n  // Seed Hy-Line Brown breed standards (call this once to populate the database)\n  async seedHyLineBrownStandards(): Promise<void> {\n    const hyLineStandards = [\n      { weekNumber: 1, standardWeight: 0.060, toleranceLower: 0.010, toleranceUpper: 0.010 },\n      { weekNumber: 2, standardWeight: 0.120, toleranceLower: 0.020, toleranceUpper: 0.020 },\n      { weekNumber: 3, standardWeight: 0.200, toleranceLower: 0.030, toleranceUpper: 0.030 },\n      { weekNumber: 4, standardWeight: 0.300, toleranceLower: 0.040, toleranceUpper: 0.040 },\n      { weekNumber: 5, standardWeight: 0.400, toleranceLower: 0.050, toleranceUpper: 0.050 },\n      { weekNumber: 6, standardWeight: 0.500, toleranceLower: 0.060, toleranceUpper: 0.060 },\n      { weekNumber: 7, standardWeight: 0.600, toleranceLower: 0.070, toleranceUpper: 0.070 },\n      { weekNumber: 8, standardWeight: 0.650, toleranceLower: 0.075, toleranceUpper: 0.075 },\n      { weekNumber: 9, standardWeight: 0.780, toleranceLower: 0.080, toleranceUpper: 0.080 },\n      { weekNumber: 10, standardWeight: 0.870, toleranceLower: 0.090, toleranceUpper: 0.090 },\n      { weekNumber: 11, standardWeight: 0.980, toleranceLower: 0.100, toleranceUpper: 0.100 },\n      { weekNumber: 12, standardWeight: 1.050, toleranceLower: 0.110, toleranceUpper: 0.110 },\n      { weekNumber: 13, standardWeight: 1.140, toleranceLower: 0.120, toleranceUpper: 0.120 },\n      { weekNumber: 14, standardWeight: 1.230, toleranceLower: 0.130, toleranceUpper: 0.130 },\n      { weekNumber: 15, standardWeight: 1.320, toleranceLower: 0.140, toleranceUpper: 0.140 },\n      { weekNumber: 16, standardWeight: 1.410, toleranceLower: 0.150, toleranceUpper: 0.150 },\n      { weekNumber: 17, standardWeight: 1.500, toleranceLower: 0.160, toleranceUpper: 0.160 },\n      { weekNumber: 18, standardWeight: 1.600, toleranceLower: 0.170, toleranceUpper: 0.170 },\n      { weekNumber: 19, standardWeight: 1.680, toleranceLower: 0.180, toleranceUpper: 0.180 },\n      { weekNumber: 20, standardWeight: 1.750, toleranceLower: 0.190, toleranceUpper: 0.190 },\n    ];\n\n    for (const standard of hyLineStandards) {\n      // Check if standard already exists\n      const existing = await this.getBreedStandardByBreedAndWeek('Hy-Line Brown', standard.weekNumber);\n      if (!existing) {\n        await this.createBreedStandard({\n          breedName: 'Hy-Line Brown',\n          ...standard,\n          notes: `Standard weight for Hy-Line Brown at week ${standard.weekNumber}`\n        });\n      }\n    }\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":54609},"client/src/pages/users.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { isUnauthorizedError, hasManagementRole } from \"@/lib/authUtils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Users, Shield, UserPlus, Menu, Settings, Crown, User as UserIcon } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { z } from \"zod\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport type { User } from \"@shared/schema\";\n\nconst userFormSchema = z.object({\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  email: z.string().email(\"Valid email is required\"),\n  role: z.enum([\"admin\", \"farm_owner\", \"manager\", \"staff\", \"customer\"], {\n    required_error: \"Role is required\",\n  }),\n  farmId: z.string().optional(),\n}).refine((data) => {\n  // Farm ID is required for manager, staff, farm_owner roles\n  const rolesThatNeedFarm = [\"manager\", \"staff\", \"farm_owner\"];\n  if (rolesThatNeedFarm.includes(data.role) && !data.farmId) {\n    return false;\n  }\n  return true;\n}, {\n  message: \"Farm selection is required for manager, staff, and farm owner roles\",\n  path: [\"farmId\"],\n});\n\ntype UserFormData = z.infer<typeof userFormSchema>;\n\n// Activity type based on the API response structure\ntype Activity = {\n  id: string;\n  type: string; // flexible to support multiple activity types\n  description: string;\n  createdAt: string;\n  userId: string;\n};\n\nexport default function UsersPage() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const { user: currentUser, isLoading, isAuthenticated } = useAuth();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [userDialogOpen, setUserDialogOpen] = useState(false);\n  const queryClient = useQueryClient();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  // Check if user is admin or manager\n  useEffect(() => {\n    if (!isLoading && isAuthenticated && !hasManagementRole(currentUser)) {\n      toast({\n        title: \"Access Denied\",\n        description: \"You need admin or manager privileges to access this page\",\n        variant: \"destructive\",\n      });\n      // Redirect to home page\n      setLocation(\"/\");\n      return;\n    }\n  }, [currentUser, isAuthenticated, isLoading, toast]);\n\n  const { data: users, error: usersError } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n    enabled: isAuthenticated && hasManagementRole(currentUser),\n  });\n\n  const { data: activity, error: activityError, isLoading: activityLoading } = useQuery<Activity[]>({\n    queryKey: [\"/api/dashboard/activity\"],\n    enabled: isAuthenticated && hasManagementRole(currentUser),\n  });\n\n  // Fetch farms for farm selection dropdown (admins only)\n  const { data: farms } = useQuery<any[]>({\n    queryKey: [\"/api/farms\"],\n    enabled: isAuthenticated && currentUser?.role === 'admin',\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if ((usersError && isUnauthorizedError(usersError)) || (activityError && isUnauthorizedError(activityError))) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [usersError, activityError, toast]);\n\n  const userForm = useForm<UserFormData>({\n    resolver: zodResolver(userFormSchema),\n    defaultValues: {\n      firstName: \"\",\n      lastName: \"\",\n      email: \"\",\n      role: \"staff\",\n      farmId: \"\",\n    },\n  });\n\n  // Watch role changes to conditionally show farm selector\n  const selectedRole = userForm.watch(\"role\");\n  const rolesThatNeedFarm = [\"manager\", \"staff\", \"farm_owner\"];\n  const shouldShowFarmSelector = rolesThatNeedFarm.includes(selectedRole);\n\n  // Clear farmId when role doesn't need it\n  useEffect(() => {\n    if (!shouldShowFarmSelector) {\n      userForm.setValue(\"farmId\", \"\");\n    }\n  }, [shouldShowFarmSelector, userForm]);\n\n  const createUserMutation = useMutation({\n    mutationFn: async (data: UserFormData) => {\n      await apiRequest(\"POST\", \"/api/users\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({\n        title: \"Success\",\n        description: \"User created successfully\",\n      });\n      userForm.reset();\n      setUserDialogOpen(false);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading user management...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated || !hasManagementRole(currentUser)) {\n    return null;\n  }\n\n  const displayUsers = users || [];\n  const adminUsers = displayUsers.filter((user: User) => user.role === 'admin');\n  const managerUsers = displayUsers.filter((user: User) => user.role === 'manager');\n  const farmOwnerUsers = displayUsers.filter((user: User) => user.role === 'farm_owner');\n  const staffUsers = displayUsers.filter((user: User) => user.role === 'staff');\n  const customerUsers = displayUsers.filter((user: User) => user.role === 'customer');\n  const activeUsers = displayUsers.filter((user: User) => {\n    if (!user.lastActive) return false;\n    const lastActive = new Date(user.lastActive);\n    const yesterday = new Date();\n    yesterday.setDate(yesterday.getDate() - 1);\n    return lastActive >= yesterday;\n  });\n\n  const onSubmitUser = (data: UserFormData) => {\n    createUserMutation.mutate(data);\n  };\n\n  const getRoleIcon = (role: string) => {\n    switch (role) {\n      case 'admin': return Crown;\n      case 'farm_owner': return Shield;\n      case 'manager': return Settings;\n      case 'customer': return UserIcon;\n      default: return UserIcon; // staff and others\n    }\n  };\n\n  const getRoleBadge = (role: string) => {\n    switch (role) {\n      case 'admin':\n        return { variant: \"default\" as const, color: \"text-primary\" };\n      case 'farm_owner':\n        return { variant: \"default\" as const, color: \"text-green-600\" };\n      case 'manager':\n        return { variant: \"secondary\" as const, color: \"text-blue-600\" };\n      case 'customer':\n        return { variant: \"outline\" as const, color: \"text-purple-600\" };\n      default: // staff\n        return { variant: \"secondary\" as const, color: \"text-muted-foreground\" };\n    }\n  };\n\n  const getInitials = (firstName: string, lastName: string) => {\n    const initials = `${firstName?.[0] || ''}${lastName?.[0] || ''}`.toUpperCase();\n    return initials.trim() || '?';\n  };\n\n  const formatLastActive = (lastActive: string) => {\n    const date = new Date(lastActive);\n    const now = new Date();\n    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));\n    \n    if (diffInMinutes < 60) {\n      return `${diffInMinutes}m ago`;\n    }\n    \n    const diffInHours = Math.floor(diffInMinutes / 60);\n    if (diffInHours < 24) {\n      return `${diffInHours}h ago`;\n    }\n    \n    const diffInDays = Math.floor(diffInHours / 24);\n    return `${diffInDays}d ago`;\n  };\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Header */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Users & Permissions</h2>\n                <p className=\"text-sm text-muted-foreground\">Manage farm staff and access controls</p>\n              </div>\n            </div>\n            \n            <Dialog open={userDialogOpen} onOpenChange={setUserDialogOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-add-user\">\n                  <UserPlus className=\"h-4 w-4 mr-2\" />\n                  Add User\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle>Add New User</DialogTitle>\n                </DialogHeader>\n                <Form {...userForm}>\n                  <form onSubmit={userForm.handleSubmit(onSubmitUser)} className=\"space-y-4\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={userForm.control}\n                        name=\"firstName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>First Name</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"John\" data-testid=\"input-first-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={userForm.control}\n                        name=\"lastName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Last Name</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Doe\" data-testid=\"input-last-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={userForm.control}\n                      name=\"email\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Email</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"email\" \n                              {...field} \n                              placeholder=\"john.doe@example.com\" \n                              data-testid=\"input-email\" \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={userForm.control}\n                      name=\"role\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Role</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-role\">\n                                <SelectValue placeholder=\"Select role\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"staff\">Staff</SelectItem>\n                              {currentUser?.role === 'admin' && (\n                                <>\n                                  <SelectItem value=\"manager\">Manager</SelectItem>\n                                  <SelectItem value=\"farm_owner\">Farm Owner</SelectItem>\n                                  <SelectItem value=\"admin\">Admin</SelectItem>\n                                  <SelectItem value=\"customer\">Customer</SelectItem>\n                                </>\n                              )}\n                              {currentUser?.role === 'manager' && (\n                                <>\n                                  <SelectItem value=\"manager\">Manager</SelectItem>\n                                  <SelectItem value=\"customer\">Customer</SelectItem>\n                                </>\n                              )}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    {/* Farm Selector - Only show for roles that need a farm */}\n                    {shouldShowFarmSelector && (\n                      <FormField\n                        control={userForm.control}\n                        name=\"farmId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Farm <span className=\"text-red-500\">*</span></FormLabel>\n                            <Select onValueChange={field.onChange} defaultValue={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-farm\">\n                                  <SelectValue placeholder=\"Select farm\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                {farms && farms.length > 0 ? (\n                                  farms.map((farm) => (\n                                    <SelectItem \n                                      key={farm.id} \n                                      value={farm.id}\n                                      data-testid={`option-farm-${farm.id}`}\n                                    >\n                                      {farm.name}\n                                    </SelectItem>\n                                  ))\n                                ) : (\n                                  <SelectItem value=\"\" disabled>\n                                    No farms available\n                                  </SelectItem>\n                                )}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                            {(!farms || farms.length === 0) && (\n                              <p className=\"text-sm text-muted-foreground\">\n                                Create a farm first to assign {selectedRole} users\n                              </p>\n                            )}\n                          </FormItem>\n                        )}\n                      />\n                    )}\n\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full\" \n                      disabled={createUserMutation.isPending || (shouldShowFarmSelector && (!farms || farms.length === 0))}\n                      data-testid=\"button-submit-user\"\n                    >\n                      {createUserMutation.isPending ? \"Creating...\" : \"Create User\"}\n                    </Button>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          {/* Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6\">\n            <Card data-testid=\"card-total-users\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Total Users</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{displayUsers.length}</p>\n                    <p className=\"text-xs text-muted-foreground\">Active accounts</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <Users className=\"h-6 w-6 text-primary\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-admin-users\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Administrators</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{adminUsers.length}</p>\n                    <p className=\"text-xs text-green-600\">Full access</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n                    <Crown className=\"h-6 w-6 text-green-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-manager-users\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Managers</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{managerUsers.length}</p>\n                    <p className=\"text-xs text-blue-600\">Management access</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center\">\n                    <Settings className=\"h-6 w-6 text-blue-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-staff-users\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Staff Members</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{staffUsers.length}</p>\n                    <p className=\"text-xs text-gray-600\">Standard access</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center\">\n                    <UserIcon className=\"h-6 w-6 text-gray-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-active-users\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Active Today</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{activeUsers.length}</p>\n                    <p className=\"text-xs text-orange-600\">Last 24 hours</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center\">\n                    <Shield className=\"h-6 w-6 text-orange-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-farm-owner-users\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Farm Owners</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{farmOwnerUsers.length}</p>\n                    <p className=\"text-xs text-yellow-600\">Owner privileges</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center\">\n                    <Shield className=\"h-6 w-6 text-yellow-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs defaultValue=\"all-users\" className=\"space-y-4\">\n            <TabsList>\n              <TabsTrigger value=\"all-users\">All Users</TabsTrigger>\n              <TabsTrigger value=\"permissions\">Permissions</TabsTrigger>\n              <TabsTrigger value=\"activity\">User Activity</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"all-users\">\n              <Card data-testid=\"card-all-users\">\n                <CardHeader>\n                  <CardTitle>Farm Users</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {displayUsers.map((user: User) => {\n                      const RoleIcon = getRoleIcon(user.role);\n                      const roleBadge = getRoleBadge(user.role);\n                      \n                      return (\n                        <div \n                          key={user.id} \n                          className=\"flex items-center justify-between p-4 border border-border rounded-lg\"\n                          data-testid={`user-card-${user.id}`}\n                        >\n                          <div className=\"flex items-center space-x-4\">\n                            <Avatar className=\"h-12 w-12\">\n                              <AvatarImage src={user.profileImageUrl} />\n                              <AvatarFallback>\n                                {getInitials(user.firstName, user.lastName)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <div>\n                              <h3 className=\"font-semibold text-foreground\">\n                                {user.firstName} {user.lastName}\n                              </h3>\n                              <p className=\"text-sm text-muted-foreground\">{user.email}</p>\n                              <div className=\"flex items-center space-x-2 mt-1\">\n                                <Badge variant={roleBadge.variant} className=\"capitalize\">\n                                  <RoleIcon className=\"h-3 w-3 mr-1\" />\n                                  {user.role}\n                                </Badge>\n                                {user.lastActive && (\n                                  <span className=\"text-xs text-muted-foreground\">\n                                    Last active: {formatLastActive(user.lastActive)}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                          <div className=\"flex items-center space-x-2\">\n                            {/* Edit functionality not yet implemented - removed to avoid dead-end UX */}\n                            {user.id !== currentUser?.id && (\n                              <Button \n                                variant=\"outline\" \n                                size=\"sm\" \n                                className=\"text-red-600 hover:text-red-700\"\n                                data-testid={`button-disable-user-${user.id}`}\n                              >\n                                Disable\n                              </Button>\n                            )}\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"permissions\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card data-testid=\"card-role-permissions\">\n                  <CardHeader>\n                    <CardTitle>Role Permissions</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"p-4 border border-green-200 bg-green-50 dark:bg-green-900/20 dark:border-green-800 rounded-lg\">\n                        <div className=\"flex items-center space-x-2 mb-2\">\n                          <Crown className=\"h-5 w-5 text-green-600\" />\n                          <h3 className=\"font-semibold text-green-800 dark:text-green-200\">Administrator</h3>\n                        </div>\n                        <ul className=\"text-sm text-green-700 dark:text-green-300 space-y-1\">\n                          <li>• Full access to all farm data</li>\n                          <li>• User management and permissions</li>\n                          <li>• Financial reports and analytics</li>\n                          <li>• System settings and configuration</li>\n                          <li>• Export and backup capabilities</li>\n                        </ul>\n                      </div>\n\n                      <div className=\"p-4 border border-yellow-200 bg-yellow-50 dark:bg-yellow-900/20 dark:border-yellow-800 rounded-lg\">\n                        <div className=\"flex items-center space-x-2 mb-2\">\n                          <Shield className=\"h-5 w-5 text-yellow-600\" />\n                          <h3 className=\"font-semibold text-yellow-800 dark:text-yellow-200\">Farm Owner</h3>\n                        </div>\n                        <ul className=\"text-sm text-yellow-700 dark:text-yellow-300 space-y-1\">\n                          <li>• Full farm ownership and control</li>\n                          <li>• Manage farm settings and configuration</li>\n                          <li>• Access to all farm financial data</li>\n                          <li>• Receive notifications and alerts</li>\n                          <li>• Create and manage flocks</li>\n                        </ul>\n                      </div>\n\n                      <div className=\"p-4 border border-blue-200 bg-blue-50 dark:bg-blue-900/20 dark:border-blue-800 rounded-lg\">\n                        <div className=\"flex items-center space-x-2 mb-2\">\n                          <Settings className=\"h-5 w-5 text-blue-600\" />\n                          <h3 className=\"font-semibold text-blue-800 dark:text-blue-200\">Manager</h3>\n                        </div>\n                        <ul className=\"text-sm text-blue-700 dark:text-blue-300 space-y-1\">\n                          <li>• Create and manage users (staff, customers)</li>\n                          <li>• Oversee daily farm operations</li>\n                          <li>• Access to production analytics</li>\n                          <li>• Receive notifications and alerts</li>\n                          <li>• Review and approve daily records</li>\n                        </ul>\n                      </div>\n\n                      <div className=\"p-4 border border-gray-200 bg-gray-50 dark:bg-gray-900/20 dark:border-gray-800 rounded-lg\">\n                        <div className=\"flex items-center space-x-2 mb-2\">\n                          <UserIcon className=\"h-5 w-5 text-gray-600\" />\n                          <h3 className=\"font-semibold text-gray-800 dark:text-gray-200\">Staff Member</h3>\n                        </div>\n                        <ul className=\"text-sm text-gray-700 dark:text-gray-300 space-y-1\">\n                          <li>• Record daily farm activities</li>\n                          <li>• View production reports</li>\n                          <li>• Add expenses and sales</li>\n                          <li>• Update feed and health records</li>\n                          <li>• Limited access to analytics</li>\n                        </ul>\n                      </div>\n\n                      <div className=\"p-4 border border-purple-200 bg-purple-50 dark:bg-purple-900/20 dark:border-purple-800 rounded-lg\">\n                        <div className=\"flex items-center space-x-2 mb-2\">\n                          <UserIcon className=\"h-5 w-5 text-purple-600\" />\n                          <h3 className=\"font-semibold text-purple-800 dark:text-purple-200\">Customer</h3>\n                        </div>\n                        <ul className=\"text-sm text-purple-700 dark:text-purple-300 space-y-1\">\n                          <li>• Browse and view available products</li>\n                          <li>• Place orders for eggs and chickens</li>\n                          <li>• Track order status and delivery</li>\n                          <li>• View order history</li>\n                          <li>• Contact farm for support</li>\n                        </ul>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-access-controls\">\n                  <CardHeader>\n                    <CardTitle>Access Controls</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded\">\n                        <div>\n                          <p className=\"font-medium\">Session Timeout</p>\n                          <p className=\"text-sm text-muted-foreground\">Auto logout after inactivity</p>\n                        </div>\n                        <Badge variant=\"outline\">1 hour</Badge>\n                      </div>\n\n                      <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded\">\n                        <div>\n                          <p className=\"font-medium\">Password Requirements</p>\n                          <p className=\"text-sm text-muted-foreground\">Minimum security standards</p>\n                        </div>\n                        <Badge variant=\"outline\">Strong</Badge>\n                      </div>\n\n                      <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded\">\n                        <div>\n                          <p className=\"font-medium\">Two-Factor Authentication</p>\n                          <p className=\"text-sm text-muted-foreground\">Additional security layer</p>\n                        </div>\n                        <Badge variant=\"secondary\">Optional</Badge>\n                      </div>\n\n                      <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded\">\n                        <div>\n                          <p className=\"font-medium\">Audit Logging</p>\n                          <p className=\"text-sm text-muted-foreground\">Track user actions</p>\n                        </div>\n                        <Badge variant=\"default\">Enabled</Badge>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"activity\">\n              <Card data-testid=\"card-user-activity\">\n                <CardHeader>\n                  <CardTitle>Recent User Activity</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {activityLoading ? (\n                      // Loading skeleton\n                      <div data-testid=\"status-activity-loading\">\n                        {Array.from({ length: 5 }).map((_, index) => (\n                          <div key={index} className=\"flex items-start space-x-3 p-3 bg-muted/50 rounded animate-pulse\">\n                            <div className=\"h-8 w-8 bg-muted rounded-full\" />\n                            <div className=\"flex-1 space-y-2\">\n                              <div className=\"h-4 bg-muted rounded w-3/4\" />\n                              <div className=\"h-3 bg-muted rounded w-1/2\" />\n                            </div>\n                            <div className=\"h-5 bg-muted rounded w-16\" />\n                          </div>\n                        ))}\n                      </div>\n                    ) : activity && activity.length > 0 ? (\n                      // Activity items\n                      activity.slice(0, 10).map((item: any, index: number) => (\n                        <div key={item.id || index} className=\"flex items-start space-x-3 p-3 bg-muted/50 rounded\">\n                          <Avatar className=\"h-8 w-8\">\n                            <AvatarFallback>\n                              {item.userId ? getInitials(\"User\", \"Name\") : \"SY\"}\n                            </AvatarFallback>\n                          </Avatar>\n                          <div className=\"flex-1\">\n                            <p className=\"text-sm text-foreground\">{item.description}</p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {new Date(item.createdAt).toLocaleString()}\n                            </p>\n                          </div>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {item.type}\n                          </Badge>\n                        </div>\n                      ))\n                    ) : (\n                      // Empty state\n                      <div data-testid=\"status-activity-empty\" className=\"text-center py-8\">\n                        <Shield className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                        <p className=\"text-muted-foreground\">No recent activity</p>\n                      </div>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":35503},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"server/breakEvenUtils.ts":{"content":"/**\n * Break-Even Analysis Utilities\n * Provides expense categorization and financial calculations for break-even analysis\n */\n\nexport type CostType = 'variable' | 'fixed';\n\n/**\n * Maps expense categories to cost types (variable or fixed)\n * \n * Variable Costs: Costs that vary directly with production volume\n * - feed: Directly proportional to number of birds and production\n * - medication: Varies with flock health and size\n * \n * Fixed Costs: Costs that remain relatively constant regardless of production\n * - labor: Salaries and wages are typically fixed monthly costs\n * - utilities: Electricity, water generally remain constant\n * - equipment: Depreciation and maintenance are fixed periodic costs\n * - other: Default to fixed for miscellaneous expenses\n */\nexport const EXPENSE_CATEGORY_TO_COST_TYPE: Record<string, CostType> = {\n  feed: 'variable',\n  medication: 'variable',\n  labor: 'fixed',\n  utilities: 'fixed',\n  equipment: 'fixed',\n  other: 'fixed',\n};\n\n/**\n * Determines whether an expense category is a variable or fixed cost\n */\nexport function getCostType(category: string): CostType {\n  return EXPENSE_CATEGORY_TO_COST_TYPE[category] || 'fixed';\n}\n\n/**\n * Filters expenses by cost type\n */\nexport function filterExpensesByType(\n  expenses: Array<{ category: string; amount: string | number }>,\n  costType: CostType\n): Array<{ category: string; amount: string | number }> {\n  return expenses.filter(expense => getCostType(expense.category) === costType);\n}\n\n/**\n * Calculates total amount for a list of expenses\n */\nexport function calculateTotalAmount(\n  expenses: Array<{ amount: string | number }>\n): number {\n  return expenses.reduce((total, expense) => {\n    const amount = typeof expense.amount === 'string' \n      ? parseFloat(expense.amount) \n      : expense.amount;\n    return total + (isNaN(amount) ? 0 : amount);\n  }, 0);\n}\n\n/**\n * Splits expenses into variable and fixed costs with totals\n */\nexport function splitExpensesByType(\n  expenses: Array<{ category: string; amount: string | number }>\n): { variable: number; fixed: number; total: number } {\n  const variableExpenses = filterExpensesByType(expenses, 'variable');\n  const fixedExpenses = filterExpensesByType(expenses, 'fixed');\n  \n  const variable = calculateTotalAmount(variableExpenses);\n  const fixed = calculateTotalAmount(fixedExpenses);\n  \n  return {\n    variable,\n    fixed,\n    total: variable + fixed,\n  };\n}\n\n/**\n * Monthly aggregation interface for revenue and expenses\n */\nexport interface MonthlyData {\n  month: string; // Format: YYYY-MM\n  revenue: number;\n  variableCosts: number;\n  fixedCosts: number;\n  totalCosts: number;\n  profit: number;\n  unitsSold: number;\n}\n\n/**\n * UTC-aware month key helper\n */\nfunction getUTCMonthKey(dateStr: string): string {\n  const date = dateStr.includes('T') \n    ? new Date(dateStr) \n    : new Date(`${dateStr}T00:00:00Z`);\n  const year = date.getUTCFullYear();\n  const month = String(date.getUTCMonth() + 1).padStart(2, '0');\n  return `${year}-${month}`;\n}\n\n/**\n * Helper to calculate months between two YYYY-MM strings\n */\nfunction getMonthsBetween(monthKey1: string, monthKey2: string): number {\n  const [year1, month1] = monthKey1.split('-').map(Number);\n  const [year2, month2] = monthKey2.split('-').map(Number);\n  return (year2 - year1) * 12 + (month2 - month1);\n}\n\n/**\n * Aggregates financial data by month using UTC-aware month keys\n */\nexport function aggregateByMonth(\n  sales: Array<{ saleDate: string; totalAmount: string | number; cratesSold: number }>,\n  expenses: Array<{ expenseDate: string; category: string; amount: string | number }>\n): MonthlyData[] {\n  const monthlyMap = new Map<string, MonthlyData>();\n\n  // Process sales with UTC month keys\n  sales.forEach(sale => {\n    const month = getUTCMonthKey(sale.saleDate);\n    const amount = typeof sale.totalAmount === 'string' \n      ? parseFloat(sale.totalAmount) \n      : sale.totalAmount;\n    \n    if (!monthlyMap.has(month)) {\n      monthlyMap.set(month, {\n        month,\n        revenue: 0,\n        variableCosts: 0,\n        fixedCosts: 0,\n        totalCosts: 0,\n        profit: 0,\n        unitsSold: 0,\n      });\n    }\n    \n    const data = monthlyMap.get(month)!;\n    data.revenue += isNaN(amount) ? 0 : amount;\n    data.unitsSold += sale.cratesSold;\n  });\n\n  // Process expenses with UTC month keys\n  expenses.forEach(expense => {\n    const month = getUTCMonthKey(expense.expenseDate);\n    const amount = typeof expense.amount === 'string' \n      ? parseFloat(expense.amount) \n      : expense.amount;\n    \n    if (!monthlyMap.has(month)) {\n      monthlyMap.set(month, {\n        month,\n        revenue: 0,\n        variableCosts: 0,\n        fixedCosts: 0,\n        totalCosts: 0,\n        profit: 0,\n        unitsSold: 0,\n      });\n    }\n    \n    const data = monthlyMap.get(month)!;\n    const costType = getCostType(expense.category);\n    \n    if (costType === 'variable') {\n      data.variableCosts += isNaN(amount) ? 0 : amount;\n    } else {\n      data.fixedCosts += isNaN(amount) ? 0 : amount;\n    }\n  });\n\n  // Calculate totals and profit for each month\n  monthlyMap.forEach(data => {\n    data.totalCosts = data.variableCosts + data.fixedCosts;\n    data.profit = data.revenue - data.totalCosts;\n  });\n\n  // Convert to array and sort by month\n  return Array.from(monthlyMap.values()).sort((a, b) => a.month.localeCompare(b.month));\n}\n\n/**\n * Data quality metrics for auto-calculated break-even parameters\n */\nexport interface DataQuality {\n  hasSufficientData: boolean;\n  monthsWithSales: number;\n  monthsWithExpenses: number;\n  totalSales: number;\n  totalExpenses: number;\n  warnings: string[];\n}\n\n/**\n * Auto-calculated break-even parameters from historical data\n */\nexport interface AutoCalculatedParams {\n  price: number;\n  unitVariableCost: number;\n  fixedCostsPerMonth: number;\n  initialUnits: number;\n  growthRate: number;\n  seasonalityFactors: number[];\n  dataQuality: DataQuality;\n}\n\n/**\n * Auto-calculates break-even parameters from historical sales and expense data\n */\nexport function autoCalculateBreakEvenParams(\n  sales: Array<{ saleDate: string; totalAmount: string | number; cratesSold: number; pricePerCrate: string | number }>,\n  expenses: Array<{ expenseDate: string; category: string; amount: string | number }>,\n  timeframeMonths: number\n): AutoCalculatedParams {\n  const warnings: string[] = [];\n  \n  // Filter data to timeframe using UTC months\n  const now = new Date();\n  const cutoffDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - timeframeMonths + 1, 1));\n  \n  const filteredSales = sales.filter(s => {\n    const saleDate = s.saleDate.includes('T') ? new Date(s.saleDate) : new Date(`${s.saleDate}T00:00:00Z`);\n    return saleDate >= cutoffDate;\n  });\n  \n  const filteredExpenses = expenses.filter(e => {\n    const expenseDate = e.expenseDate.includes('T') ? new Date(e.expenseDate) : new Date(`${e.expenseDate}T00:00:00Z`);\n    return expenseDate >= cutoffDate;\n  });\n\n  // Aggregate by month\n  const monthlyData = aggregateByMonth(filteredSales, filteredExpenses);\n  \n  // Sort by month\n  const sortedMonths = monthlyData.sort((a, b) => a.month.localeCompare(b.month));\n  \n  // Calculate data quality metrics\n  const monthsWithSales = sortedMonths.filter(m => m.unitsSold > 0).length;\n  const monthsWithExpenses = sortedMonths.filter(m => m.totalCosts > 0).length;\n  const totalSalesUnits = sortedMonths.reduce((sum, m) => sum + m.unitsSold, 0);\n  const totalRevenue = sortedMonths.reduce((sum, m) => sum + m.revenue, 0);\n  const totalExpenses = sortedMonths.reduce((sum, m) => sum + m.totalCosts, 0);\n  \n  // Minimum data requirements: ≥3 months with sales, ≥2 with expenses\n  const hasSufficientData = monthsWithSales >= 3 && monthsWithExpenses >= 2 && totalSalesUnits > 0;\n  \n  if (monthsWithSales < 3) warnings.push(\"Less than 3 months of sales data\");\n  if (monthsWithExpenses < 2) warnings.push(\"Less than 2 months of expense data\");\n  if (totalSalesUnits === 0) warnings.push(\"No units sold in selected timeframe\");\n  \n  // 1. Price: Weighted average\n  let price = 0;\n  if (totalSalesUnits > 0) {\n    price = totalRevenue / totalSalesUnits;\n  } else if (filteredSales.length > 0) {\n    // Fallback to simple average of pricePerCrate\n    const sum = filteredSales.reduce((s, sale) => {\n      const p = typeof sale.pricePerCrate === 'string' ? parseFloat(sale.pricePerCrate) : sale.pricePerCrate;\n      return s + (isNaN(p) ? 0 : p);\n    }, 0);\n    price = sum / filteredSales.length;\n    warnings.push(\"Using average price (no units sold)\");\n  } else {\n    price = 400; // Default fallback\n    warnings.push(\"No sales data - using default price\");\n  }\n  \n  // 2. Unit Variable Cost: Variable expenses / total units\n  const totalVariableCosts = sortedMonths.reduce((sum, m) => sum + m.variableCosts, 0);\n  let unitVariableCost = 0;\n  if (totalSalesUnits > 0) {\n    unitVariableCost = totalVariableCosts / totalSalesUnits;\n  } else {\n    unitVariableCost = price * 0.4; // Default to 40% of price\n    warnings.push(\"No units sold - estimating variable cost\");\n  }\n  \n  // 3. Fixed Costs Per Month: Average monthly fixed costs\n  const monthsWithData = new Set<string>();\n  filteredSales.forEach(s => monthsWithData.add(getUTCMonthKey(s.saleDate)));\n  filteredExpenses.forEach(e => monthsWithData.add(getUTCMonthKey(e.expenseDate)));\n  \n  const totalFixedCosts = sortedMonths.reduce((sum, m) => sum + m.fixedCosts, 0);\n  const fixedCostsPerMonth = monthsWithData.size > 0 ? totalFixedCosts / monthsWithData.size : 0;\n  \n  if (totalFixedCosts === 0) warnings.push(\"No fixed expenses recorded\");\n  \n  // 4. Initial Units: First non-zero month\n  let initialUnits = 0;\n  const firstMonthWithSales = sortedMonths.find(m => m.unitsSold > 0);\n  if (firstMonthWithSales) {\n    initialUnits = firstMonthWithSales.unitsSold;\n  } else {\n    // Fallback to average units\n    initialUnits = monthsWithSales > 0 ? totalSalesUnits / monthsWithSales : 100;\n    warnings.push(\"No sales in first month - using average\");\n  }\n  \n  // 5. Growth Rate: CAGR across actual calendar months\n  let growthRate = 0;\n  const nonZeroMonths = sortedMonths.filter(m => m.unitsSold > 0);\n  if (nonZeroMonths.length >= 2) {\n    const firstMonth = nonZeroMonths[0];\n    const lastMonth = nonZeroMonths[nonZeroMonths.length - 1];\n    \n    // Calculate actual calendar months between first and last non-zero month\n    const actualMonthsBetween = getMonthsBetween(firstMonth.month, lastMonth.month);\n    \n    if (firstMonth.unitsSold > 0 && actualMonthsBetween > 0) {\n      growthRate = Math.pow(lastMonth.unitsSold / firstMonth.unitsSold, 1 / actualMonthsBetween) - 1;\n      \n      // Cap growth rate to reasonable bounds (-20% to +20% per month)\n      if (growthRate > 0.2) {\n        growthRate = 0.2;\n        warnings.push(\"Growth rate capped at 20%/month\");\n      } else if (growthRate < -0.2) {\n        growthRate = -0.2;\n        warnings.push(\"Decline rate capped at 20%/month\");\n      }\n    }\n  } else {\n    growthRate = 0;\n    warnings.push(\"Insufficient data for growth rate - using 0%\");\n  }\n  \n  // 6. Seasonality Factors: Monthly patterns\n  let seasonalityFactors: number[] = [];\n  if (sortedMonths.length >= 3) {\n    const avgUnitsPerMonth = totalSalesUnits / sortedMonths.length;\n    seasonalityFactors = sortedMonths.map(m => \n      avgUnitsPerMonth > 0 ? m.unitsSold / avgUnitsPerMonth : 1\n    );\n    \n    // Normalize to mean 1\n    const mean = seasonalityFactors.reduce((s, f) => s + f, 0) / seasonalityFactors.length;\n    if (mean > 0) {\n      seasonalityFactors = seasonalityFactors.map(f => f / mean);\n    }\n  } else {\n    seasonalityFactors = [1];\n    warnings.push(\"Insufficient data for seasonality - using flat pattern\");\n  }\n  \n  return {\n    price: Math.round(price * 100) / 100,\n    unitVariableCost: Math.round(unitVariableCost * 100) / 100,\n    fixedCostsPerMonth: Math.round(fixedCostsPerMonth * 100) / 100,\n    initialUnits: Math.round(initialUnits),\n    growthRate: Math.round(growthRate * 10000) / 10000, // 4 decimal places\n    seasonalityFactors,\n    dataQuality: {\n      hasSufficientData,\n      monthsWithSales,\n      monthsWithExpenses,\n      totalSales: totalSalesUnits,\n      totalExpenses: Math.round(totalExpenses * 100) / 100,\n      warnings,\n    },\n  };\n}\n\n/**\n * Break-even calculation results\n */\nexport interface BreakEvenResults {\n  contributionMargin: number;\n  contributionMarginRatio: number;\n  breakEvenUnits: number;\n  breakEvenRevenue: number;\n  breakEvenMonth: number | null; // Month index (0-based) when break-even is reached, null if not reachable\n  breakEvenDate: string | null; // Actual date when break-even is reached\n  paybackPeriod: number | null; // Number of months to recover initial investment\n  cumulativeProfits: number[]; // Cumulative profit for each month\n  monthlyProjections: Array<{\n    month: number;\n    units: number;\n    revenue: number;\n    variableCosts: number;\n    fixedCosts: number;\n    totalCosts: number;\n    profit: number;\n    cumulativeProfit: number;\n  }>;\n}\n\n/**\n * Calculates break-even analysis based on assumptions and historical data\n */\nexport function calculateBreakEven(params: {\n  price: number;\n  unitVariableCost: number;\n  fixedCostsPerMonth: number;\n  initialUnits: number;\n  growthRate: number;\n  projectionMonths?: number;\n  seasonalityFactors?: number[];\n}): BreakEvenResults {\n  const {\n    price,\n    unitVariableCost,\n    fixedCostsPerMonth,\n    initialUnits,\n    growthRate,\n    projectionMonths = 12,\n    seasonalityFactors = [],\n  } = params;\n\n  // Calculate contribution margin\n  const contributionMargin = price - unitVariableCost;\n  const contributionMarginRatio = contributionMargin / price;\n\n  // Calculate break-even units per month\n  const breakEvenUnits = fixedCostsPerMonth / contributionMargin;\n  const breakEvenRevenue = breakEvenUnits * price;\n\n  // Generate monthly projections\n  const monthlyProjections = [];\n  let cumulativeProfit = 0;\n  let breakEvenMonth: number | null = null;\n  let breakEvenDate: string | null = null;\n\n  for (let month = 0; month < projectionMonths; month++) {\n    // Calculate units for this month with growth rate\n    let units = initialUnits * Math.pow(1 + growthRate, month);\n    \n    // Apply seasonality factor if provided\n    if (seasonalityFactors.length > 0) {\n      const seasonalityIndex = month % seasonalityFactors.length;\n      units *= seasonalityFactors[seasonalityIndex];\n    }\n\n    // Calculate financial metrics\n    const revenue = units * price;\n    const variableCosts = units * unitVariableCost;\n    const totalCosts = variableCosts + fixedCostsPerMonth;\n    const profit = revenue - totalCosts;\n    cumulativeProfit += profit;\n\n    monthlyProjections.push({\n      month: month + 1,\n      units: Math.round(units * 100) / 100,\n      revenue: Math.round(revenue * 100) / 100,\n      variableCosts: Math.round(variableCosts * 100) / 100,\n      fixedCosts: fixedCostsPerMonth,\n      totalCosts: Math.round(totalCosts * 100) / 100,\n      profit: Math.round(profit * 100) / 100,\n      cumulativeProfit: Math.round(cumulativeProfit * 100) / 100,\n    });\n\n    // Check if break-even is reached\n    if (breakEvenMonth === null && cumulativeProfit >= 0) {\n      breakEvenMonth = month;\n      \n      // Calculate approximate date using interpolation\n      const currentMonth = monthlyProjections[month];\n      if (month > 0) {\n        const previousMonth = monthlyProjections[month - 1];\n        const profitGap = currentMonth.cumulativeProfit - previousMonth.cumulativeProfit;\n        const daysIntoMonth = profitGap > 0 \n          ? Math.round((0 - previousMonth.cumulativeProfit) / profitGap * 30)\n          : 0;\n        \n        const today = new Date();\n        const breakEvenDateObj = new Date(today.getFullYear(), today.getMonth() + month, daysIntoMonth);\n        breakEvenDate = breakEvenDateObj.toISOString().split('T')[0];\n      } else {\n        const today = new Date();\n        const breakEvenDateObj = new Date(today.getFullYear(), today.getMonth(), 1);\n        breakEvenDate = breakEvenDateObj.toISOString().split('T')[0];\n      }\n    }\n  }\n\n  // Calculate payback period (same as break-even month for now)\n  const paybackPeriod = breakEvenMonth !== null ? breakEvenMonth + 1 : null;\n\n  return {\n    contributionMargin: Math.round(contributionMargin * 100) / 100,\n    contributionMarginRatio: Math.round(contributionMarginRatio * 10000) / 100, // As percentage\n    breakEvenUnits: Math.round(breakEvenUnits * 100) / 100,\n    breakEvenRevenue: Math.round(breakEvenRevenue * 100) / 100,\n    breakEvenMonth: breakEvenMonth !== null ? breakEvenMonth + 1 : null,\n    breakEvenDate,\n    paybackPeriod,\n    cumulativeProfits: monthlyProjections.map(m => m.cumulativeProfit),\n    monthlyProjections,\n  };\n}\n","size_bytes":16713},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5742},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/pages/customer-dashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport CustomerSidebar from \"@/components/layout/customer-sidebar\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { \n  User, \n  ShoppingBag, \n  Truck, \n  MapPin, \n  Phone, \n  Mail, \n  Calendar,\n  Package,\n  Clock,\n  CheckCircle,\n  XCircle,\n  AlertCircle,\n  Settings,\n  Store,\n  Menu\n} from \"lucide-react\";\n\ninterface CustomerProfile {\n  id: string;\n  name: string;\n  email: string;\n  phone?: string;\n  address?: string;\n  location?: string;\n  customerType: 'individual' | 'business';\n  status: string;\n  createdAt: string;\n}\n\ninterface Order {\n  id: string;\n  orderNumber: string;\n  orderDate: string;\n  status: 'pending' | 'confirmed' | 'processing' | 'ready' | 'delivered' | 'cancelled';\n  deliveryMethod: 'pickup' | 'delivery';\n  totalAmount: string;\n  farmName?: string;\n  estimatedDelivery?: string;\n}\n\ninterface Delivery {\n  id: string;\n  orderId: string;\n  status: 'scheduled' | 'in_transit' | 'delivered' | 'failed';\n  scheduledDate: string;\n  actualDate?: string;\n  trackingNumber?: string;\n  notes?: string;\n}\n\nexport default function CustomerDashboard() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [selectedTab, setSelectedTab] = useState<'overview' | 'orders' | 'profile'>('overview');\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n\n  // Fetch customer profile\n  const { data: customerProfile, isLoading: profileLoading } = useQuery<CustomerProfile>({\n    queryKey: ['/api/customers/me'],\n  });\n\n  // Fetch customer orders - we'll need to implement this endpoint\n  const { data: orders = [], isLoading: ordersLoading } = useQuery<Order[]>({\n    queryKey: ['/api/customers/orders'],\n    enabled: !!customerProfile,\n  });\n\n  // Fetch deliveries\n  const { data: deliveries = [], isLoading: deliveriesLoading } = useQuery<Delivery[]>({\n    queryKey: ['/api/customers/deliveries'],\n    enabled: !!customerProfile,\n  });\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'delivered':\n      case 'confirmed':\n        return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';\n      case 'processing':\n      case 'ready':\n      case 'in_transit':\n        return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';\n      case 'pending':\n      case 'scheduled':\n        return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';\n      case 'cancelled':\n      case 'failed':\n        return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';\n      default:\n        return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300';\n    }\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case 'delivered':\n        return <CheckCircle className=\"w-4 h-4\" />;\n      case 'cancelled':\n      case 'failed':\n        return <XCircle className=\"w-4 h-4\" />;\n      case 'pending':\n        return <Clock className=\"w-4 h-4\" />;\n      default:\n        return <AlertCircle className=\"w-4 h-4\" />;\n    }\n  };\n\n  if (profileLoading) {\n    return (\n      <div className=\"flex h-screen bg-background\">\n        <CustomerSidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n        <main className=\"flex-1 overflow-auto\">\n          <div className=\"container mx-auto px-4 py-8\">\n            <div className=\"space-y-6\">\n              <Skeleton className=\"h-8 w-64\" />\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                {[...Array(3)].map((_, i) => (\n                  <Card key={i}>\n                    <CardHeader>\n                      <Skeleton className=\"h-6 w-32\" />\n                    </CardHeader>\n                    <CardContent>\n                      <Skeleton className=\"h-12 w-full\" />\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            </div>\n          </div>\n        </main>\n      </div>\n    );\n  }\n\n  if (!customerProfile) {\n    return (\n      <div className=\"flex h-screen bg-background\">\n        <CustomerSidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n        <main className=\"flex-1 overflow-auto\">\n          <div className=\"container mx-auto px-4 py-8\">\n            <Card>\n              <CardContent className=\"text-center py-12\">\n                <User className=\"w-16 h-16 text-muted-foreground mx-auto mb-4\" />\n                <h2 className=\"text-2xl font-semibold mb-2\">Welcome to KukuHub</h2>\n                <p className=\"text-muted-foreground mb-6\">\n                  Complete your customer profile to start placing orders and tracking deliveries.\n                </p>\n                <Link to=\"/customer-registration\">\n                  <Button size=\"lg\" data-testid=\"button-complete-profile\">\n                    Complete Your Profile\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n          </div>\n        </main>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex h-screen bg-background\">\n      <CustomerSidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      <main className=\"flex-1 overflow-auto\">\n        {/* Mobile menu button */}\n        <div className=\"md:hidden p-4 border-b border-border\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setSidebarOpen(!sidebarOpen)}\n            data-testid=\"button-menu\"\n          >\n            <Menu className=\"w-5 h-5\" />\n          </Button>\n        </div>\n\n        <div className=\"container mx-auto px-4 py-8\">\n          {/* Header */}\n          <div className=\"mb-8\">\n            <h1 className=\"text-3xl font-bold text-foreground mb-2\">\n              Welcome back, {customerProfile.name}\n            </h1>\n            <p className=\"text-muted-foreground\">\n              Manage your orders, track deliveries, and explore fresh poultry products from local farms.\n            </p>\n          </div>\n\n        {/* Navigation Tabs */}\n        <div className=\"mb-6\">\n          <div className=\"flex space-x-1 bg-muted p-1 rounded-lg w-fit\">\n            <Button\n              variant={selectedTab === 'overview' ? 'default' : 'ghost'}\n              size=\"sm\"\n              onClick={() => setSelectedTab('overview')}\n              data-testid=\"tab-overview\"\n            >\n              Overview\n            </Button>\n            <Button\n              variant={selectedTab === 'orders' ? 'default' : 'ghost'}\n              size=\"sm\"\n              onClick={() => setSelectedTab('orders')}\n              data-testid=\"tab-orders\"\n            >\n              My Orders\n            </Button>\n            <Button\n              variant={selectedTab === 'profile' ? 'default' : 'ghost'}\n              size=\"sm\"\n              onClick={() => setSelectedTab('profile')}\n              data-testid=\"tab-profile\"\n            >\n              Profile\n            </Button>\n          </div>\n        </div>\n\n        {/* Overview Tab */}\n        {selectedTab === 'overview' && (\n          <div className=\"space-y-6\">\n            {/* Quick Stats */}\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n              <Card data-testid=\"card-total-orders\">\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Total Orders</CardTitle>\n                  <ShoppingBag className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{orders.length}</div>\n                  <p className=\"text-xs text-muted-foreground\">All time</p>\n                </CardContent>\n              </Card>\n\n              <Card data-testid=\"card-active-deliveries\">\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Active Deliveries</CardTitle>\n                  <Truck className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">\n                    {deliveries.filter(d => ['scheduled', 'in_transit'].includes(d.status)).length}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">In progress</p>\n                </CardContent>\n              </Card>\n\n              <Card data-testid=\"card-member-since\">\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Member Since</CardTitle>\n                  <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">\n                    {new Date(customerProfile.createdAt).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">Customer</p>\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Recent Orders */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Package className=\"w-5 h-5\" />\n                  Recent Orders\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {ordersLoading ? (\n                  <div className=\"space-y-4\">\n                    {[...Array(3)].map((_, i) => (\n                      <div key={i} className=\"flex items-center justify-between\">\n                        <Skeleton className=\"h-4 w-48\" />\n                        <Skeleton className=\"h-6 w-20\" />\n                      </div>\n                    ))}\n                  </div>\n                ) : orders.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {orders.slice(0, 5).map((order) => (\n                      <div key={order.id} className=\"flex items-center justify-between\" data-testid={`order-${order.id}`}>\n                        <div>\n                          <p className=\"font-medium\">Order #{order.orderNumber}</p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {new Date(order.orderDate).toLocaleDateString()} • {order.farmName || 'Local Farm'}\n                          </p>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Badge className={getStatusColor(order.status)}>\n                            {getStatusIcon(order.status)}\n                            <span className=\"ml-1 capitalize\">{order.status}</span>\n                          </Badge>\n                          <span className=\"font-medium\">${order.totalAmount}</span>\n                        </div>\n                      </div>\n                    ))}\n                    {orders.length > 5 && (\n                      <Button \n                        variant=\"outline\" \n                        className=\"w-full\"\n                        onClick={() => setSelectedTab('orders')}\n                        data-testid=\"button-view-all-orders\"\n                      >\n                        View All Orders\n                      </Button>\n                    )}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8\">\n                    <ShoppingBag className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                    <p className=\"text-muted-foreground mb-4\">No orders yet</p>\n                    <Link to=\"/marketplace\">\n                      <Button data-testid=\"button-browse-marketplace\">\n                        Browse Marketplace\n                      </Button>\n                    </Link>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Quick Actions */}\n            <Card>\n              <CardHeader>\n                <CardTitle>Quick Actions</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <Link to=\"/marketplace\">\n                    <Button variant=\"outline\" className=\"w-full h-20 flex flex-col\" data-testid=\"button-browse-products\">\n                      <Store className=\"w-6 h-6 mb-2\" />\n                      Browse Products\n                    </Button>\n                  </Link>\n                  <Button \n                    variant=\"outline\" \n                    className=\"w-full h-20 flex flex-col\"\n                    onClick={() => setSelectedTab('orders')}\n                    data-testid=\"button-track-orders\"\n                  >\n                    <Package className=\"w-6 h-6 mb-2\" />\n                    Track Orders\n                  </Button>\n                  <Button \n                    variant=\"outline\" \n                    className=\"w-full h-20 flex flex-col\"\n                    onClick={() => setSelectedTab('profile')}\n                    data-testid=\"button-update-profile\"\n                  >\n                    <Settings className=\"w-6 h-6 mb-2\" />\n                    Update Profile\n                  </Button>\n                  <Link to=\"/marketplace\">\n                    <Button variant=\"outline\" className=\"w-full h-20 flex flex-col\" data-testid=\"button-find-farms\">\n                      <MapPin className=\"w-6 h-6 mb-2\" />\n                      Find Farms\n                    </Button>\n                  </Link>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        {/* Orders Tab */}\n        {selectedTab === 'orders' && (\n          <div className=\"space-y-6\">\n            <div className=\"flex justify-between items-center\">\n              <h2 className=\"text-2xl font-semibold\">My Orders</h2>\n              <Link to=\"/marketplace\">\n                <Button data-testid=\"button-new-order\">\n                  <Package className=\"w-4 h-4 mr-2\" />\n                  Place New Order\n                </Button>\n              </Link>\n            </div>\n\n            {ordersLoading ? (\n              <div className=\"space-y-4\">\n                {[...Array(5)].map((_, i) => (\n                  <Card key={i}>\n                    <CardContent className=\"p-6\">\n                      <Skeleton className=\"h-6 w-32 mb-2\" />\n                      <Skeleton className=\"h-4 w-48 mb-4\" />\n                      <div className=\"flex justify-between\">\n                        <Skeleton className=\"h-6 w-24\" />\n                        <Skeleton className=\"h-6 w-16\" />\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            ) : orders.length > 0 ? (\n              <div className=\"space-y-4\">\n                {orders.map((order) => (\n                  <Card key={order.id} data-testid={`order-card-${order.id}`}>\n                    <CardContent className=\"p-6\">\n                      <div className=\"flex justify-between items-start mb-4\">\n                        <div>\n                          <h3 className=\"font-semibold text-lg\">Order #{order.orderNumber}</h3>\n                          <p className=\"text-muted-foreground\">\n                            Placed on {new Date(order.orderDate).toLocaleDateString()}\n                          </p>\n                          {order.farmName && (\n                            <p className=\"text-sm text-muted-foreground\">From: {order.farmName}</p>\n                          )}\n                        </div>\n                        <Badge className={getStatusColor(order.status)}>\n                          {getStatusIcon(order.status)}\n                          <span className=\"ml-1 capitalize\">{order.status}</span>\n                        </Badge>\n                      </div>\n                      \n                      <div className=\"flex justify-between items-center\">\n                        <div className=\"flex items-center gap-4\">\n                          <div className=\"flex items-center gap-1\">\n                            <Truck className=\"w-4 h-4 text-muted-foreground\" />\n                            <span className=\"text-sm capitalize\">{order.deliveryMethod}</span>\n                          </div>\n                          {order.estimatedDelivery && (\n                            <div className=\"flex items-center gap-1\">\n                              <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n                              <span className=\"text-sm\">\n                                Est. {new Date(order.estimatedDelivery).toLocaleDateString()}\n                              </span>\n                            </div>\n                          )}\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-semibold text-lg\">${order.totalAmount}</p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            ) : (\n              <Card>\n                <CardContent className=\"text-center py-12\">\n                  <ShoppingBag className=\"w-16 h-16 text-muted-foreground mx-auto mb-4\" />\n                  <h3 className=\"text-xl font-semibold mb-2\">No orders yet</h3>\n                  <p className=\"text-muted-foreground mb-6\">\n                    Start exploring our marketplace to find fresh poultry products from local farms.\n                  </p>\n                  <Link to=\"/marketplace\">\n                    <Button size=\"lg\" data-testid=\"button-start-shopping\">\n                      Start Shopping\n                    </Button>\n                  </Link>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        )}\n\n        {/* Profile Tab */}\n        {selectedTab === 'profile' && (\n          <div className=\"space-y-6\">\n            <h2 className=\"text-2xl font-semibold\">Customer Profile</h2>\n            \n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <User className=\"w-5 h-5\" />\n                  Personal Information\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"text-sm font-medium text-muted-foreground\">Name</label>\n                    <p className=\"font-medium\">{customerProfile.name}</p>\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium text-muted-foreground\">Customer Type</label>\n                    <p className=\"font-medium capitalize\">{customerProfile.customerType}</p>\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium text-muted-foreground\">Email</label>\n                    <div className=\"flex items-center gap-2\">\n                      <Mail className=\"w-4 h-4 text-muted-foreground\" />\n                      <p className=\"font-medium\">{customerProfile.email}</p>\n                    </div>\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium text-muted-foreground\">Phone</label>\n                    <div className=\"flex items-center gap-2\">\n                      <Phone className=\"w-4 h-4 text-muted-foreground\" />\n                      <p className=\"font-medium\">{customerProfile.phone || 'Not provided'}</p>\n                    </div>\n                  </div>\n                </div>\n                \n                {customerProfile.address && (\n                  <div>\n                    <label className=\"text-sm font-medium text-muted-foreground\">Address</label>\n                    <div className=\"flex items-start gap-2\">\n                      <MapPin className=\"w-4 h-4 text-muted-foreground mt-1\" />\n                      <div>\n                        <p className=\"font-medium\">{customerProfile.address}</p>\n                        {customerProfile.location && (\n                          <p className=\"text-sm text-muted-foreground\">{customerProfile.location}</p>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"pt-4 border-t\">\n                  <Link to=\"/customer-registration\">\n                    <Button variant=\"outline\" data-testid=\"button-edit-profile\">\n                      <Settings className=\"w-4 h-4 mr-2\" />\n                      Edit Profile\n                    </Button>\n                  </Link>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n        </div>\n      </main>\n    </div>\n  );\n}","size_bytes":21343},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from \"wouter\";\nimport { useEffect } from \"react\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { AuthProvider, useAuth } from \"@/contexts/AuthContext\";\nimport { FarmProvider } from \"@/contexts/FarmContext\";\nimport { ROUTES, FARM_MANAGEMENT_ROUTES } from \"@/lib/routes\";\n\nimport NotFound from \"@/pages/not-found\";\nimport Landing from \"@/pages/landing\";\nimport Home from \"@/pages/home\";\nimport ChickBrooding from \"@/pages/chick-brooding\";\nimport BodyWeights from \"@/pages/body-weights\";\nimport EggProduction from \"@/pages/egg-production\";\nimport FeedManagement from \"@/pages/feed-management\";\nimport HealthRecords from \"@/pages/health-records\";\nimport Reports from \"@/pages/reports\";\nimport Expenses from \"@/pages/expenses\";\nimport Users from \"@/pages/users\";\nimport Settings from \"@/pages/settings\";\nimport { FarmRegistrationPage } from \"@/pages/farm-registration\";\nimport { FarmSetupPage } from \"@/pages/farm-setup\";\nimport MarketplaceCustomers from \"@/pages/marketplace-customers\";\nimport MarketplaceProducts from \"@/pages/marketplace-products\";\nimport MarketplaceOrders from \"@/pages/marketplace-orders\";\nimport PublicMarketplace from \"@/pages/public-marketplace\";\nimport FarmStorefront from \"@/pages/farm-storefront\";\nimport CustomerRegistration from \"@/pages/customer-registration\";\nimport CustomerDashboard from \"@/pages/customer-dashboard\";\n\nfunction Router() {\n  const { user, isAuthenticated, isLoading } = useAuth();\n  const [location, setLocation] = useLocation();\n\n  // Handle saved customer registration data - but NEVER redirect from farm management routes\n  useEffect(() => {\n    const savedFormData = sessionStorage.getItem('customerRegistrationData');\n    if (savedFormData && isAuthenticated && !isLoading) {\n      // Only redirect if NOT on a farm management route to prevent test routing conflicts\n      const isFarmManagementRoute = FARM_MANAGEMENT_ROUTES.includes(location as any);\n      if (!isFarmManagementRoute && location !== ROUTES.CUSTOMER_REGISTRATION) {\n        setLocation(ROUTES.CUSTOMER_REGISTRATION);\n      }\n    }\n  }, [isAuthenticated, isLoading, location, setLocation]);\n\n  // Determine if user is a customer\n  const isCustomer = user?.role === 'customer';\n\n  return (\n    <Switch>\n      {/* Public routes - always accessible */}\n      <Route path={ROUTES.MARKETPLACE} component={PublicMarketplace} />\n      <Route path=\"/farm/:farmId\" component={FarmStorefront} />\n      <Route path={ROUTES.CUSTOMER_REGISTRATION} component={CustomerRegistration} />\n      <Route path={ROUTES.FARM_REGISTRATION} component={FarmRegistrationPage} />\n      <Route path={ROUTES.FARM_SETUP} component={FarmSetupPage} />\n      <Route path={ROUTES.BODY_WEIGHTS} component={BodyWeights} />\n      \n      {isLoading || !isAuthenticated ? (\n        <Route path=\"/\" component={Landing} />\n      ) : isCustomer ? (\n        // Customer-specific routes\n        <>\n          <Route path=\"/\" component={CustomerDashboard} />\n          <Route path=\"/settings\" component={Settings} />\n        </>\n      ) : !user?.farmId && user?.role !== 'admin' ? (\n        // Non-admin farm management users without a farm - redirect to setup\n        <Route path=\"/\" component={FarmSetupPage} />\n      ) : (\n        // Farm management routes (admin, farm_owner, manager, staff with farms)\n        <>\n          <Route path=\"/\" component={Home} />\n          <Route path=\"/chick-brooding\" component={ChickBrooding} />\n          <Route path=\"/egg-production\" component={EggProduction} />\n          <Route path=\"/feed-management\" component={FeedManagement} />\n          <Route path=\"/health-records\" component={HealthRecords} />\n          <Route path=\"/reports\" component={Reports} />\n          <Route path=\"/expenses\" component={Expenses} />\n          <Route path=\"/users\" component={Users} />\n          <Route path=\"/settings\" component={Settings} />\n          <Route path=\"/marketplace/customers\" component={MarketplaceCustomers} />\n          <Route path=\"/marketplace/products\" component={MarketplaceProducts} />\n          <Route path=\"/marketplace/orders\" component={MarketplaceOrders} />\n        </>\n      )}\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <AuthProvider>\n          <FarmProvider>\n            <Toaster />\n            <Router />\n          </FarmProvider>\n        </AuthProvider>\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":4701},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/forms/brooding-record-form.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { insertDailyRecordSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\n\nconst broodingFormSchema = insertDailyRecordSchema.extend({\n  recordDate: z.string().min(1, \"Record date is required\"),\n  // Override numeric fields to handle empty values properly\n  temperature: z.union([z.string(), z.number()]).transform((val) => {\n    if (val === \"\" || val === undefined || val === null) return undefined;\n    const num = typeof val === \"string\" ? parseFloat(val) : val;\n    return isNaN(num) ? undefined : num;\n  }).optional(),\n  lightingHours: z.union([z.string(), z.number()]).transform((val) => {\n    if (val === \"\" || val === undefined || val === null) return undefined;\n    const num = typeof val === \"string\" ? parseFloat(val) : val;\n    return isNaN(num) ? undefined : num;\n  }).optional(),\n  feedConsumed: z.union([z.string(), z.number()]).transform((val) => {\n    if (val === \"\" || val === undefined || val === null) return undefined;\n    const num = typeof val === \"string\" ? parseFloat(val) : val;\n    return isNaN(num) ? undefined : num;\n  }).optional(),\n  averageWeight: z.union([z.string(), z.number()]).transform((val) => {\n    if (val === \"\" || val === undefined || val === null) return undefined;\n    const num = typeof val === \"string\" ? parseFloat(val) : val;\n    return isNaN(num) ? undefined : num;\n  }).optional(),\n  mortalityCount: z.union([z.string(), z.number()]).transform((val) => {\n    if (val === \"\" || val === undefined || val === null) return 0;\n    const num = typeof val === \"string\" ? parseInt(val) : val;\n    return isNaN(num) ? 0 : num;\n  }),\n  sampleSize: z.union([z.string(), z.number()]).transform((val) => {\n    if (val === \"\" || val === undefined || val === null) return 0;\n    const num = typeof val === \"string\" ? parseInt(val) : val;\n    return isNaN(num) ? 0 : num;\n  }),\n}).omit({\n  eggsCollected: true,\n  brokenEggs: true, \n  cratesProduced: true,\n});\n\ntype BroodingFormData = z.infer<typeof broodingFormSchema>;\n\ninterface BroodingRecordFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function BroodingRecordForm({ onSuccess }: BroodingRecordFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const form = useForm<BroodingFormData>({\n    resolver: zodResolver(broodingFormSchema),\n    defaultValues: {\n      recordDate: new Date().toISOString().split('T')[0],\n      mortalityCount: 0,\n      mortalityReason: \"\",\n      feedConsumed: undefined,\n      feedType: \"\",\n      temperature: undefined,\n      lightingHours: undefined,\n      averageWeight: undefined,\n      sampleSize: 0,\n      notes: \"\",\n    },\n  });\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  const createRecordMutation = useMutation({\n    mutationFn: async (data: BroodingFormData) => {\n      // Add default values for egg production fields to satisfy API\n      const recordData = {\n        ...data,\n        eggsCollected: 0,\n        brokenEggs: 0,\n        cratesProduced: 0,\n      };\n      await apiRequest(\"POST\", \"/api/daily-records\", recordData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Brooding record created successfully\",\n      });\n      form.reset();\n      onSuccess?.();\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create brooding record\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: BroodingFormData) => {\n    createRecordMutation.mutate(data);\n  };\n\n  return (\n    <Card data-testid=\"card-brooding-record-form\">\n      <CardHeader>\n        <CardTitle>Brooding Record</CardTitle>\n        <CardDescription>\n          Record daily brooding activities including temperature, lighting, feed consumption, and chick health.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"recordDate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Record Date</FormLabel>\n                    <FormControl>\n                      <Input type=\"date\" {...field} data-testid=\"input-record-date\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"flockId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Flock</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value || \"\"}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-flock\">\n                          <SelectValue placeholder=\"Select a flock\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {flocks.map((flock: any) => (\n                          <SelectItem key={flock.id} value={flock.id}>\n                            {flock.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            {/* Environment Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Environment Conditions</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"temperature\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Temperature (°C)</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          step=\"0.1\" \n                          {...field} \n                          value={field.value || \"\"}\n                          data-testid=\"input-temperature\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"lightingHours\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Lighting Hours</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          step=\"0.5\" \n                          {...field} \n                          value={field.value || \"\"}\n                          placeholder=\"e.g., 18\"\n                          data-testid=\"input-lighting-hours\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            {/* Mortality Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Mortality</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"mortalityCount\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Mortality Count</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          {...field} \n                          value={field.value || 0}\n                          onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                          data-testid=\"input-mortality-count\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"mortalityReason\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Mortality Reason</FormLabel>\n                      <FormControl>\n                        <Input \n                          {...field} \n                          value={field.value || \"\"}\n                          placeholder=\"e.g., Disease, Injury\" \n                          data-testid=\"input-mortality-reason\" \n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            {/* Feed Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Feed</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"feedConsumed\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Feed Consumed (kg)</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          step=\"0.01\" \n                          {...field} \n                          value={field.value || \"\"}\n                          data-testid=\"input-feed-consumed\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"feedType\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Feed Type</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value || \"\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-feed-type\">\n                            <SelectValue placeholder=\"Select feed type\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"chick-starter\">Chick Starter</SelectItem>\n                          <SelectItem value=\"broiler-starter\">Broiler Starter</SelectItem>\n                          <SelectItem value=\"chick-grower\">Chick Grower</SelectItem>\n                          <SelectItem value=\"medicated-starter\">Medicated Starter</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            {/* Weight Monitoring Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Weight Monitoring</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"averageWeight\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Average Weight (g)</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          step=\"0.1\" \n                          {...field} \n                          value={field.value || \"\"}\n                          data-testid=\"input-average-weight\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"sampleSize\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Sample Size</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          {...field} \n                          value={field.value || 0}\n                          onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                          data-testid=\"input-sample-size\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            {/* Notes */}\n            <FormField\n              control={form.control}\n              name=\"notes\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Notes</FormLabel>\n                  <FormControl>\n                    <Textarea \n                      {...field} \n                      value={field.value || \"\"}\n                      rows={3} \n                      data-testid=\"textarea-notes\" \n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <Button \n              type=\"submit\" \n              disabled={createRecordMutation.isPending}\n              data-testid=\"button-submit-brooding-record\"\n            >\n              {createRecordMutation.isPending ? \"Saving...\" : \"Save Brooding Record\"}\n            </Button>\n          </form>\n        </Form>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":14821},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"replit.md":{"content":"# KukuHub\n\n## Overview\nKukuHub is a comprehensive poultry farm management system designed for tracking layer chickens from chicks to eggs. It offers role-based access for managing farm operations, including brooding, egg production, feed, health, sales, and expense tracking. The system also features a marketplace for farmer-customer interaction, order placement, and delivery management. It provides real-time performance analytics and reporting to optimize poultry farm operations.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n### Development Workflow Requirements\n\n**CRITICAL: Architect Review Before Testing**\n- Never proceed with feature testing without first calling the architect to review if everything is working properly\n- If architect raises any issues, fix them immediately\n- Call architect again for review after fixes\n- Only proceed with E2E testing once architect has approved the implementation\n- This ensures quality and prevents wasted testing cycles on broken features\n\n## System Architecture\n\n### Frontend Architecture\n- **Framework**: React with TypeScript\n- **Routing**: Wouter\n- **State Management**: TanStack Query (React Query)\n- **UI Components**: Radix UI primitives with shadcn/ui\n- **Styling**: Tailwind CSS with CSS variables\n- **Build Tool**: Vite\n\n### Backend Architecture\n- **Runtime**: Node.js with Express.js\n- **Language**: TypeScript with ES modules\n- **API Design**: RESTful API\n- **Authentication**: Replit Auth with OpenID Connect\n- **Session Management**: Express sessions with PostgreSQL storage\n\n### Data Storage\n- **Database**: PostgreSQL with Neon serverless provider\n- **ORM**: Drizzle ORM\n- **Schema Validation**: Zod\n- **Migrations**: Drizzle Kit\n\n### Authentication & Authorization\n- **Provider**: Replit Auth with OIDC\n- **Session Storage**: PostgreSQL-backed sessions\n- **Role-Based Access**: Admin and staff roles\n- **Security**: HTTP-only cookies, secure session handling, CSRF protection\n\n### Key Features Architecture\n- **Dashboard**: Real-time metrics and analytics.\n- **Flock Management**: Lifecycle tracking from brooding to production.\n- **Daily Records**: Temperature, lighting, mortality, and production logging.\n- **Sales Tracking**: Egg sales, pricing, and customer management.\n- **Feed Inventory**: Stock levels, consumption, and low-stock alerts.\n- **Health Records**: Vaccination, treatments, and veterinary care tracking.\n- **Expense Management**: Operating cost tracking and categorization.\n- **Reporting**: Comprehensive analytics with filtering and export.\n- **User Management**: Multi-tenant role-based access control.\n- **Marketplace**: Customer-facing ordering system.\n- **Break-Even Analysis**: Dynamic calculation, historical data analysis, and what-if scenarios.\n- **Body Weight Tracking**: Advanced analytics with distribution histogram, CV% alerts, and professional reporting.\n- **Dynamic Alert System**: Real-time alerts for feed stock, mortality rate, vaccination schedules, and production efficiency drops.\n- **Egg Quality Metric**: Real-time quality tracking and classification on the dashboard.\n- **Dashboard Enhancement with Weekly Targets**: Displays week number, flock age, and age-based targets for temperature, lighting, feed, and weight.\n- **Trend Charts**: Visualizations for expense categories, monthly expenses, and daily production, featuring UTC-consistent date handling and zero-filling for continuity.\n- **Multi-Tenant Data Isolation**: Ensures data is correctly scoped to the active farm across all pages for admin users.\n\n## External Dependencies\n- **Database Hosting**: Neon PostgreSQL\n- **Authentication Provider**: Replit Auth service\n- **Development Platform**: Replit\n- **Font Services**: Google Fonts (Architects Daughter, DM Sans, Fira Code, Geist Mono)\n- **Build & Deployment**: Replit hosting\n\n## Recent Changes\n\n### Break-Even Analysis NaN Fix (November 10, 2025)\n- **CRITICAL BUG FIX**: Resolved \"KshNaN\" display in break-even analysis derived values\n- **Root Cause**: Property name mismatch between backend API response and frontend expectations\n  - Backend returned: `price`, `unitVariableCost`, `fixedCostsPerMonth`, `initialUnits`, `growthRate`\n  - Frontend expected: `averagePrice`, `averageUnitVariableCost`, `averageFixedCostsPerMonth`, `averageMonthlyUnits`, `calculatedGrowthRate`\n- **TypeScript Interface Updates** (client/src/pages/reports.tsx):\n  - Updated `BreakEvenMetrics` interface derivedValues to match backend API properties\n  - Added missing `seasonalityFactors: number[]` field\n  - Added complete `dataQuality` interface with all backend response fields\n- **Defensive Formatting** (formatCurrency function):\n  - Changed signature to accept `number | undefined | null`\n  - Added guard: `if (value == null || !isFinite(value)) return \"N/A\"`\n  - Prevents NaN, undefined, null, and Infinity from reaching currency formatter\n- **Property Reference Updates**:\n  - Fixed all display cards to use correct property names: `.price`, `.unitVariableCost`, `.fixedCostsPerMonth`, `.initialUnits`, `.growthRate`\n  - Updated CSV export to use correct properties and improved labels\n- **Auto-Recalculation**:\n  - Rolling window period selector properly wired with `setRollingWindow`\n  - Query key includes `rollingWindow`: `[\"/api/breakeven/metrics\", rollingWindow, activeFarmId]`\n  - TanStack Query automatically refetches when period changes (3/6/12 months)\n- **Impact**: Break-even derived values now display actual currency and number values instead of \"KshNaN\", with automatic recalculation when switching time periods\n- **Architect Validated**: Comprehensive review confirmed interface matches backend contract, defensive guards prevent NaN display, and period selector triggers automatic refetch\n\n### Sales History Empty State & Farm Context UX Improvements (November 10, 2025)\n- **UX ENHANCEMENT**: Improved empty state messaging and farm selection experience for admin users\n- **Context-Aware Empty State** (client/src/pages/egg-production.tsx):\n  - Sales History tab now shows current farm name in empty state: \"No Sales Records for [Farm Name]\"\n  - Explains why data is missing: \"This farm doesn't have any sales data yet\"\n  - Provides actionable CTAs:\n    - \"View Demo Farm Data\" button - switches to Demo Farm and shows toast (only visible when demo farm exists and user is on different farm)\n    - \"Record First Sale\" button - opens sales dialog to add first sale\n  - Uses FarmContext to dynamically detect current farm and demo farm availability\n- **Farm Indicator Badge** (client/src/pages/egg-production.tsx):\n  - Added badge next to \"Egg Production\" page title showing current farm name\n  - Uses 'default' variant (highlighted) for Demo Farm\n  - Uses 'outline' variant for other farms\n  - Updates automatically when farm is switched via sidebar selector\n- **FarmContext Persistence & Auto-Selection** (client/src/contexts/FarmContext.tsx):\n  - **localStorage Persistence**: Admin farm selections now persist across page reloads\n  - **Demo Farm Preference**: New admin users automatically land on \"🎯 Demo Farm - Sample Data\" (if exists) to see example data\n  - **Returning User Experience**: Admin users see their last manually selected farm on subsequent logins\n  - **Security Hardening**:\n    - localStorage only read AFTER role validation (prevents unauthorized farm access during hydration)\n    - Saved farm validated against current farms list before restoration\n    - ALL setActiveFarmId calls use persistence wrapper to keep localStorage in sync\n    - Logout properly clears localStorage to prevent cross-session farm leakage\n  - **Persistence Key**: `kukuhub_selected_farm_id` in localStorage\n  - **Role Handling**:\n    - Admin: Restores last selection (if valid) or prefers Demo Farm, persists manual changes\n    - Customer: Clears localStorage, sets farm to null\n    - Non-admin farm users: Persists their assigned farmId\n- **Impact**: \n  - Users always know which farm they're viewing (badge indicator)\n  - Clear guidance when viewing farms without data (context-aware empty state)\n  - New admins immediately see sample data instead of empty farms\n  - Farm selections survive page reloads and browser sessions\n  - No unauthorized farm access or stale data across user sessions\n- **Architect Validated**: Three-iteration review confirmed empty state, badge, and FarmContext changes meet requirements without security regressions\n\n### Body Weight Histogram Zero-Range Bug Fix (November 11, 2025)\n- **CRITICAL BUG FIX**: Resolved runtime error \"Cannot read properties of undefined (reading 'frequency')\" in body weight histogram\n- **Root Cause**: When all weight records had identical values, the histogram calculation failed\n  - `range = max - min = 0`\n  - `binWidth = range / binCount = 0`\n  - `binIndex = (weight - min) / binWidth = NaN` (division by zero)\n  - `bins[NaN]` = undefined → error when accessing `.frequency` property\n- **The Fix** (client/src/pages/body-weights.tsx):\n  - **Zero-range guard** (lines 195-204): Detects when all weights are identical and returns a single bin with all frequencies\n  - **StdDev guard** (lines 225-233): Only calculates normal distribution density when `stdDev > 0` to prevent division by zero\n- **Impact**: Weight records with uniform values (e.g., all birds weigh 1kg) now render correctly with a single histogram bar instead of crashing\n- **Architect Validated**: Confirmed fix properly handles edge cases, prevents NaN bin indices, and downstream chart components handle single-bin datasets gracefully","size_bytes":9530},"client/src/contexts/FarmContext.tsx":{"content":"import { createContext, useContext, useEffect, useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { useAuth } from '@/hooks/useAuth';\n\ninterface Farm {\n  id: string;\n  name: string;\n  location: string;\n  isApproved: boolean;\n  status: string;\n}\n\ninterface FarmContextValue {\n  activeFarmId: string | null;\n  setActiveFarmId: (farmId: string | null) => void;\n  farms: Farm[];\n  isLoading: boolean;\n  error: string | null;\n  hasActiveFarm: boolean;\n}\n\nconst FarmContext = createContext<FarmContextValue | null>(null);\n\nexport function useFarmContext() {\n  const context = useContext(FarmContext);\n  if (!context) {\n    throw new Error('useFarmContext must be used within a FarmProvider');\n  }\n  return context;\n}\n\ninterface FarmProviderProps {\n  children: React.ReactNode;\n}\n\nconst FARM_SELECTION_KEY = 'kukuhub_selected_farm_id';\n\nexport function FarmProvider({ children }: FarmProviderProps) {\n  const { user, isAuthenticated } = useAuth();\n  // Don't hydrate from localStorage on initial load to prevent unauthorized access\n  // The useEffect will restore it after role validation\n  const [activeFarmId, setActiveFarmId] = useState<string | null>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  // Wrapper for setActiveFarmId that persists to localStorage\n  const setActiveFarmIdWithPersistence = (farmId: string | null) => {\n    setActiveFarmId(farmId);\n    if (typeof window !== 'undefined') {\n      if (farmId) {\n        localStorage.setItem(FARM_SELECTION_KEY, farmId);\n      } else {\n        localStorage.removeItem(FARM_SELECTION_KEY);\n      }\n    }\n  };\n\n  // Fetch farms for admin users or user's farm for non-admin users\n  const { data: farms = [], isLoading } = useQuery<Farm[]>({\n    queryKey: ['/api/farms'],\n    enabled: isAuthenticated && !!user,\n  });\n\n  // Automatically set active farm based on user role\n  useEffect(() => {\n    if (!user || !isAuthenticated) {\n      setActiveFarmIdWithPersistence(null);\n      setError(null);\n      return;\n    }\n\n    if (user.role === 'admin') {\n      // Admin users: restore from localStorage or auto-select\n      if (!activeFarmId && farms.length > 0) {\n        // Try to restore last selected farm from localStorage\n        const savedFarmId = typeof window !== 'undefined' ? localStorage.getItem(FARM_SELECTION_KEY) : null;\n        \n        // Validate saved farm exists in current farm list\n        if (savedFarmId && farms.some(f => f.id === savedFarmId)) {\n          setActiveFarmIdWithPersistence(savedFarmId);\n          setError(null);\n        } else {\n          // No valid saved farm, prefer Demo Farm or first farm\n          const demoFarm = farms.find(f => f.name.includes('Demo Farm'));\n          const selectedFarm = demoFarm || farms[0];\n          setActiveFarmIdWithPersistence(selectedFarm.id);\n          setError(null);\n        }\n      } else if (activeFarmId && !farms.some(farm => farm.id === activeFarmId)) {\n        // Selected farm no longer exists (e.g., deleted), reset to Demo Farm or first farm\n        if (farms.length > 0) {\n          const demoFarm = farms.find(f => f.name.includes('Demo Farm'));\n          const selectedFarm = demoFarm || farms[0];\n          setActiveFarmIdWithPersistence(selectedFarm.id);\n        } else {\n          setActiveFarmIdWithPersistence(null);\n        }\n        setError(null);\n      }\n    } else if (user.role === 'customer') {\n      // Customer users: no farm needed, clear any persisted farm\n      setActiveFarmIdWithPersistence(null);\n      setError(null);\n    } else {\n      // Non-admin farm users: use their assigned farmId\n      if (user.farmId) {\n        setActiveFarmIdWithPersistence(user.farmId);\n        setError(null);\n      } else {\n        setError('You are not associated with any farm. Please contact an administrator.');\n        setActiveFarmIdWithPersistence(null);\n      }\n    }\n    // Note: activeFarmId intentionally NOT in dependency array to prevent loops\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [user, isAuthenticated, farms]);\n\n  const hasActiveFarm = !!activeFarmId || user?.role === 'customer';\n\n  const contextValue: FarmContextValue = {\n    activeFarmId,\n    setActiveFarmId: setActiveFarmIdWithPersistence,\n    farms,\n    isLoading,\n    error,\n    hasActiveFarm,\n  };\n\n  return (\n    <FarmContext.Provider value={contextValue}>\n      {children}\n    </FarmContext.Provider>\n  );\n}","size_bytes":4404},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar-background)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":2766},"client/src/components/forms/simple-quick-egg-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface SimpleQuickEggFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function SimpleQuickEggForm({ onSuccess }: SimpleQuickEggFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Form state\n  const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);\n  const [flockId, setFlockId] = useState(\"\");\n  const [eggsCollected, setEggsCollected] = useState(\"\");\n  const [brokenEggs, setBrokenEggs] = useState(\"\");\n  const [cratesProduced, setCratesProduced] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  // Auto-calculate crates produced\n  useEffect(() => {\n    const eggs = parseInt(eggsCollected) || 0;\n    const calculatedCrates = Math.floor(eggs / 30);\n    setCratesProduced(calculatedCrates.toString());\n  }, [eggsCollected]);\n\n  const createEggRecordMutation = useMutation({\n    mutationFn: async (data: any) => {\n      console.log(\"Submitting quick egg record:\", data);\n      await apiRequest(\"POST\", \"/api/daily-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Egg collection recorded successfully\"\n      });\n      \n      // Reset form\n      setRecordDate(new Date().toISOString().split('T')[0]);\n      setFlockId(\"\");\n      setEggsCollected(\"\");\n      setBrokenEggs(\"\");\n      setCratesProduced(\"\");\n      setNotes(\"\");\n      \n      if (onSuccess) onSuccess();\n    },\n    onError: (error: any) => {\n      console.error(\"Failed to create egg record:\", error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to record eggs. Please try again.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!flockId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a flock\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!eggsCollected || parseInt(eggsCollected) < 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter valid number of eggs collected\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const recordData = {\n      recordDate,\n      flockId,\n      eggsCollected: parseInt(eggsCollected) || 0,\n      brokenEggs: parseInt(brokenEggs) || 0,\n      cratesProduced: parseInt(cratesProduced) || 0,\n      mortalityCount: 0,\n      mortalityReason: null,\n      feedConsumed: null,\n      feedType: null,\n      temperature: null,\n      lightingHours: null,\n      averageWeight: null,\n      sampleSize: 0,\n      notes: notes.trim(),\n    };\n\n    createEggRecordMutation.mutate(recordData);\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"flockId\">Flock</Label>\n        <Select value={flockId} onValueChange={setFlockId} required>\n          <SelectTrigger data-testid=\"select-quick-egg-flock\">\n            <SelectValue placeholder=\"Select flock\" />\n          </SelectTrigger>\n          <SelectContent>\n            {flocks.map((flock) => (\n              <SelectItem key={flock.id} value={flock.id}>\n                {flock.name} ({flock.currentCount} birds)\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"recordDate\">Date</Label>\n        <Input\n          id=\"recordDate\"\n          type=\"date\"\n          value={recordDate}\n          onChange={(e) => setRecordDate(e.target.value)}\n          required\n          data-testid=\"input-egg-date\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"eggsCollected\">Eggs Collected</Label>\n        <Input\n          id=\"eggsCollected\"\n          type=\"number\"\n          value={eggsCollected}\n          onChange={(e) => setEggsCollected(e.target.value)}\n          placeholder=\"150\"\n          required\n          data-testid=\"input-eggs-collected\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"brokenEggs\">Broken Eggs</Label>\n        <Input\n          id=\"brokenEggs\"\n          type=\"number\"\n          value={brokenEggs}\n          onChange={(e) => setBrokenEggs(e.target.value)}\n          placeholder=\"5\"\n          data-testid=\"input-broken-eggs\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"cratesProduced\">Crates Produced</Label>\n        <Input\n          id=\"cratesProduced\"\n          type=\"number\"\n          value={cratesProduced}\n          readOnly\n          className=\"bg-muted\"\n          placeholder=\"Auto-calculated\"\n          data-testid=\"input-crates-produced\"\n        />\n        <p className=\"text-xs text-muted-foreground\">\n          Auto-calculated: 30 eggs = 1 crate\n        </p>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"notes\">Notes (Optional)</Label>\n        <Input\n          id=\"notes\"\n          value={notes}\n          onChange={(e) => setNotes(e.target.value)}\n          placeholder=\"Any observations about today's collection\"\n          data-testid=\"input-egg-notes\"\n        />\n      </div>\n\n      <Button \n        type=\"submit\" \n        className=\"w-full\" \n        disabled={createEggRecordMutation.isPending}\n        data-testid=\"button-submit-eggs\"\n      >\n        {createEggRecordMutation.isPending ? \"Recording...\" : \"Record Eggs\"}\n      </Button>\n    </form>\n  );\n}","size_bytes":6199},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/pages/farm-registration.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { insertFarmSchema, type InsertFarm } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Building2, Phone, Mail, MapPin, Award, Users, CheckCircle, ArrowLeft } from \"lucide-react\";\nimport { z } from \"zod\";\n\n// Custom form schema to handle UI fields that need transformation\nconst farmRegistrationSchema = insertFarmSchema.extend({\n  city: z.string().min(1, \"City is required\"),\n  state: z.string().min(1, \"State is required\"),\n  postalCode: z.string().min(1, \"Postal code is required\"),\n  country: z.string().min(1, \"Country is required\"),\n  acceptTerms: z.boolean().refine(val => val === true, \"You must accept the terms\")\n}).omit({ location: true }); // We'll construct location from city and state\n\ntype FarmFormData = z.infer<typeof farmRegistrationSchema>;\n\nexport function FarmRegistrationPage() {\n  const [, setLocation] = useLocation();\n  const [isSuccess, setIsSuccess] = useState(false);\n  const [registeredFarmName, setRegisteredFarmName] = useState(\"\");\n  const { toast } = useToast();\n\n  const form = useForm<FarmFormData>({\n    resolver: zodResolver(farmRegistrationSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      contactEmail: \"\",\n      contactPhone: \"\",\n      address: \"\",\n      city: \"\",\n      state: \"\",\n      postalCode: \"\",\n      country: \"\",\n      specialization: \"layers\",\n      totalBirds: 0,\n      certifications: \"\",\n      website: \"\",\n      acceptTerms: false\n    }\n  });\n\n  const createFarmMutation = useMutation({\n    mutationFn: (farmData: InsertFarm) =>\n      apiRequest(\"POST\", \"/api/farms\", farmData),\n    onSuccess: (farm) => {\n      // SECURITY FIX: Invalidate both farms and user context to update farmId/role\n      queryClient.invalidateQueries({ queryKey: [\"/api/farms\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      \n      setRegisteredFarmName((farm as any)?.name || 'your farm');\n      setIsSuccess(true);\n      toast({\n        title: \"Farm registered successfully!\",\n        description: `Welcome to KukuHub! Your farm registration is complete.`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Registration failed\",\n        description: error.message || \"Failed to register farm. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: FarmFormData) => {\n    const { acceptTerms, city, state, postalCode, country, ...farmData } = data;\n    \n    // Construct location from city and state\n    const location = `${city}, ${state}`;\n    \n    // Construct full address\n    const fullAddress = `${data.address}, ${city}, ${state} ${postalCode}, ${country}`;\n    \n    const submitData: InsertFarm = {\n      ...farmData,\n      location,\n      address: fullAddress\n    };\n    \n    createFarmMutation.mutate(submitData);\n  };\n\n  // Success page\n  if (isSuccess) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4\">\n        <div className=\"max-w-2xl mx-auto\">\n          <Card className=\"shadow-xl\">\n            <CardContent className=\"text-center py-12 space-y-6\">\n              <CheckCircle className=\"h-16 w-16 mx-auto text-green-500\" />\n              <div>\n                <h2 className=\"text-2xl font-bold text-green-600 mb-2\">Farm Registration Successful!</h2>\n                <p className=\"text-gray-600 mb-4\">\n                  Welcome to KukuHub! Your farm \"{registeredFarmName}\" has been registered successfully.\n                </p>\n              </div>\n              \n              <div className=\"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg\">\n                <h3 className=\"font-semibold mb-2\">What's Next?</h3>\n                <ul className=\"text-sm text-gray-600 dark:text-gray-400 space-y-1 text-left\">\n                  <li>• Log in to access your farm management dashboard</li>\n                  <li>• Set up your flock records and daily operations</li>\n                  <li>• Create products to sell in the marketplace</li>\n                  <li>• Connect with customers and manage orders</li>\n                  <li>• Track production, sales, and analytics</li>\n                </ul>\n              </div>\n\n              <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n                <Button \n                  size=\"lg\" \n                  onClick={() => window.location.href = \"/api/login\"}\n                  data-testid=\"button-login-farm\"\n                >\n                  Login to Your Farm Dashboard\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"lg\" \n                  onClick={() => setLocation(\"/marketplace\")}\n                  data-testid=\"button-browse-marketplace\"\n                >\n                  Browse Marketplace\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4\">\n      <div className=\"max-w-4xl mx-auto\">\n        <div className=\"text-center mb-8\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <Building2 className=\"h-12 w-12 text-green-600 mr-3\" />\n            <h1 className=\"text-4xl font-bold text-gray-900\">Farm Registration</h1>\n          </div>\n          <p className=\"text-xl text-gray-600\">\n            Join the KukuHub marketplace and start managing your poultry operations\n          </p>\n        </div>\n\n        <Card className=\"shadow-xl\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center text-2xl\">\n              <Users className=\"h-6 w-6 mr-2\" />\n              Register Your Poultry Farm\n            </CardTitle>\n            <CardDescription>\n              Complete your farm profile to join our marketplace platform and connect with customers\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n                {/* Basic Information */}\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div className=\"space-y-4\">\n                    <h3 className=\"text-lg font-semibold flex items-center\">\n                      <Building2 className=\"h-5 w-5 mr-2\" />\n                      Farm Information\n                    </h3>\n                    \n                    <FormField\n                      control={form.control}\n                      name=\"name\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Farm Name *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"Enter your farm name\" \n                              data-testid=\"input-farm-name\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"specialization\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Farm Type *</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value || \"\"}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-farm-type\">\n                                <SelectValue placeholder=\"Select farm type\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"layers\">Layer Farm (Egg Production)</SelectItem>\n                              <SelectItem value=\"broilers\">Broiler Farm (Meat Production)</SelectItem>\n                              <SelectItem value=\"mixed\">Mixed Farm (Eggs & Meat)</SelectItem>\n                              <SelectItem value=\"breeding\">Breeding Farm</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"totalBirds\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Farm Capacity (Number of Birds)</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"number\" \n                              placeholder=\"Total bird capacity\"\n                              data-testid=\"input-capacity\"\n                              {...field}\n                              value={field.value || 0}\n                              onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"description\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Farm Description</FormLabel>\n                          <FormControl>\n                            <Textarea \n                              placeholder=\"Tell customers about your farm, practices, and specialties...\"\n                              data-testid=\"textarea-description\"\n                              className=\"min-h-[100px]\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  {/* Contact Information */}\n                  <div className=\"space-y-4\">\n                    <h3 className=\"text-lg font-semibold flex items-center\">\n                      <Phone className=\"h-5 w-5 mr-2\" />\n                      Contact Information\n                    </h3>\n\n\n                    <FormField\n                      control={form.control}\n                      name=\"contactEmail\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Email Address *</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"email\" \n                              placeholder=\"contact@yourfarm.com\"\n                              data-testid=\"input-email\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"contactPhone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Phone Number *</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"tel\" \n                              placeholder=\"+1 (555) 123-4567\"\n                              data-testid=\"input-phone\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"website\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Website URL</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"url\" \n                              placeholder=\"https://www.yourfarm.com\"\n                              data-testid=\"input-website\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Address Information */}\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-lg font-semibold flex items-center\">\n                    <MapPin className=\"h-5 w-5 mr-2\" />\n                    Farm Address\n                  </h3>\n                  \n                  <FormField\n                    control={form.control}\n                    name=\"address\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Street Address *</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Farm physical address\"\n                            data-testid=\"input-address\"\n                            {...field}\n                            value={field.value || \"\"}\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"city\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>City *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"City\"\n                              data-testid=\"input-city\"\n                              {...field} \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"state\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>State/Province *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"State\"\n                              data-testid=\"input-state\"\n                              {...field} \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"postalCode\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Postal Code *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"ZIP/Postal\"\n                              data-testid=\"input-postal-code\"\n                              {...field} \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"country\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Country *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"Country\"\n                              data-testid=\"input-country\"\n                              {...field} \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Certifications */}\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-lg font-semibold flex items-center\">\n                    <Award className=\"h-5 w-5 mr-2\" />\n                    Certifications & Standards\n                  </h3>\n                  <p className=\"text-sm text-gray-600\">\n                    Select any certifications or standards your farm follows (optional)\n                  </p>\n                  \n                  <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\n                    {[\n                      \"Organic Certified\",\n                      \"Free Range\",\n                      \"Cage Free\",\n                      \"Pasture Raised\",\n                      \"Animal Welfare Approved\",\n                      \"Non-GMO Verified\",\n                      \"Humane Certified\",\n                      \"USDA Certified\",\n                      \"ISO 22000\",\n                      \"HACCP Certified\"\n                    ].map((cert) => (\n                      <FormField\n                        key={cert}\n                        control={form.control}\n                        name=\"certifications\"\n                        render={({ field }) => {\n                          const currentCerts = field.value ? field.value.split(', ').filter(Boolean) : [];\n                          const isChecked = currentCerts.includes(cert);\n                          \n                          return (\n                            <FormItem className=\"flex flex-row items-start space-x-3 space-y-0\">\n                              <FormControl>\n                                <Checkbox\n                                  data-testid={`checkbox-cert-${cert.toLowerCase().replace(/\\s+/g, '-')}`}\n                                  checked={isChecked}\n                                  onCheckedChange={(checked) => {\n                                    if (checked) {\n                                      const newCerts = [...currentCerts, cert];\n                                      field.onChange(newCerts.join(', '));\n                                    } else {\n                                      const newCerts = currentCerts.filter((item) => item !== cert);\n                                      field.onChange(newCerts.join(', '));\n                                    }\n                                  }}\n                                />\n                              </FormControl>\n                              <FormLabel className=\"text-sm font-normal\">\n                                {cert}\n                              </FormLabel>\n                            </FormItem>\n                          );\n                        }}\n                      />\n                    ))}\n                  </div>\n                </div>\n\n                {/* Terms and Conditions */}\n                <div className=\"space-y-4 border-t pt-6\">\n                  <FormField\n                    control={form.control}\n                    name=\"acceptTerms\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex flex-row items-start space-x-3 space-y-0\">\n                        <FormControl>\n                          <Checkbox\n                            data-testid=\"checkbox-accept-terms\"\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                          />\n                        </FormControl>\n                        <div className=\"space-y-1 leading-none\">\n                          <FormLabel className=\"text-sm font-normal\">\n                            I accept the Terms of Service and Privacy Policy *\n                          </FormLabel>\n                          <p className=\"text-xs text-gray-500\">\n                            By registering, you agree to our marketplace terms and data handling practices\n                          </p>\n                        </div>\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"flex gap-4\">\n                  <Button\n                    type=\"submit\"\n                    className=\"flex-1\"\n                    disabled={createFarmMutation.isPending}\n                    data-testid=\"button-register-farm\"\n                  >\n                    {createFarmMutation.isPending ? \"Registering...\" : \"Register Farm\"}\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setLocation(\"/\")}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","size_bytes":22585},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1383},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/dashboard/notification-panel.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  DropdownMenu, \n  DropdownMenuContent, \n  DropdownMenuItem, \n  DropdownMenuTrigger,\n  DropdownMenuLabel,\n  DropdownMenuSeparator\n} from \"@/components/ui/dropdown-menu\";\nimport { Bell, AlertTriangle, Info, CheckCircle, Clock, X } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface Notification {\n  id: string;\n  title: string;\n  message: string;\n  type: \"alert\" | \"info\" | \"success\" | \"warning\";\n  timestamp: string;\n  read: boolean;\n}\n\nexport default function NotificationPanel() {\n  const [notifications, setNotifications] = useState<Notification[]>([\n    {\n      id: \"1\",\n      title: \"Low Feed Stock Alert\",\n      message: \"Feed levels are running low. Only 5 days remaining for Flock Alpha.\",\n      type: \"warning\",\n      timestamp: \"2 hours ago\",\n      read: false,\n    },\n    {\n      id: \"2\", \n      title: \"High Mortality Rate\",\n      message: \"Unusual mortality rate detected in Flock Beta. Consider veterinary check.\",\n      type: \"alert\",\n      timestamp: \"4 hours ago\", \n      read: false,\n    },\n    {\n      id: \"3\",\n      title: \"Production Goal Achieved\",\n      message: \"Daily egg production exceeded target by 12%. Great work!\",\n      type: \"success\",\n      timestamp: \"1 day ago\",\n      read: true,\n    },\n    {\n      id: \"4\",\n      title: \"Temperature Alert\",\n      message: \"Brooding temperature dropped below recommended range in Coop 1.\",\n      type: \"warning\", \n      timestamp: \"2 days ago\",\n      read: false,\n    },\n    {\n      id: \"5\",\n      title: \"Vaccination Reminder\",\n      message: \"Newcastle disease vaccination due for Flock Charlie in 3 days.\",\n      type: \"info\",\n      timestamp: \"3 days ago\",\n      read: true,\n    },\n  ]);\n\n  // Get metrics for generating dynamic alerts\n  const { data: metrics = {} } = useQuery<any>({\n    queryKey: [\"/api/dashboard/metrics\"],\n  });\n\n  const unreadCount = notifications.filter(n => !n.read).length;\n\n  const markAsRead = (id: string) => {\n    setNotifications(prev => \n      prev.map(n => n.id === id ? { ...n, read: true } : n)\n    );\n  };\n\n  const markAllAsRead = () => {\n    setNotifications(prev => prev.map(n => ({ ...n, read: true })));\n  };\n\n  const removeNotification = (id: string) => {\n    setNotifications(prev => prev.filter(n => n.id !== id));\n  };\n\n  const getIcon = (type: string) => {\n    switch (type) {\n      case \"alert\": return <AlertTriangle className=\"h-4 w-4 text-red-500\" />;\n      case \"warning\": return <AlertTriangle className=\"h-4 w-4 text-orange-500\" />;\n      case \"success\": return <CheckCircle className=\"h-4 w-4 text-green-500\" />;\n      case \"info\": return <Info className=\"h-4 w-4 text-blue-500\" />;\n      default: return <Bell className=\"h-4 w-4\" />;\n    }\n  };\n\n  const getBadgeVariant = (type: string) => {\n    switch (type) {\n      case \"alert\": return \"destructive\";\n      case \"warning\": return \"secondary\";\n      case \"success\": return \"default\";\n      case \"info\": return \"outline\";\n      default: return \"secondary\";\n    }\n  };\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button \n          variant=\"ghost\" \n          size=\"icon\"\n          className=\"relative\"\n          data-testid=\"button-notifications\"\n        >\n          <Bell className=\"h-5 w-5\" />\n          {unreadCount > 0 && (\n            <span className=\"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center\">\n              {unreadCount > 9 ? \"9+\" : unreadCount}\n            </span>\n          )}\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent \n        align=\"end\" \n        className=\"w-80\"\n        data-testid=\"dropdown-notifications\"\n      >\n        <div className=\"flex items-center justify-between px-2 py-2\">\n          <DropdownMenuLabel>Notifications ({unreadCount} new)</DropdownMenuLabel>\n          {unreadCount > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={markAllAsRead}\n              className=\"text-xs\"\n              data-testid=\"button-mark-all-read\"\n            >\n              Mark all read\n            </Button>\n          )}\n        </div>\n        <DropdownMenuSeparator />\n        \n        <ScrollArea className=\"h-80\">\n          <div className=\"space-y-1\">\n            {notifications.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center py-6 text-muted-foreground\">\n                <Bell className=\"h-8 w-8 mb-2\" />\n                <p className=\"text-sm\">No notifications</p>\n              </div>\n            ) : (\n              notifications.map((notification) => (\n                <DropdownMenuItem\n                  key={notification.id}\n                  className={`flex flex-col items-start p-3 cursor-pointer ${\n                    !notification.read ? \"bg-blue-50 dark:bg-blue-950\" : \"\"\n                  }`}\n                  onClick={() => markAsRead(notification.id)}\n                  data-testid={`notification-${notification.id}`}\n                >\n                  <div className=\"flex items-start justify-between w-full\">\n                    <div className=\"flex items-start space-x-2 flex-1\">\n                      {getIcon(notification.type)}\n                      <div className=\"space-y-1 flex-1 min-w-0\">\n                        <div className=\"flex items-center space-x-2\">\n                          <p className=\"text-sm font-medium truncate\">\n                            {notification.title}\n                          </p>\n                          <Badge \n                            variant={getBadgeVariant(notification.type)}\n                            className=\"text-xs\"\n                          >\n                            {notification.type}\n                          </Badge>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                          {notification.message}\n                        </p>\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-xs text-muted-foreground flex items-center\">\n                            <Clock className=\"h-3 w-3 mr-1\" />\n                            {notification.timestamp}\n                          </span>\n                          {!notification.read && (\n                            <div className=\"w-2 h-2 bg-blue-500 rounded-full\"></div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        removeNotification(notification.id);\n                      }}\n                      className=\"ml-2 h-6 w-6 p-0\"\n                      data-testid={`button-remove-${notification.id}`}\n                    >\n                      <X className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                </DropdownMenuItem>\n              ))\n            )}\n          </div>\n        </ScrollArea>\n        \n        {notifications.length > 0 && (\n          <>\n            <DropdownMenuSeparator />\n            <DropdownMenuItem className=\"justify-center\">\n              <Button variant=\"ghost\" size=\"sm\" className=\"text-xs\">\n                View All Notifications\n              </Button>\n            </DropdownMenuItem>\n          </>\n        )}\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}","size_bytes":7876},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/pages/landing.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Sprout, Egg, BarChart3, Shield, ShoppingCart, Users } from \"lucide-react\";\n\nexport default function Landing() {\n  const handleLogin = (roleIntent?: string) => {\n    // Store user's role intent for post-login routing\n    if (roleIntent) {\n      sessionStorage.setItem('userRoleIntent', roleIntent);\n    }\n    window.location.href = \"/api/login\";\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20\">\n      <div className=\"container mx-auto px-4 py-16\">\n        {/* Header */}\n        <div className=\"text-center mb-16\">\n          <div className=\"flex justify-center mb-6\">\n            <div className=\"w-16 h-16 bg-primary rounded-full flex items-center justify-center\">\n              <Sprout className=\"w-8 h-8 text-primary-foreground\" />\n            </div>\n          </div>\n          <h1 className=\"text-4xl md:text-6xl font-bold text-foreground mb-4\">\n            KukuHub\n          </h1>\n          <p className=\"text-xl text-muted-foreground max-w-2xl mx-auto mb-8\">\n            Comprehensive poultry farm management platform with integrated marketplace for tracking layers production from chicks to eggs, customer interactions, and order management.\n          </p>\n          <div className=\"space-y-4\">\n            <Button size=\"lg\" onClick={() => handleLogin()} data-testid=\"button-sign-in\" className=\"text-lg px-8 py-6\">\n              Sign In\n            </Button>\n            <div className=\"flex flex-col sm:flex-row gap-3 justify-center\">\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={() => handleLogin('farmer')} \n                data-testid=\"button-farmer-intent\"\n                className=\"px-6 py-3\"\n              >\n                <Users className=\"w-4 h-4 mr-2\" />\n                I'm a Farmer\n              </Button>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={() => handleLogin('customer')} \n                data-testid=\"button-customer-intent\"\n                className=\"px-6 py-3\"\n              >\n                <ShoppingCart className=\"w-4 h-4 mr-2\" />\n                I'm a Customer\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Features */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-16\">\n          <Card data-testid=\"card-feature-brooding\">\n            <CardHeader>\n              <div className=\"w-12 h-12 bg-chart-3/10 rounded-lg flex items-center justify-center mb-4\">\n                <Sprout className=\"w-6 h-6 text-chart-3\" />\n              </div>\n              <CardTitle>Chick Brooding</CardTitle>\n              <CardDescription>\n                Track temperature, lighting, mortality, and feed from day-old chicks through the brooding period.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card data-testid=\"card-feature-production\">\n            <CardHeader>\n              <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center mb-4\">\n                <Egg className=\"w-6 h-6 text-chart-2\" />\n              </div>\n              <CardTitle>Egg Production</CardTitle>\n              <CardDescription>\n                Monitor daily egg collection, sales tracking, and production performance with automated alerts.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card data-testid=\"card-feature-marketplace\">\n            <CardHeader>\n              <div className=\"w-12 h-12 bg-chart-4/10 rounded-lg flex items-center justify-center mb-4\">\n                <ShoppingCart className=\"w-6 h-6 text-chart-4\" />\n              </div>\n              <CardTitle>Marketplace</CardTitle>\n              <CardDescription>\n                Connect with customers, manage orders, and sell your farm products through our integrated marketplace.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card data-testid=\"card-feature-analytics\">\n            <CardHeader>\n              <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center mb-4\">\n                <BarChart3 className=\"w-6 h-6 text-primary\" />\n              </div>\n              <CardTitle>Analytics & Reports</CardTitle>\n              <CardDescription>\n                Comprehensive dashboard with charts, trends, and insights to optimize your farm operations.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n        </div>\n\n        {/* Key Benefits */}\n        <Card className=\"max-w-4xl mx-auto\" data-testid=\"card-benefits\">\n          <CardHeader className=\"text-center\">\n            <CardTitle className=\"text-2xl\">Why Choose KukuHub?</CardTitle>\n            <CardDescription>Built specifically for East African poultry farmers managing large-scale layer operations</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div className=\"flex items-start space-x-3\">\n                <div className=\"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0\">\n                  <Shield className=\"w-4 h-4 text-primary\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold mb-2\">Role-Based Access</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Secure multi-user system with admin and staff roles for proper data management.\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex items-start space-x-3\">\n                <div className=\"w-8 h-8 bg-chart-3/10 rounded-full flex items-center justify-center flex-shrink-0\">\n                  <BarChart3 className=\"w-4 h-4 text-chart-3\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold mb-2\">Real-time Monitoring</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Live dashboards with alerts for production drops, feed shortages, and health issues.\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex items-start space-x-3\">\n                <div className=\"w-8 h-8 bg-chart-2/10 rounded-full flex items-center justify-center flex-shrink-0\">\n                  <Egg className=\"w-4 h-4 text-chart-2\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold mb-2\">Complete Lifecycle Tracking</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    From day-old chicks to mature laying hens, track every aspect of your operation.\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex items-start space-x-3\">\n                <div className=\"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0\">\n                  <Sprout className=\"w-4 h-4 text-primary\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold mb-2\">Mobile-First Design</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Optimized for use on the farm with responsive design for all devices.\n                  </p>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Footer */}\n        <div className=\"text-center mt-16 text-muted-foreground\">\n          <p>Ready to optimize your poultry farm operations?</p>\n          <Button variant=\"outline\" onClick={() => handleLogin()} className=\"mt-4\" data-testid=\"button-login-footer\">\n            Sign In to Get Started\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8027},"client/src/components/forms/SalesForm.tsx":{"content":"import { useEffect, useMemo } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { insertSaleSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { useSaleMutation } from \"../../hooks/useSales\";\n\n// UI-specific validation schema that extends the shared schema\nconst salesFormSchema = insertSaleSchema.extend({\n  saleDate: z.string().min(1, \"Sale date is required\"),\n  customerName: z.string().min(1, \"Customer name is required\"),\n  cratesSold: z.number().min(1, \"Must sell at least 1 crate\"),\n  pricePerCrate: z.string().min(1, \"Price per crate is required\").refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\n    \"Price must be a positive number\"\n  ),\n  totalAmount: z.string().optional(), // Auto-calculated, so optional in form\n  paymentStatus: z.enum([\"pending\", \"paid\", \"overdue\"]),\n  notes: z.string().optional(),\n}).omit({ farmId: true, userId: true }); // These are auto-injected\n\ntype SalesFormData = z.infer<typeof salesFormSchema>;\n\ninterface SalesFormProps {\n  mode?: 'dialog' | 'page' | 'embedded';\n  compact?: boolean;\n  defaultValues?: Partial<SalesFormData>;\n  onSuccess?: () => void;\n  customerNameRequired?: boolean;\n  showNotes?: boolean;\n}\n\nexport default function SalesForm({ \n  mode = 'page',\n  compact = false,\n  defaultValues = {},\n  onSuccess,\n  customerNameRequired = true,\n  showNotes = true\n}: SalesFormProps) {\n  const { hasActiveFarm } = useFarmContext();\n  const { toast } = useToast();\n  const createSaleMutation = useSaleMutation();\n\n  // Create dynamic schema based on customerNameRequired prop\n  const validationSchema = useMemo(() => {\n    return customerNameRequired ? \n      salesFormSchema : \n      salesFormSchema.extend({ customerName: z.string().optional() });\n  }, [customerNameRequired]);\n\n  const form = useForm<SalesFormData>({\n    resolver: zodResolver(validationSchema),\n    defaultValues: {\n      saleDate: new Date().toISOString().split('T')[0],\n      customerName: \"\",\n      cratesSold: 1,\n      pricePerCrate: \"\",\n      totalAmount: \"0.00\",\n      paymentStatus: \"pending\",\n      notes: \"\",\n      ...defaultValues\n    },\n  });\n\n  // Auto-calculate total amount\n  const cratesSold = form.watch(\"cratesSold\");\n  const pricePerCrate = form.watch(\"pricePerCrate\");\n\n  useEffect(() => {\n    if (cratesSold && pricePerCrate && !isNaN(parseFloat(pricePerCrate))) {\n      const total = (cratesSold * parseFloat(pricePerCrate)).toFixed(2);\n      form.setValue(\"totalAmount\", total);\n    }\n  }, [cratesSold, pricePerCrate, form]);\n\n  const onSubmit = (data: SalesFormData) => {\n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select an active farm before submitting records.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Prepare data with proper type coercion for API\n    const saleData = {\n      saleDate: data.saleDate,\n      customerName: data.customerName?.trim() || null,\n      cratesSold: data.cratesSold,\n      pricePerCrate: parseFloat(data.pricePerCrate), // Convert to number for decimal field\n      totalAmount: parseFloat(data.totalAmount || \"0.00\"), // Convert to number for decimal field\n      paymentStatus: data.paymentStatus,\n      notes: data.notes?.trim() || null,\n    };\n\n    createSaleMutation.mutate(saleData, {\n      onSuccess: () => {\n        form.reset();\n        onSuccess?.();\n      }\n    });\n  };\n\n  const isLoading = createSaleMutation.isPending;\n\n  const formContent = (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n        <div className={compact ? \"space-y-3\" : \"grid grid-cols-1 md:grid-cols-2 gap-4\"}>\n          <FormField\n            control={form.control}\n            name=\"saleDate\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Sale Date</FormLabel>\n                <FormControl>\n                  <Input\n                    type=\"date\"\n                    {...field}\n                    data-testid=\"input-sale-date\"\n                  />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"customerName\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Customer Name{customerNameRequired && \" *\"}</FormLabel>\n                <FormControl>\n                  <Input\n                    placeholder=\"Enter customer name\"\n                    {...field}\n                    data-testid=\"input-customer-name\"\n                  />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"cratesSold\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Crates Sold *</FormLabel>\n                <FormControl>\n                  <Input\n                    type=\"number\"\n                    min=\"1\"\n                    placeholder=\"Enter number of crates\"\n                    {...field}\n                    onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                    data-testid=\"input-crates-sold\"\n                  />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"pricePerCrate\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Price per Crate *</FormLabel>\n                <FormControl>\n                  <Input\n                    type=\"number\"\n                    step=\"0.01\"\n                    min=\"0\"\n                    placeholder=\"Enter price per crate\"\n                    {...field}\n                    data-testid=\"input-price-per-crate\"\n                  />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"totalAmount\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Total Amount</FormLabel>\n                <FormControl>\n                  <Input\n                    {...field}\n                    readOnly\n                    className=\"bg-muted\"\n                    data-testid=\"input-total-amount\"\n                  />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"paymentStatus\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Payment Status</FormLabel>\n                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                  <FormControl>\n                    <SelectTrigger data-testid=\"select-payment-status\">\n                      <SelectValue placeholder=\"Select payment status\" />\n                    </SelectTrigger>\n                  </FormControl>\n                  <SelectContent>\n                    <SelectItem value=\"pending\">Pending</SelectItem>\n                    <SelectItem value=\"paid\">Paid</SelectItem>\n                    <SelectItem value=\"overdue\">Overdue</SelectItem>\n                  </SelectContent>\n                </Select>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        {showNotes && (\n          <FormField\n            control={form.control}\n            name=\"notes\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Notes</FormLabel>\n                <FormControl>\n                  <Textarea\n                    placeholder=\"Additional notes about the sale\"\n                    className=\"resize-none\"\n                    {...field}\n                    data-testid=\"textarea-notes\"\n                  />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        )}\n\n        <Button\n          type=\"submit\"\n          disabled={isLoading || !hasActiveFarm}\n          className=\"w-full\"\n          data-testid=\"button-submit-sale\"\n        >\n          {isLoading ? \"Recording Sale...\" : \"Record Sale\"}\n        </Button>\n      </form>\n    </Form>\n  );\n\n  if (mode === 'page') {\n    return (\n      <Card data-testid=\"card-sales-form\">\n        <CardHeader>\n          <CardTitle>Record Sale</CardTitle>\n          <CardDescription>\n            Record egg sales with customer information and payment details\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {formContent}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return formContent;\n}","size_bytes":9488},"client/src/pages/chick-brooding.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Baby, Thermometer, Sun, Utensils, AlertCircle, Plus, Edit, Eye, Trash2, Download, Filter, Scale } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"@/components/ui/alert-dialog\";\nimport { Menu } from \"lucide-react\";\nimport SimpleBroodingForm from \"@/components/forms/simple-brooding-form\";\nimport FlockForm from \"@/components/forms/flock-form\";\nimport SimpleFlockForm from \"@/components/forms/simple-flock-form\";\n\nexport default function ChickBrooding() {\n  const { toast } = useToast();\n  const { user, isLoading, isAuthenticated } = useAuth();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [recordDialogOpen, setRecordDialogOpen] = useState(false);\n  const [flockDialogOpen, setFlockDialogOpen] = useState(false);\n  const [flockDetailsOpen, setFlockDetailsOpen] = useState(false);\n  const [flockEditOpen, setFlockEditOpen] = useState(false);\n  const [selectedFlock, setSelectedFlock] = useState<any>(null);\n  const queryClient = useQueryClient();\n\n  // Handlers for flock actions\n  const handleViewDetails = (flock: any) => {\n    setSelectedFlock(flock);\n    setFlockDetailsOpen(true);\n  };\n\n  const handleEditFlock = (flock: any) => {\n    setSelectedFlock(flock);\n    setFlockEditOpen(true);\n  };\n\n  // Deactivate flock mutation (admin-only)\n  const deactivateFlockMutation = useMutation({\n    mutationFn: async (flockId: string) => {\n      return apiRequest('PATCH', `/api/flocks/${flockId}/deactivate`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Flock Deactivated\",\n        description: \"The flock has been successfully deactivated and hidden from the list.\",\n      });\n      // Invalidate queries to refresh the data\n      queryClient.invalidateQueries({ queryKey: [\"/api/flocks\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/flocks\", { includeDeactivated: true }, activeFarmId] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Deactivation Failed\",\n        description: error?.message || \"Failed to deactivate flock. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDeactivateFlock = (flockId: string, flockName: string) => {\n    deactivateFlockMutation.mutate(flockId);\n  };\n\n  // Reactivate flock mutation (admin-only)\n  const reactivateFlockMutation = useMutation({\n    mutationFn: async (flockId: string) => {\n      return apiRequest('PATCH', `/api/flocks/${flockId}/reactivate`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Flock Reactivated\",\n        description: \"The flock has been successfully reactivated and restored to active status.\",\n      });\n      // Invalidate queries to refresh the data\n      queryClient.invalidateQueries({ queryKey: [\"/api/flocks\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/flocks\", { includeDeactivated: true }, activeFarmId] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Reactivation Failed\",\n        description: error?.message || \"Failed to reactivate flock. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleReactivateFlock = (flockId: string, flockName: string) => {\n    reactivateFlockMutation.mutate(flockId);\n  };\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: flocks = [], error: flocksError } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/flocks?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch flocks');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Query for deactivated flocks (admin only)\n  const { data: deactivatedFlocks = [], error: deactivatedFlocksError } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\", { includeDeactivated: true }, activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/flocks?includeDeactivated=true&farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) {\n        throw new Error('Failed to fetch deactivated flocks');\n      }\n      return response.json();\n    },\n    enabled: isAuthenticated && user?.role === 'admin' && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: dailyRecords = [], error: recordsError } = useQuery<any[]>({\n    queryKey: [\"/api/daily-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/daily-records?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch daily records');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if ((flocksError && isUnauthorizedError(flocksError)) || \n        (recordsError && isUnauthorizedError(recordsError)) || \n        (deactivatedFlocksError && isUnauthorizedError(deactivatedFlocksError))) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [flocksError, recordsError, deactivatedFlocksError, toast]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading chick brooding data...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  // Filter flocks to show only brooding flocks\n  const broodingFlocks = flocks.filter((flock: any) => flock.status === 'brooding');\n  const broodingRecords = dailyRecords.filter((record: any) => \n    record.temperature || record.lightingHours\n  ) || [];\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Header */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Chick Brooding</h2>\n                <p className=\"text-sm text-muted-foreground\">Monitor temperature, lighting, and feed for brooding chicks</p>\n              </div>\n            </div>\n            \n            <Dialog open={recordDialogOpen} onOpenChange={setRecordDialogOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-add-brooding-record\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Add Record\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Add Brooding Record</DialogTitle>\n                  <DialogDescription>\n                    Record daily brooding data including temperature, lighting, feed, and chick mortality.\n                  </DialogDescription>\n                </DialogHeader>\n                <SimpleBroodingForm onSuccess={() => setRecordDialogOpen(false)} />\n              </DialogContent>\n            </Dialog>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          {/* Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n            <Card data-testid=\"card-active-broods\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center space-x-2\">\n                  <Baby className=\"h-8 w-8 text-primary\" />\n                  <div>\n                    <p className=\"text-2xl font-bold\">{broodingFlocks.length}</p>\n                    <p className=\"text-sm text-muted-foreground\">Active Broods</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-avg-temperature\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center space-x-2\">\n                  <Thermometer className=\"h-8 w-8 text-chart-5\" />\n                  <div>\n                    <p className=\"text-2xl font-bold\">32.5°C</p>\n                    <p className=\"text-sm text-muted-foreground\">Avg Temperature</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-lighting-hours\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center space-x-2\">\n                  <Sun className=\"h-8 w-8 text-chart-3\" />\n                  <div>\n                    <p className=\"text-2xl font-bold\">18h</p>\n                    <p className=\"text-sm text-muted-foreground\">Daily Lighting</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-feed-consumption\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center space-x-2\">\n                  <Utensils className=\"h-8 w-8 text-chart-2\" />\n                  <div>\n                    <p className=\"text-2xl font-bold\">125kg</p>\n                    <p className=\"text-sm text-muted-foreground\">Daily Feed</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs defaultValue=\"flocks\" className=\"space-y-4\">\n            <TabsList>\n              <TabsTrigger value=\"flocks\">Brooding Flocks</TabsTrigger>\n              <TabsTrigger value=\"records\">Daily Records</TabsTrigger>\n              <TabsTrigger value=\"schedule\">Brooding Schedule</TabsTrigger>\n              {user?.role === 'admin' && (\n                <TabsTrigger value=\"deactivated\">Deactivated Flocks</TabsTrigger>\n              )}\n            </TabsList>\n\n            <TabsContent value=\"flocks\">\n              <Card data-testid=\"card-brooding-flocks\">\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle>Brooding Flocks</CardTitle>\n                    <Dialog open={flockDialogOpen} onOpenChange={setFlockDialogOpen}>\n                      <DialogTrigger asChild>\n                        <Button size=\"sm\" data-testid=\"button-add-flock-header\">\n                          <Plus className=\"h-4 w-4 mr-2\" />\n                          Add New Flock\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent className=\"max-w-2xl\">\n                        <DialogHeader>\n                          <DialogTitle>Create New Flock</DialogTitle>\n                          <DialogDescription>\n                            Add a new flock to your farm for tracking throughout its lifecycle.\n                          </DialogDescription>\n                        </DialogHeader>\n                        <SimpleFlockForm onSuccess={() => setFlockDialogOpen(false)} />\n                      </DialogContent>\n                    </Dialog>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {broodingFlocks.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <Baby className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No brooding flocks currently active</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Click \"Add New Flock\" above to get started</p>\n                    </div>\n                  ) : (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      {broodingFlocks.map((flock: any) => (\n                        <Card key={flock.id} data-testid={`card-flock-${flock.id}`}>\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex items-center justify-between mb-2\">\n                              <h3 className=\"font-semibold\">{flock.name}</h3>\n                              <Badge variant=\"secondary\">Week {Math.floor((new Date().getTime() - new Date(flock.hatchDate).getTime()) / (1000 * 60 * 60 * 24 * 7))}</Badge>\n                            </div>\n                            <div className=\"space-y-2 text-sm\">\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-muted-foreground\">Breed:</span>\n                                <span>{flock.breed}</span>\n                              </div>\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-muted-foreground\">Current Count:</span>\n                                <span>{flock.currentCount}</span>\n                              </div>\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-muted-foreground\">Hatch Date:</span>\n                                <span>{new Date(flock.hatchDate).toLocaleDateString()}</span>\n                              </div>\n                            </div>\n                            <div className=\"flex gap-2 mt-4\">\n                              <Button \n                                size=\"sm\" \n                                variant=\"outline\" \n                                className=\"flex-1\" \n                                onClick={() => handleViewDetails(flock)}\n                                data-testid={`button-view-flock-${flock.id}`}\n                              >\n                                <Eye className=\"h-4 w-4 mr-2\" />\n                                View Details\n                              </Button>\n                              <Button \n                                size=\"sm\" \n                                className=\"flex-1\" \n                                onClick={() => handleEditFlock(flock)}\n                                data-testid={`button-edit-flock-${flock.id}`}\n                              >\n                                <Edit className=\"h-4 w-4 mr-2\" />\n                                Edit\n                              </Button>\n                              {user?.role === 'admin' && (\n                                <AlertDialog>\n                                  <AlertDialogTrigger asChild>\n                                    <Button \n                                      size=\"sm\" \n                                      variant=\"destructive\"\n                                      disabled={deactivateFlockMutation.isPending}\n                                      data-testid={`button-deactivate-flock-${flock.id}`}\n                                    >\n                                      <Trash2 className=\"h-4 w-4 mr-2\" />\n                                      {deactivateFlockMutation.isPending ? \"Deactivating...\" : \"Deactivate\"}\n                                    </Button>\n                                  </AlertDialogTrigger>\n                                  <AlertDialogContent>\n                                    <AlertDialogHeader>\n                                      <div className=\"flex items-center space-x-2\">\n                                        <AlertCircle className=\"h-6 w-6 text-destructive\" />\n                                        <AlertDialogTitle className=\"text-destructive\">\n                                          ⚠️ Permanently Deactivate Flock\n                                        </AlertDialogTitle>\n                                      </div>\n                                      <AlertDialogDescription className=\"space-y-3 pt-2\">\n                                        <div className=\"p-3 bg-destructive/10 border border-destructive/20 rounded-md\">\n                                          <p className=\"font-semibold text-destructive-foreground\">\n                                            Warning: This is a destructive action!\n                                          </p>\n                                        </div>\n                                        <p>\n                                          You are about to <strong>permanently deactivate</strong> the flock <strong>\"{flock.name}\"</strong>.\n                                        </p>\n                                        <div className=\"space-y-2 text-sm\">\n                                          <p className=\"flex items-start space-x-2\">\n                                            <span className=\"text-destructive font-bold\">•</span>\n                                            <span>This flock will be <strong>hidden</strong> from all active flock lists</span>\n                                          </p>\n                                          <p className=\"flex items-start space-x-2\">\n                                            <span className=\"text-destructive font-bold\">•</span>\n                                            <span>All historical data will be <strong>preserved</strong> but not easily accessible</span>\n                                          </p>\n                                          <p className=\"flex items-start space-x-2\">\n                                            <span className=\"text-destructive font-bold\">•</span>\n                                            <span>Only administrators can <strong>recover</strong> this flock later</span>\n                                          </p>\n                                          <p className=\"flex items-start space-x-2\">\n                                            <span className=\"text-destructive font-bold\">•</span>\n                                            <span>Farm staff will <strong>lose access</strong> to this flock's data</span>\n                                          </p>\n                                        </div>\n                                        <p className=\"text-muted-foreground text-sm mt-4\">\n                                          Consider if you really need to deactivate this flock. This action should only be used for permanently discontinued flocks.\n                                        </p>\n                                      </AlertDialogDescription>\n                                    </AlertDialogHeader>\n                                    <AlertDialogFooter className=\"flex-col space-y-2 sm:flex-row sm:space-y-0\">\n                                      <AlertDialogCancel className=\"w-full sm:w-auto\">Cancel</AlertDialogCancel>\n                                      <AlertDialogAction \n                                        onClick={() => handleDeactivateFlock(flock.id, flock.name)}\n                                        className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90 w-full sm:w-auto\"\n                                      >\n                                        <Trash2 className=\"h-4 w-4 mr-2\" />\n                                        Yes, Permanently Deactivate\n                                      </AlertDialogAction>\n                                    </AlertDialogFooter>\n                                  </AlertDialogContent>\n                                </AlertDialog>\n                              )}\n                            </div>\n                          </CardContent>\n                        </Card>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"records\">\n              <Card data-testid=\"card-brooding-records\">\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle>Recent Brooding Records</CardTitle>\n                    <Dialog open={recordDialogOpen} onOpenChange={setRecordDialogOpen}>\n                      <DialogTrigger asChild>\n                        <Button size=\"sm\" data-testid=\"button-add-record\">\n                          <Plus className=\"h-4 w-4 mr-2\" />\n                          Add Record\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n                        <DialogHeader>\n                          <DialogTitle>Add Brooding Record</DialogTitle>\n                          <DialogDescription>\n                            Record daily brooding data including temperature, lighting, feed, and chick mortality.\n                          </DialogDescription>\n                        </DialogHeader>\n                        <SimpleBroodingForm onSuccess={() => setRecordDialogOpen(false)} />\n                      </DialogContent>\n                    </Dialog>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {broodingRecords.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <AlertCircle className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No brooding records found</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Start recording temperature, lighting, and feed data</p>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Date</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Temperature</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Lighting</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Feed</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Notes</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {broodingRecords.slice(0, 10).map((record: any) => (\n                            <tr key={record.id} className=\"border-b border-border/50\" data-testid={`row-record-${record.id}`}>\n                              <td className=\"p-2\">{new Date(record.recordDate).toLocaleDateString()}</td>\n                              <td className=\"p-2\">{record.temperature ? `${record.temperature}°C` : '-'}</td>\n                              <td className=\"p-2\">{record.lightingHours ? `${record.lightingHours}h` : '-'}</td>\n                              <td className=\"p-2\">{record.feedConsumed ? `${record.feedConsumed}kg` : '-'}</td>\n                              <td className=\"p-2 max-w-xs truncate\">{record.notes || '-'}</td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"schedule\">\n              <Card data-testid=\"card-brooding-schedule\">\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle>Brooding Schedule Guidelines</CardTitle>\n                      <p className=\"text-sm text-muted-foreground mt-2\">\n                        Comprehensive week-by-week brooding management guide for optimal chick development and health\n                      </p>\n                    </div>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      onClick={() => {\n                        const scheduleData = [\n                          ['Week', 'Temperature (°C)', 'Lighting (hours)', 'Feed (g/bird/day)', 'Feed Type', 'Expected Weight (g)', 'Key Notes'],\n                          ['Week 1', '35-32°C', '24', '12g', 'Chick and Duck Mash', '40-60g', 'Critical growth period - monitor closely'],\n                          ['Week 2', '32-29°C', '20', '18g', 'Chick and Duck Mash', '85-120g', 'Rapid growth phase begins'],\n                          ['Week 3', '29-26°C', '16', '25g', 'Chick and Duck Mash', '150-200g', 'Feed transition period'],\n                          ['Week 4', '26-23°C', '14', '31g', 'Chick and Duck Mash', '220-300g', 'Feather development peak'],\n                          ['Week 5', '23-21°C', '14', '38g', 'Chick and Duck Mash', '380-400g', 'Steady growth continues'],\n                          ['Week 6', '21°C', '14', '41g', 'Chick and Duck Mash', '470-500g', 'Prepare for grower phase'],\n                          ['Week 7', '21°C', '14', '45g', 'Chick and Duck Mash', '560-600g', 'Transition preparation'],\n                          ['Week 8', '21°C', '14', '49g', 'Gradual change to Growers Mash', '650g', 'Begin grower feed transition'],\n                          ['Week 9', '21°C', '14', '52g', 'Growers Mash', '740-780g', 'Full grower feed'],\n                          ['Week 10', '21°C', '14', '60g', 'Growers Mash', '830-870g', 'Rapid growth phase'],\n                          ['Week 11', '21°C', '14', '70g', 'Growers Mash', '920-980g', 'Peak growth period'],\n                          ['Week 12', '21°C', '14', '75g', 'Growers Mash', '1010-1050g', 'Consistent growth'],\n                          ['Week 13', '21°C', '14', '80g', 'Growers Mash', '1100-1140g', 'Continued development'],\n                          ['Week 14', '21°C', '14', '85g', 'Growers Mash', '1185-1230g', 'Pre-layer development'],\n                          ['Week 15', '21°C', '14', '92g', 'Growers Mash', '1270-1320g', 'Final grower phase'],\n                          ['Week 16', '21°C', '14', '100g', 'Gradual change to Layers Mash', '1355-1410g', 'Begin layer feed transition'],\n                          ['Week 17', '21°C', '14', '107g', 'Layers Mash', '1440-1500g', 'Layer feed establishment'],\n                          ['Week 18', '21°C', '14', '114g', 'Layers Mash', '1530-1600g', 'Pre-laying preparation'],\n                          ['Week 19', '21°C', '14', '118g', 'Layers Mash', '1580-1680g', 'Approaching laying'],\n                          ['Week 20', '21°C', '14', '120g', 'Layers Mash', '1645-1750g', 'Ready for egg production']\n                        ];\n                        const csvContent = scheduleData.map(row => row.join(',')).join('\\n');\n                        const blob = new Blob([csvContent], { type: 'text/csv' });\n                        const url = URL.createObjectURL(blob);\n                        const link = document.createElement('a');\n                        link.href = url;\n                        link.download = 'brooding-schedule-guidelines.csv';\n                        link.click();\n                        URL.revokeObjectURL(url);\n                      }}\n                      data-testid=\"button-export-schedule\"\n                    >\n                      <Download className=\"h-4 w-4 mr-2\" />\n                      Export CSV\n                    </Button>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {/* Week-by-Week Overview Table */}\n                  <div className=\"mb-8\">\n                    <h3 className=\"text-lg font-semibold mb-4 flex items-center\">\n                      <Baby className=\"h-5 w-5 mr-2\" />\n                      Week-by-Week Overview\n                    </h3>\n                    <div className=\"overflow-x-auto\">\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead className=\"min-w-[80px]\">Week</TableHead>\n                            <TableHead className=\"min-w-[120px]\">Temperature</TableHead>\n                            <TableHead className=\"min-w-[100px]\">Lighting</TableHead>\n                            <TableHead className=\"min-w-[120px]\">Feed Amount</TableHead>\n                            <TableHead className=\"min-w-[140px]\">Feed Type & Protein</TableHead>\n                            <TableHead className=\"min-w-[120px]\">Expected Weight</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          <TableRow className=\"bg-red-50/50 dark:bg-red-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"destructive\" className=\"text-xs\">Week 1</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">0-7 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-red-500\" />\n                                <span className=\"font-medium\">35-32°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>24 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">12g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Chick and Duck Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">High protein starter</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">40-60g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Critical period</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-orange-50/50 dark:bg-orange-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\">Week 2</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">8-14 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-orange-500\" />\n                                <span className=\"font-medium\">32-29°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>20 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">18g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Chick and Duck Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">High protein starter</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">85-120g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Rapid growth</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-yellow-50/50 dark:bg-yellow-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\">Week 3</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">15-21 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-yellow-600\" />\n                                <span className=\"font-medium\">29-26°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>16 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">25g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Chick and Duck Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">High protein starter</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">150-200g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Feed transition</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-green-50/50 dark:bg-green-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\">Week 4</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">22-28 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-green-600\" />\n                                <span className=\"font-medium\">26-23°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">31g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Chick and Duck Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">High protein starter</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">220-300g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Feather development</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-green-50/50 dark:bg-green-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\">Week 5</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">29-35 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-green-600\" />\n                                <span className=\"font-medium\">23-21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">38g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Chick and Duck Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">High protein starter</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">380-400g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Steady growth</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-blue-50/50 dark:bg-blue-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\">Week 6</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">36-42 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-blue-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">41g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Chick and Duck Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">High protein starter</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">470-500g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Grower preparation</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-indigo-50/50 dark:bg-indigo-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200\">Week 7</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">43-49 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-indigo-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">45g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Chick and Duck Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">High protein starter</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">560-600g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Transition preparation</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-blue-50/50 dark:bg-blue-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\">Week 8</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">50-56 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-blue-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">49g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Gradual change to Growers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Feed transition</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">650g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Begin grower feed transition</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-purple-50/50 dark:bg-purple-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\">Week 9</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">57-63 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-purple-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">52g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Growers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Full grower feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">740-780g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Full grower feed</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-purple-50/50 dark:bg-purple-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\">Week 10</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">64-70 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-purple-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">60g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Growers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Growth feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">830-870g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Rapid growth phase</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-purple-50/50 dark:bg-purple-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\">Week 11</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">71-77 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-purple-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">70g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Growers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Growth feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">920-980g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Peak growth period</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-purple-50/50 dark:bg-purple-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\">Week 12</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">78-84 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-purple-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">75g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Growers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Growth feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1010-1050g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Consistent growth</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-cyan-50/50 dark:bg-cyan-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200\">Week 13</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">85-91 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-cyan-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">80g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Growers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Growth feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1100-1140g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Continued development</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-cyan-50/50 dark:bg-cyan-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200\">Week 14</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">92-98 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-cyan-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">85g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Growers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Growth feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1185-1230g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Pre-layer development</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-cyan-50/50 dark:bg-cyan-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200\">Week 15</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">99-105 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-cyan-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">92g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Growers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Growth feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1270-1320g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Final grower phase</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-cyan-50/50 dark:bg-cyan-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200\">Week 16</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">106-112 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-cyan-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">100g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Gradual change to Layers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Feed transition</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1355-1410g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Begin layer feed transition</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-pink-50/50 dark:bg-pink-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200\">Week 17</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">113-119 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-pink-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">107g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Layers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Layer feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1440-1500g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Layer feed establishment</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-pink-50/50 dark:bg-pink-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200\">Week 18</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">120-126 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-pink-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">114g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Layers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Layer feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1530-1600g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Pre-laying preparation</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-pink-50/50 dark:bg-pink-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200\">Week 19</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">127-133 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-pink-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">118g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Layers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Layer feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1580-1680g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Approaching laying</div>\n                            </TableCell>\n                          </TableRow>\n                          <TableRow className=\"bg-pink-50/50 dark:bg-pink-950/20\">\n                            <TableCell className=\"font-medium\">\n                              <Badge variant=\"secondary\" className=\"text-xs bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200\">Week 20</Badge>\n                              <div className=\"text-xs text-muted-foreground mt-1\">134-140 days</div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Thermometer className=\"h-4 w-4 mr-1 text-pink-600\" />\n                                <span className=\"font-medium\">21°C</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Sun className=\"h-4 w-4 mr-1 text-yellow-500\" />\n                                <span>14 hours</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <Utensils className=\"h-4 w-4 mr-1 text-green-500\" />\n                                <span className=\"font-medium\">120g/day</span>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div>Layers Mash</div>\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">Layer feed</Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center\">\n                                <span className=\"font-medium\">1645-1750g</span>\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">Ready for egg production</div>\n                            </TableCell>\n                          </TableRow>\n                        </TableBody>\n                      </Table>\n                    </div>\n                  </div>\n\n                  {/* Detailed Guidelines Accordion */}\n                  <Accordion type=\"single\" collapsible className=\"w-full\">\n                    <AccordionItem value=\"temperature\">\n                      <AccordionTrigger className=\"text-left\" data-testid=\"accordion-temperature\">\n                        <div className=\"flex items-center\">\n                          <Thermometer className=\"h-5 w-5 mr-2 text-red-500\" />\n                          <span>Temperature Management Guide</span>\n                        </div>\n                      </AccordionTrigger>\n                      <AccordionContent>\n                        <div className=\"space-y-4\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            Proper temperature control is critical for chick survival and development. Temperature should be reduced gradually as chicks develop their own thermoregulation.\n                          </p>\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            <div className=\"space-y-3\">\n                              <h4 className=\"font-medium\">Temperature Zones</h4>\n                              <ul className=\"text-sm space-y-2\">\n                                <li>• <strong>Critical Zone (Week 1):</strong> 35-32°C - Chicks cannot regulate body temperature</li>\n                                <li>• <strong>Growth Zone (Week 2-3):</strong> 32-26°C - Rapid development period</li>\n                                <li>• <strong>Comfort Zone (Week 4+):</strong> 26-21°C - Approaching adult thermoregulation</li>\n                              </ul>\n                            </div>\n                            <div className=\"space-y-3\">\n                              <h4 className=\"font-medium\">Temperature Tips</h4>\n                              <ul className=\"text-sm space-y-2\">\n                                <li>• Monitor chick behavior - huddling indicates cold, spreading indicates heat</li>\n                                <li>• Use multiple thermometers at chick level, not air temperature</li>\n                                <li>• Reduce temperature by 2-3°C per week after week 1</li>\n                                <li>• Provide temperature gradient areas in the brooding space</li>\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      </AccordionContent>\n                    </AccordionItem>\n\n                    <AccordionItem value=\"lighting\">\n                      <AccordionTrigger className=\"text-left\" data-testid=\"accordion-lighting\">\n                        <div className=\"flex items-center\">\n                          <Sun className=\"h-5 w-5 mr-2 text-yellow-500\" />\n                          <span>Lighting Schedule Guide</span>\n                        </div>\n                      </AccordionTrigger>\n                      <AccordionContent>\n                        <div className=\"space-y-4\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            Lighting programs affect feed consumption, growth rate, and natural behavior patterns. Gradual reduction helps establish normal day/night cycles.\n                          </p>\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            <div className=\"space-y-3\">\n                              <h4 className=\"font-medium\">Lighting Phases</h4>\n                              <ul className=\"text-sm space-y-2\">\n                                <li>• <strong>24 Hours (Week 1):</strong> Continuous lighting ensures feed/water access</li>\n                                <li>• <strong>20 Hours (Week 2):</strong> Introduce 4 hours of darkness</li>\n                                <li>• <strong>16 Hours (Week 3):</strong> Establish day/night rhythm</li>\n                                <li>• <strong>14 Hours (Week 4+):</strong> Natural lighting pattern</li>\n                              </ul>\n                            </div>\n                            <div className=\"space-y-3\">\n                              <h4 className=\"font-medium\">Lighting Best Practices</h4>\n                              <ul className=\"text-sm space-y-2\">\n                                <li>• Use 20-40 lux intensity for brooding</li>\n                                <li>• Avoid sudden lighting changes - use dimmer systems</li>\n                                <li>• Ensure even light distribution throughout brooding area</li>\n                                <li>• Provide backup lighting systems for power outages</li>\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      </AccordionContent>\n                    </AccordionItem>\n\n                    <AccordionItem value=\"feeding\">\n                      <AccordionTrigger className=\"text-left\" data-testid=\"accordion-feeding\">\n                        <div className=\"flex items-center\">\n                          <Utensils className=\"h-5 w-5 mr-2 text-green-500\" />\n                          <span>Feed & Nutrition Guide</span>\n                        </div>\n                      </AccordionTrigger>\n                      <AccordionContent>\n                        <div className=\"space-y-4\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            Proper nutrition is essential for healthy growth and development. Feed requirements change as chicks grow and develop.\n                          </p>\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            <div className=\"space-y-3\">\n                              <h4 className=\"font-medium\">Feed Types & Stages</h4>\n                              <ul className=\"text-sm space-y-2\">\n                                <li>• <strong>Chick and Duck Mash:</strong> Week 1-7 - Complete starter nutrition (12-45g/day)</li>\n                                <li>• <strong>Gradual Transition:</strong> Week 8 - Change to Growers Mash (49g/day)</li>\n                                <li>• <strong>Growers Mash:</strong> Week 9-15 - Growth and development (52-92g/day)</li>\n                                <li>• <strong>Layer Feed Transition:</strong> Week 16 - Change to Layers Mash (100g/day)</li>\n                                <li>• <strong>Layers Mash:</strong> Week 17-20+ - Pre-laying and production (107-120g/day)</li>\n                              </ul>\n                            </div>\n                            <div className=\"space-y-3\">\n                              <h4 className=\"font-medium\">Feeding Guidelines</h4>\n                              <ul className=\"text-sm space-y-2\">\n                                <li>• Provide fresh, clean water at all times (ratio 2:1 water to feed)</li>\n                                <li>• Use appropriate feeder height - adjust as chicks grow</li>\n                                <li>• Monitor feed consumption daily - sudden changes indicate health issues</li>\n                                <li>• Transition feeds gradually over 3-5 days to avoid digestive upset</li>\n                                <li>• Store feed in cool, dry conditions to prevent spoilage</li>\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      </AccordionContent>\n                    </AccordionItem>\n\n                    <AccordionItem value=\"weight\">\n                      <AccordionTrigger className=\"text-left\" data-testid=\"accordion-weight\">\n                        <div className=\"flex items-center\">\n                          <Scale className=\"h-5 w-5 mr-2 text-blue-500\" />\n                          <span>Weight Monitoring Guide</span>\n                        </div>\n                      </AccordionTrigger>\n                      <AccordionContent>\n                        <div className=\"space-y-4\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            Regular weight monitoring helps ensure proper growth and early detection of health issues. Sample weights weekly from different areas of the brooding facility.\n                          </p>\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            <div className=\"space-y-3\">\n                              <h4 className=\"font-medium\">Weight Targets by Phase</h4>\n                              <ul className=\"text-sm space-y-2\">\n                                <li>• <strong>Week 1-2:</strong> 40-120g (Critical establishment phase)</li>\n                                <li>• <strong>Week 3-5:</strong> 150-400g (Rapid growth phase)</li>\n                                <li>• <strong>Week 6-8:</strong> 470-650g (Transition to grower)</li>\n                                <li>• <strong>Week 9-12:</strong> 740-1050g (Active growth period)</li>\n                                <li>• <strong>Week 13-16:</strong> 1100-1410g (Pre-layer development)</li>\n                                <li>• <strong>Week 17-20:</strong> 1440-1750g (Layer preparation)</li>\n                              </ul>\n                            </div>\n                            <div className=\"space-y-3\">\n                              <h4 className=\"font-medium\">Monitoring Best Practices</h4>\n                              <ul className=\"text-sm space-y-2\">\n                                <li>• Weigh 10-15 chicks from different areas weekly</li>\n                                <li>• Record weights at the same time of day consistently</li>\n                                <li>• Track weight gain trends, not just absolute weights</li>\n                                <li>• Investigate if &gt;20% of chicks fall below target weight</li>\n                                <li>• Adjust feeding program based on growth performance</li>\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      </AccordionContent>\n                    </AccordionItem>\n                  </Accordion>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            {/* Deactivated Flocks Tab - Admin Only */}\n            {user?.role === 'admin' && (\n              <TabsContent value=\"deactivated\">\n                <Card data-testid=\"card-deactivated-flocks\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center space-x-2\">\n                      <AlertCircle className=\"h-5 w-5 text-muted-foreground\" />\n                      <span>Deactivated Flocks</span>\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {deactivatedFlocks.filter((flock: any) => flock.status === 'deactivated').length === 0 ? (\n                      <div className=\"text-center py-8\">\n                        <div className=\"flex flex-col items-center\">\n                          <AlertCircle className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                          <p className=\"text-muted-foreground\">No deactivated flocks found</p>\n                          <p className=\"text-sm text-muted-foreground mt-2\">Deactivated flocks will appear here for recovery</p>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"space-y-4\">\n                        <div className=\"p-4 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n                          <div className=\"flex items-start space-x-3\">\n                            <AlertCircle className=\"h-5 w-5 text-amber-600 dark:text-amber-400 mt-0.5\" />\n                            <div>\n                              <h3 className=\"font-medium text-amber-800 dark:text-amber-200\">Recovery Zone</h3>\n                              <p className=\"text-sm text-amber-700 dark:text-amber-300 mt-1\">\n                                These flocks have been deactivated and are hidden from normal operations. \n                                You can reactivate them to restore full functionality.\n                              </p>\n                            </div>\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          {deactivatedFlocks.filter((flock: any) => flock.status === 'deactivated').map((flock: any) => (\n                            <Card key={flock.id} data-testid={`card-deactivated-flock-${flock.id}`} className=\"border-dashed border-muted-foreground/20\">\n                              <CardContent className=\"p-4\">\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <h3 className=\"font-semibold text-muted-foreground\">{flock.name}</h3>\n                                  <Badge variant=\"outline\" className=\"text-muted-foreground border-muted-foreground/50\">\n                                    Deactivated\n                                  </Badge>\n                                </div>\n                                <div className=\"space-y-2 text-sm text-muted-foreground\">\n                                  <div className=\"flex justify-between\">\n                                    <span>Breed:</span>\n                                    <span>{flock.breed}</span>\n                                  </div>\n                                  <div className=\"flex justify-between\">\n                                    <span>Total Birds:</span>\n                                    <span>{flock.currentCount.toLocaleString()}</span>\n                                  </div>\n                                  <div className=\"flex justify-between\">\n                                    <span>Hatch Date:</span>\n                                    <span>{new Date(flock.hatchDate).toLocaleDateString()}</span>\n                                  </div>\n                                </div>\n\n                                <div className=\"flex gap-2 mt-4\">\n                                  <Button \n                                    size=\"sm\" \n                                    variant=\"outline\" \n                                    className=\"flex-1\" \n                                    onClick={() => handleViewDetails(flock)}\n                                    data-testid={`button-view-deactivated-flock-${flock.id}`}\n                                  >\n                                    <Eye className=\"h-4 w-4 mr-2\" />\n                                    View Details\n                                  </Button>\n                                  \n                                  <AlertDialog>\n                                    <AlertDialogTrigger asChild>\n                                      <Button \n                                        size=\"sm\" \n                                        className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                                        disabled={reactivateFlockMutation.isPending}\n                                        data-testid={`button-reactivate-flock-${flock.id}`}\n                                      >\n                                        <Scale className=\"h-4 w-4 mr-2\" />\n                                        {reactivateFlockMutation.isPending ? \"Reactivating...\" : \"Reactivate\"}\n                                      </Button>\n                                    </AlertDialogTrigger>\n                                    <AlertDialogContent>\n                                      <AlertDialogHeader>\n                                        <div className=\"flex items-center space-x-2\">\n                                          <Scale className=\"h-6 w-6 text-green-600\" />\n                                          <AlertDialogTitle className=\"text-green-600\">\n                                            ✅ Reactivate Flock\n                                          </AlertDialogTitle>\n                                        </div>\n                                        <AlertDialogDescription className=\"space-y-3 pt-2\">\n                                          <p>\n                                            You are about to <strong>reactivate</strong> the flock <strong>\"{flock.name}\"</strong>.\n                                          </p>\n                                          <div className=\"space-y-2 text-sm\">\n                                            <p className=\"flex items-start space-x-2\">\n                                              <span className=\"text-green-600 font-bold\">•</span>\n                                              <span>This flock will be <strong>restored</strong> to active status</span>\n                                            </p>\n                                            <p className=\"flex items-start space-x-2\">\n                                              <span className=\"text-green-600 font-bold\">•</span>\n                                              <span>It will <strong>reappear</strong> in the main brooding flocks list</span>\n                                            </p>\n                                            <p className=\"flex items-start space-x-2\">\n                                              <span className=\"text-green-600 font-bold\">•</span>\n                                              <span>Farm staff will <strong>regain access</strong> to all flock data</span>\n                                            </p>\n                                            <p className=\"flex items-start space-x-2\">\n                                              <span className=\"text-green-600 font-bold\">•</span>\n                                              <span>All historical records will remain <strong>intact</strong></span>\n                                            </p>\n                                          </div>\n                                          <p className=\"text-muted-foreground text-sm mt-4\">\n                                            This action will restore the flock to full operational status.\n                                          </p>\n                                        </AlertDialogDescription>\n                                      </AlertDialogHeader>\n                                      <AlertDialogFooter className=\"flex-col space-y-2 sm:flex-row sm:space-y-0\">\n                                        <AlertDialogCancel className=\"w-full sm:w-auto\">Cancel</AlertDialogCancel>\n                                        <AlertDialogAction \n                                          onClick={() => handleReactivateFlock(flock.id, flock.name)}\n                                          className=\"bg-green-600 text-white hover:bg-green-700 w-full sm:w-auto\"\n                                        >\n                                          <Scale className=\"h-4 w-4 mr-2\" />\n                                          Yes, Reactivate Flock\n                                        </AlertDialogAction>\n                                      </AlertDialogFooter>\n                                    </AlertDialogContent>\n                                  </AlertDialog>\n                                </div>\n                              </CardContent>\n                            </Card>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n            )}\n          </Tabs>\n        </div>\n      </main>\n\n      {/* Flock Details Dialog */}\n      <Dialog open={flockDetailsOpen} onOpenChange={setFlockDetailsOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Flock Details</DialogTitle>\n            <DialogDescription>\n              Detailed information about {selectedFlock?.name}\n            </DialogDescription>\n          </DialogHeader>\n          {selectedFlock && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Flock Name</label>\n                  <p className=\"text-lg font-semibold\">{selectedFlock.name}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Status</label>\n                  <p>\n                    <Badge variant={selectedFlock.status === 'brooding' ? 'secondary' : 'default'}>\n                      {selectedFlock.status.charAt(0).toUpperCase() + selectedFlock.status.slice(1)}\n                    </Badge>\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Breed</label>\n                  <p className=\"text-lg\">{selectedFlock.breed}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Current Age</label>\n                  <p className=\"text-lg\">Week {Math.floor((new Date().getTime() - new Date(selectedFlock.hatchDate).getTime()) / (1000 * 60 * 60 * 24 * 7))}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Initial Count</label>\n                  <p className=\"text-lg\">{selectedFlock.initialCount.toLocaleString()}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Current Count</label>\n                  <p className=\"text-lg\">{selectedFlock.currentCount.toLocaleString()}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Hatch Date</label>\n                  <p className=\"text-lg\">{new Date(selectedFlock.hatchDate).toLocaleDateString()}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Mortality Rate</label>\n                  <p className=\"text-lg\">\n                    {(((selectedFlock.initialCount - selectedFlock.currentCount) / selectedFlock.initialCount) * 100).toFixed(1)}%\n                  </p>\n                </div>\n              </div>\n              <div className=\"pt-4 border-t\">\n                <Button onClick={() => handleEditFlock(selectedFlock)} className=\"w-full\">\n                  <Edit className=\"h-4 w-4 mr-2\" />\n                  Edit Flock Details\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Flock Edit Dialog */}\n      <Dialog open={flockEditOpen} onOpenChange={setFlockEditOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Edit Flock</DialogTitle>\n            <DialogDescription>\n              Update the details for {selectedFlock?.name}\n            </DialogDescription>\n          </DialogHeader>\n          {selectedFlock && (\n            <FlockForm \n              flock={selectedFlock} \n              onSuccess={() => {\n                setFlockEditOpen(false);\n                setFlockDetailsOpen(false);\n                setSelectedFlock(null);\n              }} \n            />\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":96905},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/pages/egg-production.tsx":{"content":"import { useEffect, useState, useMemo } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Egg, TrendingUp, Plus, Menu, DollarSign } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport SimpleEggProductionForm from \"@/components/forms/simple-egg-production-form\";\nimport SalesForm from \"@/components/forms/SalesForm\";\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from \"recharts\";\n\nexport default function EggProduction() {\n  const { toast } = useToast();\n  const { isLoading, isAuthenticated } = useAuth();\n  const { activeFarmId, hasActiveFarm, farms, setActiveFarmId } = useFarmContext();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [saleDialogOpen, setSaleDialogOpen] = useState(false);\n  const [recordDialogOpen, setRecordDialogOpen] = useState(false);\n  const queryClient = useQueryClient();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: dailyRecords = [], error: recordsError } = useQuery<any[]>({\n    queryKey: [\"/api/daily-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/daily-records?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch daily records');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: sales = [], error: salesError } = useQuery<any[]>({\n    queryKey: [\"/api/sales\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/sales?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch sales');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if ((recordsError && isUnauthorizedError(recordsError)) || (salesError && isUnauthorizedError(salesError))) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [recordsError, salesError, toast]);\n\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading egg production data...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  const eggRecords = dailyRecords.filter((record: any) => record.eggsCollected > 0);\n  const todayRecords = eggRecords.filter((record: any) => \n    record.recordDate === new Date().toISOString().split('T')[0]\n  );\n  const weekRecords = eggRecords.filter((record: any) => {\n    const recordDate = new Date(record.recordDate);\n    const weekAgo = new Date();\n    weekAgo.setDate(weekAgo.getDate() - 7);\n    return recordDate >= weekAgo;\n  });\n\n  const todayTotal = todayRecords.reduce((sum: number, record: any) => sum + (record.eggsCollected || 0), 0);\n  const weekTotal = weekRecords.reduce((sum: number, record: any) => sum + (record.eggsCollected || 0), 0);\n  const weekAverage = weekTotal / 7;\n  const todayCrates = todayRecords.reduce((sum: number, record: any) => sum + (record.cratesProduced || 0), 0);\n\n  const recentSales = sales.slice(0, 5);\n  const weekSales = sales.filter((sale: any) => {\n    const saleDate = new Date(sale.saleDate);\n    const weekAgo = new Date();\n    weekAgo.setDate(weekAgo.getDate() - 7);\n    return saleDate >= weekAgo;\n  });\n  const weekRevenue = weekSales.reduce((sum: number, sale: any) => sum + parseFloat(sale.totalAmount || '0'), 0);\n\n  // Get current farm name and demo farm info for empty state guidance\n  const currentFarm = farms.find(f => f.id === activeFarmId);\n  const demoFarm = farms.find(f => f.name.includes('Demo Farm'));\n\n  // Daily production trends (last 30 days) with UTC consistency\n  const dailyProductionTrends = useMemo(() => {\n    // Helper to get stable date key (yyyy-mm-dd format) using UTC\n    const getDateKey = (date: Date): string => {\n      const year = date.getUTCFullYear();\n      const month = String(date.getUTCMonth() + 1).padStart(2, '0');\n      const day = String(date.getUTCDate()).padStart(2, '0');\n      return `${year}-${month}-${day}`;\n    };\n\n    // Helper to format date for display\n    const formatDateDisplay = (dateKey: string): string => {\n      const [year, month, day] = dateKey.split('-');\n      const date = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day)));\n      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });\n    };\n\n    // Calculate trailing 30 days in UTC\n    const now = new Date();\n    const nowUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));\n    \n    // Generate last 30 days using UTC\n    const dateKeys: string[] = [];\n    const startDate = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate() - 29));\n    \n    for (let i = 0; i < 30; i++) {\n      const dayDate = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate() + i));\n      dateKeys.push(getDateKey(dayDate));\n    }\n    \n    // Date range for filtering\n    const startOfTrailingPeriod = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()));\n    const endOfToday = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth(), nowUTC.getUTCDate(), 23, 59, 59, 999));\n\n    // Aggregate actual production by day with explicit date range filtering\n    const dailyData: { [key: string]: { eggs: number; crates: number } } = {};\n    if (dailyRecords && dailyRecords.length > 0) {\n      dailyRecords.forEach((record: any) => {\n        // Parse record date - handle both date-only (YYYY-MM-DD) and ISO timestamp formats\n        const dateStr = record.recordDate;\n        const recordDate = dateStr.includes('T') \n          ? new Date(dateStr) // Already has time component\n          : new Date(`${dateStr}T00:00:00Z`); // Add UTC time for date-only strings\n        \n        // Only include if within trailing 30 days date range\n        if (recordDate >= startOfTrailingPeriod && recordDate <= endOfToday) {\n          const dateKey = getDateKey(recordDate);\n          if (!dailyData[dateKey]) {\n            dailyData[dateKey] = { eggs: 0, crates: 0 };\n          }\n          dailyData[dateKey].eggs += record.eggsCollected || 0;\n          dailyData[dateKey].crates += record.cratesProduced || 0;\n        }\n      });\n    }\n\n    // Create final dataset with zero-filled days\n    return dateKeys.map(dateKey => ({\n      dateKey,\n      date: formatDateDisplay(dateKey),\n      eggs: dailyData[dateKey]?.eggs || 0,\n      crates: dailyData[dateKey]?.crates || 0,\n    }));\n  }, [dailyRecords]);\n\n  // Check if there's any actual production data to display\n  const hasProductionActivity = useMemo(() => {\n    return dailyProductionTrends.some(d => d.eggs > 0 || d.crates > 0);\n  }, [dailyProductionTrends]);\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Header */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <div className=\"flex items-center gap-3 mb-1\">\n                  <h2 className=\"text-xl font-semibold text-foreground\">Egg Production</h2>\n                  {currentFarm && (\n                    <Badge variant={currentFarm.name.includes('Demo') ? 'default' : 'outline'} className=\"text-xs\" data-testid=\"badge-current-farm\">\n                      {currentFarm.name}\n                    </Badge>\n                  )}\n                </div>\n                <p className=\"text-sm text-muted-foreground\">Track daily egg collection and sales</p>\n              </div>\n            </div>\n            \n            <div className=\"flex space-x-2\">\n              <Dialog open={recordDialogOpen} onOpenChange={setRecordDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-add-egg-record\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Add Egg Record\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n                  <DialogHeader>\n                    <DialogTitle>Add Egg Production Record</DialogTitle>\n                    <DialogDescription>\n                      Record daily egg collection data including total eggs, broken eggs, and crates produced.\n                    </DialogDescription>\n                  </DialogHeader>\n                  <SimpleEggProductionForm onSuccess={() => setRecordDialogOpen(false)} />\n                </DialogContent>\n              </Dialog>\n              \n              <Dialog open={saleDialogOpen} onOpenChange={setSaleDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-record-sale\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Record Sale\n                  </Button>\n                </DialogTrigger>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle>Record Egg Sale</DialogTitle>\n                  <DialogDescription>\n                    Record egg sales including customer details and payment information.\n                  </DialogDescription>\n                </DialogHeader>\n                <SalesForm \n                  mode=\"dialog\"\n                  customerNameRequired={false}\n                  showNotes={false}\n                  compact={true}\n                  onSuccess={() => setSaleDialogOpen(false)}\n                />\n              </DialogContent>\n            </Dialog>\n            </div>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          {/* Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n            <Card data-testid=\"card-today-eggs\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Today's Eggs</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{todayTotal.toLocaleString()}</p>\n                    <p className=\"text-xs text-muted-foreground\">{todayCrates} crates</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-chart-3/10 rounded-lg flex items-center justify-center\">\n                    <Egg className=\"h-6 w-6 text-chart-3\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-week-average\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Week Average</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{Math.round(weekAverage).toLocaleString()}</p>\n                    <p className=\"text-xs text-green-600\">↗ Daily average</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <TrendingUp className=\"h-6 w-6 text-primary\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-week-total\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Week Total</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{weekTotal.toLocaleString()}</p>\n                    <p className=\"text-xs text-muted-foreground\">Last 7 days</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <Egg className=\"h-6 w-6 text-chart-2\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-week-revenue\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Week Revenue</p>\n                    <p className=\"text-2xl font-bold text-foreground\">KSh {weekRevenue.toLocaleString()}</p>\n                    <p className=\"text-xs text-green-600\">Sales income</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n                    <DollarSign className=\"h-6 w-6 text-green-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs defaultValue=\"records\" className=\"space-y-4\">\n            <TabsList>\n              <TabsTrigger value=\"records\">Production Records</TabsTrigger>\n              <TabsTrigger value=\"sales\">Sales History</TabsTrigger>\n              <TabsTrigger value=\"analysis\">Production Analysis</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"records\">\n              <Card data-testid=\"card-production-records\">\n                <CardHeader>\n                  <CardTitle>Recent Production Records</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {eggRecords.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <Egg className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No egg production records found</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Start recording daily egg collection</p>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Date</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Eggs Collected</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Crates</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Broken</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Quality</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {eggRecords.slice(0, 10).map((record: any) => (\n                            <tr key={record.id} className=\"border-b border-border/50\" data-testid={`row-record-${record.id}`}>\n                              <td className=\"p-2\">{new Date(record.recordDate).toLocaleDateString()}</td>\n                              <td className=\"p-2 font-medium\">{record.eggsCollected?.toLocaleString()}</td>\n                              <td className=\"p-2\">{record.cratesProduced}</td>\n                              <td className=\"p-2 text-orange-600\">{record.brokenEggs || 0}</td>\n                              <td className=\"p-2\">\n                                <Badge variant={record.brokenEggs > 50 ? \"destructive\" : record.brokenEggs > 20 ? \"secondary\" : \"default\"}>\n                                  {record.brokenEggs > 50 ? \"Poor\" : record.brokenEggs > 20 ? \"Fair\" : \"Good\"}\n                                </Badge>\n                              </td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"sales\">\n              <Card data-testid=\"card-sales-history\">\n                <CardHeader>\n                  <CardTitle>Sales History</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {recentSales.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <DollarSign className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-lg font-medium text-muted-foreground mb-2\">\n                        No Sales Records for {currentFarm?.name || 'Selected Farm'}\n                      </p>\n                      <p className=\"text-sm text-muted-foreground mb-6\">\n                        This farm doesn't have any sales data yet\n                      </p>\n                      <div className=\"flex flex-col sm:flex-row gap-3 justify-center items-center\">\n                        {demoFarm && demoFarm.id !== activeFarmId && (\n                          <Button\n                            variant=\"outline\"\n                            onClick={() => {\n                              setActiveFarmId(demoFarm.id);\n                              toast({\n                                title: \"Switched to Demo Farm\",\n                                description: \"You can now explore sample sales data\",\n                              });\n                            }}\n                            data-testid=\"button-switch-demo\"\n                          >\n                            View Demo Farm Data\n                          </Button>\n                        )}\n                        <Button\n                          onClick={() => setSaleDialogOpen(true)}\n                          data-testid=\"button-add-first-sale\"\n                        >\n                          <Plus className=\"h-4 w-4 mr-2\" />\n                          Record First Sale\n                        </Button>\n                      </div>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Date</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Customer</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Crates</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Price/Crate</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Total</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Status</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {recentSales.map((sale: any) => (\n                            <tr key={sale.id} className=\"border-b border-border/50\" data-testid={`row-sale-${sale.id}`}>\n                              <td className=\"p-2\">{new Date(sale.saleDate).toLocaleDateString()}</td>\n                              <td className=\"p-2\">{sale.customerName || \"Walk-in\"}</td>\n                              <td className=\"p-2\">{sale.cratesSold}</td>\n                              <td className=\"p-2\">KSh {parseFloat(sale.pricePerCrate).toLocaleString()}</td>\n                              <td className=\"p-2 font-medium\">KSh {parseFloat(sale.totalAmount).toLocaleString()}</td>\n                              <td className=\"p-2\">\n                                <Badge variant={\n                                  sale.paymentStatus === \"paid\" ? \"default\" : \n                                  sale.paymentStatus === \"overdue\" ? \"destructive\" : \"secondary\"\n                                }>\n                                  {sale.paymentStatus}\n                                </Badge>\n                              </td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"analysis\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card data-testid=\"card-production-trends\">\n                  <CardHeader>\n                    <CardTitle>Production Trends</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {!hasProductionActivity ? (\n                      <div className=\"h-80 bg-muted/20 rounded-lg flex items-center justify-center\">\n                        <div className=\"text-center\">\n                          <TrendingUp className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                          <p className=\"text-sm text-muted-foreground\">No production data available</p>\n                          <p className=\"text-xs text-muted-foreground mt-2\">Start recording daily production to see trends</p>\n                        </div>\n                      </div>\n                    ) : (\n                      <ResponsiveContainer width=\"100%\" height={320}>\n                        <LineChart data={dailyProductionTrends}>\n                          <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n                          <XAxis \n                            dataKey=\"date\" \n                            className=\"text-xs\"\n                            tick={{ fill: 'hsl(var(--muted-foreground))' }}\n                          />\n                          <YAxis className=\"text-xs\" tick={{ fill: 'hsl(var(--muted-foreground))' }} />\n                          <Tooltip \n                            contentStyle={{ \n                              backgroundColor: 'hsl(var(--card))',\n                              border: '1px solid hsl(var(--border))',\n                              borderRadius: '6px'\n                            }}\n                          />\n                          <Legend />\n                          <Line \n                            type=\"monotone\" \n                            dataKey=\"eggs\" \n                            stroke=\"hsl(221, 83%, 53%)\" \n                            strokeWidth={2.5}\n                            name=\"Eggs Collected\"\n                            dot={false}\n                          />\n                          <Line \n                            type=\"monotone\" \n                            dataKey=\"crates\" \n                            stroke=\"hsl(142, 76%, 36%)\" \n                            strokeWidth={2.5}\n                            name=\"Crates Produced\"\n                            dot={false}\n                          />\n                        </LineChart>\n                      </ResponsiveContainer>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-performance-metrics\">\n                  <CardHeader>\n                    <CardTitle>Performance Metrics</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Laying Rate</span>\n                        <span className=\"font-medium\">89.4%</span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Eggs per Bird/Day</span>\n                        <span className=\"font-medium\">0.89</span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Break Rate</span>\n                        <span className=\"font-medium text-orange-600\">0.5%</span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Revenue/Crate</span>\n                        <span className=\"font-medium text-green-600\">KSh 550</span>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":26939},"client/src/pages/body-weights.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm, useFieldArray } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { AlertCircle, Plus, Trash2, Calculator, TrendingUp, Scale, BarChart3, LineChart, Eye, EyeOff, AlertTriangle, CheckCircle, Download, Menu } from \"lucide-react\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Flock, WeightRecord, InsertWeightRecord } from \"@shared/schema\";\nimport { useCallback } from \"react\";\nimport { BarChart, Bar, LineChart as RechartsLineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, ComposedChart } from 'recharts';\nimport Sidebar from \"@/components/layout/sidebar\";\n\n// Validation schema for weight entry form\nconst weightEntrySchema = z.object({\n  flockId: z.string().min(1, \"Please select a flock\"),\n  weekNumber: z.coerce.number().int().positive().max(100),\n  recordDate: z.string(),\n  notes: z.string().optional(),\n});\n\n// Helper function to validate decimal input with up to 4 decimal places\nconst validateDecimalInput = (value: string): boolean => {\n  const decimalRegex = /^\\d*(?:[.]\\d{0,4})?$/;\n  return decimalRegex.test(value);\n};\n\ntype WeightEntryFormData = z.infer<typeof weightEntrySchema> & {\n  weights: number[];\n};\n\n// Statistics calculation hook with debouncing\nfunction useWeightStatistics(weights: number[], weekNumber: number) {\n  const [statistics, setStatistics] = useState<{\n    average: number;\n    stdDev: number;\n    uniformity: number;\n    sampleSize: number;\n    cvPercent: number;\n    comparisonResult?: string;\n    expectedWeight?: number;\n    weightDeviation?: number;\n  } | null>(null);\n\n  const [debouncedWeights, setDebouncedWeights] = useState<number[]>([]);\n  const [debouncedWeekNumber, setDebouncedWeekNumber] = useState(0);\n\n  // Debounce weights changes to prevent excessive API calls\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedWeights(weights);\n      setDebouncedWeekNumber(weekNumber);\n    }, 500);\n\n    return () => clearTimeout(timer);\n  }, [weights, weekNumber]);\n\n  useEffect(() => {\n    if (debouncedWeights.length === 0) {\n      setStatistics(null);\n      return;\n    }\n\n    // Calculate basic statistics locally\n    const average = debouncedWeights.reduce((sum, weight) => sum + weight, 0) / debouncedWeights.length;\n    const variance = debouncedWeights.reduce((sum, weight) => sum + Math.pow(weight - average, 2), 0) / debouncedWeights.length;\n    const stdDev = Math.sqrt(variance);\n    \n    // Calculate CV% (coefficient of variation)\n    const cvPercent = average > 0 ? Number(((stdDev / average) * 100).toFixed(2)) : 0;\n    \n    // Calculate uniformity (percentage within 10% of average)\n    const tolerance = average * 0.1;\n    const uniformCount = debouncedWeights.filter(weight => Math.abs(weight - average) <= tolerance).length;\n    const uniformity = (uniformCount / debouncedWeights.length) * 100;\n\n    // Call API for breed standard comparison (debounced)\n    if (debouncedWeekNumber > 0) {\n      apiRequest('POST', '/api/weight-records/calculate', { weights: debouncedWeights, weekNumber: debouncedWeekNumber })\n        .then((response: any) => {\n          setStatistics({\n            average: Number(average.toFixed(2)),\n            stdDev: Number(stdDev.toFixed(2)),\n            uniformity: Number(uniformity.toFixed(2)),\n            sampleSize: debouncedWeights.length,\n            cvPercent,\n            comparisonResult: response.comparisonResult,\n            expectedWeight: response.expectedWeight,\n            weightDeviation: response.weightDeviation,\n          });\n        })\n        .catch(() => {\n          // Fallback to local calculations only\n          setStatistics({\n            average: Number(average.toFixed(2)),\n            stdDev: Number(stdDev.toFixed(2)),\n            uniformity: Number(uniformity.toFixed(2)),\n            sampleSize: debouncedWeights.length,\n            cvPercent,\n          });\n        });\n    } else {\n      setStatistics({\n        average: Number(average.toFixed(2)),\n        stdDev: Number(stdDev.toFixed(2)),\n        uniformity: Number(uniformity.toFixed(2)),\n        sampleSize: debouncedWeights.length,\n        cvPercent,\n      });\n    }\n  }, [debouncedWeights, debouncedWeekNumber]);\n\n  return statistics;\n}\n\n// Enhanced alerting system functions\nconst generateCVAlert = (cvPercent: number | null) => {\n  if (!cvPercent) return null;\n  \n  if (cvPercent > 10) {\n    return {\n      type: 'error' as const,\n      title: 'Poor Weight Uniformity',\n      message: `CV% too high (${cvPercent.toFixed(2)}%) — flock uniformity is poor, check feeding or health.`,\n      icon: AlertTriangle,\n    };\n  }\n  \n  return null;\n};\n\nconst generateWeightGainAlert = (currentWeight: number, expectedWeight: number | null, weekNumber: number) => {\n  if (!expectedWeight) return null;\n  \n  const actualPercentOfStandard = (currentWeight / expectedWeight) * 100;\n  \n  if (actualPercentOfStandard < 90) {\n    return {\n      type: 'error' as const,\n      title: 'Below Standard Weight Gain',\n      message: `Week ${weekNumber}: Actual weight is ${actualPercentOfStandard.toFixed(1)}% of standard (${currentWeight.toFixed(3)}kg vs ${expectedWeight.toFixed(3)}kg expected)`,\n      icon: AlertTriangle,\n    };\n  } else if (actualPercentOfStandard > 110) {\n    return {\n      type: 'warning' as const,\n      title: 'Above Standard Weight Gain',\n      message: `Week ${weekNumber}: Actual weight is ${actualPercentOfStandard.toFixed(1)}% of standard (${currentWeight.toFixed(3)}kg vs ${expectedWeight.toFixed(3)}kg expected)`,\n      icon: AlertCircle,\n    };\n  } else {\n    return {\n      type: 'success' as const,\n      title: 'Weight Gain Within Range',\n      message: `Week ${weekNumber}: Weight gain is ${actualPercentOfStandard.toFixed(1)}% of standard - within acceptable range`,\n      icon: CheckCircle,\n    };\n  }\n};\n\nconst classifyBirdWeight = (weight: number, mean: number) => {\n  const tolerance = mean * 0.1; // 10% tolerance\n  \n  if (weight < (mean - tolerance)) {\n    return { classification: 'Low', color: 'text-red-600' };\n  } else if (weight > (mean + tolerance)) {\n    return { classification: 'High', color: 'text-orange-600' };\n  } else {\n    return { classification: 'Normal', color: 'text-green-600' };\n  }\n};\n\n// Helper functions for distribution histogram and normal curve\nconst generateHistogramData = (weights: number[], mean: number, stdDev: number) => {\n  if (weights.length === 0) return [];\n  \n  const min = Math.min(...weights);\n  const max = Math.max(...weights);\n  const range = max - min;\n  \n  // Handle edge case: all weights are identical (range = 0)\n  if (range === 0) {\n    return [{\n      x: min,\n      frequency: weights.length,\n      normalDensity: 0, // No distribution when stdDev = 0\n      binStart: min,\n      binEnd: min,\n    }];\n  }\n  \n  const binCount = Math.min(10, Math.ceil(Math.sqrt(weights.length))); // Optimal bin count\n  const binWidth = range / binCount;\n  \n  // Create bins\n  const bins = Array.from({ length: binCount }, (_, i) => ({\n    x: min + (i + 0.5) * binWidth, // Center of bin\n    frequency: 0,\n    normalDensity: 0,\n    binStart: min + i * binWidth,\n    binEnd: min + (i + 1) * binWidth,\n  }));\n  \n  // Count frequencies\n  weights.forEach(weight => {\n    const binIndex = Math.min(Math.floor((weight - min) / binWidth), binCount - 1);\n    bins[binIndex].frequency++;\n  });\n  \n  // Calculate normal distribution density for each bin (only if stdDev > 0)\n  if (stdDev > 0) {\n    bins.forEach(bin => {\n      // Normal distribution probability density function\n      const exponent = -0.5 * Math.pow((bin.x - mean) / stdDev, 2);\n      const density = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(exponent);\n      // Scale density to match frequency scale\n      bin.normalDensity = density * weights.length * binWidth;\n    });\n  }\n  \n  return bins;\n};\n\n// CSV/PDF download helper functions\nconst generateCSVReport = (weightRecord: WeightRecord) => {\n  const weights = weightRecord.weights as number[];\n  const mean = parseFloat(weightRecord.averageWeight);\n  \n  const csvData = [\n    ['Weight Record Summary'],\n    ['Week Number', weightRecord.weekNumber.toString()],\n    ['Date', new Date(weightRecord.recordDate).toLocaleDateString()],\n    ['Sample Size', weightRecord.sampleSize.toString()],\n    ['Average Weight (kg)', weightRecord.averageWeight],\n    ['Standard Deviation (kg)', weightRecord.stdDev],\n    ['CV%', weightRecord.cvPercent || 'N/A'],\n    ['Uniformity (%)', weightRecord.uniformity],\n    [''],\n    ['Individual Bird Weights'],\n    ['Bird #', 'Weight (kg)', 'Classification', 'Deviation (%)'],\n    ...weights.map((weight, index) => {\n      const classification = classifyBirdWeight(weight, mean);\n      const deviation = ((weight - mean) / mean) * 100;\n      return [\n        (index + 1).toString(),\n        weight.toFixed(4),\n        classification.classification,\n        `${deviation > 0 ? '+' : ''}${deviation.toFixed(1)}%`\n      ];\n    }),\n    [''],\n    ['Range Alert Summary'],\n    ['Low Count (< -10%)', weights.filter(w => classifyBirdWeight(w, mean).classification === 'Low').length.toString()],\n    ['Normal Count (±10%)', weights.filter(w => classifyBirdWeight(w, mean).classification === 'Normal').length.toString()],\n    ['High Count (> +10%)', weights.filter(w => classifyBirdWeight(w, mean).classification === 'High').length.toString()],\n    ['Low Percentage', `${((weights.filter(w => classifyBirdWeight(w, mean).classification === 'Low').length / weights.length) * 100).toFixed(1)}%`],\n    ['Normal Percentage', `${((weights.filter(w => classifyBirdWeight(w, mean).classification === 'Normal').length / weights.length) * 100).toFixed(1)}%`],\n    ['High Percentage', `${((weights.filter(w => classifyBirdWeight(w, mean).classification === 'High').length / weights.length) * 100).toFixed(1)}%`],\n  ];\n  \n  return csvData.map(row => row.join(',')).join('\\n');\n};\n\nconst downloadCSVReport = (weightRecord: WeightRecord) => {\n  const csvContent = generateCSVReport(weightRecord);\n  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n  const link = document.createElement('a');\n  const url = URL.createObjectURL(blob);\n  link.setAttribute('href', url);\n  link.setAttribute('download', `weight-record-week-${weightRecord.weekNumber}-${new Date(weightRecord.recordDate).toISOString().split('T')[0]}.csv`);\n  link.style.visibility = 'hidden';\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n};\n\n// PDF download functionality\nconst generatePDFContent = (weightRecord: WeightRecord) => {\n  const weights = weightRecord.weights as number[];\n  const mean = parseFloat(weightRecord.averageWeight);\n  const lowCount = weights.filter(w => classifyBirdWeight(w, mean).classification === 'Low').length;\n  const normalCount = weights.filter(w => classifyBirdWeight(w, mean).classification === 'Normal').length;\n  const highCount = weights.filter(w => classifyBirdWeight(w, mean).classification === 'High').length;\n  \n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <title>Weight Record Report - Week ${weightRecord.weekNumber}</title>\n      <style>\n        body { font-family: Arial, sans-serif; margin: 20px; }\n        .header { text-align: center; margin-bottom: 30px; }\n        .summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0; }\n        .stat-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }\n        .stat-label { font-size: 12px; color: #666; }\n        .stat-value { font-size: 18px; font-weight: bold; }\n        .range-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }\n        .range-card { border: 1px solid #ddd; padding: 10px; text-align: center; border-radius: 5px; }\n        .low { border-color: #ef4444; background: #fef2f2; }\n        .normal { border-color: #22c55e; background: #f0fdf4; }\n        .high { border-color: #f97316; background: #fff7ed; }\n        table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n        th { background-color: #f5f5f5; }\n        .classification-low { color: #ef4444; font-weight: bold; }\n        .classification-normal { color: #22c55e; font-weight: bold; }\n        .classification-high { color: #f97316; font-weight: bold; }\n      </style>\n    </head>\n    <body>\n      <div class=\"header\">\n        <h1>Weight Record Report</h1>\n        <h2>Week ${weightRecord.weekNumber} - ${new Date(weightRecord.recordDate).toLocaleDateString()}</h2>\n      </div>\n      \n      <div class=\"summary\">\n        <div class=\"stat-card\">\n          <div class=\"stat-label\">Sample Size</div>\n          <div class=\"stat-value\">${weightRecord.sampleSize} birds</div>\n        </div>\n        <div class=\"stat-card\">\n          <div class=\"stat-label\">Average Weight</div>\n          <div class=\"stat-value\">${weightRecord.averageWeight} kg</div>\n        </div>\n        <div class=\"stat-card\">\n          <div class=\"stat-label\">Standard Deviation</div>\n          <div class=\"stat-value\">${weightRecord.stdDev} kg</div>\n        </div>\n        <div class=\"stat-card\">\n          <div class=\"stat-label\">CV%</div>\n          <div class=\"stat-value\">${weightRecord.cvPercent || 'N/A'}%</div>\n        </div>\n        <div class=\"stat-card\">\n          <div class=\"stat-label\">Uniformity</div>\n          <div class=\"stat-value\">${weightRecord.uniformity}%</div>\n        </div>\n      </div>\n      \n      <h3>Range Distribution</h3>\n      <div class=\"range-summary\">\n        <div class=\"range-card low\">\n          <div>Low (&lt; -10%)</div>\n          <div style=\"font-size: 24px; font-weight: bold;\">${lowCount}</div>\n          <div>${((lowCount / weights.length) * 100).toFixed(1)}%</div>\n        </div>\n        <div class=\"range-card normal\">\n          <div>Normal (±10%)</div>\n          <div style=\"font-size: 24px; font-weight: bold;\">${normalCount}</div>\n          <div>${((normalCount / weights.length) * 100).toFixed(1)}%</div>\n        </div>\n        <div class=\"range-card high\">\n          <div>High (&gt; +10%)</div>\n          <div style=\"font-size: 24px; font-weight: bold;\">${highCount}</div>\n          <div>${((highCount / weights.length) * 100).toFixed(1)}%</div>\n        </div>\n      </div>\n      \n      <h3>Individual Bird Weights</h3>\n      <table>\n        <thead>\n          <tr>\n            <th>Bird #</th>\n            <th>Weight (kg)</th>\n            <th>Classification</th>\n            <th>Deviation</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${weights.map((weight, index) => {\n            const classification = classifyBirdWeight(weight, mean);\n            const deviation = ((weight - mean) / mean) * 100;\n            return `\n              <tr>\n                <td>${index + 1}</td>\n                <td>${weight.toFixed(4)}</td>\n                <td class=\"classification-${classification.classification.toLowerCase()}\">${classification.classification}</td>\n                <td>${deviation > 0 ? '+' : ''}${deviation.toFixed(1)}%</td>\n              </tr>\n            `;\n          }).join('')}\n        </tbody>\n      </table>\n      \n      ${weightRecord.notes ? `\n        <h3>Notes</h3>\n        <p style=\"background: #f5f5f5; padding: 15px; border-radius: 5px;\">${weightRecord.notes}</p>\n      ` : ''}\n    </body>\n    </html>\n  `;\n};\n\nconst downloadPDFReport = (weightRecord: WeightRecord) => {\n  const htmlContent = generatePDFContent(weightRecord);\n  const printWindow = window.open('', '_blank');\n  if (printWindow) {\n    printWindow.document.write(htmlContent);\n    printWindow.document.close();\n    printWindow.focus();\n    setTimeout(() => {\n      printWindow.print();\n    }, 250);\n  }\n};\n\nexport default function BodyWeights() {\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n  const { toast } = useToast();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [weightInputs, setWeightInputs] = useState<{ id: number; weight: string }[]>([\n    { id: 1, weight: \"\" }\n  ]);\n  const [nextId, setNextId] = useState(2);\n  const [expandedRecords, setExpandedRecords] = useState<Set<string>>(new Set());\n  const [selectedFlockFilter, setSelectedFlockFilter] = useState<string>(\"all\"); // \"all\" means \"All Flocks\"\n\n  // Fetch flocks for the dropdown\n  const { data: flocks = [], isLoading: flocksLoading } = useQuery<Flock[]>({\n    queryKey: ['/api/flocks', activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/flocks?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch flocks');\n      return response.json();\n    },\n    enabled: hasActiveFarm && !!activeFarmId,\n  });\n\n  // Fetch existing weight records\n  const { data: weightRecords = [], isLoading: recordsLoading } = useQuery<WeightRecord[]>({\n    queryKey: ['/api/weight-records', activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/weight-records?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch weight records');\n      return response.json();\n    },\n    enabled: hasActiveFarm && !!activeFarmId,\n  });\n\n  // Filter weight records by selected flock\n  const filteredWeightRecords = selectedFlockFilter === \"all\" \n    ? weightRecords\n    : weightRecords.filter(record => record.flockId === selectedFlockFilter);\n\n  // Form setup\n  const form = useForm<WeightEntryFormData>({\n    resolver: zodResolver(weightEntrySchema),\n    defaultValues: {\n      flockId: \"\",\n      weekNumber: 1,\n      recordDate: new Date().toISOString().split('T')[0],\n      weights: [],\n      notes: \"\",\n    },\n  });\n\n  const watchedFlockId = form.watch(\"flockId\");\n  const watchedWeekNumber = form.watch(\"weekNumber\");\n\n  // Calculate current week number based on selected flock\n  useEffect(() => {\n    if (watchedFlockId) {\n      const selectedFlock = flocks.find(f => f.id === watchedFlockId);\n      if (selectedFlock?.hatchDate) {\n        const hatchDate = new Date(selectedFlock.hatchDate);\n        const now = new Date();\n        const diffTime = Math.abs(now.getTime() - hatchDate.getTime());\n        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n        const calculatedWeek = Math.ceil(diffDays / 7);\n        form.setValue(\"weekNumber\", calculatedWeek);\n      }\n    }\n  }, [watchedFlockId, flocks, form]);\n\n  // Extract weights from input fields\n  const currentWeights = weightInputs\n    .map(input => parseFloat(input.weight))\n    .filter(weight => !isNaN(weight) && weight > 0);\n\n  // Calculate statistics\n  const statistics = useWeightStatistics(currentWeights, watchedWeekNumber);\n\n  // Add weight input field\n  const addWeightInput = () => {\n    setWeightInputs(prev => [...prev, { id: nextId, weight: \"\" }]);\n    setNextId(prev => prev + 1);\n  };\n\n  // Remove weight input field\n  const removeWeightInput = (id: number) => {\n    if (weightInputs.length > 1) {\n      setWeightInputs(prev => prev.filter(input => input.id !== id));\n    }\n  };\n\n  // Update weight input value with validation\n  const updateWeightInput = useCallback((id: number, value: string) => {\n    // Normalize comma to dot and validate format\n    const normalizedValue = value.replace(',', '.');\n    \n    // Only update if the value matches our decimal pattern\n    if (normalizedValue === '' || validateDecimalInput(normalizedValue)) {\n      setWeightInputs(prev => prev.map(input => \n        input.id === id ? { ...input, weight: normalizedValue } : input\n      ));\n    }\n  }, []);\n\n  // Add multiple weight inputs at once\n  const addMultipleInputs = (count: number) => {\n    const newInputs = Array.from({ length: count }, (_, i) => ({\n      id: nextId + i,\n      weight: \"\"\n    }));\n    setWeightInputs(prev => [...prev, ...newInputs]);\n    setNextId(prev => prev + count);\n  };\n\n  // Create weight record mutation\n  const createWeightRecord = useMutation({\n    mutationFn: async (data: WeightEntryFormData) => {\n      // Calculate statistics from weights\n      const weights = data.weights;\n      const sampleSize = weights.length;\n      const averageWeight = weights.reduce((sum, weight) => sum + weight, 0) / weights.length;\n      const variance = weights.reduce((sum, weight) => sum + Math.pow(weight - averageWeight, 2), 0) / weights.length;\n      const stdDev = Math.sqrt(variance);\n      \n      // Calculate uniformity (percentage within 10% of average)\n      const tolerance = averageWeight * 0.1;\n      const uniformCount = weights.filter(weight => Math.abs(weight - averageWeight) <= tolerance).length;\n      const uniformity = (uniformCount / weights.length) * 100;\n\n      const payload = {\n        flockId: data.flockId,\n        weekNumber: data.weekNumber,\n        recordDate: data.recordDate,\n        weights: data.weights,\n        sampleSize,\n        averageWeight: Number(averageWeight.toFixed(4)),\n        stdDev: Number(stdDev.toFixed(4)),\n        uniformity: Number(uniformity.toFixed(2)),\n        notes: data.notes || null,\n      };\n      \n      return apiRequest('POST', '/api/weight-records', payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/weight-records', activeFarmId] });\n      toast({\n        title: \"Success\",\n        description: \"Weight record created successfully\",\n      });\n      // Reset form\n      form.reset();\n      setWeightInputs([{ id: 1, weight: \"\" }]);\n      setNextId(2);\n    },\n    onError: (error: any) => {\n      const errorMessage = error.message || \"Failed to create weight record\";\n      let description = errorMessage;\n      \n      // Handle specific duplicate record error\n      if (error.status === 409 || errorMessage.includes(\"already exists\")) {\n        description = \"A weight record for this flock and week already exists. Please choose a different week number or edit the existing record.\";\n      }\n      \n      toast({\n        title: \"Error\",\n        description,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: WeightEntryFormData) => {\n    const weights = currentWeights;\n    if (weights.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter at least one weight measurement\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Sync current weights into form data before validation\n    const submissionData = {\n      ...data,\n      weights,\n    };\n\n    createWeightRecord.mutate(submissionData);\n  };\n\n  // Toggle record expansion\n  const toggleRecordExpansion = (recordId: string) => {\n    setExpandedRecords(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(recordId)) {\n        newSet.delete(recordId);\n      } else {\n        newSet.add(recordId);\n      }\n      return newSet;\n    });\n  };\n\n  // Calculate normal distribution probability density function\n  const normalPDF = (x: number, mean: number, stdDev: number) => {\n    if (stdDev === 0) return 0;\n    const coefficient = 1 / (stdDev * Math.sqrt(2 * Math.PI));\n    const exponent = -0.5 * Math.pow((x - mean) / stdDev, 2);\n    return coefficient * Math.exp(exponent);\n  };\n\n  // Create enhanced histogram data with normal distribution overlay\n  const createHistogramData = (weights: number[]) => {\n    if (!weights || weights.length === 0) return { bins: [], normalCurve: [] };\n    \n    const mean = weights.reduce((sum, w) => sum + w, 0) / weights.length;\n    const variance = weights.reduce((sum, w) => sum + Math.pow(w - mean, 2), 0) / weights.length;\n    const stdDev = Math.sqrt(variance);\n    \n    const min = Math.min(...weights);\n    const max = Math.max(...weights);\n    \n    // Use Freedman-Diaconis rule for bin width, clamped to 0.01-0.03 kg\n    const iqr = weights.sort((a, b) => a - b)[Math.floor(weights.length * 0.75)] - \n                weights[Math.floor(weights.length * 0.25)];\n    const fdBinWidth = 2 * iqr / Math.pow(weights.length, 1/3);\n    const binWidth = Math.max(0.01, Math.min(0.03, fdBinWidth));\n    const binCount = Math.max(5, Math.ceil((max - min) / binWidth));\n    \n    // Create bins\n    const bins = Array.from({ length: binCount }, (_, i) => {\n      const binStart = min + i * binWidth;\n      const binEnd = binStart + binWidth;\n      const count = weights.filter(w => w >= binStart && (i === binCount - 1 ? w <= binEnd : w < binEnd)).length;\n      \n      return {\n        range: `${binStart.toFixed(3)}-${binEnd.toFixed(3)}`,\n        count,\n        midpoint: binStart + binWidth / 2,\n        binStart,\n        binEnd\n      };\n    });\n    \n    // Create normal distribution curve points (only if stdDev > 0)\n    const normalCurve = stdDev > 0 ? Array.from({ length: 100 }, (_, i) => {\n      const x = min + (i / 99) * (max - min);\n      const pdf = normalPDF(x, mean, stdDev);\n      const scaledY = pdf * weights.length * binWidth; // Scale to match histogram\n      \n      return { x, y: scaledY };\n    }) : [];\n    \n    return { bins, normalCurve };\n  };\n\n  // Create weekly weight gain data\n  const createWeeklyGainData = () => {\n    if (!filteredWeightRecords || filteredWeightRecords.length < 2) return [];\n    \n    const sortedRecords = [...filteredWeightRecords].sort((a, b) => a.weekNumber - b.weekNumber);\n    const gainData = [];\n    \n    for (let i = 1; i < sortedRecords.length; i++) {\n      const currentRecord = sortedRecords[i];\n      const previousRecord = sortedRecords[i - 1];\n      \n      const actualGain = parseFloat(currentRecord.averageWeight) - parseFloat(previousRecord.averageWeight);\n      const currentStandard = currentRecord.expectedWeight ? parseFloat(currentRecord.expectedWeight) : null;\n      const previousStandard = previousRecord.expectedWeight ? parseFloat(previousRecord.expectedWeight) : null;\n      const standardGain = (currentStandard && previousStandard) ? currentStandard - previousStandard : null;\n      \n      gainData.push({\n        week: currentRecord.weekNumber,\n        actualGain: Number(actualGain.toFixed(3)),\n        standardGain: standardGain ? Number(standardGain.toFixed(3)) : null\n      });\n    }\n    \n    return gainData;\n  };\n\n  // Create weekly comparison chart data\n  const createWeeklyChartData = () => {\n    if (!filteredWeightRecords || filteredWeightRecords.length === 0) return [];\n    \n    return filteredWeightRecords\n      .sort((a, b) => a.weekNumber - b.weekNumber)\n      .map(record => ({\n        week: record.weekNumber,\n        actual: parseFloat(record.averageWeight),\n        standard: record.expectedWeight ? parseFloat(record.expectedWeight) : null,\n        uniformity: parseFloat(record.uniformity)\n      }));\n  };\n\n  if (!activeFarmId) {\n    return (\n      <div className=\"min-h-screen flex bg-background\">\n        <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n        \n        {sidebarOpen && (\n          <div \n            className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n            onClick={() => setSidebarOpen(false)}\n          />\n        )}\n\n        <div className=\"flex-1 flex flex-col min-h-screen\">\n          <header className=\"border-b border-border bg-card sticky top-0 z-30\">\n            <div className=\"px-6 py-4\">\n              <div className=\"flex items-center space-x-4\">\n                <button \n                  className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                  onClick={() => setSidebarOpen(true)}\n                >\n                  <Menu className=\"h-5 w-5\" />\n                </button>\n              </div>\n            </div>\n          </header>\n\n          <main className=\"flex-1 p-6\">\n            <Alert>\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                Please select a farm to continue with body weight tracking.\n              </AlertDescription>\n            </Alert>\n          </main>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      <div className=\"flex-1 flex flex-col min-h-screen\">\n        <header className=\"border-b border-border bg-card sticky top-0 z-30\">\n          <div className=\"px-6 py-4\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h1 className=\"text-2xl font-bold\">Body Weight Tracking</h1>\n                <p className=\"text-sm text-muted-foreground\">\n                  Record and analyze weekly body weights for flock performance monitoring\n                </p>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        <main className=\"flex-1 space-y-6 p-6\">\n\n      <div className=\"grid gap-6 lg:grid-cols-2\">\n        {/* Weight Entry Form */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Scale className=\"h-5 w-5\" />\n              New Weight Record\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                {/* Flock Selection */}\n                <FormField\n                  control={form.control}\n                  name=\"flockId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Flock</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-flock\">\n                            <SelectValue placeholder=\"Select a flock\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {flocksLoading ? (\n                            <SelectItem value=\"loading\">Loading flocks...</SelectItem>\n                          ) : (\n                            flocks.map((flock) => (\n                              <SelectItem key={flock.id} value={flock.id}>\n                                {flock.name} ({flock.currentCount} birds)\n                              </SelectItem>\n                            ))\n                          )}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Week Number and Date */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"weekNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Week Number</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"number\"\n                            min=\"1\"\n                            max=\"100\"\n                            data-testid=\"input-week-number\"\n                            {...field}\n                            onChange={(e) => field.onChange(parseInt(e.target.value) || 1)}\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"recordDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Record Date</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"date\"\n                            data-testid=\"input-record-date\"\n                            {...field}\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {/* Weight Measurements Section */}\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label>Bird Weights (kg)</Label>\n                    <div className=\"flex gap-2\">\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => addMultipleInputs(10)}\n                        data-testid=\"button-add-10-weights\"\n                      >\n                        Add 10\n                      </Button>\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => addMultipleInputs(50)}\n                        data-testid=\"button-add-50-weights\"\n                      >\n                        Add 50\n                      </Button>\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={addWeightInput}\n                        data-testid=\"button-add-weight\"\n                      >\n                        <Plus className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-3 gap-2 max-h-40 overflow-y-auto border rounded p-2\">\n                    {weightInputs.map((input) => (\n                      <div key={input.id} className=\"flex gap-1\">\n                        <Input\n                          type=\"text\"\n                          inputMode=\"decimal\"\n                          placeholder=\"0.0000\"\n                          value={input.weight}\n                          onChange={(e) => updateWeightInput(input.id, e.target.value)}\n                          onBlur={(e) => {\n                            // Format to 4 decimal places on blur if it's a valid number\n                            const num = parseFloat(e.target.value);\n                            if (!isNaN(num) && num > 0) {\n                              const formatted = num.toFixed(4);\n                              updateWeightInput(input.id, formatted);\n                            }\n                          }}\n                          data-testid={`input-weight-${input.id}`}\n                          className=\"text-sm\"\n                        />\n                        {weightInputs.length > 1 && (\n                          <Button\n                            type=\"button\"\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => removeWeightInput(input.id)}\n                            data-testid={`button-remove-weight-${input.id}`}\n                            className=\"px-2\"\n                          >\n                            <Trash2 className=\"h-3 w-3\" />\n                          </Button>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                  \n                  <p className=\"text-sm text-muted-foreground\">\n                    Enter individual bird weights. Current count: {currentWeights.length}\n                  </p>\n                </div>\n\n                {/* Notes */}\n                <FormField\n                  control={form.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Notes (Optional)</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Any observations about the birds or weighing conditions...\"\n                          data-testid=\"textarea-notes\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full\"\n                  disabled={createWeightRecord.isPending || currentWeights.length === 0}\n                  data-testid=\"button-submit-weight-record\"\n                >\n                  {createWeightRecord.isPending ? \"Creating...\" : \"Create Weight Record\"}\n                </Button>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n\n        {/* Statistics Panel */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Calculator className=\"h-5 w-5\" />\n              Real-time Statistics\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {statistics && currentWeights.length > 0 ? (\n              <div className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-1\">\n                    <Label className=\"text-sm text-muted-foreground\">Sample Size</Label>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-sample-size\">\n                      {statistics.sampleSize}\n                    </p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label className=\"text-sm text-muted-foreground\">Average Weight</Label>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-average-weight\">\n                      {statistics.average} kg\n                    </p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label className=\"text-sm text-muted-foreground\">Standard Deviation</Label>\n                    <p className=\"text-lg font-semibold\" data-testid=\"stat-std-dev\">\n                      {statistics.stdDev} kg\n                    </p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label className=\"text-sm text-muted-foreground\">CV%</Label>\n                    <p className={`text-lg font-semibold ${\n                      statistics.cvPercent > 10 ? 'text-red-600' : \n                      statistics.cvPercent > 8 ? 'text-orange-600' : \n                      'text-green-600'\n                    }`} data-testid=\"stat-cv-percent\">\n                      {statistics.cvPercent.toFixed(2)}%\n                    </p>\n                  </div>\n                </div>\n\n                {statistics.comparisonResult && (\n                  <>\n                    <Separator />\n                    <div className=\"space-y-3\">\n                      <Label className=\"text-sm text-muted-foreground\">Breed Standard Comparison</Label>\n                      \n                      <div className=\"flex items-center gap-2\">\n                        <Badge\n                          variant={\n                            statistics.comparisonResult === 'within_standard' ? 'default' :\n                            statistics.comparisonResult === 'above_standard' ? 'secondary' :\n                            'destructive'\n                          }\n                          data-testid=\"badge-comparison-result\"\n                        >\n                          {statistics.comparisonResult === 'within_standard' && 'Within Standard'}\n                          {statistics.comparisonResult === 'above_standard' && 'Above Standard'}\n                          {statistics.comparisonResult === 'below_standard' && 'Below Standard'}\n                        </Badge>\n                        <TrendingUp className=\"h-4 w-4\" />\n                      </div>\n\n                      {statistics.expectedWeight && (\n                        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                          <div>\n                            <Label className=\"text-xs text-muted-foreground\">Expected Weight</Label>\n                            <p className=\"font-semibold\" data-testid=\"stat-expected-weight\">\n                              {statistics.expectedWeight} kg\n                            </p>\n                          </div>\n                          <div>\n                            <Label className=\"text-xs text-muted-foreground\">Deviation</Label>\n                            <p \n                              className={`font-semibold ${\n                                (statistics.weightDeviation || 0) >= 0 ? 'text-green-600' : 'text-red-600'\n                              }`}\n                              data-testid=\"stat-weight-deviation\"\n                            >\n                              {(statistics.weightDeviation || 0) > 0 ? '+' : ''}{statistics.weightDeviation || 0} kg\n                            </p>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            ) : (\n              <p className=\"text-muted-foreground text-center py-8\">\n                Enter weight measurements to see real-time statistics\n              </p>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Distribution Histogram with Normal Curve Overlay */}\n        {statistics && currentWeights.length > 0 && (\n          <Card data-testid=\"distribution-histogram-card\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <BarChart3 className=\"h-5 w-5\" />\n                Weight Distribution Histogram\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"h-64 mb-4\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <ComposedChart data={generateHistogramData(currentWeights, statistics.average, statistics.stdDev)}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis \n                      dataKey=\"x\" \n                      domain={['dataMin', 'dataMax']}\n                      scale=\"linear\"\n                      type=\"number\"\n                      tickFormatter={(value) => `${value.toFixed(2)} kg`}\n                    />\n                    <YAxis yAxisId=\"left\" orientation=\"left\" label={{ value: 'Frequency', angle: -90, position: 'insideLeft' }} />\n                    <YAxis yAxisId=\"right\" orientation=\"right\" label={{ value: 'Normal Density', angle: 90, position: 'insideRight' }} />\n                    <Tooltip \n                      formatter={(value: any, name: string) => [\n                        name === 'frequency' ? value : value.toFixed(3),\n                        name === 'frequency' ? 'Frequency' : 'Normal Density'\n                      ]}\n                      labelFormatter={(value) => `Weight: ${value.toFixed(2)} kg`}\n                    />\n                    <Bar \n                      yAxisId=\"left\"\n                      dataKey=\"frequency\" \n                      fill=\"#3b82f6\" \n                      opacity={0.7}\n                      name=\"frequency\"\n                    />\n                    <Line \n                      yAxisId=\"right\"\n                      type=\"monotone\" \n                      dataKey=\"normalDensity\" \n                      stroke=\"#ef4444\" \n                      strokeWidth={2}\n                      dot={false}\n                      name=\"normalDensity\"\n                    />\n                  </ComposedChart>\n                </ResponsiveContainer>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                Blue bars show actual weight distribution. Red line shows expected normal distribution curve based on calculated mean and standard deviation.\n              </p>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Alert Panel for CV% and Weight Gain Alerts */}\n      {statistics && currentWeights.length > 0 && (\n        <div className=\"space-y-4\">\n          {(() => {\n            const alerts = [];\n            \n            // CV% alert using calculated cvPercent\n            const cvAlert = generateCVAlert(statistics.cvPercent);\n            if (cvAlert) alerts.push(cvAlert);\n            \n            // Check weight gain alert if we have breed standard data\n            if (statistics.expectedWeight) {\n              const weightGainAlert = generateWeightGainAlert(\n                statistics.average, \n                statistics.expectedWeight, \n                watchedWeekNumber\n              );\n              if (weightGainAlert) alerts.push(weightGainAlert);\n            }\n            \n            return alerts.length > 0 ? (\n              <div className=\"space-y-3\" data-testid=\"alert-panel\">\n                <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n                  <AlertTriangle className=\"h-5 w-5\" />\n                  Performance Alerts\n                </h3>\n                {alerts.map((alert, index) => {\n                  const Icon = alert.icon;\n                  return (\n                    <Alert \n                      key={index}\n                      variant={alert.type === 'error' ? 'destructive' : alert.type === 'warning' ? 'default' : 'default'}\n                      className={\n                        alert.type === 'error' ? 'border-red-500 bg-red-50 dark:bg-red-900/20' :\n                        alert.type === 'warning' ? 'border-orange-500 bg-orange-50 dark:bg-orange-900/20' :\n                        'border-green-500 bg-green-50 dark:bg-green-900/20'\n                      }\n                      data-testid={`alert-${alert.type}-${index}`}\n                    >\n                      <Icon className=\"h-4 w-4\" />\n                      <AlertTitle>{alert.title}</AlertTitle>\n                      <AlertDescription>{alert.message}</AlertDescription>\n                    </Alert>\n                  );\n                })}\n              </div>\n            ) : null;\n          })()}\n        </div>\n      )}\n\n      {/* Enhanced Weight Records with Visualizations */}\n      <div className=\"space-y-6\">\n        {/* Flock Filter Control */}\n        <div className=\"flex items-center justify-end\">\n          <div className=\"flex items-center gap-2\">\n            <Label htmlFor=\"flock-filter\" className=\"text-sm\">Filter by Flock:</Label>\n            <Select \n              value={selectedFlockFilter} \n              onValueChange={setSelectedFlockFilter}\n              data-testid=\"select-flock-filter\"\n            >\n              <SelectTrigger className=\"w-[200px]\" id=\"flock-filter\">\n                <SelectValue placeholder=\"All Flocks\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\" data-testid=\"flock-filter-all\">All Flocks</SelectItem>\n                {flocks.map((flock) => (\n                  <SelectItem key={flock.id} value={flock.id} data-testid={`flock-filter-${flock.id}`}>\n                    {flock.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        {/* Weekly Comparison Chart */}\n        {filteredWeightRecords.length > 1 && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <LineChart className=\"h-5 w-5\" />\n                Weekly Progress - Actual vs Standard\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"h-80 w-full\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <RechartsLineChart data={createWeeklyChartData()}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis \n                      dataKey=\"week\" \n                      label={{ value: 'Week Number', position: 'insideBottom', offset: -5 }}\n                    />\n                    <YAxis \n                      label={{ value: 'Weight (kg)', angle: -90, position: 'insideLeft' }}\n                    />\n                    <Tooltip \n                      formatter={(value: any, name: string) => [\n                        `${parseFloat(value).toFixed(3)} kg`, \n                        name === 'actual' ? 'Actual Weight' : 'Standard Weight'\n                      ]}\n                      labelFormatter={(week) => `Week ${week}`}\n                    />\n                    <Line \n                      type=\"monotone\" \n                      dataKey=\"actual\" \n                      stroke=\"#8884d8\" \n                      strokeWidth={2}\n                      name=\"actual\"\n                      connectNulls={false}\n                    />\n                    <Line \n                      type=\"monotone\" \n                      dataKey=\"standard\" \n                      stroke=\"#82ca9d\" \n                      strokeWidth={2}\n                      strokeDasharray=\"5 5\"\n                      name=\"standard\"\n                      connectNulls={false}\n                    />\n                  </RechartsLineChart>\n                </ResponsiveContainer>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Recent Records with Detailed View */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Recent Weight Records</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {recordsLoading ? (\n              <p>Loading records...</p>\n            ) : filteredWeightRecords.length > 0 ? (\n              <div className=\"space-y-4\">\n                {filteredWeightRecords.slice(0, 5).map((record) => {\n                  const isExpanded = expandedRecords.has(record.id);\n                  const histogramResult = isExpanded ? createHistogramData(record.weights as number[]) : { bins: [], normalCurve: [] };\n                  const histogramData = histogramResult.bins;\n                  \n                  return (\n                    <div\n                      key={record.id}\n                      className=\"border rounded-lg overflow-hidden\"\n                      data-testid={`weight-record-${record.id}`}\n                    >\n                      {/* Record Summary */}\n                      <div \n                        className=\"flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                        onClick={() => toggleRecordExpansion(record.id)}\n                      >\n                        <div className=\"flex items-center gap-4\">\n                          <div>\n                            <p className=\"font-semibold\">Week {record.weekNumber}</p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {new Date(record.recordDate).toLocaleDateString()}\n                            </p>\n                          </div>\n                          <div className=\"text-center\">\n                            <p className=\"font-semibold\">{parseFloat(record.averageWeight).toFixed(3)} kg avg</p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {record.sampleSize} birds\n                            </p>\n                          </div>\n                          <Badge\n                            variant={\n                              record.comparisonResult === 'within_standard' ? 'default' :\n                              record.comparisonResult === 'above_standard' ? 'secondary' :\n                              'destructive'\n                            }\n                          >\n                            {record.comparisonResult?.replace('_', ' ') || 'Unknown'}\n                          </Badge>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Button variant=\"ghost\" size=\"sm\">\n                            {isExpanded ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                            {isExpanded ? 'Hide Details' : 'Show Details'}\n                          </Button>\n                        </div>\n                      </div>\n\n                      {/* Expanded Details */}\n                      {isExpanded && (\n                        <div className=\"p-4 space-y-6\">\n                          {/* Detailed Statistics */}\n                          <div>\n                            <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                              <Calculator className=\"h-4 w-4\" />\n                              Detailed Statistics\n                            </h4>\n                            <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\n                              <div className=\"text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded\">\n                                <p className=\"text-sm text-muted-foreground\">Average Weight</p>\n                                <p className=\"font-bold text-lg\">{parseFloat(record.averageWeight).toFixed(3)} kg</p>\n                              </div>\n                              <div className=\"text-center p-3 bg-green-50 dark:bg-green-900/20 rounded\">\n                                <p className=\"text-sm text-muted-foreground\">Std Deviation</p>\n                                <p className=\"font-bold text-lg\">{parseFloat(record.stdDev).toFixed(3)} kg</p>\n                              </div>\n                              <div className=\"text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded\">\n                                <p className=\"text-sm text-muted-foreground\">Uniformity</p>\n                                <p className=\"font-bold text-lg\">{parseFloat(record.uniformity).toFixed(1)}%</p>\n                              </div>\n                              <div className=\"text-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded\">\n                                <p className=\"text-sm text-muted-foreground\">CV%</p>\n                                <p className=\"font-bold text-lg\">{record.cvPercent ? parseFloat(record.cvPercent).toFixed(2) : 'N/A'}%</p>\n                              </div>\n                              <div className=\"text-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded\">\n                                <p className=\"text-sm text-muted-foreground\">Sample Size</p>\n                                <p className=\"font-bold text-lg\">{record.sampleSize}</p>\n                              </div>\n                            </div>\n                            \n                            {/* Breed Comparison */}\n                            {record.expectedWeight && (\n                              <div className=\"mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded\">\n                                <p className=\"text-sm text-muted-foreground\">Breed Standard Comparison</p>\n                                <div className=\"flex justify-between items-center mt-1\">\n                                  <span>Expected: {parseFloat(record.expectedWeight).toFixed(3)} kg</span>\n                                  <span className={`font-semibold ${\n                                    record.weightDeviation && parseFloat(record.weightDeviation) > 0 ? 'text-green-600' : \n                                    record.weightDeviation && parseFloat(record.weightDeviation) < 0 ? 'text-red-600' : \n                                    'text-gray-600'\n                                  }`}>\n                                    {record.weightDeviation ? \n                                      `${parseFloat(record.weightDeviation) > 0 ? '+' : ''}${parseFloat(record.weightDeviation).toFixed(3)} kg` : \n                                      'N/A'\n                                    }\n                                  </span>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n\n                          {/* Weight Distribution Histogram with Normal Curve */}\n                          <div>\n                            <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                              <BarChart3 className=\"h-4 w-4\" />\n                              Weight Distribution with Normal Curve\n                            </h4>\n                            <div className=\"h-60 w-full\">\n                              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                <BarChart data={histogramData}>\n                                  <CartesianGrid strokeDasharray=\"3 3\" />\n                                  <XAxis \n                                    dataKey=\"range\" \n                                    angle={-45}\n                                    textAnchor=\"end\"\n                                    height={80}\n                                    label={{ value: 'Weight Range (kg)', position: 'insideBottom', offset: -5 }}\n                                  />\n                                  <YAxis \n                                    label={{ value: 'Count', angle: -90, position: 'insideLeft' }}\n                                  />\n                                  <Tooltip \n                                    formatter={(value: any) => [`${value} birds`, 'Count']}\n                                    labelFormatter={(range) => `Weight Range: ${range} kg`}\n                                  />\n                                  <Bar dataKey=\"count\" fill=\"#8884d8\" fillOpacity={0.7}>\n                                    {histogramData.map((entry, index) => (\n                                      <Cell key={`cell-${index}`} fill={`hsl(${220 + index * 20}, 70%, 50%)`} />\n                                    ))}\n                                  </Bar>\n                                </BarChart>\n                              </ResponsiveContainer>\n                            </div>\n                            \n                            {/* CV% Interpretation */}\n                            {record.cvPercent && (\n                              <div className=\"mt-2 text-sm text-muted-foreground bg-gray-50 dark:bg-gray-800 p-3 rounded\">\n                                <strong>CV% Interpretation:</strong>\n                                {parseFloat(record.cvPercent) < 5 ? \" Excellent uniformity - very consistent weights\" :\n                                 parseFloat(record.cvPercent) < 8 ? \" Good uniformity - acceptable variation\" :\n                                 parseFloat(record.cvPercent) < 12 ? \" Moderate uniformity - some variation present\" :\n                                 \" Poor uniformity - high variation in weights\"}\n                              </div>\n                            )}\n                          </div>\n\n                          {/* Individual Bird Weight Classification */}\n                          <div>\n                            <div className=\"flex items-center justify-between mb-3\">\n                              <h4 className=\"font-semibold flex items-center gap-2\">\n                                <Scale className=\"h-4 w-4\" />\n                                Individual Bird Weight Classification\n                              </h4>\n                              <div className=\"flex gap-2\">\n                                <Button\n                                  onClick={() => downloadCSVReport(record)}\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  className=\"flex items-center gap-2\"\n                                  data-testid={`button-download-csv-${record.id}`}\n                                >\n                                  <Download className=\"h-4 w-4\" />\n                                  CSV\n                                </Button>\n                                <Button\n                                  onClick={() => downloadPDFReport(record)}\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  className=\"flex items-center gap-2\"\n                                  data-testid={`button-download-pdf-${record.id}`}\n                                >\n                                  <Download className=\"h-4 w-4\" />\n                                  PDF\n                                </Button>\n                              </div>\n                            </div>\n                            \n                            {/* Range Summary Cards */}\n                            {(() => {\n                              const weights = record.weights as number[];\n                              const mean = parseFloat(record.averageWeight);\n                              const lowCount = weights.filter(w => classifyBirdWeight(w, mean).classification === 'Low').length;\n                              const normalCount = weights.filter(w => classifyBirdWeight(w, mean).classification === 'Normal').length;\n                              const highCount = weights.filter(w => classifyBirdWeight(w, mean).classification === 'High').length;\n                              \n                              return (\n                                <div className=\"grid grid-cols-3 gap-4 mb-4\">\n                                  <div className=\"text-center p-3 bg-red-50 dark:bg-red-900/20 rounded border border-red-200 dark:border-red-800\">\n                                    <p className=\"text-sm text-red-600 dark:text-red-400\">Low (&lt; -10%)</p>\n                                    <p className=\"font-bold text-lg text-red-700 dark:text-red-300\">{lowCount} birds</p>\n                                    <p className=\"text-xs text-red-500\">\n                                      {((lowCount / weights.length) * 100).toFixed(1)}%\n                                    </p>\n                                  </div>\n                                  <div className=\"text-center p-3 bg-green-50 dark:bg-green-900/20 rounded border border-green-200 dark:border-green-800\">\n                                    <p className=\"text-sm text-green-600 dark:text-green-400\">Normal (±10%)</p>\n                                    <p className=\"font-bold text-lg text-green-700 dark:text-green-300\">{normalCount} birds</p>\n                                    <p className=\"text-xs text-green-500\">\n                                      {((normalCount / weights.length) * 100).toFixed(1)}%\n                                    </p>\n                                  </div>\n                                  <div className=\"text-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded border border-orange-200 dark:border-orange-800\">\n                                    <p className=\"text-sm text-orange-600 dark:text-orange-400\">High (&gt; +10%)</p>\n                                    <p className=\"font-bold text-lg text-orange-700 dark:text-orange-300\">{highCount} birds</p>\n                                    <p className=\"text-xs text-orange-500\">\n                                      {((highCount / weights.length) * 100).toFixed(1)}%\n                                    </p>\n                                  </div>\n                                </div>\n                              );\n                            })()}\n                            \n                            {/* Individual Bird Weights Table */}\n                            <div className=\"max-h-40 overflow-y-auto border rounded\">\n                              <div className=\"grid grid-cols-4 gap-2 p-2 bg-gray-100 dark:bg-gray-800 sticky top-0\">\n                                <div className=\"font-semibold text-sm\">Bird #</div>\n                                <div className=\"font-semibold text-sm\">Weight (kg)</div>\n                                <div className=\"font-semibold text-sm\">Classification</div>\n                                <div className=\"font-semibold text-sm\">Deviation</div>\n                              </div>\n                              {(record.weights as number[]).map((weight, index) => {\n                                const mean = parseFloat(record.averageWeight);\n                                const classification = classifyBirdWeight(weight, mean);\n                                const deviation = ((weight - mean) / mean) * 100;\n                                \n                                return (\n                                  <div key={index} className=\"grid grid-cols-4 gap-2 p-2 border-b border-gray-200 dark:border-gray-700 text-sm\">\n                                    <div>{index + 1}</div>\n                                    <div className=\"font-mono\">{weight.toFixed(4)}</div>\n                                    <div className={`font-semibold ${classification.color}`}>\n                                      {classification.classification}\n                                    </div>\n                                    <div className={`font-mono text-xs ${\n                                      deviation > 10 ? 'text-orange-600' :\n                                      deviation < -10 ? 'text-red-600' :\n                                      'text-green-600'\n                                    }`}>\n                                      {deviation > 0 ? '+' : ''}{deviation.toFixed(1)}%\n                                    </div>\n                                  </div>\n                                );\n                              })}\n                            </div>\n                            \n                            <div className=\"mt-2 text-xs text-muted-foreground\">\n                              Classification based on ±10% of mean weight ({parseFloat(record.averageWeight).toFixed(3)} kg)\n                            </div>\n                          </div>\n\n                          {/* Weekly Weight Gain Chart */}\n                          {weightRecords && weightRecords.length > 1 && (\n                            <div>\n                              <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                                <TrendingUp className=\"h-4 w-4\" />\n                                Weekly Weight Gain Analysis\n                              </h4>\n                              <div className=\"h-60 w-full\">\n                                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                  <RechartsLineChart data={createWeeklyGainData()}>\n                                    <CartesianGrid strokeDasharray=\"3 3\" />\n                                    <XAxis \n                                      dataKey=\"week\" \n                                      label={{ value: 'Week Number', position: 'insideBottom', offset: -5 }}\n                                    />\n                                    <YAxis \n                                      label={{ value: 'Weight Gain (kg)', angle: -90, position: 'insideLeft' }}\n                                    />\n                                    <Tooltip \n                                      formatter={(value: any, name: string) => [\n                                        `${value} kg`, \n                                        name === 'actualGain' ? 'Actual Gain' : 'Standard Gain'\n                                      ]}\n                                      labelFormatter={(week) => `Week ${week}`}\n                                    />\n                                    <Line \n                                      type=\"monotone\" \n                                      dataKey=\"actualGain\" \n                                      stroke=\"#8884d8\" \n                                      strokeWidth={2}\n                                      dot={{ r: 4 }}\n                                      name=\"actualGain\"\n                                    />\n                                    <Line \n                                      type=\"monotone\" \n                                      dataKey=\"standardGain\" \n                                      stroke=\"#82ca9d\" \n                                      strokeWidth={2}\n                                      strokeDasharray=\"5 5\"\n                                      dot={{ r: 4 }}\n                                      name=\"standardGain\"\n                                    />\n                                  </RechartsLineChart>\n                                </ResponsiveContainer>\n                              </div>\n                              <div className=\"mt-2 text-sm text-muted-foreground\">\n                                Solid line: Actual weekly gain | Dashed line: Expected breed standard gain\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Notes */}\n                          {record.notes && (\n                            <div>\n                              <h4 className=\"font-semibold mb-2\">Notes</h4>\n                              <p className=\"text-sm text-muted-foreground bg-gray-50 dark:bg-gray-800 p-3 rounded\">\n                                {record.notes}\n                              </p>\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            ) : (\n              <p className=\"text-muted-foreground text-center py-8\">\n                {selectedFlockFilter !== \"all\" \n                  ? `No weight records found for the selected flock. ${weightRecords.length > 0 ? 'Try selecting a different flock or clear the filter to see all records.' : 'Create your first weight record above.'}`\n                  : 'No weight records found. Create your first weight record above.'\n                }\n              </p>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n        </main>\n      </div>\n    </div>\n  );\n}","size_bytes":71094},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/forms/simple-mortality-form.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\n\ninterface SimpleMortalityFormProps {\n  onSuccess?: () => void;\n}\n\nconst mortalityReasons = [\n  { value: \"disease\", label: \"Disease/Illness\" },\n  { value: \"predator\", label: \"Predator Attack\" },\n  { value: \"accident\", label: \"Accident/Injury\" }, \n  { value: \"heat-stress\", label: \"Heat Stress\" },\n  { value: \"cold-stress\", label: \"Cold Stress\" },\n  { value: \"feed-related\", label: \"Feed Related\" },\n  { value: \"water-related\", label: \"Water Related\" },\n  { value: \"old-age\", label: \"Old Age\" },\n  { value: \"cannibalism\", label: \"Cannibalism/Pecking\" },\n  { value: \"unknown\", label: \"Unknown Cause\" },\n  { value: \"other\", label: \"Other\" }\n];\n\nexport default function SimpleMortalityForm({ onSuccess }: SimpleMortalityFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  // Form state\n  const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);\n  const [flockId, setFlockId] = useState(\"\");\n  const [mortalityCount, setMortalityCount] = useState(\"\");\n  const [mortalityReason, setMortalityReason] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  const createMortalityRecordMutation = useMutation({\n    mutationFn: async (data: any) => {\n      console.log(\"Submitting mortality record:\", data);\n      await apiRequest(\"POST\", \"/api/daily-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Mortality record created successfully\"\n      });\n      \n      // Reset form\n      setRecordDate(new Date().toISOString().split('T')[0]);\n      setFlockId(\"\");\n      setMortalityCount(\"\");\n      setMortalityReason(\"\");\n      setNotes(\"\");\n      \n      if (onSuccess) onSuccess();\n    },\n    onError: (error: any) => {\n      console.error(\"Failed to create mortality record:\", error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to record mortality. Please try again.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select an active farm before submitting records.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (!flockId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a flock\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!mortalityCount || parseInt(mortalityCount) < 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter valid mortality count\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!mortalityReason) {\n      toast({\n        title: \"Error\",\n        description: \"Please select mortality reason\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const recordData = {\n      recordDate,\n      flockId,\n      eggsCollected: 0,\n      brokenEggs: 0,\n      cratesProduced: 0,\n      mortalityCount: parseInt(mortalityCount) || 0,\n      mortalityReason,\n      feedConsumed: null,\n      feedType: null,\n      temperature: null,\n      lightingHours: null,\n      averageWeight: null,\n      sampleSize: 0,\n      notes: notes.trim(),\n      farmId: activeFarmId,\n    };\n\n    createMortalityRecordMutation.mutate(recordData);\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"flockId\">Flock</Label>\n        <Select value={flockId} onValueChange={setFlockId} required>\n          <SelectTrigger data-testid=\"select-mortality-flock\">\n            <SelectValue placeholder=\"Select flock\" />\n          </SelectTrigger>\n          <SelectContent>\n            {flocks.map((flock) => (\n              <SelectItem key={flock.id} value={flock.id}>\n                {flock.name} ({flock.currentCount} birds)\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"recordDate\">Date</Label>\n        <Input\n          id=\"recordDate\"\n          type=\"date\"\n          value={recordDate}\n          onChange={(e) => setRecordDate(e.target.value)}\n          required\n          data-testid=\"input-mortality-date\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"mortalityCount\">Number of Birds Lost</Label>\n        <Input\n          id=\"mortalityCount\"\n          type=\"number\"\n          value={mortalityCount}\n          onChange={(e) => setMortalityCount(e.target.value)}\n          placeholder=\"2\"\n          required\n          data-testid=\"input-mortality-count\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"mortalityReason\">Reason for Loss</Label>\n        <Select value={mortalityReason} onValueChange={setMortalityReason} required>\n          <SelectTrigger data-testid=\"select-mortality-reason\">\n            <SelectValue placeholder=\"Select reason\" />\n          </SelectTrigger>\n          <SelectContent>\n            {mortalityReasons.map((reason) => (\n              <SelectItem key={reason.value} value={reason.value}>\n                {reason.label}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"notes\">Additional Notes</Label>\n        <Textarea\n          id=\"notes\"\n          value={notes}\n          onChange={(e) => setNotes(e.target.value)}\n          placeholder=\"Additional details about the mortality...\"\n          className=\"min-h-[80px]\"\n          data-testid=\"textarea-mortality-notes\"\n        />\n      </div>\n\n      <Button \n        type=\"submit\" \n        className=\"w-full\" \n        disabled={createMortalityRecordMutation.isPending}\n        data-testid=\"button-submit-mortality\"\n      >\n        {createMortalityRecordMutation.isPending ? \"Recording...\" : \"Record Mortality\"}\n      </Button>\n    </form>\n  );\n}","size_bytes":6906},"tests/schemaValidation.test.ts":{"content":"import { describe, it, expect } from '@jest/globals';\nimport { ZodError } from 'zod';\nimport {\n  insertFarmSchema,\n  insertUserSchema,\n  insertFlockSchema,\n  insertDailyRecordSchema,\n  insertSaleSchema,\n  insertFeedInventorySchema,\n  insertHealthRecordSchema,\n  insertExpenseSchema,\n  insertCustomerSchema,\n  insertProductSchema,\n  insertOrderSchema,\n  insertOrderItemSchema,\n  insertDeliverySchema,\n} from '../shared/schema';\n\n// Define the schemas to test with their expected numeric fields\nconst SCHEMAS_TO_TEST = {\n  insertFarmSchema: {\n    schema: insertFarmSchema,\n    numericFields: ['totalBirds', 'avgEggsPerDay'],\n    requiredFields: { name: 'Test Farm', location: 'Test Location' }\n  },\n  insertFlockSchema: {\n    schema: insertFlockSchema,\n    numericFields: ['initialCount', 'currentCount'],\n    requiredFields: { \n      farmId: 'test-farm-id',\n      name: 'Test Flock',\n      hatchDate: '2025-01-01'\n    }\n  },\n  insertDailyRecordSchema: {\n    schema: insertDailyRecordSchema,\n    numericFields: [\n      'eggsCollected', 'brokenEggs', 'cratesProduced', 'mortalityCount',\n      'feedConsumed', 'temperature', 'lightingHours', 'averageWeight', 'sampleSize'\n    ],\n    requiredFields: {\n      flockId: 'test-flock-id',\n      recordDate: '2025-01-01',\n      userId: 'test-user-id'\n    }\n  },\n  insertSaleSchema: {\n    schema: insertSaleSchema,\n    numericFields: ['cratesSold', 'pricePerCrate', 'totalAmount'],\n    requiredFields: {\n      farmId: 'test-farm-id',\n      saleDate: '2025-01-01',\n      userId: 'test-user-id',\n      paymentStatus: 'pending'\n    }\n  },\n  insertFeedInventorySchema: {\n    schema: insertFeedInventorySchema,\n    numericFields: ['quantityKg', 'unitPrice'],\n    requiredFields: {\n      farmId: 'test-farm-id',\n      feedType: 'Layer Feed',\n      userId: 'test-user-id'\n    }\n  },\n  insertHealthRecordSchema: {\n    schema: insertHealthRecordSchema,\n    numericFields: ['cost'],\n    requiredFields: {\n      flockId: 'test-flock-id',\n      recordDate: '2025-01-01',\n      userId: 'test-user-id',\n      recordType: 'vaccination',\n      title: 'Test Record'\n    }\n  },\n  insertExpenseSchema: {\n    schema: insertExpenseSchema,\n    numericFields: ['amount'],\n    requiredFields: {\n      farmId: 'test-farm-id',\n      expenseDate: '2025-01-01',\n      userId: 'test-user-id',\n      category: 'feed',\n      description: 'Test Expense'\n    }\n  },\n  insertProductSchema: {\n    schema: insertProductSchema,\n    numericFields: ['currentPrice', 'minOrderQuantity', 'stockQuantity'],\n    requiredFields: {\n      farmId: 'test-farm-id',\n      name: 'Test Product',\n      category: 'eggs',\n      unit: 'crates'\n    }\n  },\n  insertOrderSchema: {\n    schema: insertOrderSchema,\n    numericFields: [], // Note: totalAmount and paidAmount are omitted from insert schema for security\n    requiredFields: {\n      orderNumber: 'TEST-001',\n      farmId: 'test-farm-id',\n      customerId: 'test-customer-id',\n      userId: 'test-user-id',\n      deliveryMethod: 'pickup'\n    }\n  },\n  insertOrderItemSchema: {\n    schema: insertOrderItemSchema,\n    numericFields: ['quantity'], // Note: unitPrice and totalPrice are omitted for security\n    requiredFields: {\n      orderId: 'test-order-id',\n      productId: 'test-product-id'\n    }\n  }\n};\n\ndescribe('Schema Numeric Field Validation', () => {\n  describe('Schema numeric field handling', () => {\n    Object.entries(SCHEMAS_TO_TEST).forEach(([schemaName, config]) => {\n      if (config.numericFields.length === 0) {\n        it(`${schemaName}: should not have numeric fields to test (by design)`, () => {\n          // Some schemas intentionally omit numeric fields for security reasons\n          expect(config.numericFields).toHaveLength(0);\n        });\n        return;\n      }\n\n      describe(`${schemaName}`, () => {\n        config.numericFields.forEach((fieldName) => {\n          describe(`Field: ${fieldName}`, () => {\n            it('should accept valid numeric values', () => {\n              const testData = {\n                ...config.requiredFields,\n                [fieldName]: 123.45\n              };\n\n              const result = config.schema.safeParse(testData);\n              expect(result.success).toBe(true);\n              \n              if (result.success) {\n                expect(typeof result.data[fieldName]).toBe('number');\n                expect(result.data[fieldName]).toBe(123.45);\n              }\n            });\n\n            it('should accept integer values', () => {\n              const testData = {\n                ...config.requiredFields,\n                [fieldName]: 100\n              };\n\n              const result = config.schema.safeParse(testData);\n              expect(result.success).toBe(true);\n              \n              if (result.success) {\n                expect(typeof result.data[fieldName]).toBe('number');\n                expect(result.data[fieldName]).toBe(100);\n              }\n            });\n\n            it('should reject string values (no auto-coercion)', () => {\n              const testData = {\n                ...config.requiredFields,\n                [fieldName]: \"123.45\" // String instead of number\n              };\n\n              const result = config.schema.safeParse(testData);\n              \n              // We expect this to fail since forms should send numbers, not strings\n              expect(result.success).toBe(false);\n              \n              if (!result.success) {\n                const fieldError = result.error.issues.find(\n                  issue => issue.path.includes(fieldName)\n                );\n                expect(fieldError).toBeDefined();\n                expect(fieldError?.code).toBe('invalid_type');\n                expect(fieldError?.message).toContain('number');\n              }\n            });\n\n            it('should reject invalid string values', () => {\n              const testData = {\n                ...config.requiredFields,\n                [fieldName]: \"not-a-number\"\n              };\n\n              const result = config.schema.safeParse(testData);\n              expect(result.success).toBe(false);\n              \n              if (!result.success) {\n                const fieldError = result.error.issues.find(\n                  issue => issue.path.includes(fieldName)\n                );\n                expect(fieldError).toBeDefined();\n              }\n            });\n\n            it('should accept zero values', () => {\n              const testData = {\n                ...config.requiredFields,\n                [fieldName]: 0\n              };\n\n              const result = config.schema.safeParse(testData);\n              expect(result.success).toBe(true);\n              \n              if (result.success) {\n                expect(typeof result.data[fieldName]).toBe('number');\n                expect(result.data[fieldName]).toBe(0);\n              }\n            });\n\n            it('should accept negative values (where applicable)', () => {\n              // Some fields may not allow negative values, but we test the schema behavior\n              const testData = {\n                ...config.requiredFields,\n                [fieldName]: -10.5\n              };\n\n              const result = config.schema.safeParse(testData);\n              \n              // The test checks if negative values are handled correctly\n              // Some schemas may have .min(0) validation, others may allow negative values\n              if (result.success) {\n                expect(typeof result.data[fieldName]).toBe('number');\n                expect(result.data[fieldName]).toBe(-10.5);\n              } else {\n                // If it fails, it should be due to a minimum value constraint, not type issues\n                const fieldError = result.error.issues.find(\n                  issue => issue.path.includes(fieldName)\n                );\n                if (fieldError) {\n                  expect(['too_small', 'invalid_type']).toContain(fieldError.code);\n                }\n              }\n            });\n          });\n        });\n\n        it(`should validate complete valid object`, () => {\n          const testData = {\n            ...config.requiredFields,\n            // Add valid numeric values for all numeric fields\n            ...Object.fromEntries(\n              config.numericFields.map(field => [field, 100])\n            )\n          };\n\n          const result = config.schema.safeParse(testData);\n          expect(result.success).toBe(true);\n          \n          if (result.success) {\n            // Verify all numeric fields are indeed numbers\n            config.numericFields.forEach(field => {\n              expect(typeof result.data[field]).toBe('number');\n            });\n          }\n        });\n\n        it(`should fail validation with mixed string and number fields`, () => {\n          if (config.numericFields.length < 2) {\n            // Skip this test if there's only one or no numeric fields\n            return;\n          }\n\n          const testData = {\n            ...config.requiredFields,\n            // Mix: first field as number, second as string\n            [config.numericFields[0]]: 100,\n            [config.numericFields[1]]: \"200\" // This should cause failure\n          };\n\n          const result = config.schema.safeParse(testData);\n          expect(result.success).toBe(false);\n          \n          if (!result.success) {\n            // Should have error for the string field\n            const stringFieldError = result.error.issues.find(\n              issue => issue.path.includes(config.numericFields[1])\n            );\n            expect(stringFieldError).toBeDefined();\n            expect(stringFieldError?.code).toBe('invalid_type');\n          }\n        });\n      });\n    });\n  });\n\n  describe('Form submission reality check', () => {\n    it('should document expected form behavior', () => {\n      // This test serves as documentation of expected behavior\n      const formExpectations = {\n        'HTML number inputs': 'should send numbers, not strings',\n        'Controlled React inputs': 'should convert strings to numbers before submission',\n        'Form libraries': 'should handle type coercion before schema validation',\n        'API endpoints': 'should receive properly typed data from frontend'\n      };\n\n      // This test always passes but documents our expectations\n      expect(Object.keys(formExpectations).length).toBeGreaterThan(0);\n      console.log('📋 Form Behavior Expectations:');\n      Object.entries(formExpectations).forEach(([context, expectation]) => {\n        console.log(`  • ${context}: ${expectation}`);\n      });\n    });\n  });\n\n  describe('Schema coverage', () => {\n    it('should test all major insert schemas', () => {\n      const testedSchemas = Object.keys(SCHEMAS_TO_TEST);\n      const expectedSchemas = [\n        'insertFlockSchema',\n        'insertDailyRecordSchema', \n        'insertSaleSchema',\n        'insertFeedInventorySchema',\n        'insertHealthRecordSchema',\n        'insertExpenseSchema',\n        'insertProductSchema'\n      ];\n\n      expectedSchemas.forEach(schemaName => {\n        expect(testedSchemas).toContain(schemaName);\n      });\n    });\n\n    it('should report total numeric fields tested', () => {\n      const totalNumericFields = Object.values(SCHEMAS_TO_TEST)\n        .reduce((total, config) => total + config.numericFields.length, 0);\n      \n      expect(totalNumericFields).toBeGreaterThan(10);\n      console.log(`🔢 Testing ${totalNumericFields} numeric fields across ${Object.keys(SCHEMAS_TO_TEST).length} schemas`);\n    });\n  });\n});","size_bytes":11499},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":23567},"client/src/components/forms/simple-feed-form.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\n\ninterface SimpleFeedFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function SimpleFeedForm({ onSuccess }: SimpleFeedFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  // Form state\n  const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);\n  const [flockId, setFlockId] = useState(\"\");\n  const [feedConsumed, setFeedConsumed] = useState(\"\");\n  const [feedType, setFeedType] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  // Calculate chick age and get guidance\n  const getChickAge = (recordDate: string, hatchDate: string) => {\n    const record = new Date(recordDate);\n    const hatch = new Date(hatchDate);\n    const diffTime = record.getTime() - hatch.getTime();\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n  };\n\n  const selectedFlock = flocks.find(f => f.id === flockId);\n  const chickAge = selectedFlock ? getChickAge(recordDate, selectedFlock.hatchDate) : 0;\n\n  // Age-based feed guidance\n  const getFeedGuidance = (age: number) => {\n    if (age <= 7) return {\n      feedType: \"chick-starter\",\n      dailyAmount: \"15-20g per chick\",\n      protein: \"24% protein\",\n      tips: \"Critical growth period - ensure continuous access to feed\"\n    };\n    if (age <= 14) return {\n      feedType: \"chick-starter\", \n      dailyAmount: \"25-35g per chick\",\n      protein: \"24% protein\",\n      tips: \"Monitor feed intake closely, increase as birds grow\"\n    };\n    if (age <= 21) return {\n      feedType: \"chick-starter\",\n      dailyAmount: \"40-50g per chick\", \n      protein: \"20-22% protein\",\n      tips: \"Transitioning period - can start mixing with grower feed\"\n    };\n    if (age <= 28) return {\n      feedType: \"grower-feed\",\n      dailyAmount: \"55-65g per chick\",\n      protein: \"18-20% protein\", \n      tips: \"Key development phase - maintain consistent feeding schedule\"\n    };\n    if (age <= 42) return {\n      feedType: \"grower-feed\",\n      dailyAmount: \"70-85g per bird\",\n      protein: \"16-18% protein\",\n      tips: \"Pre-laying preparation - monitor body condition\"\n    };\n    return {\n      feedType: \"layer-feed\",\n      dailyAmount: \"110-130g per bird\", \n      protein: \"16-18% protein\",\n      tips: \"Peak production - consistent high-quality nutrition required\"\n    };\n  };\n\n  const feedGuidance = getFeedGuidance(chickAge);\n\n  const createFeedRecordMutation = useMutation({\n    mutationFn: async (data: any) => {\n      console.log(\"Submitting feed record:\", data);\n      await apiRequest(\"POST\", \"/api/daily-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Feed record updated successfully\"\n      });\n      \n      // Reset form\n      setRecordDate(new Date().toISOString().split('T')[0]);\n      setFlockId(\"\");\n      setFeedConsumed(\"\");\n      setFeedType(\"\");\n      setNotes(\"\");\n      \n      if (onSuccess) onSuccess();\n    },\n    onError: (error: any) => {\n      console.error(\"Failed to create feed record:\", error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update feed record. Please try again.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select an active farm before submitting records.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (!flockId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a flock\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!feedConsumed || parseFloat(feedConsumed) <= 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter valid feed consumed amount\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!feedType) {\n      toast({\n        title: \"Error\",\n        description: \"Please select feed type\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const recordData = {\n      recordDate,\n      flockId,\n      eggsCollected: 0,\n      brokenEggs: 0,\n      cratesProduced: 0,\n      mortalityCount: 0,\n      mortalityReason: null,\n      feedConsumed,\n      feedType,\n      temperature: null,\n      lightingHours: null,\n      averageWeight: null,\n      sampleSize: 0,\n      notes: notes.trim(),\n      farmId: activeFarmId,\n    };\n\n    createFeedRecordMutation.mutate(recordData);\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"flockId\">Flock</Label>\n        <Select value={flockId} onValueChange={setFlockId} required>\n          <SelectTrigger data-testid=\"select-feed-flock\">\n            <SelectValue placeholder=\"Select flock\" />\n          </SelectTrigger>\n          <SelectContent>\n            {flocks.map((flock) => (\n              <SelectItem key={flock.id} value={flock.id}>\n                {flock.name} ({flock.currentCount} birds) - Day {getChickAge(recordDate, flock.hatchDate)}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Age-based Guidance */}\n      {selectedFlock && chickAge > 0 && (\n        <Card className=\"bg-green-50 dark:bg-green-950 border-green-200 dark:border-green-800\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg text-green-800 dark:text-green-200\">\n              🌱 Day {chickAge} Feed Guidance\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2 text-sm\">\n              <div className=\"flex items-center space-x-2\">\n                <Badge variant=\"secondary\">Recommended</Badge>\n                <span><strong>Type:</strong> {feedGuidance.feedType} ({feedGuidance.protein})</span>\n              </div>\n              <p><strong>Amount:</strong> {feedGuidance.dailyAmount}</p>\n              <p><strong>For {selectedFlock.currentCount} birds:</strong> ~{Math.round(selectedFlock.currentCount * (chickAge <= 7 ? 0.02 : chickAge <= 14 ? 0.03 : chickAge <= 21 ? 0.045 : chickAge <= 28 ? 0.06 : chickAge <= 42 ? 0.075 : 0.12))}kg total</p>\n              <div className=\"bg-green-100 dark:bg-green-900 p-2 rounded text-xs\">\n                <strong>💡 Tip:</strong> {feedGuidance.tips}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"recordDate\">Date</Label>\n        <Input\n          id=\"recordDate\"\n          type=\"date\"\n          value={recordDate}\n          onChange={(e) => setRecordDate(e.target.value)}\n          required\n          data-testid=\"input-feed-date\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"feedConsumed\">Feed Consumed (kg)</Label>\n        <Input\n          id=\"feedConsumed\"\n          type=\"number\"\n          step=\"0.1\"\n          value={feedConsumed}\n          onChange={(e) => setFeedConsumed(e.target.value)}\n          placeholder=\"150.0\"\n          required\n          data-testid=\"input-feed-consumed\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"feedType\">Feed Type</Label>\n        <Select value={feedType} onValueChange={setFeedType} required>\n          <SelectTrigger data-testid=\"select-feed-type\">\n            <SelectValue placeholder=\"Select feed type\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"chick-starter\">Chick Starter (24% protein)</SelectItem>\n            <SelectItem value=\"chick-grower\">Chick Grower (20% protein)</SelectItem>\n            <SelectItem value=\"grower-feed\">Grower Feed (18% protein)</SelectItem>\n            <SelectItem value=\"developer\">Developer Feed (16-18% protein)</SelectItem>\n            <SelectItem value=\"layer-feed\">Layer Feed (16% protein)</SelectItem>\n            <SelectItem value=\"layer-mash\">Layer Mash</SelectItem>\n            <SelectItem value=\"layer-pellets\">Layer Pellets</SelectItem>\n            <SelectItem value=\"wheat\">Wheat</SelectItem>\n            <SelectItem value=\"maize\">Maize</SelectItem>\n            <SelectItem value=\"other\">Other</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"notes\">Notes (Optional)</Label>\n        <Textarea\n          id=\"notes\"\n          value={notes}\n          onChange={(e) => setNotes(e.target.value)}\n          placeholder=\"Feed quality, supplier, or other observations...\"\n          className=\"min-h-[60px]\"\n          data-testid=\"textarea-feed-notes\"\n        />\n      </div>\n\n      <Button \n        type=\"submit\" \n        className=\"w-full\" \n        disabled={createFeedRecordMutation.isPending}\n        data-testid=\"button-submit-feed\"\n      >\n        {createFeedRecordMutation.isPending ? \"Updating...\" : \"Update Feed Record\"}\n      </Button>\n    </form>\n  );\n}","size_bytes":10017},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    console.error('Server error:', err);\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","size_bytes":2092},"client/src/components/dashboard/performance-summary.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\n\n// Helper function to get CV% status\nconst getCVStatus = (cvPercent: number | null) => {\n  if (!cvPercent) return \"No data\";\n  if (cvPercent < 5) return \"Excellent uniformity\";\n  if (cvPercent < 8) return \"Good uniformity\";\n  if (cvPercent < 12) return \"Moderate uniformity\";\n  return \"Poor uniformity\";\n};\n\n// Helper function to get CV% performance score (0-100)\nconst getCVPerformanceScore = (cvPercent: number | null) => {\n  if (!cvPercent) return 0;\n  // Lower CV% is better, so invert the score\n  // CV% < 5 = 100%, CV% 5-8 = 80%, CV% 8-12 = 60%, CV% > 12 = 40%\n  if (cvPercent < 5) return 100;\n  if (cvPercent < 8) return 80;\n  if (cvPercent < 12) return 60;\n  return 40;\n};\n\n// Helper function to get egg quality classification\nconst getEggQualityStatus = (qualityPercent: number, goodEggs: number, totalEggs: number) => {\n  if (totalEggs === 0) return \"No data\";\n  \n  let classification = \"\";\n  if (qualityPercent >= 95) classification = \"Excellent\";\n  else if (qualityPercent >= 90) classification = \"Good\";\n  else if (qualityPercent >= 85) classification = \"Fair\";\n  else classification = \"Poor\";\n  \n  return `${classification} | ${goodEggs.toLocaleString()} good / ${totalEggs.toLocaleString()} total`;\n};\n\nexport default function PerformanceSummary() {\n  const { isAuthenticated } = useAuth();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  // Fetch all required data\n  const { data: weightRecords = [] } = useQuery<any[]>({\n    queryKey: [\"/api/weight-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/weight-records?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch weight records');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: dailyRecords = [] } = useQuery<any[]>({\n    queryKey: [\"/api/daily-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/daily-records?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch daily records');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/flocks?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch flocks');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: sales = [] } = useQuery<any[]>({\n    queryKey: [\"/api/sales\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/sales?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch sales');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Calculate date ranges for weekly data\n  const today = new Date();\n  const sevenDaysAgo = new Date(today);\n  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\n\n  // Filter weekly records\n  const weeklyRecords = dailyRecords.filter((record: any) => {\n    const recordDate = new Date(record.recordDate);\n    return recordDate >= sevenDaysAgo && recordDate <= today;\n  });\n\n  // Filter weekly sales\n  const weeklySales = sales.filter((sale: any) => {\n    const saleDate = new Date(sale.saleDate);\n    return saleDate >= sevenDaysAgo && saleDate <= today;\n  });\n\n  // Calculate total active birds\n  const totalBirds = flocks.reduce((sum: number, flock: any) => sum + (flock.currentCount || 0), 0);\n\n  // Calculate LAYING RATE (average weekly production rate)\n  const weeklyEggs = weeklyRecords.reduce((sum: number, record: any) => sum + (record.eggsCollected || 0), 0);\n  const weeklyAvgEggs = weeklyEggs / 7;\n  const layingRate = totalBirds > 0 ? (weeklyAvgEggs / totalBirds) * 100 : 0;\n  const layingRateTarget = 90;\n\n  // Calculate FEED EFFICIENCY (kg feed per dozen eggs)\n  const weeklyFeed = weeklyRecords.reduce((sum: number, record: any) => sum + parseFloat(record.feedConsumed || '0'), 0);\n  const dozenEggs = weeklyEggs / 12;\n  const feedPerDozen = dozenEggs > 0 ? weeklyFeed / dozenEggs : 0;\n  // Good feed efficiency: ~1.8-2.2 kg per dozen eggs, convert to percentage (lower is better)\n  // Target: 2.0 kg/dozen, so calculate as inverted percentage\n  const feedEfficiencyScore = feedPerDozen > 0 ? Math.min(100, ((2.0 / feedPerDozen) * 100)) : 0;\n\n  // Calculate MORTALITY RATE (weekly average)\n  const weeklyMortality = weeklyRecords.reduce((sum: number, record: any) => sum + (record.mortalityCount || 0), 0);\n  const mortalityRate = totalBirds > 0 ? (weeklyMortality / totalBirds) * 100 : 0;\n  const mortalityTarget = 0.5; // 0.5% weekly is acceptable\n\n  // Calculate REVENUE TARGET (weekly sales vs baseline target)\n  const weeklyRevenue = weeklySales.reduce((sum: number, sale: any) => sum + parseFloat(sale.totalAmount || '0'), 0);\n  // Use a baseline weekly target derived from expected production\n  // Assuming: 80% laying rate, average price KSh 15/egg\n  const expectedWeeklyEggs = totalBirds > 0 ? (totalBirds * 0.80 * 7) : 0;\n  const weeklyRevenueTarget = expectedWeeklyEggs * 15;\n  const revenueProgress = weeklyRevenueTarget > 0 ? (weeklyRevenue / weeklyRevenueTarget) * 100 : 0;\n\n  // Calculate EGG QUALITY (good eggs / total eggs * 100)\n  const weeklyBrokenEggs = weeklyRecords.reduce((sum: number, record: any) => sum + (record.brokenEggs || 0), 0);\n  const weeklyGoodEggs = Math.max(0, weeklyEggs - weeklyBrokenEggs); // Clamp to 0 in case of data inconsistencies\n  const eggQuality = weeklyEggs > 0 ? (weeklyGoodEggs / weeklyEggs) * 100 : 0;\n  const eggQualityTarget = 95; // 95% is target for good quality eggs\n\n  // Get the latest weight record with CV% data\n  const latestWeightRecord = weightRecords.length > 0 ? \n    [...weightRecords].sort((a, b) => new Date(b.recordDate).getTime() - new Date(a.recordDate).getTime())[0] : \n    null;\n\n  const latestCVPercent = latestWeightRecord?.cvPercent ? parseFloat(latestWeightRecord.cvPercent) : null;\n\n  // Create dynamic performance data\n  const performanceData = [\n    {\n      name: \"Laying Rate\",\n      value: layingRate,\n      target: layingRateTarget,\n      status: `Target: ${layingRateTarget}% | ${weeklyAvgEggs.toFixed(2)} eggs/day`,\n      color: \"bg-primary\",\n    },\n    {\n      name: \"Feed Efficiency\",\n      value: feedEfficiencyScore,\n      target: 100,\n      status: feedPerDozen > 0 ? `${feedPerDozen.toFixed(2)} kg/dozen eggs` : \"No data\",\n      color: \"bg-chart-2\",\n    },\n    {\n      name: \"Mortality Rate\",\n      value: mortalityRate,\n      target: mortalityTarget,\n      status: `${weeklyMortality} birds this week`,\n      color: \"bg-orange-400\",\n      inverted: true,\n    },\n    {\n      name: \"Revenue Target\",\n      value: revenueProgress,\n      target: 100,\n      status: `KSh ${weeklyRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} / KSh ${weeklyRevenueTarget.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,\n      color: \"bg-chart-3\",\n    },\n    {\n      name: \"Egg Quality\",\n      value: eggQuality,\n      target: eggQualityTarget,\n      status: getEggQualityStatus(eggQuality, weeklyGoodEggs, weeklyEggs),\n      color: \"bg-green-500\",\n    },\n    {\n      name: \"Weight Uniformity\",\n      value: getCVPerformanceScore(latestCVPercent),\n      target: 100,\n      status: getCVStatus(latestCVPercent),\n      color: \"bg-chart-4\",\n      cvPercent: latestCVPercent,\n    },\n  ];\n\n  return (\n    <Card data-testid=\"card-performance-summary\">\n      <CardHeader>\n        <CardTitle>This Week's Performance</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-4\">\n          {performanceData.map((item) => (\n            <div key={item.name}>\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm text-muted-foreground\">{item.name}</span>\n                <span className=\"text-sm font-medium text-foreground\">\n                  {item.name === \"Weight Uniformity\" && (item as any).cvPercent ? \n                    `CV: ${(item as any).cvPercent.toFixed(2)}%` :\n                    `${item.value.toFixed(2)}%`\n                  }\n                </span>\n              </div>\n              <Progress \n                value={(item as any).inverted \n                  ? Math.max(0, Math.min(100, 100 - ((item.value / item.target) * 100)))\n                  : Math.min(100, item.value)\n                } \n                className=\"w-full h-2 mb-1\"\n                data-testid={`progress-${item.name.toLowerCase().replace(/\\s+/g, '-')}`}\n              />\n              <p className={`text-xs mt-1 ${\n                item.name === \"Mortality Rate\" \n                  ? \"text-orange-600\" \n                  : item.name === \"Weight Uniformity\" && latestCVPercent\n                    ? latestCVPercent < 5 ? \"text-green-600\" :\n                      latestCVPercent < 8 ? \"text-blue-600\" :\n                      latestCVPercent < 12 ? \"text-yellow-600\" : \"text-red-600\"\n                    : item.name === \"Egg Quality\"\n                      ? weeklyEggs === 0 ? \"text-muted-foreground\" :\n                        item.value >= 95 ? \"text-green-600\" :\n                        item.value >= 90 ? \"text-blue-600\" :\n                        item.value >= 85 ? \"text-yellow-600\" : \"text-red-600\"\n                      : item.value >= item.target \n                        ? \"text-muted-foreground\" \n                        : \"text-muted-foreground\"\n              }`}>\n                {item.status}\n              </p>\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":10057},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/components/forms/simple-health-form.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\n\ninterface SimpleHealthFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function SimpleHealthForm({ onSuccess }: SimpleHealthFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  // Form state\n  const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);\n  const [flockId, setFlockId] = useState(\"\");\n  const [recordType, setRecordType] = useState(\"vaccination\");\n  const [title, setTitle] = useState(\"\");\n  const [description, setDescription] = useState(\"\");\n  const [medicationUsed, setMedicationUsed] = useState(\"\");\n  const [dosage, setDosage] = useState(\"\");\n  const [administeredBy, setAdministeredBy] = useState(\"\");\n  const [nextDueDate, setNextDueDate] = useState(\"\");\n  const [cost, setCost] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  const createHealthMutation = useMutation({\n    mutationFn: async (data: any) => {\n      console.log(\"Submitting health record:\", data);\n      await apiRequest(\"POST\", \"/api/health-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/health-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      toast({\n        title: \"Success\",\n        description: \"Health record added successfully\"\n      });\n      \n      // Reset form\n      setRecordDate(new Date().toISOString().split('T')[0]);\n      setFlockId(\"\");\n      setRecordType(\"vaccination\");\n      setTitle(\"\");\n      setDescription(\"\");\n      setMedicationUsed(\"\");\n      setDosage(\"\");\n      setAdministeredBy(\"\");\n      setNextDueDate(\"\");\n      setCost(\"\");\n      setNotes(\"\");\n      \n      if (onSuccess) onSuccess();\n    },\n    onError: (error: any) => {\n      console.error(\"Failed to create health record:\", error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add health record. Please try again.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select an active farm before submitting records.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (!flockId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a flock\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!title.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter a title\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const healthData = {\n      recordDate,\n      flockId,\n      recordType,\n      title: title.trim(),\n      description: description.trim(),\n      medicationUsed: medicationUsed.trim() || undefined,\n      dosage: dosage.trim() || undefined,\n      administeredBy: administeredBy.trim() || undefined,\n      nextDueDate: nextDueDate || undefined,\n      cost: cost.trim() || undefined,\n      notes: notes.trim(),\n      farmId: activeFarmId,\n    };\n\n    createHealthMutation.mutate(healthData);\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"recordDate\">Date</Label>\n          <Input\n            id=\"recordDate\"\n            type=\"date\"\n            value={recordDate}\n            onChange={(e) => setRecordDate(e.target.value)}\n            required\n            data-testid=\"input-health-date\"\n          />\n        </div>\n        \n        <div className=\"space-y-2\">\n          <Label htmlFor=\"flockId\">Flock</Label>\n          <Select value={flockId} onValueChange={setFlockId} required>\n            <SelectTrigger data-testid=\"select-health-flock\">\n              <SelectValue placeholder=\"Select flock\" />\n            </SelectTrigger>\n            <SelectContent>\n              {flocks.map((flock) => (\n                <SelectItem key={flock.id} value={flock.id}>\n                  {flock.name} ({flock.currentCount} birds)\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"recordType\">Type</Label>\n          <Select value={recordType} onValueChange={setRecordType}>\n            <SelectTrigger data-testid=\"select-health-type\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"vaccination\">Vaccination</SelectItem>\n              <SelectItem value=\"medication\">Medication</SelectItem>\n              <SelectItem value=\"treatment\">Treatment</SelectItem>\n              <SelectItem value=\"checkup\">Health Checkup</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"cost\">Cost (KSh)</Label>\n          <Input\n            id=\"cost\"\n            type=\"number\"\n            placeholder=\"0.00\"\n            value={cost}\n            onChange={(e) => setCost(e.target.value)}\n            data-testid=\"input-health-cost\"\n          />\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"title\">Title *</Label>\n        <Input\n          id=\"title\"\n          placeholder=\"e.g., Newcastle vaccination, Routine checkup\"\n          value={title}\n          onChange={(e) => setTitle(e.target.value)}\n          required\n          data-testid=\"input-health-title\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"description\">Description</Label>\n        <Textarea\n          id=\"description\"\n          placeholder=\"Brief description of the health event\"\n          value={description}\n          onChange={(e) => setDescription(e.target.value)}\n          rows={2}\n          data-testid=\"textarea-health-description\"\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"medicationUsed\">Medication/Vaccine</Label>\n          <Select value={medicationUsed} onValueChange={setMedicationUsed}>\n            <SelectTrigger data-testid=\"select-health-medication\">\n              <SelectValue placeholder=\"Select vaccine/medication\" />\n            </SelectTrigger>\n            <SelectContent className=\"max-h-60 overflow-y-auto\">\n              <SelectItem value=\"custom\">Custom/Other</SelectItem>\n              \n              {/* Day 1 Vaccines */}\n              <SelectItem value=\"Marek's MD/IBD\">Marek's MD/IBD</SelectItem>\n              <SelectItem value=\"Rismavac\">Rismavac</SelectItem>\n              <SelectItem value=\"NCD+IB Live (Vitabron)\">NCD+IB Live (Vitabron)</SelectItem>\n              \n              {/* Day 12-14 Vaccines */}\n              <SelectItem value=\"NCD+IB Live (Ceva BiJI)\">NCD+IB Live (Ceva BiJI)</SelectItem>\n              \n              {/* Day 16-18 Vaccines */}\n              <SelectItem value=\"IBD Intermediate\">IBD Intermediate</SelectItem>\n              \n              {/* Week 6-8 Vaccines */}\n              <SelectItem value=\"Salmonella E&T\">Salmonella E&T</SelectItem>\n              <SelectItem value=\"Coryza (ABC) Killed\">Coryza (ABC) Killed</SelectItem>\n              \n              {/* Week 8-10 Vaccines */}\n              <SelectItem value=\"Fowl pox\">Fowl pox</SelectItem>\n              <SelectItem value=\"Fowl cholera\">Fowl cholera</SelectItem>\n              \n              {/* Week 12-14 Vaccines */}\n              <SelectItem value=\"Salmonella E&T (killed)\">Salmonella E&T (killed)</SelectItem>\n              <SelectItem value=\"Coryza (ABC) killed\">Coryza (ABC) killed</SelectItem>\n              \n              {/* Week 16-18 Vaccines */}\n              <SelectItem value=\"NCD+IB (Killed)\">NCD+IB (Killed)</SelectItem>\n              \n              {/* Common Medications */}\n              <SelectItem value=\"Antibiotics\">Antibiotics</SelectItem>\n              <SelectItem value=\"Vitamins\">Vitamins</SelectItem>\n              <SelectItem value=\"Dewormers\">Dewormers</SelectItem>\n              <SelectItem value=\"Probiotics\">Probiotics</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"dosage\">Dosage/Application Method</Label>\n          <Select value={dosage} onValueChange={setDosage}>\n            <SelectTrigger data-testid=\"select-health-dosage\">\n              <SelectValue placeholder=\"Select application method\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"S/C injection\">S/C injection (Subcutaneous)</SelectItem>\n              <SelectItem value=\"Intramuscular injection\">Intramuscular injection</SelectItem>\n              <SelectItem value=\"Eye drop/Drinking water\">Eye drop/Drinking water</SelectItem>\n              <SelectItem value=\"Drinking water\">Drinking water</SelectItem>\n              <SelectItem value=\"Coarse spray\">Coarse spray</SelectItem>\n              <SelectItem value=\"Wing stab\">Wing stab</SelectItem>\n              <SelectItem value=\"Subcutaneous injection\">Subcutaneous injection</SelectItem>\n              <SelectItem value=\"Oral\">Oral</SelectItem>\n              <SelectItem value=\"Feed mixing\">Feed mixing</SelectItem>\n              <SelectItem value=\"Topical\">Topical</SelectItem>\n              <SelectItem value=\"Custom\">Custom/Other</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"administeredBy\">Administered By</Label>\n        <Input\n          id=\"administeredBy\"\n          placeholder=\"Veterinarian or staff name\"\n          value={administeredBy}\n          onChange={(e) => setAdministeredBy(e.target.value)}\n          data-testid=\"input-health-administered-by\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"nextDueDate\">Next Due Date</Label>\n        <Input\n          id=\"nextDueDate\"\n          type=\"date\"\n          value={nextDueDate}\n          onChange={(e) => setNextDueDate(e.target.value)}\n          data-testid=\"input-health-next-due-date\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"notes\">Notes</Label>\n        <Textarea\n          id=\"notes\"\n          placeholder=\"Additional notes or observations\"\n          value={notes}\n          onChange={(e) => setNotes(e.target.value)}\n          rows={2}\n          data-testid=\"textarea-health-notes\"\n        />\n      </div>\n\n      <Button\n        type=\"submit\"\n        className=\"w-full\"\n        disabled={createHealthMutation.isPending}\n        data-testid=\"button-submit-health\"\n      >\n        {createHealthMutation.isPending ? \"Adding...\" : \"Add Health Record\"}\n      </Button>\n    </form>\n  );\n}","size_bytes":11667},"server/utils/dates.ts":{"content":"/**\n * Server-side date utilities for safe date parsing and coercion\n */\n\n/**\n * Safely parse a date string/value and return Date or null\n * @param value - Date string, Date object, or other value\n * @returns Valid Date object or null if invalid\n */\nexport const safeDate = (value?: string | Date | null): Date | null => {\n  if (!value) return null;\n  \n  const date = new Date(value);\n  return isNaN(date.getTime()) ? null : date;\n};\n\n/**\n * Safely parse a date string/value and return Date or undefined\n * @param value - Date string, Date object, or other value\n * @returns Valid Date object or undefined if invalid\n */\nexport const safeDateOptional = (value?: string | Date | null): Date | undefined => {\n  if (!value) return undefined;\n  \n  const date = new Date(value);\n  return isNaN(date.getTime()) ? undefined : date;\n};","size_bytes":827},"client/src/pages/break-even-analysis.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { \n  TrendingUp, Calculator, DollarSign, Calendar, Download, AlertCircle, \n  FileText, ArrowRight, ShoppingCart, DollarSign as CostsIcon, Package \n} from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport {\n  LineChart,\n  Line,\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  ReferenceLine,\n} from \"recharts\";\n\ninterface BreakEvenMetrics {\n  hasData: boolean;\n  autoCalculated?: boolean;\n  message?: string;\n  suggestedActions?: Array<{ label: string; route: string }>;\n  dataSource?: {\n    monthsAnalyzed: number;\n    salesRecords: number;\n    expenseRecords: number;\n    dateRange: { startDate: string; endDate: string };\n  };\n  derivedValues?: {\n    price: number;\n    unitVariableCost: number;\n    fixedCostsPerMonth: number;\n    initialUnits: number;\n    growthRate: number;\n    seasonalityFactors: number[];\n  };\n  dataQuality?: {\n    hasSufficientData: boolean;\n    monthsWithSales: number;\n    monthsWithExpenses: number;\n    totalSales: number;\n    totalExpenses: number;\n    warnings: string[];\n  };\n  contributionMargin?: number;\n  contributionMarginRatio?: number;\n  breakEvenUnits?: number;\n  breakEvenRevenue?: number;\n  breakEvenMonth?: number | null;\n  breakEvenDate?: string | null;\n  monthlyProjections?: Array<{\n    month: number;\n    units: number;\n    revenue: number;\n    variableCosts: number;\n    fixedCosts: number;\n    totalCosts: number;\n    profit: number;\n    cumulativeProfit: number;\n  }>;\n}\n\n// Adapter: Map API response to UI-friendly field names at component boundary\nfunction mapBreakEvenMetrics(raw: BreakEvenMetrics | undefined) {\n  if (!raw) return undefined;\n  \n  return {\n    ...raw,\n    derivedValues: raw.derivedValues ? {\n      ...raw.derivedValues,\n      averagePrice: raw.derivedValues.price,\n      averageUnitVariableCost: raw.derivedValues.unitVariableCost,\n      averageFixedCostsPerMonth: raw.derivedValues.fixedCostsPerMonth,\n      averageMonthlyUnits: raw.derivedValues.initialUnits,\n      calculatedGrowthRate: raw.derivedValues.growthRate,\n    } : undefined\n  };\n}\n\nexport default function BreakEvenAnalysis() {\n  const { toast } = useToast();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [rollingWindow, setRollingWindow] = useState<3 | 6 | 12>(6);\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  // Fetch auto-calculated metrics with rolling window\n  const { data: rawMetrics, isLoading } = useQuery<BreakEvenMetrics>({\n    queryKey: [`/api/breakeven/metrics?months=${rollingWindow}&farmId=${activeFarmId}`],\n    enabled: hasActiveFarm, // Only fetch when farm is selected\n    refetchOnWindowFocus: true, // Auto-refresh when user returns from linked pages\n  });\n  \n  // Map API response to UI-friendly field names\n  const metrics = mapBreakEvenMetrics(rawMetrics);\n\n  // Download CSV\n  const downloadCSV = () => {\n    if (!metrics?.monthlyProjections) return;\n\n    const headers = [\n      \"Month\", \"Units\", \"Revenue\", \"Variable Costs\", \"Fixed Costs\", \n      \"Total Costs\", \"Profit\", \"Cumulative Profit\"\n    ];\n    const rows = metrics.monthlyProjections.map(m => [\n      m.month,\n      m.units,\n      m.revenue,\n      m.variableCosts,\n      m.fixedCosts,\n      m.totalCosts,\n      m.profit,\n      m.cumulativeProfit,\n    ]);\n\n    // Add summary section\n    const summaryRows = [\n      [\"\"],\n      [\"AUTO-CALCULATED METRICS\"],\n      [\"Data Source\", `${metrics.dataSource?.monthsAnalyzed || 0} months of historical data`],\n      [\"Sales Records\", metrics.dataSource?.salesRecords || 0],\n      [\"Expense Records\", metrics.dataSource?.expenseRecords || 0],\n      [\"\"],\n    ];\n\n    // Only add derived values if they exist\n    if (metrics.derivedValues) {\n      summaryRows.push(\n        [\"DERIVED VALUES\"],\n        [\"Average Price/Crate\", `$${metrics.derivedValues.price.toFixed(2)}`],\n        [\"Avg Variable Cost/Crate\", `$${metrics.derivedValues.unitVariableCost.toFixed(2)}`],\n        [\"Avg Fixed Costs/Month\", `$${metrics.derivedValues.fixedCostsPerMonth.toFixed(2)}`],\n        [\"Avg Monthly Units\", metrics.derivedValues.initialUnits.toString()],\n        [\"Calculated Growth Rate\", `${metrics.derivedValues.growthRate.toFixed(2)}%`]\n      );\n    }\n    \n    // Add data quality warnings if they exist\n    if (metrics.dataQuality?.warnings && metrics.dataQuality.warnings.length > 0) {\n      summaryRows.push(\n        [\"\"],\n        [\"DATA QUALITY WARNINGS\"],\n        ...metrics.dataQuality.warnings.map(w => [\"⚠\", w])\n      );\n    }\n\n    const csvContent = [\n      ...summaryRows.map(row => row.join(\",\")),\n      [\"\"],\n      headers.join(\",\"),\n      ...rows.map(row => row.join(\",\")),\n    ].join(\"\\n\");\n\n    const blob = new Blob([csvContent], { type: \"text/csv\" });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `break-even-analysis-${rollingWindow}months-${new Date().toISOString().split('T')[0]}.csv`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    window.URL.revokeObjectURL(url);\n\n    toast({\n      title: \"Download Started\",\n      description: \"CSV file with auto-calculated metrics is being downloaded\",\n    });\n  };\n\n  // Download PDF (via print)\n  const downloadPDF = () => {\n    window.print();\n    toast({\n      title: \"Print Dialog Opened\",\n      description: \"Use your browser's print dialog to save as PDF\",\n    });\n  };\n\n  const formatCurrency = (value: number) => {\n    return new Intl.NumberFormat(\"en-US\", {\n      style: \"currency\",\n      currency: \"USD\",\n    }).format(value);\n  };\n\n  // Missing Data State\n  if (!isLoading && metrics && !metrics.hasData) {\n    return (\n      <div className=\"min-h-screen flex bg-background\">\n        <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n        <div className=\"flex-1 overflow-x-hidden\">\n          <div className=\"container mx-auto p-4 md:p-6 space-y-6\">\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">Break-Even Analysis</h1>\n              <p className=\"text-muted-foreground mt-1\">\n                Automatically calculated from your farm data\n              </p>\n            </div>\n\n            <Alert data-testid=\"alert-missing-data\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                {metrics.message || \"No data found for analysis\"}\n              </AlertDescription>\n            </Alert>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Get Started</CardTitle>\n                <CardDescription>\n                  Add sales and expense records to enable break-even analysis\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {metrics.suggestedActions?.map((action, idx) => (\n                  <Link key={idx} href={action.route}>\n                    <Button \n                      variant=\"outline\" \n                      className=\"w-full justify-between\"\n                      data-testid={`button-${action.route.replace('/', '')}`}\n                    >\n                      {action.label}\n                      <ArrowRight className=\"h-4 w-4\" />\n                    </Button>\n                  </Link>\n                ))}\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      <div className=\"flex-1 overflow-x-hidden\">\n        <div className=\"container mx-auto p-4 md:p-6 space-y-6\">\n          {/* Header */}\n          <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">Break-Even Analysis</h1>\n              <p className=\"text-muted-foreground mt-1\">\n                Automatically calculated from your farm data\n              </p>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={downloadCSV}\n                disabled={!metrics?.monthlyProjections}\n                data-testid=\"button-download-csv\"\n              >\n                <Download className=\"h-4 w-4 mr-2\" />\n                CSV\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={downloadPDF}\n                disabled={!metrics?.monthlyProjections}\n                data-testid=\"button-download-pdf\"\n              >\n                <FileText className=\"h-4 w-4 mr-2\" />\n                PDF\n              </Button>\n            </div>\n          </div>\n\n          {/* Rolling Window Selector */}\n          <Card data-testid=\"card-rolling-window\">\n            <CardHeader>\n              <CardTitle>Analysis Period</CardTitle>\n              <CardDescription>\n                Select historical data timeframe for calculations\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Tabs \n                value={rollingWindow.toString()} \n                onValueChange={(v) => setRollingWindow(parseInt(v) as 3 | 6 | 12)}\n              >\n                <TabsList className=\"grid w-full grid-cols-3\">\n                  <TabsTrigger value=\"3\" data-testid=\"tab-3months\">3 Months</TabsTrigger>\n                  <TabsTrigger value=\"6\" data-testid=\"tab-6months\">6 Months</TabsTrigger>\n                  <TabsTrigger value=\"12\" data-testid=\"tab-12months\">12 Months</TabsTrigger>\n                </TabsList>\n              </Tabs>\n            </CardContent>\n          </Card>\n\n          {/* Data Source Banner */}\n          {metrics?.dataSource && (\n            <Alert data-testid=\"alert-data-source\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                <strong>Auto-Calculated:</strong> Analyzing {metrics.dataSource.monthsAnalyzed} months \n                ({metrics.dataSource.salesRecords} sales records, {metrics.dataSource.expenseRecords} expense records)\n                from {new Date(metrics.dataSource.dateRange.startDate).toLocaleDateString()} to {new Date(metrics.dataSource.dateRange.endDate).toLocaleDateString()}\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {/* Data Quality Warnings */}\n          {metrics?.dataQuality?.warnings && metrics.dataQuality.warnings.length > 0 && (\n            <Alert variant=\"destructive\" data-testid=\"alert-data-quality-warnings\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                <strong>Data Quality Issues:</strong>\n                <ul className=\"mt-2 ml-4 list-disc space-y-1\">\n                  {metrics.dataQuality.warnings.map((warning, idx) => (\n                    <li key={idx} data-testid={`text-warning-${idx}`}>\n                      {warning}\n                    </li>\n                  ))}\n                </ul>\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {/* Derived Values Summary */}\n          {isLoading ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <Card key={i}>\n                  <CardHeader className=\"pb-2\">\n                    <Skeleton className=\"h-4 w-24\" />\n                  </CardHeader>\n                  <CardContent>\n                    <Skeleton className=\"h-6 w-20\" />\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : metrics?.derivedValues ? (\n            <>\n              <div className=\"text-sm font-semibold text-muted-foreground mb-2\">Calculated from Your Data</div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n                <Card data-testid=\"card-avg-price\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                      Avg Price/Crate\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-xl font-bold\" data-testid=\"text-avg-price\">\n                      {formatCurrency(metrics.derivedValues.averagePrice)}\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-avg-variable-cost\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                      Avg Variable Cost\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-xl font-bold\" data-testid=\"text-avg-variable-cost\">\n                      {formatCurrency(metrics.derivedValues.averageUnitVariableCost)}\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-avg-fixed-costs\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                      Avg Fixed Costs/Month\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-xl font-bold\" data-testid=\"text-avg-fixed-costs\">\n                      {formatCurrency(metrics.derivedValues.averageFixedCostsPerMonth)}\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-avg-units\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                      Avg Monthly Units\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-xl font-bold\" data-testid=\"text-avg-units\">\n                      {metrics.derivedValues.averageMonthlyUnits} crates\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-growth-rate\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                      Growth Rate (CAGR)\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-xl font-bold\" data-testid=\"text-growth-rate\">\n                      {metrics.derivedValues.calculatedGrowthRate.toFixed(2)}%\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </>\n          ) : null}\n\n          {/* Interactive Navigation */}\n          <Card data-testid=\"card-navigation\">\n            <CardHeader>\n              <CardTitle>Adjust Your Data</CardTitle>\n              <CardDescription>\n                Update sales, expenses, or feed to see real-time changes in your break-even analysis\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n              <Link href=\"/egg-production\">\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full justify-between\"\n                  data-testid=\"button-goto-sales\"\n                >\n                  <div className=\"flex items-center gap-2\">\n                    <ShoppingCart className=\"h-4 w-4\" />\n                    Manage Sales\n                  </div>\n                  <ArrowRight className=\"h-4 w-4\" />\n                </Button>\n              </Link>\n              \n              <Link href=\"/expenses\">\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full justify-between\"\n                  data-testid=\"button-goto-expenses\"\n                >\n                  <div className=\"flex items-center gap-2\">\n                    <CostsIcon className=\"h-4 w-4\" />\n                    Manage Expenses\n                  </div>\n                  <ArrowRight className=\"h-4 w-4\" />\n                </Button>\n              </Link>\n              \n              <Link href=\"/feed-management\">\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full justify-between\"\n                  data-testid=\"button-goto-feed\"\n                >\n                  <div className=\"flex items-center gap-2\">\n                    <Package className=\"h-4 w-4\" />\n                    Feed Management\n                  </div>\n                  <ArrowRight className=\"h-4 w-4\" />\n                </Button>\n              </Link>\n            </CardContent>\n          </Card>\n\n          {/* Break-Even Metrics */}\n          {isLoading ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n              {[1, 2, 3, 4].map((i) => (\n                <Card key={i}>\n                  <CardHeader className=\"pb-2\">\n                    <Skeleton className=\"h-4 w-24\" />\n                  </CardHeader>\n                  <CardContent>\n                    <Skeleton className=\"h-8 w-32\" />\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : metrics && metrics.breakEvenUnits !== undefined ? (\n            <>\n              <div className=\"text-sm font-semibold text-muted-foreground mb-2\">Break-Even Projections</div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <Card data-testid=\"card-break-even-units\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                      Break-Even Units\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex items-center gap-2\">\n                      <Calculator className=\"h-5 w-5 text-blue-500\" />\n                      <span className=\"text-2xl font-bold\" data-testid=\"text-break-even-units\">\n                        {metrics.breakEvenUnits.toFixed(0)} crates\n                      </span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Per month</p>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-break-even-revenue\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                      Break-Even Revenue\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex items-center gap-2\">\n                      <DollarSign className=\"h-5 w-5 text-green-500\" />\n                      <span className=\"text-2xl font-bold\" data-testid=\"text-break-even-revenue\">\n                        {formatCurrency(metrics.breakEvenRevenue || 0)}\n                      </span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Per month</p>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-break-even-month\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                      Break-Even Month\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex items-center gap-2\">\n                      <Calendar className=\"h-5 w-5 text-purple-500\" />\n                      <span className=\"text-2xl font-bold\" data-testid=\"text-break-even-month\">\n                        {metrics.breakEvenMonth !== null ? `Month ${metrics.breakEvenMonth}` : \"Not Reachable\"}\n                      </span>\n                    </div>\n                    {metrics.breakEvenDate && (\n                      <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"text-break-even-date\">\n                        {new Date(metrics.breakEvenDate).toLocaleDateString()}\n                      </p>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-contribution-margin\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                      Contribution Margin\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex items-center gap-2\">\n                      <TrendingUp className=\"h-5 w-5 text-orange-500\" />\n                      <span className=\"text-2xl font-bold\" data-testid=\"text-contribution-margin\">\n                        {metrics.contributionMarginRatio?.toFixed(1)}%\n                      </span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {formatCurrency(metrics.contributionMargin || 0)} per unit\n                    </p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Not Reachable Warning */}\n              {metrics.breakEvenMonth === null && (\n                <Alert data-testid=\"alert-not-reachable\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Break-even is not reachable within the 12-month projection period with current data trends.\n                    Consider adjusting your prices or reducing costs.\n                  </AlertDescription>\n                </Alert>\n              )}\n\n              {/* Charts */}\n              {metrics.monthlyProjections && metrics.monthlyProjections.length > 0 && (\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                  {/* Cumulative Profit Chart */}\n                  <Card data-testid=\"card-cumulative-profit-chart\">\n                    <CardHeader>\n                      <CardTitle>Cumulative Profit Over Time</CardTitle>\n                      <CardDescription>Track when you'll reach profitability</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      <ResponsiveContainer width=\"100%\" height={300}>\n                        <LineChart data={metrics.monthlyProjections}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis dataKey=\"month\" label={{ value: \"Month\", position: \"insideBottom\", offset: -5 }} />\n                          <YAxis label={{ value: \"Profit ($)\", angle: -90, position: \"insideLeft\" }} />\n                          <Tooltip formatter={(value) => formatCurrency(Number(value))} />\n                          <Legend />\n                          <ReferenceLine y={0} stroke=\"#000\" strokeDasharray=\"3 3\" />\n                          {metrics.breakEvenMonth !== null && (\n                            <ReferenceLine\n                              x={metrics.breakEvenMonth}\n                              stroke=\"#22c55e\"\n                              strokeDasharray=\"3 3\"\n                              label={{ value: \"Break-Even\", position: \"top\" }}\n                            />\n                          )}\n                          <Line\n                            type=\"monotone\"\n                            dataKey=\"cumulativeProfit\"\n                            stroke=\"#8b5cf6\"\n                            strokeWidth={2}\n                            name=\"Cumulative Profit\"\n                          />\n                        </LineChart>\n                      </ResponsiveContainer>\n                    </CardContent>\n                  </Card>\n\n                  {/* Revenue vs Costs Chart */}\n                  <Card data-testid=\"card-revenue-costs-chart\">\n                    <CardHeader>\n                      <CardTitle>Revenue vs Total Costs</CardTitle>\n                      <CardDescription>Monthly comparison</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      <ResponsiveContainer width=\"100%\" height={300}>\n                        <BarChart data={metrics.monthlyProjections}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis dataKey=\"month\" label={{ value: \"Month\", position: \"insideBottom\", offset: -5 }} />\n                          <YAxis label={{ value: \"Amount ($)\", angle: -90, position: \"insideLeft\" }} />\n                          <Tooltip formatter={(value) => formatCurrency(Number(value))} />\n                          <Legend />\n                          <Bar dataKey=\"revenue\" fill=\"#22c55e\" name=\"Revenue\" />\n                          <Bar dataKey=\"totalCosts\" fill=\"#ef4444\" name=\"Total Costs\" />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    </CardContent>\n                  </Card>\n                </div>\n              )}\n\n              {/* Monthly Projections Table */}\n              {metrics.monthlyProjections && metrics.monthlyProjections.length > 0 && (\n                <Card data-testid=\"card-monthly-projections\">\n                  <CardHeader>\n                    <CardTitle>Monthly Projections</CardTitle>\n                    <CardDescription>Detailed breakdown of revenue and costs</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b\">\n                            <th className=\"text-left p-2\">Month</th>\n                            <th className=\"text-right p-2\">Units</th>\n                            <th className=\"text-right p-2\">Revenue</th>\n                            <th className=\"text-right p-2\">Variable</th>\n                            <th className=\"text-right p-2\">Fixed</th>\n                            <th className=\"text-right p-2\">Total Costs</th>\n                            <th className=\"text-right p-2\">Profit</th>\n                            <th className=\"text-right p-2\">Cumulative</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {metrics.monthlyProjections.map((projection, idx) => (\n                            <tr\n                              key={idx}\n                              className={`border-b ${projection.cumulativeProfit >= 0 ? 'bg-green-50 dark:bg-green-950/20' : ''}`}\n                              data-testid={`row-projection-${idx}`}\n                            >\n                              <td className=\"p-2\">{projection.month}</td>\n                              <td className=\"text-right p-2\">{projection.units.toFixed(0)}</td>\n                              <td className=\"text-right p-2\">{formatCurrency(projection.revenue)}</td>\n                              <td className=\"text-right p-2\">{formatCurrency(projection.variableCosts)}</td>\n                              <td className=\"text-right p-2\">{formatCurrency(projection.fixedCosts)}</td>\n                              <td className=\"text-right p-2\">{formatCurrency(projection.totalCosts)}</td>\n                              <td className={`text-right p-2 ${projection.profit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                {formatCurrency(projection.profit)}\n                              </td>\n                              <td className={`text-right p-2 font-semibold ${projection.cumulativeProfit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                {formatCurrency(projection.cumulativeProfit)}\n                              </td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </>\n          ) : null}\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":29038},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":971},"client/src/lib/routes.ts":{"content":"// Route constants to prevent routing conflicts and make navigation explicit\nexport const ROUTES = {\n  // Public routes\n  LANDING: \"/\",\n  MARKETPLACE: \"/marketplace\",\n  FARM_STOREFRONT: \"/farm\",\n  CUSTOMER_REGISTRATION: \"/customer-registration\",\n  FARM_REGISTRATION: \"/farm-registration\",\n  FARM_SETUP: \"/farm-setup\",\n  \n  // Farm management routes (always accessible)\n  BODY_WEIGHTS: \"/body-weights\",\n  \n  // Customer routes\n  CUSTOMER_DASHBOARD: \"/\",\n  \n  // Authenticated farm management routes\n  DASHBOARD: \"/\",\n  CHICK_BROODING: \"/chick-brooding\",\n  EGG_PRODUCTION: \"/egg-production\",\n  FEED_MANAGEMENT: \"/feed-management\",\n  HEALTH_RECORDS: \"/health-records\",\n  REPORTS: \"/reports\",\n  EXPENSES: \"/expenses\",\n  USERS: \"/users\",\n  SETTINGS: \"/settings\",\n  \n  // Marketplace management routes\n  MARKETPLACE_CUSTOMERS: \"/marketplace/customers\",\n  MARKETPLACE_PRODUCTS: \"/marketplace/products\",\n  MARKETPLACE_ORDERS: \"/marketplace/orders\",\n} as const;\n\n// Farm management routes that should never be redirected away from\nexport const FARM_MANAGEMENT_ROUTES = [\n  ROUTES.BODY_WEIGHTS,\n  ROUTES.CHICK_BROODING,\n  ROUTES.EGG_PRODUCTION,\n  ROUTES.FEED_MANAGEMENT,\n  ROUTES.HEALTH_RECORDS,\n  ROUTES.REPORTS,\n  ROUTES.EXPENSES,\n  ROUTES.USERS,\n  ROUTES.MARKETPLACE_CUSTOMERS,\n  ROUTES.MARKETPLACE_PRODUCTS,\n  ROUTES.MARKETPLACE_ORDERS,\n] as const;","size_bytes":1342},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/lib/authUtils.ts":{"content":"import type { User } from '@shared/schema';\nimport type { LucideIcon } from 'lucide-react';\nimport { Shield, Users, UserCheck, User as UserIcon, ShoppingCart } from 'lucide-react';\n\nexport function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n\n/**\n * Check if an error represents an unauthorized response\n * @param error - Error of unknown type\n * @returns boolean indicating if error is 401 unauthorized\n */\nexport const isUnauthorized = (error: unknown): boolean => {\n  // Handle Response objects\n  if (error && typeof error === 'object' && 'status' in error) {\n    return (error as Response).status === 401;\n  }\n  \n  // Handle Axios-like errors\n  if (error && typeof error === 'object' && 'response' in error) {\n    const axiosError = error as any;\n    return axiosError.response?.status === 401;\n  }\n  \n  // Handle Error objects with 401 message pattern\n  if (error instanceof Error) {\n    return /^401: .*Unauthorized/.test(error.message) || error.message.includes('401');\n  }\n  \n  return false;\n};\n\n// Define management roles that have administrative privileges\nexport const MANAGEMENT_ROLES = new Set<User['role']>(['admin', 'farm_owner', 'manager']);\n\n/**\n * Check if a user has management role (admin or manager)\n * @param user - User object to check\n * @returns boolean indicating if user has management privileges\n */\nexport const hasManagementRole = (user?: User | null): boolean => {\n  return !!user && MANAGEMENT_ROLES.has(user.role);\n};\n\n/**\n * Check if a user is an admin\n * @param user - User object to check\n * @returns boolean indicating if user is admin\n */\nexport const isAdmin = (user?: User | null): boolean => {\n  return !!user && user.role === 'admin';\n};\n\n/**\n * Check if current user can manage another user\n * @param currentUser - The user performing the action\n * @param targetUser - The user being managed\n * @returns boolean indicating if management is allowed\n */\nexport const canManageUser = (currentUser?: User | null, targetUser?: User | null): boolean => {\n  if (!currentUser || !targetUser) return false;\n  \n  // Admins can manage anyone except other admins\n  if (isAdmin(currentUser)) {\n    return !isAdmin(targetUser);\n  }\n  \n  // Managers can only manage staff\n  if (currentUser.role === 'manager') {\n    return targetUser.role === 'staff';\n  }\n  \n  return false;\n};\n\n// Role metadata configuration for consistent UI rendering\ninterface RoleMeta {\n  label: string;\n  icon: LucideIcon;\n  badgeVariant: 'default' | 'secondary' | 'destructive' | 'outline';\n  colorClass: string;\n  description: string;\n}\n\nexport const ROLE_META: Record<User['role'], RoleMeta> = {\n  admin: {\n    label: 'Admin',\n    icon: Shield,\n    badgeVariant: 'destructive',\n    colorClass: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300',\n    description: 'Full system access and management'\n  },\n  farm_owner: {\n    label: 'Farm Owner', \n    icon: Users,\n    badgeVariant: 'default',\n    colorClass: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',\n    description: 'Owner of the farm operation'\n  },\n  manager: {\n    label: 'Manager',\n    icon: UserCheck,\n    badgeVariant: 'secondary',\n    colorClass: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',\n    description: 'Farm operations management'\n  },\n  staff: {\n    label: 'Staff',\n    icon: UserIcon,\n    badgeVariant: 'outline',\n    colorClass: 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300',\n    description: 'Farm worker and operations'\n  },\n  customer: {\n    label: 'Customer',\n    icon: ShoppingCart,\n    badgeVariant: 'outline',\n    colorClass: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300',\n    description: 'Product purchaser'\n  }\n} as const;\n\n/**\n * Get role metadata for UI rendering\n * @param role - User role\n * @returns Role metadata object\n */\nexport const getRoleMeta = (role: User['role']): RoleMeta => {\n  return ROLE_META[role] || ROLE_META.staff; // Fallback to staff\n};","size_bytes":3999},"client/src/components/forms/daily-record-form.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { insertDailyRecordSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\n\nconst formSchema = insertDailyRecordSchema.extend({\n  recordDate: z.string().min(1, \"Record date is required\"),\n});\n\ntype FormData = z.infer<typeof formSchema>;\n\ninterface DailyRecordFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function DailyRecordForm({ onSuccess }: DailyRecordFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  const form = useForm<FormData>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      recordDate: new Date().toISOString().split('T')[0],\n      eggsCollected: 0,\n      brokenEggs: 0,\n      cratesProduced: 0,\n      mortalityCount: 0,\n      mortalityReason: \"\",\n      feedConsumed: \"\",\n      feedType: \"\",\n      temperature: \"\",\n      lightingHours: \"\",\n      averageWeight: \"\",\n      sampleSize: 0,\n      notes: \"\",\n    },\n  });\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [`/api/flocks${activeFarmId ? `?farmId=${activeFarmId}` : ''}`, activeFarmId],\n    enabled: hasActiveFarm,\n  });\n\n  const createRecordMutation = useMutation({\n    mutationFn: async (data: FormData) => {\n      // Include farmId for admin users, server will handle type coercion\n      const payload = { ...data, farmId: activeFarmId };\n      await apiRequest(\"POST\", \"/api/daily-records\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/daily-records${activeFarmId ? `?farmId=${activeFarmId}` : ''}`, activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\", activeFarmId] });\n      toast({\n        title: \"Success\",\n        description: \"Daily record created successfully\",\n      });\n      form.reset();\n      onSuccess?.();\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create daily record\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: FormData) => {\n    // Early guard: Prevent submission without active farm\n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select a farm before submitting daily records\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    console.log('Submitting comprehensive daily record:', data);\n    createRecordMutation.mutate(data);\n  };\n\n  return (\n    <Card data-testid=\"card-daily-record-form\">\n      <CardHeader>\n        <CardTitle>Daily Record</CardTitle>\n        <CardDescription>\n          Record daily farm activities including egg production, mortality, and feed consumption.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"recordDate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Record Date</FormLabel>\n                    <FormControl>\n                      <Input type=\"date\" {...field} data-testid=\"input-record-date\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"flockId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Flock</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-flock\">\n                          <SelectValue placeholder=\"Select a flock\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {flocks.map((flock: any) => (\n                          <SelectItem key={flock.id} value={flock.id}>\n                            {flock.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            {/* Egg Production Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Egg Production</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"eggsCollected\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Eggs Collected</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          {...field} \n                          value={field.value || 0}\n                          onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                          data-testid=\"input-eggs-collected\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"brokenEggs\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Broken Eggs</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          {...field} \n                          value={field.value || 0}\n                          onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                          data-testid=\"input-broken-eggs\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"cratesProduced\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Crates Produced</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          {...field} \n                          value={field.value || 0}\n                          onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                          data-testid=\"input-crates-produced\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            {/* Mortality Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Mortality</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"mortalityCount\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Mortality Count</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          {...field} \n                          value={field.value || 0}\n                          onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                          data-testid=\"input-mortality-count\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"mortalityReason\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Mortality Reason</FormLabel>\n                      <FormControl>\n                        <Input {...field} value={field.value || \"\"} placeholder=\"e.g., Disease, Injury\" data-testid=\"input-mortality-reason\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            {/* Feed Section */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Feed</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"feedConsumed\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Feed Consumed (kg)</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          step=\"0.01\" \n                          {...field} \n                          value={field.value || \"\"}\n                          data-testid=\"input-feed-consumed\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"feedType\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Feed Type</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value || \"\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-feed-type\">\n                            <SelectValue placeholder=\"Select feed type\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"layer-mash\">Layer Mash</SelectItem>\n                          <SelectItem value=\"layer-pellets\">Layer Pellets</SelectItem>\n                          <SelectItem value=\"chick-starter\">Chick Starter</SelectItem>\n                          <SelectItem value=\"broiler-starter\">Broiler Starter</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            {/* Notes */}\n            <FormField\n              control={form.control}\n              name=\"notes\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Notes</FormLabel>\n                  <FormControl>\n                    <Textarea {...field} value={field.value || \"\"} rows={3} data-testid=\"textarea-notes\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <Button \n              type=\"submit\" \n              disabled={createRecordMutation.isPending || !hasActiveFarm}\n              title={!hasActiveFarm ? \"Please select a farm first\" : \"\"}\n              data-testid=\"button-submit-daily-record\"\n            >\n              {createRecordMutation.isPending ? \"Saving...\" : \"Save Record\"}\n            </Button>\n          </form>\n        </Form>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":12520},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/components/forms/simple-chick-brooding-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { format } from \"date-fns\";\n\ninterface SimpleChickBroodingFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function SimpleChickBroodingForm({ onSuccess }: SimpleChickBroodingFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Form state\n  const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);\n  const [flockId, setFlockId] = useState(\"\");\n  const [temperature, setTemperature] = useState(\"\");\n  const [lightingHours, setLightingHours] = useState(\"18\");\n  const [feedConsumed, setFeedConsumed] = useState(\"\");\n  const [feedType, setFeedType] = useState(\"chick-starter\");\n  const [averageWeight, setAverageWeight] = useState(\"\");\n  const [sampleSize, setSampleSize] = useState(\"100\");\n  const [mortalityCount, setMortalityCount] = useState(\"0\");\n  const [notes, setNotes] = useState(\"\");\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  // Calculate chick age from selected date and flock hatch date\n  const getChickAge = (recordDate: string, hatchDate: string) => {\n    const record = new Date(recordDate);\n    const hatch = new Date(hatchDate);\n    const diffTime = record.getTime() - hatch.getTime();\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n  };\n\n  const selectedFlock = flocks.find(f => f.id === flockId);\n  const chickAge = selectedFlock ? getChickAge(recordDate, selectedFlock.hatchDate) : 0;\n\n  // Get age-based guidance (matches brooding schedule)\n  const getAgeGuidance = (age: number) => {\n    if (age <= 7) return {\n      category: \"Week 1: Critical Care\",\n      tempRange: \"35-32°C\",\n      lighting: \"24 hours\",\n      feedType: \"Chick and Duck Mash\",\n      feedAmount: \"12g per bird\",\n      expectedWeight: \"40-60g\",\n      tips: \"Critical growth period - monitor closely. Watch for pasty bottom, ensure access to water, check temperature frequently\"\n    };\n    if (age <= 14) return {\n      category: \"Week 2: Rapid Growth\", \n      tempRange: \"32-29°C\",\n      lighting: \"20 hours\",\n      feedType: \"Chick and Duck Mash\",\n      feedAmount: \"18g per bird\", \n      expectedWeight: \"85-120g\",\n      tips: \"Rapid growth phase begins. Reduce temperature gradually, monitor feed intake, watch for pecking\"\n    };\n    if (age <= 21) return {\n      category: \"Week 3: Development\",\n      tempRange: \"29-26°C\", \n      lighting: \"16 hours\",\n      feedType: \"Chick and Duck Mash\",\n      feedAmount: \"25g per bird\",\n      expectedWeight: \"150-200g\",\n      tips: \"Feed transition period. Increase space allowance, start feather development monitoring\"\n    };\n    if (age <= 28) return {\n      category: \"Week 4: Feather Development\",\n      tempRange: \"26-23°C\",\n      lighting: \"14 hours\", \n      feedType: \"Chick and Duck Mash\",\n      feedAmount: \"31g per bird\",\n      expectedWeight: \"220-300g\",\n      tips: \"Feather development peak. Monitor for uniform growth, adjust feeding schedule\"\n    };\n    if (age <= 35) return {\n      category: \"Week 5: Steady Growth\",\n      tempRange: \"23-21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Chick and Duck Mash\",\n      feedAmount: \"38g per bird\",\n      expectedWeight: \"380-400g\",\n      tips: \"Steady growth continues. Maintain consistent environment and feeding routine\"\n    };\n    if (age <= 42) return {\n      category: \"Week 6: Grower Preparation\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Chick and Duck Mash\",\n      feedAmount: \"41g per bird\",\n      expectedWeight: \"470-500g\",\n      tips: \"Prepare for grower phase. Monitor body condition and weight gain\"\n    };\n    if (age <= 49) return {\n      category: \"Week 7: Transition Prep\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Chick and Duck Mash\",\n      feedAmount: \"45g per bird\",\n      expectedWeight: \"560-600g\",\n      tips: \"Transition preparation. Prepare for feed type change\"\n    };\n    if (age <= 56) return {\n      category: \"Week 8: Feed Transition\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Gradual change to Growers Mash\",\n      feedAmount: \"49g per bird\",\n      expectedWeight: \"650g\",\n      tips: \"Begin grower feed transition. Introduce new feed gradually over 7 days\"\n    };\n    if (age <= 63) return {\n      category: \"Week 9: Growth Phase\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Growers Mash\",\n      feedAmount: \"52g per bird\",\n      expectedWeight: \"740-780g\",\n      tips: \"Full grower feed. Monitor feed consumption and weight gain\"\n    };\n    if (age <= 70) return {\n      category: \"Week 10: Rapid Growth\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Growers Mash\",\n      feedAmount: \"60g per bird\",\n      expectedWeight: \"830-870g\",\n      tips: \"Rapid growth phase. Maintain consistent feeding schedule\"\n    };\n    if (age <= 77) return {\n      category: \"Week 11: Peak Growth\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Growers Mash\",\n      feedAmount: \"70g per bird\",\n      expectedWeight: \"920-980g\",\n      tips: \"Peak growth period. Monitor body condition\"\n    };\n    if (age <= 84) return {\n      category: \"Week 12: Consistent Growth\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Growers Mash\",\n      feedAmount: \"75g per bird\",\n      expectedWeight: \"1010-1050g\",\n      tips: \"Consistent growth. Maintain optimal conditions\"\n    };\n    if (age <= 91) return {\n      category: \"Week 13: Continued Development\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Growers Mash\",\n      feedAmount: \"80g per bird\",\n      expectedWeight: \"1100-1140g\",\n      tips: \"Continued development. Monitor overall health\"\n    };\n    if (age <= 98) return {\n      category: \"Week 14: Pre-Layer Development\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Growers Mash\",\n      feedAmount: \"85g per bird\",\n      expectedWeight: \"1185-1230g\",\n      tips: \"Pre-layer development. Prepare for transition\"\n    };\n    if (age <= 105) return {\n      category: \"Week 15: Final Grower Phase\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Growers Mash\",\n      feedAmount: \"92g per bird\",\n      expectedWeight: \"1270-1320g\",\n      tips: \"Final grower phase. Prepare for layer feed\"\n    };\n    if (age <= 112) return {\n      category: \"Week 16: Layer Feed Transition\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Gradual change to Layers Mash\",\n      feedAmount: \"100g per bird\",\n      expectedWeight: \"1355-1410g\",\n      tips: \"Begin layer feed transition. Introduce gradually\"\n    };\n    if (age <= 119) return {\n      category: \"Week 17: Layer Feed Establishment\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Layers Mash\",\n      feedAmount: \"107g per bird\",\n      expectedWeight: \"1440-1500g\",\n      tips: \"Layer feed establishment. Monitor feed acceptance\"\n    };\n    if (age <= 126) return {\n      category: \"Week 18: Pre-Laying Preparation\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Layers Mash\",\n      feedAmount: \"114g per bird\",\n      expectedWeight: \"1530-1600g\",\n      tips: \"Pre-laying preparation. Ensure optimal nutrition\"\n    };\n    if (age <= 133) return {\n      category: \"Week 19: Approaching Laying\",\n      tempRange: \"21°C\",\n      lighting: \"14 hours\",\n      feedType: \"Layers Mash\",\n      feedAmount: \"118g per bird\",\n      expectedWeight: \"1580-1680g\",\n      tips: \"Approaching laying. Monitor for early eggs\"\n    };\n    return {\n      category: \"Week 20+: Layer Phase\",\n      tempRange: \"21°C\", \n      lighting: \"14 hours\",\n      feedType: \"Layers Mash\",\n      feedAmount: \"120g per bird\",\n      expectedWeight: \"1645-1750g\",\n      tips: \"Ready for egg production. Monitor egg production, maintain consistent environment\"\n    };\n  };\n\n  const guidance = getAgeGuidance(chickAge);\n\n  const createRecordMutation = useMutation({\n    mutationFn: async (data: any) => {\n      console.log(\"Submitting chick brooding record:\", data);\n      await apiRequest(\"POST\", \"/api/daily-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Chick brooding record saved successfully\"\n      });\n      if (onSuccess) onSuccess();\n    },\n    onError: (error: any) => {\n      console.error(\"Failed to create brooding record:\", error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save brooding record. Please try again.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!flockId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a flock\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const recordData = {\n      recordDate,\n      flockId,\n      temperature,\n      lightingHours,\n      feedConsumed,\n      feedType,\n      averageWeight,\n      sampleSize: parseInt(sampleSize) || 0,\n      mortalityCount: parseInt(mortalityCount) || 0,\n      eggsCollected: 0, // Not applicable for brooding\n      brokenEggs: 0, // Not applicable for brooding  \n      cratesProduced: 0, // Not applicable for brooding\n      notes,\n    };\n\n    createRecordMutation.mutate(recordData);\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-6\">\n      {/* Record Date & Flock Selection */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"recordDate\">Record Date</Label>\n          <Input\n            id=\"recordDate\"\n            type=\"date\"\n            value={recordDate}\n            onChange={(e) => setRecordDate(e.target.value)}\n            required\n            data-testid=\"input-record-date\"\n          />\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"flockId\">Flock</Label>\n          <Select value={flockId} onValueChange={setFlockId} required>\n            <SelectTrigger data-testid=\"select-flock\">\n              <SelectValue placeholder=\"Select flock\" />\n            </SelectTrigger>\n            <SelectContent>\n              {flocks.map((flock) => (\n                <SelectItem key={flock.id} value={flock.id}>\n                  {flock.name} ({flock.currentCount} birds)\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* Age-based Guidance Section */}\n      {selectedFlock && chickAge > 0 && (\n        <Card className=\"bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg text-blue-800 dark:text-blue-200\">\n              📋 Day {chickAge} Guidance: {guidance.category}\n            </CardTitle>\n            <CardDescription className=\"text-blue-600 dark:text-blue-300\">\n              Chick age calculated from {format(new Date(selectedFlock.hatchDate), 'MMM d, yyyy')}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\">\n              <div>\n                <p><strong>🌡️ Temperature:</strong> {guidance.tempRange}</p>\n                <p><strong>💡 Lighting:</strong> {guidance.lighting}</p>\n              </div>\n              <div>\n                <p><strong>🍽️ Feed:</strong> {guidance.feedType}</p>\n                <p><strong>📊 Expected Weight:</strong> {guidance.expectedWeight}</p>\n              </div>\n            </div>\n            <div className=\"bg-blue-100 dark:bg-blue-900 p-3 rounded-lg\">\n              <p className=\"text-sm\"><strong>💡 Pro Tip:</strong> {guidance.tips}</p>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Brooding Environment */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Brooding Environment</CardTitle>\n          <CardDescription>Temperature and lighting conditions</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"temperature\">Temperature (°C)</Label>\n              <Input\n                id=\"temperature\"\n                type=\"number\"\n                step=\"0.1\"\n                value={temperature}\n                onChange={(e) => setTemperature(e.target.value)}\n                placeholder=\"32.5\"\n                required\n                data-testid=\"input-temperature\"\n              />\n              {guidance.tempRange && (\n                <p className=\"text-xs text-muted-foreground\">\n                  Recommended: {guidance.tempRange}\n                </p>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"lightingHours\">Lighting Hours</Label>\n              <Input\n                id=\"lightingHours\"\n                type=\"number\"\n                step=\"0.5\"\n                value={lightingHours}\n                onChange={(e) => setLightingHours(e.target.value)}\n                placeholder=\"18.0\"\n                required\n                data-testid=\"input-lighting-hours\"\n              />\n              {guidance.lighting && (\n                <p className=\"text-xs text-muted-foreground\">\n                  Recommended: {guidance.lighting}\n                </p>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Feed Management */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Feed Management</CardTitle>\n          <CardDescription>Daily feed consumption and type</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"feedConsumed\">Feed Consumed (kg)</Label>\n              <Input\n                id=\"feedConsumed\"\n                type=\"number\"\n                step=\"0.1\"\n                value={feedConsumed}\n                onChange={(e) => setFeedConsumed(e.target.value)}\n                placeholder=\"150.0\"\n                required\n                data-testid=\"input-feed-consumed\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"feedType\">Feed Type</Label>\n              <Select value={feedType} onValueChange={setFeedType}>\n                <SelectTrigger data-testid=\"select-feed-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"chick-starter\">Chick Starter (24% protein)</SelectItem>\n                  <SelectItem value=\"chick-grower\">Chick Grower (20% protein)</SelectItem>\n                  <SelectItem value=\"developer\">Developer Feed (16-18% protein)</SelectItem>\n                  <SelectItem value=\"layer-starter\">Layer Starter</SelectItem>\n                  <SelectItem value=\"other\">Other</SelectItem>\n                </SelectContent>\n              </Select>\n              {guidance.feedType && (\n                <p className=\"text-xs text-muted-foreground\">\n                  Recommended: {guidance.feedType}\n                </p>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Weight & Health Monitoring */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Weight & Health Monitoring</CardTitle>\n          <CardDescription>Growth tracking and mortality records</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"averageWeight\">Average Weight (g)</Label>\n              <Input\n                id=\"averageWeight\"\n                type=\"number\"\n                step=\"0.1\"\n                value={averageWeight}\n                onChange={(e) => setAverageWeight(e.target.value)}\n                placeholder=\"265.0\"\n                required\n                data-testid=\"input-average-weight\"\n              />\n              {guidance.expectedWeight && (\n                <p className=\"text-xs text-muted-foreground\">\n                  Expected: {guidance.expectedWeight}\n                </p>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"sampleSize\">Sample Size</Label>\n              <Input\n                id=\"sampleSize\"\n                type=\"number\"\n                value={sampleSize}\n                onChange={(e) => setSampleSize(e.target.value)}\n                placeholder=\"100\"\n                required\n                data-testid=\"input-sample-size\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"mortalityCount\">Mortality Count</Label>\n              <Input\n                id=\"mortalityCount\"\n                type=\"number\"\n                value={mortalityCount}\n                onChange={(e) => setMortalityCount(e.target.value)}\n                placeholder=\"0\"\n                data-testid=\"input-mortality-count\"\n              />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Notes */}\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"notes\">Notes</Label>\n        <Textarea\n          id=\"notes\"\n          value={notes}\n          onChange={(e) => setNotes(e.target.value)}\n          placeholder=\"Any observations, concerns, or special notes...\"\n          className=\"min-h-[100px]\"\n          data-testid=\"textarea-notes\"\n        />\n      </div>\n\n      <Separator />\n\n      <Button \n        type=\"submit\" \n        className=\"w-full\" \n        disabled={createRecordMutation.isPending}\n        data-testid=\"button-submit\"\n      >\n        {createRecordMutation.isPending ? \"Saving...\" : \"Save Brooding Record\"}\n      </Button>\n    </form>\n  );\n}","size_bytes":18864},"client/src/pages/farm-storefront.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { MapPin, Phone, Mail, Globe, Users, ShoppingCart, ArrowLeft, Package, Award } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\ninterface Farm {\n  id: string;\n  name: string;\n  description: string;\n  location: string;\n  address: string;\n  contactEmail: string;\n  contactPhone: string;\n  website?: string;\n  totalBirds: number;\n  avgEggsPerDay: number;\n  specialization: string;\n  businessRegistration?: string;\n  certifications?: string[];\n}\n\ninterface Product {\n  id: string;\n  farmId: string;\n  name: string;\n  category: string;\n  description: string;\n  unit: string;\n  currentPrice: string;\n  minOrderQuantity: number;\n  stockQuantity: number;\n}\n\nexport default function FarmStorefront() {\n  const [match, params] = useRoute(\"/farm/:farmId\");\n  const farmId = params?.farmId;\n\n  const { data: farm, isLoading: farmLoading } = useQuery<Farm>({\n    queryKey: ['/api/public/farms', farmId],\n    enabled: !!farmId,\n  });\n\n  const { data: products = [], isLoading: productsLoading } = useQuery<Product[]>({\n    queryKey: ['/api/public/farms', farmId, 'products'],\n    queryFn: () => fetch(`/api/public/farms/${farmId}/products`).then(res => res.json()),\n    enabled: !!farmId,\n  });\n\n  if (!match) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"text-center py-12\">\n            <p className=\"text-gray-500 dark:text-gray-400\">Farm not found</p>\n            <Link to=\"/marketplace\">\n              <Button className=\"mt-4\">Back to Marketplace</Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (farmLoading || productsLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"space-y-6\">\n          <Skeleton className=\"h-8 w-48\" />\n          <Card>\n            <CardHeader>\n              <Skeleton className=\"h-8 w-64\" />\n              <Skeleton className=\"h-4 w-48\" />\n            </CardHeader>\n            <CardContent>\n              <Skeleton className=\"h-32 w-full\" />\n            </CardContent>\n          </Card>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {[...Array(6)].map((_, i) => (\n              <Card key={i}>\n                <CardHeader>\n                  <Skeleton className=\"h-6 w-48\" />\n                  <Skeleton className=\"h-4 w-32\" />\n                </CardHeader>\n                <CardContent>\n                  <Skeleton className=\"h-24 w-full\" />\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!farm) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"text-center py-12\">\n            <p className=\"text-gray-500 dark:text-gray-400\">\n              Farm not found or not available for public viewing\n            </p>\n            <Link to=\"/marketplace\">\n              <Button className=\"mt-4\" data-testid=\"button-back-marketplace\">\n                Back to Marketplace\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const categoryGroups = products.reduce((groups: Record<string, Product[]>, product) => {\n    const category = product.category;\n    if (!groups[category]) {\n      groups[category] = [];\n    }\n    groups[category].push(product);\n    return groups;\n  }, {});\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 space-y-8\">\n      {/* Header Navigation */}\n      <div className=\"flex items-center gap-4\">\n        <Link to=\"/marketplace\">\n          <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back to Marketplace\n          </Button>\n        </Link>\n      </div>\n\n      {/* Farm Information */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n        <div className=\"lg:col-span-2\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-start justify-between\">\n                <div>\n                  <CardTitle className=\"text-2xl mb-2\" data-testid=\"text-farm-name\">\n                    {farm.name}\n                  </CardTitle>\n                  <div className=\"flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400\">\n                    <div className=\"flex items-center\">\n                      <MapPin className=\"mr-1 h-4 w-4\" />\n                      <span data-testid=\"text-farm-location\">{farm.location}</span>\n                    </div>\n                    <Badge variant=\"outline\">{farm.specialization}</Badge>\n                  </div>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div>\n                <h3 className=\"font-semibold mb-2\">About This Farm</h3>\n                <p className=\"text-gray-600 dark:text-gray-400\" data-testid=\"text-farm-description\">\n                  {farm.description || \"Premium quality poultry products from a trusted local farm committed to sustainable farming practices.\"}\n                </p>\n              </div>\n\n              {farm.address && (\n                <div>\n                  <h3 className=\"font-semibold mb-2\">Location</h3>\n                  <p className=\"text-gray-600 dark:text-gray-400\">{farm.address}</p>\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                <div className=\"text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg\">\n                  <Users className=\"h-6 w-6 mx-auto mb-2 text-blue-600\" />\n                  <p className=\"text-sm font-medium\">{farm.totalBirds.toLocaleString()}</p>\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400\">Total Birds</p>\n                </div>\n                <div className=\"text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg\">\n                  <ShoppingCart className=\"h-6 w-6 mx-auto mb-2 text-green-600\" />\n                  <p className=\"text-sm font-medium\">{farm.avgEggsPerDay.toLocaleString()}</p>\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400\">Eggs/Day</p>\n                </div>\n                <div className=\"text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg\">\n                  <Package className=\"h-6 w-6 mx-auto mb-2 text-purple-600\" />\n                  <p className=\"text-sm font-medium\">{products.length}</p>\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400\">Products</p>\n                </div>\n                <div className=\"text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg\">\n                  <Award className=\"h-6 w-6 mx-auto mb-2 text-yellow-600\" />\n                  <p className=\"text-sm font-medium\">Certified</p>\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400\">Quality</p>\n                </div>\n              </div>\n\n              {farm.certifications && farm.certifications.length > 0 && (\n                <div>\n                  <h3 className=\"font-semibold mb-2\">Certifications</h3>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {farm.certifications.map((cert, index) => (\n                      <Badge key={index} variant=\"secondary\">\n                        {cert}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        <div>\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Contact Information</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {farm.contactPhone && (\n                <div className=\"flex items-center\">\n                  <Phone className=\"mr-3 h-4 w-4 text-gray-400\" />\n                  <div>\n                    <p className=\"text-sm font-medium\">Phone</p>\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400\">{farm.contactPhone}</p>\n                  </div>\n                </div>\n              )}\n              {farm.contactEmail && (\n                <div className=\"flex items-center\">\n                  <Mail className=\"mr-3 h-4 w-4 text-gray-400\" />\n                  <div>\n                    <p className=\"text-sm font-medium\">Email</p>\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400 break-all\">{farm.contactEmail}</p>\n                  </div>\n                </div>\n              )}\n              {farm.website && (\n                <div className=\"flex items-center\">\n                  <Globe className=\"mr-3 h-4 w-4 text-gray-400\" />\n                  <div>\n                    <p className=\"text-sm font-medium\">Website</p>\n                    <a\n                      href={farm.website}\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className=\"text-sm text-blue-600 hover:underline\"\n                    >\n                      Visit Website\n                    </a>\n                  </div>\n                </div>\n              )}\n              {farm.businessRegistration && (\n                <div>\n                  <p className=\"text-sm font-medium\">Business Registration</p>\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400\">{farm.businessRegistration}</p>\n                </div>\n              )}\n\n              <Separator />\n\n              <div className=\"text-center\">\n                <p className=\"text-sm text-gray-600 dark:text-gray-400 mb-3\">\n                  Ready to place an order?\n                </p>\n                <Link to=\"/customer-registration\">\n                  <Button className=\"w-full\" data-testid=\"button-register-customer\">\n                    Register as Customer\n                  </Button>\n                </Link>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Products Section */}\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-2xl font-semibold\">Available Products</h2>\n          <Badge variant=\"secondary\" data-testid=\"text-product-count\">\n            {products.length} products\n          </Badge>\n        </div>\n\n        {products.length === 0 ? (\n          <Card>\n            <CardContent className=\"text-center py-12\">\n              <Package className=\"h-12 w-12 mx-auto text-gray-400 mb-4\" />\n              <p className=\"text-gray-500 dark:text-gray-400 mb-2\">\n                No products available at the moment\n              </p>\n              <p className=\"text-sm text-gray-400\">\n                Check back later or contact the farm directly\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-8\">\n            {Object.entries(categoryGroups).map(([category, categoryProducts]) => (\n              <div key={category}>\n                <h3 className=\"text-xl font-semibold mb-4 capitalize\">\n                  {category}\n                  <Badge variant=\"outline\" className=\"ml-2\">\n                    {categoryProducts.length}\n                  </Badge>\n                </h3>\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6\">\n                  {categoryProducts.map((product) => (\n                    <Card key={product.id} className=\"hover:shadow-lg transition-shadow\" data-testid={`card-product-${product.id}`}>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\" data-testid={`text-product-name-${product.id}`}>\n                          {product.name}\n                        </CardTitle>\n                        <div className=\"flex items-center justify-between\">\n                          <Badge variant=\"secondary\">{product.category}</Badge>\n                          <span className=\"text-xl font-bold text-green-600\" data-testid={`text-product-price-${product.id}`}>\n                            ${product.currentPrice}\n                            <span className=\"text-sm font-normal text-gray-500\">/{product.unit}</span>\n                          </span>\n                        </div>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        {product.description && (\n                          <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                            {product.description}\n                          </p>\n                        )}\n                        \n                        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                          <div>\n                            <p className=\"font-medium text-gray-900 dark:text-gray-100\">Min Order</p>\n                            <p className=\"text-gray-600 dark:text-gray-400\">\n                              {product.minOrderQuantity} {product.unit}\n                            </p>\n                          </div>\n                          <div>\n                            <p className=\"font-medium text-gray-900 dark:text-gray-100\">In Stock</p>\n                            <p className=\"text-gray-600 dark:text-gray-400\">\n                              {product.stockQuantity} {product.unit}\n                            </p>\n                          </div>\n                        </div>\n\n                        <div className=\"space-y-2\">\n                          <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                            Contact farm to place order\n                          </p>\n                          <div className=\"flex flex-col gap-2\">\n                            {farm.contactPhone && (\n                              <Button variant=\"outline\" size=\"sm\" className=\"justify-start\" data-testid={`button-call-${product.id}`}>\n                                <Phone className=\"mr-2 h-4 w-4\" />\n                                Call {farm.contactPhone}\n                              </Button>\n                            )}\n                            {farm.contactEmail && (\n                              <Button \n                                variant=\"outline\" \n                                size=\"sm\" \n                                className=\"justify-start\"\n                                onClick={() => window.location.href = `mailto:${farm.contactEmail}?subject=Order Inquiry: ${product.name}`}\n                                data-testid={`button-email-${product.id}`}\n                              >\n                                <Mail className=\"mr-2 h-4 w-4\" />\n                                Send Email\n                              </Button>\n                            )}\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* Call to Action */}\n      <Card className=\"bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-950 dark:to-blue-950\">\n        <CardContent className=\"text-center py-8\">\n          <h3 className=\"text-xl font-semibold mb-2\">Want to order from {farm.name}?</h3>\n          <p className=\"text-gray-600 dark:text-gray-400 mb-4\">\n            Register as a customer to place orders and get updates on new products.\n          </p>\n          <Link to=\"/customer-registration\">\n            <Button size=\"lg\" data-testid=\"button-cta-register\">\n              Register as Customer\n            </Button>\n          </Link>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":16013},"client/src/components/forms/simple-flock-form.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { BREED_OPTIONS } from \"@/lib/constants\";\n\ninterface SimpleFlockFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function SimpleFlockForm({ onSuccess }: SimpleFlockFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [name, setName] = useState(\"\");\n  const [breed, setBreed] = useState(\"\");\n  const [initialCount, setInitialCount] = useState(0);\n  const [hatchDate, setHatchDate] = useState(new Date().toISOString().split('T')[0]);\n  const [status, setStatus] = useState(\"brooding\");\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const createFlockMutation = useMutation({\n    mutationFn: async (flockData: any) => {\n      console.log(\"Mutation function called with:\", flockData);\n\n      // Decide once: create or update\n      const response = flockData.id\n        ? await apiRequest(\"PUT\", `/api/flocks/${flockData.id}`, flockData)\n        : await apiRequest(\"POST\", \"/api/flocks\", flockData);\n\n      console.log(\"API response:\", response);\n      return response;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/flocks\"] });\n      toast({\n        title: \"Success\",\n        description: \"Flock created successfully\",\n      });\n      // Reset form\n      setName(\"\");\n      setBreed(\"\");\n      setInitialCount(0);\n      setHatchDate(new Date().toISOString().split('T')[0]);\n      setStatus(\"brooding\");\n      onSuccess?.();\n    },\n    onError: (error: any) => {\n      console.error(\"Create flock error:\", error);\n      \n      if (error.message?.includes(\"must be associated with a farm\")) {\n        toast({\n          title: \"Farm Registration Required\",\n          description: \"You need to register your farm first. Go to /farm-registration to get started.\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Error\",\n          description: error.message || \"Failed to create flock\",\n          variant: \"destructive\",\n        });\n      }\n    },\n  });\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    console.log(\"handleSubmit called!\");\n    e.preventDefault();\n    console.log(\"Form data - name:\", name, \"breed:\", breed, \"initialCount:\", initialCount);\n    \n    // Basic validation\n    if (!name.trim()) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Flock name is required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (!breed) {\n      toast({\n        title: \"Validation Error\", \n        description: \"Please select a breed\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (initialCount <= 0) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Initial count must be greater than 0\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const flockData = {\n      name: name.trim(),\n      breed,\n      initialCount,\n      currentCount: initialCount,\n      hatchDate,\n      status,\n    };\n\n    console.log(\"Submitting flock data:\", flockData);\n    createFlockMutation.mutate(flockData);\n  };\n\n  return (\n    <Card data-testid=\"card-simple-flock-form\">\n      <CardHeader>\n        <CardTitle>Add New Flock</CardTitle>\n        <CardDescription>\n          Create a new flock for your poultry farm. Track this flock throughout its lifecycle.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Flock Name</Label>\n              <Input\n                id=\"name\"\n                type=\"text\"\n                placeholder=\"e.g., Batch A 2024\"\n                value={name}\n                onChange={(e) => setName(e.target.value)}\n                data-testid=\"input-simple-flock-name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"breed\">Breed</Label>\n              <Select value={breed} onValueChange={setBreed}>\n                <SelectTrigger data-testid=\"select-simple-breed\">\n                  <SelectValue placeholder=\"Select breed\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {BREED_OPTIONS.map((breed) => (\n                    <SelectItem key={breed.value} value={breed.value}>\n                      {breed.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"initialCount\">Initial Count</Label>\n              <Input\n                id=\"initialCount\"\n                type=\"number\"\n                placeholder=\"500\"\n                value={initialCount || \"\"}\n                onChange={(e) => setInitialCount(parseInt(e.target.value) || 0)}\n                data-testid=\"input-simple-initial-count\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"hatchDate\">Hatch Date</Label>\n              <Input\n                id=\"hatchDate\"\n                type=\"date\"\n                value={hatchDate}\n                onChange={(e) => setHatchDate(e.target.value)}\n                data-testid=\"input-simple-hatch-date\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"status\">Status</Label>\n            <Select value={status} onValueChange={setStatus}>\n              <SelectTrigger data-testid=\"select-simple-status\">\n                <SelectValue placeholder=\"Select status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"brooding\">Brooding</SelectItem>\n                <SelectItem value=\"laying\">Laying</SelectItem>\n                <SelectItem value=\"retired\">Retired</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          <Button \n            type=\"submit\" \n            disabled={createFlockMutation.isPending}\n            data-testid=\"button-submit-simple-flock\"\n            className=\"w-full\"\n          >\n            {createFlockMutation.isPending ? \"Creating...\" : \"Create Flock\"}\n          </Button>\n        </form>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":6945},"client/src/components/forms/comprehensive-daily-record-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { format } from \"date-fns\";\nimport { Egg, Skull, Wheat, Thermometer, Sun, Weight } from \"lucide-react\";\n\ninterface ComprehensiveDailyRecordFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function ComprehensiveDailyRecordForm({ onSuccess }: ComprehensiveDailyRecordFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Form state\n  const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);\n  const [flockId, setFlockId] = useState(\"\");\n  \n  // Egg production\n  const [eggsCollected, setEggsCollected] = useState(\"\");\n  const [brokenEggs, setBrokenEggs] = useState(\"\");\n  const [cratesProduced, setCratesProduced] = useState(\"\");\n\n  // Mortality\n  const [mortalityCount, setMortalityCount] = useState(\"\");\n  const [mortalityReason, setMortalityReason] = useState(\"\");\n  \n  // Feed\n  const [feedConsumed, setFeedConsumed] = useState(\"\");\n  const [feedType, setFeedType] = useState(\"\");\n  \n  // Brooding (optional)\n  const [temperature, setTemperature] = useState(\"\");\n  const [lightingHours, setLightingHours] = useState(\"\");\n  const [averageWeight, setAverageWeight] = useState(\"\");\n  const [sampleSize, setSampleSize] = useState(\"\");\n  \n  const [notes, setNotes] = useState(\"\");\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  // Calculate chick age and get guidance\n  const getChickAge = (recordDate: string, hatchDate: string) => {\n    const record = new Date(recordDate);\n    const hatch = new Date(hatchDate);\n    const diffTime = record.getTime() - hatch.getTime();\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n  };\n\n  const selectedFlock = flocks.find(f => f.id === flockId);\n  const chickAge = selectedFlock ? getChickAge(recordDate, selectedFlock.hatchDate) : 0;\n\n  // Age-based feed guidance (matches brooding schedule)\n  const getFeedGuidance = (age: number) => {\n    if (age <= 7) return {\n      feedType: \"chick-starter\",\n      dailyAmount: \"12g per bird\",\n      protein: \"High protein starter\",\n      tips: \"Week 1: Critical Care - monitor closely, ensure access to water\"\n    };\n    if (age <= 14) return {\n      feedType: \"chick-starter\", \n      dailyAmount: \"18g per bird\",\n      protein: \"High protein starter\",\n      tips: \"Week 2: Rapid Growth - monitor feed intake closely\"\n    };\n    if (age <= 21) return {\n      feedType: \"chick-starter\",\n      dailyAmount: \"25g per bird\", \n      protein: \"High protein starter\",\n      tips: \"Week 3: Development - feed transition period\"\n    };\n    if (age <= 28) return {\n      feedType: \"chick-starter\",\n      dailyAmount: \"31g per bird\",\n      protein: \"High protein starter\", \n      tips: \"Week 4: Feather Development - maintain consistent feeding\"\n    };\n    if (age <= 35) return {\n      feedType: \"chick-starter\",\n      dailyAmount: \"38g per bird\",\n      protein: \"High protein starter\",\n      tips: \"Week 5: Steady Growth - consistent environment\"\n    };\n    if (age <= 42) return {\n      feedType: \"chick-starter\",\n      dailyAmount: \"41g per bird\",\n      protein: \"High protein starter\",\n      tips: \"Week 6: Grower Prep - monitor body condition\"\n    };\n    if (age <= 49) return {\n      feedType: \"chick-starter\",\n      dailyAmount: \"45g per bird\",\n      protein: \"High protein starter\",\n      tips: \"Week 7: Transition Prep - prepare for feed change\"\n    };\n    if (age <= 56) return {\n      feedType: \"grower-feed\",\n      dailyAmount: \"49g per bird\",\n      protein: \"Grower feed\",\n      tips: \"Week 8: Feed Transition - introduce growers mash gradually\"\n    };\n    if (age <= 133) return {\n      feedType: \"grower-feed\",\n      dailyAmount: \"52-92g per bird\",\n      protein: \"Grower feed\",\n      tips: \"Weeks 9-19: Growth Phase - monitor feed consumption and weight gain\"\n    };\n    return {\n      feedType: \"layer-feed\",\n      dailyAmount: \"100-120g per bird\", \n      protein: \"16-18% protein\",\n      tips: \"Week 20+: Layer Phase - consistent high-quality nutrition required\"\n    };\n  };\n\n  const feedGuidance = getFeedGuidance(chickAge);\n\n  // Age-based weight guidance (matches brooding schedule)\n  const getWeightGuidance = (age: number): string => {\n    if (age <= 7) return \"120-150g\";      // Week 1\n    if (age <= 14) return \"200-250g\";     // Week 2\n    if (age <= 21) return \"300-350g\";     // Week 3\n    if (age <= 28) return \"400-450g\";     // Week 4\n    if (age <= 35) return \"500-550g\";     // Week 5\n    if (age <= 42) return \"600-650g\";     // Week 6\n    if (age <= 49) return \"680-720g\";     // Week 7\n    if (age <= 56) return \"710-750g\";     // Week 8\n    if (age <= 63) return \"740-780g\";     // Week 9\n    if (age <= 70) return \"830-870g\";     // Week 10\n    if (age <= 77) return \"920-980g\";     // Week 11\n    if (age <= 84) return \"1020-1080g\";   // Week 12\n    if (age <= 91) return \"1120-1180g\";   // Week 13\n    if (age <= 98) return \"1220-1280g\";   // Week 14\n    if (age <= 105) return \"1320-1380g\";  // Week 15\n    if (age <= 112) return \"1420-1480g\";  // Week 16\n    if (age <= 119) return \"1520-1580g\";  // Week 17\n    if (age <= 126) return \"1620-1680g\";  // Week 18\n    if (age <= 133) return \"1720-1780g\";  // Week 19\n    return \"1800-2000g\";                  // Week 20+\n  };\n\n  // Automatic crate calculation\n  useEffect(() => {\n    const eggs = parseInt(eggsCollected) || 0;\n    const calculatedCrates = Math.floor(eggs / 30);\n    setCratesProduced(calculatedCrates.toString());\n  }, [eggsCollected]);\n\n  // Mortality reasons list\n  const mortalityReasons = [\n    { value: \"disease\", label: \"Disease/Illness\" },\n    { value: \"predator\", label: \"Predator Attack\" },\n    { value: \"accident\", label: \"Accident/Injury\" }, \n    { value: \"heat-stress\", label: \"Heat Stress\" },\n    { value: \"cold-stress\", label: \"Cold Stress\" },\n    { value: \"feed-related\", label: \"Feed Related\" },\n    { value: \"water-related\", label: \"Water Related\" },\n    { value: \"old-age\", label: \"Old Age\" },\n    { value: \"cannibalism\", label: \"Cannibalism/Pecking\" },\n    { value: \"unknown\", label: \"Unknown Cause\" },\n    { value: \"other\", label: \"Other\" }\n  ];\n\n  const createRecordMutation = useMutation({\n    mutationFn: async (data: any) => {\n      console.log(\"Submitting comprehensive daily record:\", data);\n      await apiRequest(\"POST\", \"/api/daily-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Daily record saved successfully\"\n      });\n      if (onSuccess) onSuccess();\n    },\n    onError: (error: any) => {\n      console.error(\"Failed to create daily record:\", error);\n      toast({\n        title: \"Error\", \n        description: error.message || \"Failed to save daily record. Please try again.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!flockId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a flock\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const recordData = {\n      recordDate,\n      flockId,\n      // Egg production\n      eggsCollected: parseInt(eggsCollected) || 0,\n      brokenEggs: parseInt(brokenEggs) || 0,\n      cratesProduced: parseInt(cratesProduced) || 0,\n      // Mortality  \n      mortalityCount: parseInt(mortalityCount) || 0,\n      mortalityReason: mortalityReason || null,\n      // Feed\n      feedConsumed: feedConsumed || null,\n      feedType: feedType || null,\n      // Brooding (optional)\n      temperature: temperature || null,\n      lightingHours: lightingHours || null,\n      averageWeight: averageWeight || null,\n      sampleSize: parseInt(sampleSize) || 0,\n      notes,\n    };\n\n    createRecordMutation.mutate(recordData);\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-6\">\n      {/* Basic Information */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            📋 Daily Record Information\n          </CardTitle>\n          <CardDescription>Select date and flock for this record</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"recordDate\">Record Date</Label>\n              <Input\n                id=\"recordDate\"\n                type=\"date\"\n                value={recordDate}\n                onChange={(e) => setRecordDate(e.target.value)}\n                required\n                data-testid=\"input-record-date\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"flockId\">Flock</Label>\n              <Select value={flockId} onValueChange={setFlockId} required>\n                <SelectTrigger data-testid=\"select-flock\">\n                  <SelectValue placeholder=\"Select flock\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {flocks.map((flock) => (\n                    <SelectItem key={flock.id} value={flock.id}>\n                      {flock.name} ({flock.currentCount} birds) - Day {getChickAge(recordDate, flock.hatchDate)}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Age-based Guidance */}\n      {selectedFlock && chickAge > 0 && (\n        <Card className=\"bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg text-blue-800 dark:text-blue-200\">\n              🧭 Day {chickAge} Guidance\n            </CardTitle>\n            <CardDescription className=\"text-blue-600 dark:text-blue-300\">\n              Age-based recommendations for {selectedFlock.name}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm\">\n              <div className=\"space-y-2\">\n                <Badge variant=\"secondary\">Feed Guidance</Badge>\n                <p><strong>Type:</strong> {feedGuidance.feedType}</p>\n                <p><strong>Amount:</strong> {feedGuidance.dailyAmount}</p>\n                <p><strong>Protein:</strong> {feedGuidance.protein}</p>\n              </div>\n              <div className=\"space-y-2\">\n                <Badge variant=\"secondary\">Pro Tips</Badge>\n                <p className=\"text-xs\">{feedGuidance.tips}</p>\n              </div>\n              <div className=\"space-y-2\">\n                <Badge variant=\"secondary\">Expected Weight</Badge>\n                <p>{getWeightGuidance(chickAge)}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Egg Production Section */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Egg className=\"h-5 w-5\" />\n            Egg Production\n          </CardTitle>\n          <CardDescription>Daily egg collection and quality data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"eggsCollected\">Eggs Collected</Label>\n              <Input\n                id=\"eggsCollected\"\n                type=\"number\"\n                value={eggsCollected}\n                onChange={(e) => setEggsCollected(e.target.value)}\n                placeholder=\"0\"\n                data-testid=\"input-eggs-collected\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"brokenEggs\">Broken Eggs</Label>\n              <Input\n                id=\"brokenEggs\"\n                type=\"number\"\n                value={brokenEggs}\n                onChange={(e) => setBrokenEggs(e.target.value)}\n                placeholder=\"0\"\n                data-testid=\"input-broken-eggs\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"cratesProduced\">Crates Produced</Label>\n              <Input\n                id=\"cratesProduced\"\n                type=\"number\"\n                value={cratesProduced}\n                readOnly\n                className=\"bg-muted\"\n                placeholder=\"Auto-calculated\"\n                data-testid=\"input-crates-produced\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Auto-calculated: 30 eggs = 1 crate\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Mortality Section */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Skull className=\"h-5 w-5\" />\n            Mortality Tracking\n          </CardTitle>\n          <CardDescription>Record any bird losses and reasons</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"mortalityCount\">Birds Lost</Label>\n              <Input\n                id=\"mortalityCount\"\n                type=\"number\"\n                value={mortalityCount}\n                onChange={(e) => setMortalityCount(e.target.value)}\n                placeholder=\"0\"\n                data-testid=\"input-mortality-count\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"mortalityReason\">Reason for Loss</Label>\n              <Select value={mortalityReason} onValueChange={setMortalityReason}>\n                <SelectTrigger data-testid=\"select-mortality-reason\">\n                  <SelectValue placeholder=\"Select reason (if any)\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {mortalityReasons.map((reason) => (\n                    <SelectItem key={reason.value} value={reason.value}>\n                      {reason.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Feed Management Section */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Wheat className=\"h-5 w-5\" />\n            Feed Management\n          </CardTitle>\n          <CardDescription>Daily feed consumption and type with age-based guidance</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"feedConsumed\">Feed Consumed (kg)</Label>\n              <Input\n                id=\"feedConsumed\"\n                type=\"number\"\n                step=\"0.1\"\n                value={feedConsumed}\n                onChange={(e) => setFeedConsumed(e.target.value)}\n                placeholder=\"150.0\"\n                data-testid=\"input-feed-consumed\"\n              />\n              {selectedFlock && chickAge > 0 && (\n                <div className=\"text-xs text-blue-600 dark:text-blue-300 bg-blue-50 dark:bg-blue-950 p-2 rounded\">\n                  <p><strong>Recommended:</strong> {feedGuidance.dailyAmount}</p>\n                  <p><strong>For {selectedFlock.currentCount} birds:</strong> ~{Math.round(selectedFlock.currentCount * (chickAge <= 7 ? 0.02 : chickAge <= 14 ? 0.03 : chickAge <= 21 ? 0.045 : chickAge <= 28 ? 0.06 : chickAge <= 42 ? 0.075 : 0.12))}kg total</p>\n                </div>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"feedType\">Feed Type</Label>\n              <Select value={feedType} onValueChange={setFeedType}>\n                <SelectTrigger data-testid=\"select-feed-type\">\n                  <SelectValue placeholder=\"Select feed type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"chick-starter\">Chick Starter (24% protein)</SelectItem>\n                  <SelectItem value=\"chick-grower\">Chick Grower (20% protein)</SelectItem>\n                  <SelectItem value=\"grower-feed\">Grower Feed (18% protein)</SelectItem>\n                  <SelectItem value=\"developer\">Developer Feed (16-18% protein)</SelectItem>\n                  <SelectItem value=\"layer-feed\">Layer Feed (16% protein)</SelectItem>\n                  <SelectItem value=\"layer-mash\">Layer Mash</SelectItem>\n                  <SelectItem value=\"layer-pellets\">Layer Pellets</SelectItem>\n                  <SelectItem value=\"wheat\">Wheat</SelectItem>\n                  <SelectItem value=\"maize\">Maize</SelectItem>\n                  <SelectItem value=\"other\">Other</SelectItem>\n                </SelectContent>\n              </Select>\n              {selectedFlock && chickAge > 0 && (\n                <div className=\"text-xs text-green-600 dark:text-green-300 bg-green-50 dark:bg-green-950 p-2 rounded\">\n                  <p><strong>Age-recommended:</strong> {feedGuidance.feedType} ({feedGuidance.protein})</p>\n                </div>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Environmental Conditions (Optional) */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Thermometer className=\"h-5 w-5\" />\n            Environmental Conditions (Optional)\n          </CardTitle>\n          <CardDescription>Temperature, lighting, and weight tracking</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"temperature\">Temperature (°C)</Label>\n              <Input\n                id=\"temperature\"\n                type=\"number\"\n                step=\"0.1\"\n                value={temperature}\n                onChange={(e) => setTemperature(e.target.value)}\n                placeholder=\"24.5\"\n                data-testid=\"input-temperature\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"lightingHours\">Lighting Hours</Label>\n              <Input\n                id=\"lightingHours\"\n                type=\"number\"\n                step=\"0.5\"\n                value={lightingHours}\n                onChange={(e) => setLightingHours(e.target.value)}\n                placeholder=\"14.0\"\n                data-testid=\"input-lighting-hours\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"averageWeight\">Average Weight (g)</Label>\n              <Input\n                id=\"averageWeight\"\n                type=\"number\"\n                step=\"0.1\"\n                value={averageWeight}\n                onChange={(e) => setAverageWeight(e.target.value)}\n                placeholder=\"1650.0\"\n                data-testid=\"input-average-weight\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"sampleSize\">Sample Size</Label>\n              <Input\n                id=\"sampleSize\"\n                type=\"number\"\n                value={sampleSize}\n                onChange={(e) => setSampleSize(e.target.value)}\n                placeholder=\"50\"\n                data-testid=\"input-sample-size\"\n              />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Notes */}\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"notes\">Notes & Observations</Label>\n        <Textarea\n          id=\"notes\"\n          value={notes}\n          onChange={(e) => setNotes(e.target.value)}\n          placeholder=\"Any observations, concerns, or special notes about today's activities...\"\n          className=\"min-h-[100px]\"\n          data-testid=\"textarea-notes\"\n        />\n      </div>\n\n      <Separator />\n\n      <Button \n        type=\"submit\" \n        className=\"w-full\" \n        disabled={createRecordMutation.isPending}\n        data-testid=\"button-submit\"\n      >\n        {createRecordMutation.isPending ? \"Saving Daily Record...\" : \"Save Daily Record\"}\n      </Button>\n    </form>\n  );\n}","size_bytes":21151},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":1901},"client/src/pages/settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Badge } from \"@/components/ui/badge\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Menu, Settings as SettingsIcon, User, Bell, Shield, Database, Download } from \"lucide-react\";\n\nexport default function Settings() {\n  const { user, isLoading, isAuthenticated } = useAuth();\n  const { toast } = useToast();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading settings...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n          data-testid=\"mobile-overlay\"\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Top Navigation Bar */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Settings</h2>\n                <p className=\"text-sm text-muted-foreground\">Manage your account and application preferences</p>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-3xl font-bold text-foreground\">Settings</h1>\n              <p className=\"text-muted-foreground\">Configure your account and application preferences</p>\n            </div>\n          </div>\n\n          <div className=\"grid gap-6\">\n            {/* Profile Settings */}\n            <Card data-testid=\"card-profile-settings\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <User className=\"h-5 w-5\" />\n                  Profile Information\n                </CardTitle>\n                <CardDescription>\n                  Your account details and profile information\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"firstName\">First Name</Label>\n                    <Input\n                      id=\"firstName\"\n                      value={user?.firstName || \"\"}\n                      readOnly\n                      data-testid=\"input-first-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"lastName\">Last Name</Label>\n                    <Input\n                      id=\"lastName\"\n                      value={user?.lastName || \"\"}\n                      readOnly\n                      data-testid=\"input-last-name\"\n                    />\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    value={user?.email || \"\"}\n                    readOnly\n                    data-testid=\"input-email\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"role\">Role</Label>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge variant={user?.role === 'admin' ? 'default' : 'secondary'} data-testid=\"badge-role\">\n                      {user?.role === 'admin' ? 'Administrator' : 'Staff Member'}\n                    </Badge>\n                    <span className=\"text-sm text-muted-foreground\">\n                      {user?.role === 'admin' \n                        ? 'Full access to all features and user management'\n                        : 'Access to farm operations and data entry'}\n                    </span>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Access Control Info */}\n            <Card data-testid=\"card-access-control\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Shield className=\"h-5 w-5\" />\n                  Access Control & Permissions\n                </CardTitle>\n                <CardDescription>\n                  Understanding your access levels and permissions\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"w-2 h-2 bg-green-500 rounded-full mt-2\"></div>\n                    <div>\n                      <p className=\"font-medium\">Farm Operations Access</p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        You can manage daily records, egg production, feed management, health records, and expenses for your farm.\n                      </p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"w-2 h-2 bg-blue-500 rounded-full mt-2\"></div>\n                    <div>\n                      <p className=\"font-medium\">Marketplace Access</p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        You can manage customers, products, and orders through the integrated marketplace platform.\n                      </p>\n                    </div>\n                  </div>\n                  {user?.role === 'admin' && (\n                    <div className=\"flex items-start gap-3\">\n                      <div className=\"w-2 h-2 bg-purple-500 rounded-full mt-2\"></div>\n                      <div>\n                        <p className=\"font-medium\">Administrative Access</p>\n                        <p className=\"text-sm text-muted-foreground\">\n                          As an admin, you can manage users, assign roles, and access all farm data across the platform.\n                        </p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Application Preferences */}\n            <Card data-testid=\"card-preferences\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <SettingsIcon className=\"h-5 w-5\" />\n                  Application Preferences\n                </CardTitle>\n                <CardDescription>\n                  Customize your application experience\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"space-y-0.5\">\n                    <Label htmlFor=\"notifications\">Enable Notifications</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Receive alerts for low feed levels, health reminders, and production updates\n                    </p>\n                  </div>\n                  <Switch id=\"notifications\" defaultChecked data-testid=\"switch-notifications\" />\n                </div>\n                <Separator />\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"space-y-0.5\">\n                    <Label htmlFor=\"auto-calculations\">Auto-calculate Totals</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Automatically calculate totals in sales and expense forms\n                    </p>\n                  </div>\n                  <Switch id=\"auto-calculations\" defaultChecked data-testid=\"switch-auto-calculations\" />\n                </div>\n                <Separator />\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"space-y-0.5\">\n                    <Label htmlFor=\"daily-reminders\">Daily Record Reminders</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Get reminded to enter daily production and brooding records\n                    </p>\n                  </div>\n                  <Switch id=\"daily-reminders\" defaultChecked data-testid=\"switch-daily-reminders\" />\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Data & Privacy */}\n            <Card data-testid=\"card-data-privacy\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Database className=\"h-5 w-5\" />\n                  Data & Privacy\n                </CardTitle>\n                <CardDescription>\n                  Manage your data and privacy settings\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"space-y-0.5\">\n                    <Label>Data Backup</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Your farm data is automatically backed up daily to ensure security\n                    </p>\n                  </div>\n                  <Button variant=\"outline\" data-testid=\"button-export-data\">\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Export Data\n                  </Button>\n                </div>\n                <Separator />\n                <div className=\"space-y-2\">\n                  <Label>Data Retention</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Farm records are retained indefinitely for historical analysis. \n                    Contact support if you need specific data removal.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </main>\n    </div>\n  );\n}","size_bytes":11909},"client/src/components/FarmSelector.tsx":{"content":"import { useFarmContext } from '@/contexts/FarmContext';\nimport { useAuth } from '@/hooks/useAuth';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { AlertCircle, Building2 } from 'lucide-react';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\n\nexport function FarmSelector() {\n  const { user } = useAuth();\n  const { activeFarmId, setActiveFarmId, farms, isLoading, error } = useFarmContext();\n\n  // Only show for admin users\n  if (user?.role !== 'admin') {\n    return null;\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\" data-testid=\"farm-selector-loading\">\n        <Building2 className=\"h-4 w-4\" />\n        Loading farms...\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <Alert variant=\"destructive\" className=\"mb-4\" data-testid=\"farm-selector-error\">\n        <AlertCircle className=\"h-4 w-4\" />\n        <AlertDescription>{error}</AlertDescription>\n      </Alert>\n    );\n  }\n\n  return (\n    <div className=\"flex items-center gap-2\" data-testid=\"farm-selector\">\n      <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n      <Select value={activeFarmId || ''} onValueChange={setActiveFarmId} data-testid=\"farm-select\">\n        <SelectTrigger className=\"w-[200px]\">\n          <SelectValue placeholder=\"Select a farm to manage\" />\n        </SelectTrigger>\n        <SelectContent>\n          {farms.map((farm) => (\n            <SelectItem key={farm.id} value={farm.id} data-testid={`farm-option-${farm.id}`}>\n              {farm.name} - {farm.location}\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n    </div>\n  );\n}","size_bytes":1713},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { type User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n  };\n}\n","size_bytes":307},"server/utils/numbers.ts":{"content":"/**\n * Centralized numeric parsing and validation utilities\n * Returns proper number types for Zod validation\n */\n\nexport function roundTo(n: number, decimals = 2): number {\n  return Math.round((n + Number.EPSILON) * 10 ** decimals) / 10 ** decimals;\n}\n\nexport interface ParseOptions {\n  allowNegative?: boolean;\n  optional?: boolean;\n}\n\nexport interface DecimalParseOptions extends ParseOptions {\n  decimals?: number;\n}\n\nexport function parseDecimal(\n  input: unknown,\n  options: DecimalParseOptions = {}\n): number | undefined {\n  const { decimals = 2, allowNegative = false, optional = false } = options;\n\n  // Handle undefined/null\n  if (input === undefined || input === null) {\n    if (optional) return undefined;\n    throw new Error(\"Value is required\");\n  }\n\n  let n: number;\n\n  // Handle number input\n  if (typeof input === 'number') {\n    if (!isFinite(input)) {\n      throw new Error(\"Value must be a finite number\");\n    }\n    n = input;\n  }\n  // Handle string input\n  else if (typeof input === 'string') {\n    const trimmed = input.trim();\n    if (trimmed === '') {\n      if (optional) return undefined;\n      throw new Error(\"Value cannot be empty\");\n    }\n    n = Number(trimmed);\n    if (!isFinite(n)) {\n      throw new Error(`Invalid numeric value: ${input}`);\n    }\n  }\n  // Invalid input type\n  else {\n    throw new Error(`Invalid input type: ${typeof input}`);\n  }\n\n  // Check negative values\n  if (!allowNegative && n < 0) {\n    throw new Error(\"Value cannot be negative\");\n  }\n\n  return roundTo(n, decimals);\n}\n\nexport function parseIntStrict(\n  input: unknown,\n  options: ParseOptions & { allowZero?: boolean } = {}\n): number | undefined {\n  const { allowNegative = false, optional = false, allowZero = true } = options;\n\n  // Handle undefined/null\n  if (input === undefined || input === null) {\n    if (optional) return undefined;\n    throw new Error(\"Value is required\");\n  }\n\n  let n: number;\n\n  // Handle number input\n  if (typeof input === 'number') {\n    if (!isFinite(input)) {\n      throw new Error(\"Value must be a finite number\");\n    }\n    if (!Number.isInteger(input)) {\n      throw new Error(\"Value must be an integer\");\n    }\n    n = input;\n  }\n  // Handle string input\n  else if (typeof input === 'string') {\n    const trimmed = input.trim();\n    if (trimmed === '') {\n      if (optional) return undefined;\n      throw new Error(\"Value cannot be empty\");\n    }\n    n = Number(trimmed);\n    if (!isFinite(n)) {\n      throw new Error(`Invalid numeric value: ${input}`);\n    }\n    if (!Number.isInteger(n)) {\n      throw new Error(\"Value must be an integer\");\n    }\n  }\n  // Invalid input type\n  else {\n    throw new Error(`Invalid input type: ${typeof input}`);\n  }\n\n  // Check zero values\n  if (!allowZero && n === 0) {\n    throw new Error(\"Value cannot be zero\");\n  }\n\n  // Check negative values\n  if (!allowNegative && n < 0) {\n    throw new Error(\"Value cannot be negative\");\n  }\n\n  return n;\n}\n\nexport interface FieldConfig {\n  decimals?: Record<string, number>;\n  integers?: string[];\n  optional?: string[];\n  allowNegative?: string[];\n  returnStrings?: boolean; // New option to return strings instead of numbers\n}\n\nexport function normalizeNumericFields(\n  obj: Record<string, unknown>,\n  config: FieldConfig\n): Record<string, unknown> {\n  const { decimals = {}, integers = [], optional = [], allowNegative = [], returnStrings = false } = config;\n  const result = { ...obj };\n\n  // Process decimal fields\n  for (const [field, decimalPlaces] of Object.entries(decimals)) {\n    if (field in obj) {\n      try {\n        const numValue = parseDecimal(obj[field], {\n          decimals: decimalPlaces,\n          optional: optional.includes(field),\n          allowNegative: allowNegative.includes(field)\n        });\n        // Return as string if returnStrings is true, otherwise as number\n        result[field] = returnStrings && numValue !== undefined ? numValue.toFixed(decimalPlaces) : numValue;\n      } catch (error) {\n        throw new Error(`${field}: ${(error as Error).message}`);\n      }\n    }\n  }\n\n  // Process integer fields\n  for (const field of integers) {\n    if (field in obj) {\n      try {\n        const intValue = parseIntStrict(obj[field], {\n          optional: optional.includes(field),\n          allowNegative: allowNegative.includes(field),\n          allowZero: true\n        });\n        // Return as string if returnStrings is true, otherwise as number\n        result[field] = returnStrings && intValue !== undefined ? intValue.toString() : intValue;\n      } catch (error) {\n        throw new Error(`${field}: ${(error as Error).message}`);\n      }\n    }\n  }\n\n  return result;\n}","size_bytes":4634},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":791},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/lib/constants.ts":{"content":"/**\n * Shared constants for the application\n */\n\nexport const BREED_OPTIONS = [\n  { value: \"rhode-island-red\", label: \"Rhode Island Red\" },\n  { value: \"leghorn\", label: \"Leghorn\" },\n  { value: \"hy-line-brown\", label: \"Hy-Line Brown\" },\n  { value: \"sussex\", label: \"Sussex\" },\n  { value: \"plymouth-rock\", label: \"Plymouth Rock\" },\n  { value: \"new-hampshire\", label: \"New Hampshire\" },\n  { value: \"wyandotte\", label: \"Wyandotte\" },\n  { value: \"orpington\", label: \"Orpington\" },\n  { value: \"australorp\", label: \"Australorp\" },\n  { value: \"brahma\", label: \"Brahma\" },\n  { value: \"other\", label: \"Other\" },\n] as const;","size_bytes":613},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/pages/health-records.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Heart, Syringe, Calendar, AlertCircle, Plus, Menu, Activity } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { insertHealthRecordSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { Textarea } from \"@/components/ui/textarea\";\n\n// Health record form schema - use the actual database schema for consistency\nconst healthFormSchema = insertHealthRecordSchema.pick({\n  recordDate: true,\n  flockId: true, \n  recordType: true,\n  title: true,\n  description: true,\n  medicationUsed: true,\n  dosage: true,\n  administeredBy: true,\n  nextDueDate: true,\n  cost: true,\n  notes: true,\n}).extend({\n  // Override date fields to handle string inputs from HTML date inputs\n  recordDate: z.string().min(1, \"Record date is required\"),\n  nextDueDate: z.string().optional(),\n  // Override cost to handle string input like egg sale pattern\n  cost: z.string().optional().refine(\n    (val) => !val || val === \"\" || !isNaN(parseFloat(val)),\n    \"Invalid cost amount\"\n  ),\n});\n\ntype HealthFormData = z.infer<typeof healthFormSchema>;\n\nexport default function HealthRecords() {\n  const { toast } = useToast();\n  const { isLoading, isAuthenticated } = useAuth();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [healthDialogOpen, setHealthDialogOpen] = useState(false);\n  const queryClient = useQueryClient();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: healthRecords = [], error: recordsError } = useQuery<any[]>({\n    queryKey: [\"/api/health-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/health-records?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch health records');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: flocks = [], error: flocksError } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/flocks?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch flocks');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if ((recordsError && isUnauthorizedError(recordsError)) || (flocksError && isUnauthorizedError(flocksError))) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [recordsError, flocksError, toast]);\n\n  const healthForm = useForm<HealthFormData>({\n    resolver: zodResolver(healthFormSchema),\n    defaultValues: {\n      recordDate: new Date().toISOString().split('T')[0],\n      recordType: \"vaccination\",\n      title: \"\",\n      description: \"\",\n      medicationUsed: \"\",\n      dosage: \"\",\n      administeredBy: \"\",\n      nextDueDate: \"\",\n      cost: \"\",\n      notes: \"\",\n      flockId: \"\",\n    },\n  });\n\n  const createHealthMutation = useMutation({\n    mutationFn: async (data: HealthFormData) => {\n      // Keep cost as string like egg sale pattern\n      await apiRequest(\"POST\", \"/api/health-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/health-records\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\", activeFarmId] });\n      toast({\n        title: \"Success\",\n        description: \"Health record added successfully\",\n      });\n      healthForm.reset();\n      setHealthDialogOpen(false);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add health record\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading health records...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  const vaccinations = healthRecords.filter((record: any) => record.recordType === 'vaccination');\n  const medications = healthRecords.filter((record: any) => record.recordType === 'medication');\n  const treatments = healthRecords.filter((record: any) => record.recordType === 'treatment');\n  const checkups = healthRecords.filter((record: any) => record.recordType === 'checkup');\n\n  // Calculate upcoming vaccinations\n  const upcomingVaccinations = healthRecords.filter((record: any) => {\n    // Fix: database uses snake_case field name, not camelCase\n    if (!record.next_due_date) return false;\n    \n    // Normalize dates to remove time component for accurate comparison\n    const dueDate = new Date(record.next_due_date);\n    dueDate.setHours(0, 0, 0, 0);\n    \n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    const nextWeek = new Date(today);\n    nextWeek.setDate(nextWeek.getDate() + 7);\n    \n    return dueDate >= today && dueDate <= nextWeek;\n  });\n\n  const monthlyHealthCost = healthRecords.filter((record: any) => {\n    const recordDate = new Date(record.recordDate);\n    const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);\n    return recordDate >= monthStart;\n  }).reduce((sum: number, record: any) => sum + parseFloat(record.cost || '0'), 0);\n\n  const onSubmitHealth = (data: HealthFormData) => {\n    createHealthMutation.mutate(data);\n  };\n\n  const getRecordTypeIcon = (type: string) => {\n    switch (type) {\n      case 'vaccination': return Syringe;\n      case 'medication': return Heart;\n      case 'treatment': return Activity;\n      case 'checkup': return Heart;\n      default: return Heart;\n    }\n  };\n\n  const getRecordTypeBadge = (type: string) => {\n    switch (type) {\n      case 'vaccination': return { variant: \"default\" as const, color: \"text-primary\" };\n      case 'medication': return { variant: \"secondary\" as const, color: \"text-chart-2\" };\n      case 'treatment': return { variant: \"destructive\" as const, color: \"text-destructive\" };\n      case 'checkup': return { variant: \"outline\" as const, color: \"text-muted-foreground\" };\n      default: return { variant: \"default\" as const, color: \"text-foreground\" };\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Header */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Health Records</h2>\n                <p className=\"text-sm text-muted-foreground\">Track vaccinations, medications, and health checkups</p>\n              </div>\n            </div>\n            \n            <Dialog open={healthDialogOpen} onOpenChange={setHealthDialogOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-add-health-record\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Add Record\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Add Health Record</DialogTitle>\n                </DialogHeader>\n                <Form {...healthForm}>\n                  <form onSubmit={healthForm.handleSubmit(onSubmitHealth)} className=\"space-y-4\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={healthForm.control}\n                        name=\"recordDate\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Record Date</FormLabel>\n                            <FormControl>\n                              <Input type=\"date\" {...field} data-testid=\"input-record-date\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={healthForm.control}\n                        name=\"flockId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Flock</FormLabel>\n                            <Select onValueChange={field.onChange} defaultValue={field.value ?? \"\"}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-flock\">\n                                  <SelectValue placeholder=\"Select flock\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                {flocks?.map((flock: any) => (\n                                  <SelectItem key={flock.id} value={flock.id}>\n                                    {flock.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={healthForm.control}\n                      name=\"recordType\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Record Type</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-record-type\">\n                                <SelectValue placeholder=\"Select record type\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"vaccination\">Vaccination</SelectItem>\n                              <SelectItem value=\"medication\">Medication</SelectItem>\n                              <SelectItem value=\"treatment\">Treatment</SelectItem>\n                              <SelectItem value=\"checkup\">Health Checkup</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={healthForm.control}\n                      name=\"title\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Title</FormLabel>\n                          <FormControl>\n                            <Input {...field} placeholder=\"e.g., Newcastle Disease Vaccination\" data-testid=\"input-title\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={healthForm.control}\n                      name=\"description\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Description</FormLabel>\n                          <FormControl>\n                            <Textarea {...field} value={field.value ?? \"\"} rows={3} data-testid=\"textarea-description\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={healthForm.control}\n                        name=\"medicationUsed\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Medication/Vaccine</FormLabel>\n                            <Select onValueChange={field.onChange} defaultValue={field.value ?? \"\"}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-medication\">\n                                  <SelectValue placeholder=\"Select vaccine/medication\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent className=\"max-h-60 overflow-y-auto\">\n                                <SelectItem value=\"custom\">Custom/Other</SelectItem>\n                                \n                                {/* Day 1 Vaccines */}\n                                <SelectItem value=\"Marek's MD/IBD\">Marek's MD/IBD</SelectItem>\n                                <SelectItem value=\"Rismavac\">Rismavac</SelectItem>\n                                <SelectItem value=\"NCD+IB Live (Vitabron)\">NCD+IB Live (Vitabron)</SelectItem>\n                                \n                                {/* Day 12-14 Vaccines */}\n                                <SelectItem value=\"NCD+IB Live (Ceva BiJI)\">NCD+IB Live (Ceva BiJI)</SelectItem>\n                                \n                                {/* Day 16-18 Vaccines */}\n                                <SelectItem value=\"IBD Intermediate\">IBD Intermediate</SelectItem>\n                                \n                                {/* Week 6-8 Vaccines */}\n                                <SelectItem value=\"Salmonella E&T\">Salmonella E&T</SelectItem>\n                                <SelectItem value=\"Coryza (ABC) Killed\">Coryza (ABC) Killed</SelectItem>\n                                \n                                {/* Week 8-10 Vaccines */}\n                                <SelectItem value=\"Fowl pox\">Fowl pox</SelectItem>\n                                <SelectItem value=\"Fowl cholera\">Fowl cholera</SelectItem>\n                                \n                                {/* Week 12-14 Vaccines */}\n                                <SelectItem value=\"Salmonella E&T (killed)\">Salmonella E&T (killed)</SelectItem>\n                                <SelectItem value=\"Coryza (ABC) killed\">Coryza (ABC) killed</SelectItem>\n                                \n                                {/* Week 16-18 Vaccines */}\n                                <SelectItem value=\"NCD+IB (Killed)\">NCD+IB (Killed)</SelectItem>\n                                \n                                {/* Common Medications */}\n                                <SelectItem value=\"Antibiotics\">Antibiotics</SelectItem>\n                                <SelectItem value=\"Vitamins\">Vitamins</SelectItem>\n                                <SelectItem value=\"Dewormers\">Dewormers</SelectItem>\n                                <SelectItem value=\"Probiotics\">Probiotics</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={healthForm.control}\n                        name=\"dosage\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Dosage/Application Method</FormLabel>\n                            <Select onValueChange={field.onChange} defaultValue={field.value ?? \"\"}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-dosage\">\n                                  <SelectValue placeholder=\"Select application method\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"S/C injection\">S/C injection (Subcutaneous)</SelectItem>\n                                <SelectItem value=\"Intramuscular injection\">Intramuscular injection</SelectItem>\n                                <SelectItem value=\"Eye drop/Drinking water\">Eye drop/Drinking water</SelectItem>\n                                <SelectItem value=\"Drinking water\">Drinking water</SelectItem>\n                                <SelectItem value=\"Coarse spray\">Coarse spray</SelectItem>\n                                <SelectItem value=\"Wing stab\">Wing stab</SelectItem>\n                                <SelectItem value=\"Subcutaneous injection\">Subcutaneous injection</SelectItem>\n                                <SelectItem value=\"Oral\">Oral</SelectItem>\n                                <SelectItem value=\"Feed mixing\">Feed mixing</SelectItem>\n                                <SelectItem value=\"Topical\">Topical</SelectItem>\n                                <SelectItem value=\"Custom\">Custom/Other</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={healthForm.control}\n                      name=\"administeredBy\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Administered By</FormLabel>\n                          <FormControl>\n                            <Input {...field} value={field.value ?? \"\"} placeholder=\"Veterinarian or staff name\" data-testid=\"input-administered-by\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={healthForm.control}\n                        name=\"nextDueDate\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Next Due Date</FormLabel>\n                            <FormControl>\n                              <Input type=\"date\" {...field} data-testid=\"input-next-due-date\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={healthForm.control}\n                        name=\"cost\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Cost (KSh)</FormLabel>\n                            <FormControl>\n                              <Input \n                                type=\"text\" \n                                {...field} \n                                placeholder=\"0.00\"\n                                data-testid=\"input-cost\"\n                                onChange={(e) => {\n                                  // Keep as string like egg sale pattern\n                                  const value = e.target.value;\n                                  // Only allow digits and decimal point\n                                  if (value === \"\" || /^\\d*\\.?\\d*$/.test(value)) {\n                                    field.onChange(value);\n                                  }\n                                }}\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={healthForm.control}\n                      name=\"notes\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Additional Notes</FormLabel>\n                          <FormControl>\n                            <Textarea {...field} value={field.value ?? \"\"} rows={2} data-testid=\"textarea-notes\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full\" \n                      disabled={createHealthMutation.isPending}\n                      data-testid=\"button-submit-health-record\"\n                    >\n                      {createHealthMutation.isPending ? \"Adding...\" : \"Add Record\"}\n                    </Button>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          {/* Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n            <Card data-testid=\"card-total-records\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Total Records</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{healthRecords.length}</p>\n                    <p className=\"text-xs text-muted-foreground\">All time</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <Heart className=\"h-6 w-6 text-primary\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-vaccinations\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Vaccinations</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{vaccinations.length}</p>\n                    <p className=\"text-xs text-green-600\">Prevention care</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n                    <Syringe className=\"h-6 w-6 text-green-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-upcoming-due\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Due This Week</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{upcomingVaccinations.length}</p>\n                    <p className=\"text-xs text-orange-600\">Upcoming vaccines</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center\">\n                    <Calendar className=\"h-6 w-6 text-orange-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-monthly-cost\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Monthly Cost</p>\n                    <p className=\"text-2xl font-bold text-foreground\">KSh {monthlyHealthCost.toLocaleString()}</p>\n                    <p className=\"text-xs text-muted-foreground\">Health expenses</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <Activity className=\"h-6 w-6 text-chart-2\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Upcoming Vaccinations Alert */}\n          {upcomingVaccinations.length > 0 && (\n            <Card data-testid=\"card-upcoming-vaccinations\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <AlertCircle className=\"h-5 w-5 text-orange-600\" />\n                  <span>Upcoming Vaccinations</span>\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3\">\n                  {upcomingVaccinations.map((record: any) => (\n                    <div key={record.id} className=\"flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n                      <div>\n                        <p className=\"font-medium text-foreground\">{record.title}</p>\n                        <p className=\"text-sm text-muted-foreground\">Due: {new Date(record.nextDueDate).toLocaleDateString()}</p>\n                      </div>\n                      <Badge variant=\"secondary\">Due Soon</Badge>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* KENCHIC Vaccination Program */}\n          <Card data-testid=\"card-vaccination-program\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <Syringe className=\"h-5 w-5 text-blue-600\" />\n                <span>Standard Vaccination Program</span>\n              </CardTitle>\n              <p className=\"text-sm text-muted-foreground\">Schedule adapted from publicly available vaccination guidelines.</p>\n            </CardHeader>\n            <CardContent>\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full text-sm border-collapse\">\n                  <thead>\n                    <tr className=\"border-b border-border bg-muted/50\">\n                      <th className=\"text-left p-3 font-medium text-muted-foreground\">Age</th>\n                      <th className=\"text-left p-3 font-medium text-muted-foreground\">Vaccine</th>\n                      <th className=\"text-left p-3 font-medium text-muted-foreground\">Disease</th>\n                      <th className=\"text-left p-3 font-medium text-muted-foreground\">Application</th>\n                    </tr>\n                  </thead>\n                  <tbody className=\"divide-y divide-border\">\n                    <tr className=\"hover:bg-muted/50\">\n                      <td className=\"p-3 font-medium\">Day 1</td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>Marek's MD/IBD</div>\n                          <div>Rismavac</div>\n                          <div>NCD+IB Live (Vitabron)</div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>Marek's+NCD+IBD</div>\n                          <div>Marek's</div>\n                          <div>NCD+IB</div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <Badge variant=\"outline\" className=\"text-xs\">S/C injection</Badge>\n                          <Badge variant=\"outline\" className=\"text-xs\">S/C injection</Badge>\n                          <Badge variant=\"outline\" className=\"text-xs\">Coarse spray</Badge>\n                        </div>\n                      </td>\n                    </tr>\n                    <tr className=\"hover:bg-muted/50\">\n                      <td className=\"p-3 font-medium\">Day 12-14</td>\n                      <td className=\"p-3\">NCD+IB Live (Ceva BiJI)</td>\n                      <td className=\"p-3\">NCD+ IB</td>\n                      <td className=\"p-3\">\n                        <Badge variant=\"outline\" className=\"text-xs\">Eye drop/Drinking water</Badge>\n                      </td>\n                    </tr>\n                    <tr className=\"hover:bg-muted/50\">\n                      <td className=\"p-3 font-medium\">Day 16-18</td>\n                      <td className=\"p-3\">IBD Intermediate</td>\n                      <td className=\"p-3\">Gumboro</td>\n                      <td className=\"p-3\">\n                        <Badge variant=\"outline\" className=\"text-xs\">Drinking water</Badge>\n                      </td>\n                    </tr>\n                    <tr className=\"hover:bg-muted/50\">\n                      <td className=\"p-3 font-medium\">Week 6-8</td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>Salmonella E&T</div>\n                          <div>Coryza (ABC) Killed</div>\n                          <div>NCD+IB Live (Ceva BiJI)</div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>Salmonella E&T</div>\n                          <div>Coryza</div>\n                          <div>NCD + IB</div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <Badge variant=\"outline\" className=\"text-xs\">Intramuscular injection</Badge>\n                          <Badge variant=\"outline\" className=\"text-xs\">S/C injection</Badge>\n                          <Badge variant=\"outline\" className=\"text-xs\">Drinking water</Badge>\n                        </div>\n                      </td>\n                    </tr>\n                    <tr className=\"hover:bg-muted/50\">\n                      <td className=\"p-3 font-medium\">Week 8-10</td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>Fowl pox</div>\n                          <div>Fowl cholera <span className=\"text-xs text-muted-foreground\">(optional*)</span></div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>Pox</div>\n                          <div>Fowl cholera</div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <Badge variant=\"outline\" className=\"text-xs\">Wing stab</Badge>\n                          <Badge variant=\"outline\" className=\"text-xs\">S/C injection</Badge>\n                        </div>\n                      </td>\n                    </tr>\n                    <tr className=\"hover:bg-muted/50\">\n                      <td className=\"p-3 font-medium\">Week 12-14</td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>Salmonella E&T (killed)</div>\n                          <div>Coryza (ABC) killed</div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>Salmonella E&T</div>\n                          <div>Coryza</div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <Badge variant=\"outline\" className=\"text-xs\">Intramuscular injection</Badge>\n                          <Badge variant=\"outline\" className=\"text-xs\">S/C injection</Badge>\n                        </div>\n                      </td>\n                    </tr>\n                    <tr className=\"hover:bg-muted/50\">\n                      <td className=\"p-3 font-medium\">Week 16-18</td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>NCD+IB (Killed)</div>\n                          <div>Fowl cholera <span className=\"text-xs text-muted-foreground\">(optional*)</span></div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <div>NCD+IB</div>\n                          <div>Fowl cholera</div>\n                        </div>\n                      </td>\n                      <td className=\"p-3\">\n                        <div className=\"space-y-1\">\n                          <Badge variant=\"outline\" className=\"text-xs\">Intramuscular injection</Badge>\n                          <Badge variant=\"outline\" className=\"text-xs\">Subcutaneous injection</Badge>\n                        </div>\n                      </td>\n                    </tr>\n                  </tbody>\n                </table>\n                <div className=\"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n                  <p className=\"text-sm text-blue-800 dark:text-blue-200\">\n                    <strong>Note:</strong> *Optional vaccines depend on disease history. Introduced Coryza and ND+IB killed vaccinations. \n                    Please consult with your local veterinarian for any clarification.\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Tabs defaultValue=\"all-records\" className=\"space-y-4\">\n            <TabsList>\n              <TabsTrigger value=\"all-records\">All Records</TabsTrigger>\n              <TabsTrigger value=\"vaccinations\">Vaccinations</TabsTrigger>\n              <TabsTrigger value=\"medications\">Medications</TabsTrigger>\n              <TabsTrigger value=\"treatments\">Treatments</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"all-records\">\n              <Card data-testid=\"card-all-health-records\">\n                <CardHeader>\n                  <CardTitle>All Health Records</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {healthRecords.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <Heart className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No health records found</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Start tracking health activities</p>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Date</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Type</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Title</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Medication</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Next Due</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Cost</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {healthRecords.map((record: any) => {\n                            const TypeIcon = getRecordTypeIcon(record.recordType);\n                            const badgeStyle = getRecordTypeBadge(record.recordType);\n                            \n                            return (\n                              <tr key={record.id} className=\"border-b border-border/50\" data-testid={`row-health-record-${record.id}`}>\n                                <td className=\"p-2\">{new Date(record.recordDate).toLocaleDateString()}</td>\n                                <td className=\"p-2\">\n                                  <Badge variant={badgeStyle.variant} className=\"capitalize\">\n                                    {record.recordType}\n                                  </Badge>\n                                </td>\n                                <td className=\"p-2 font-medium\">{record.title}</td>\n                                <td className=\"p-2\">{record.medicationUsed || \"-\"}</td>\n                                <td className=\"p-2\">\n                                  {record.nextDueDate ? new Date(record.nextDueDate).toLocaleDateString() : \"-\"}\n                                </td>\n                                <td className=\"p-2\">\n                                  {record.cost ? `KSh ${parseFloat(record.cost).toLocaleString()}` : \"-\"}\n                                </td>\n                              </tr>\n                            );\n                          })}\n                        </tbody>\n                      </table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"vaccinations\">\n              <Card data-testid=\"card-vaccinations-only\">\n                <CardHeader>\n                  <CardTitle>Vaccination Records</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {vaccinations.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <Syringe className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No vaccination records found</p>\n                    </div>\n                  ) : (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      {vaccinations.map((record: any) => (\n                        <Card key={record.id} data-testid={`card-vaccination-${record.id}`}>\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex items-start justify-between mb-2\">\n                              <h3 className=\"font-semibold\">{record.title}</h3>\n                              <Badge variant=\"default\">Vaccination</Badge>\n                            </div>\n                            <div className=\"space-y-1 text-sm\">\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-muted-foreground\">Date:</span>\n                                <span>{new Date(record.recordDate).toLocaleDateString()}</span>\n                              </div>\n                              {record.medicationUsed && (\n                                <div className=\"flex justify-between\">\n                                  <span className=\"text-muted-foreground\">Vaccine:</span>\n                                  <span>{record.medicationUsed}</span>\n                                </div>\n                              )}\n                              {record.nextDueDate && (\n                                <div className=\"flex justify-between\">\n                                  <span className=\"text-muted-foreground\">Next Due:</span>\n                                  <span>{new Date(record.nextDueDate).toLocaleDateString()}</span>\n                                </div>\n                              )}\n                              {record.cost && (\n                                <div className=\"flex justify-between\">\n                                  <span className=\"text-muted-foreground\">Cost:</span>\n                                  <span>KSh {parseFloat(record.cost).toLocaleString()}</span>\n                                </div>\n                              )}\n                            </div>\n                          </CardContent>\n                        </Card>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"medications\">\n              <Card data-testid=\"card-medications-only\">\n                <CardHeader>\n                  <CardTitle>Medication Records</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {medications.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <Heart className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No medication records found</p>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {medications.map((record: any) => (\n                        <div key={record.id} className=\"p-4 border border-border rounded-lg\" data-testid={`medication-${record.id}`}>\n                          <div className=\"flex items-start justify-between mb-2\">\n                            <h3 className=\"font-semibold\">{record.title}</h3>\n                            <Badge variant=\"secondary\">Medication</Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mb-2\">{record.description}</p>\n                          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                            <div>\n                              <span className=\"text-muted-foreground\">Date: </span>\n                              <span>{new Date(record.recordDate).toLocaleDateString()}</span>\n                            </div>\n                            {record.medicationUsed && (\n                              <div>\n                                <span className=\"text-muted-foreground\">Medication: </span>\n                                <span>{record.medicationUsed}</span>\n                              </div>\n                            )}\n                            {record.dosage && (\n                              <div>\n                                <span className=\"text-muted-foreground\">Dosage: </span>\n                                <span>{record.dosage}</span>\n                              </div>\n                            )}\n                            {record.cost && (\n                              <div>\n                                <span className=\"text-muted-foreground\">Cost: </span>\n                                <span>KSh {parseFloat(record.cost).toLocaleString()}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"treatments\">\n              <Card data-testid=\"card-treatments-only\">\n                <CardHeader>\n                  <CardTitle>Treatment Records</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {treatments.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <Activity className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No treatment records found</p>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {treatments.map((record: any) => (\n                        <div key={record.id} className=\"p-4 border border-destructive/20 rounded-lg bg-destructive/5\" data-testid={`treatment-${record.id}`}>\n                          <div className=\"flex items-start justify-between mb-2\">\n                            <h3 className=\"font-semibold\">{record.title}</h3>\n                            <Badge variant=\"destructive\">Treatment</Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mb-2\">{record.description}</p>\n                          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                            <div>\n                              <span className=\"text-muted-foreground\">Date: </span>\n                              <span>{new Date(record.recordDate).toLocaleDateString()}</span>\n                            </div>\n                            {record.administeredBy && (\n                              <div>\n                                <span className=\"text-muted-foreground\">Administered by: </span>\n                                <span>{record.administeredBy}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":47964},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/lib/errorUtils.ts":{"content":"/**\n * Normalize different error types to a consistent string message\n * @param error - Error of unknown type\n * @returns Normalized error string\n */\nexport const normalizeError = (error: unknown): string => {\n  // Handle standard Error objects\n  if (error instanceof Error) {\n    return error.message;\n  }\n  \n  // Handle fetch Response errors\n  if (error && typeof error === 'object' && 'status' in error && 'statusText' in error) {\n    const response = error as Response;\n    return `${response.status}: ${response.statusText}`;\n  }\n  \n  // Handle Axios-like errors\n  if (error && typeof error === 'object' && 'response' in error) {\n    const axiosError = error as any;\n    if (axiosError.response?.data?.message) {\n      return axiosError.response.data.message;\n    }\n    if (axiosError.response?.statusText) {\n      return `${axiosError.response.status}: ${axiosError.response.statusText}`;\n    }\n    if (axiosError.message) {\n      return axiosError.message;\n    }\n  }\n  \n  // Handle string errors\n  if (typeof error === 'string') {\n    return error;\n  }\n  \n  // Handle objects with message property\n  if (error && typeof error === 'object' && 'message' in error) {\n    return String((error as any).message);\n  }\n  \n  // Fallback for unknown error types\n  return String(error) || 'An unknown error occurred';\n};","size_bytes":1316},"client/src/components/forms/simple-sales-form.tsx":{"content":"import SalesForm from \"./SalesForm\";\n\ninterface SimpleSalesFormProps {\n  onSuccess?: () => void;\n}\n\n// Thin wrapper around unified SalesForm for backwards compatibility\nexport default function SimpleSalesForm({ onSuccess }: SimpleSalesFormProps) {\n  return (\n    <SalesForm\n      mode=\"page\"\n      onSuccess={onSuccess}\n      customerNameRequired={true}\n      showNotes={true}\n    />\n  );\n}","size_bytes":390},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/pages/farm-setup.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { insertFarmSchema, type InsertFarm } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  Building2, Phone, Mail, MapPin, Award, Users, CheckCircle, ArrowRight, \n  Sprout, Target, BarChart3, ShoppingCart, Heart, Star\n} from \"lucide-react\";\nimport { z } from \"zod\";\n\n// Custom form schema to handle UI fields that need transformation\nconst farmSetupSchema = insertFarmSchema.extend({\n  city: z.string().min(1, \"City is required\"),\n  state: z.string().min(1, \"State is required\"),\n  postalCode: z.string().min(1, \"Postal code is required\"),\n  country: z.string().min(1, \"Country is required\"),\n  acceptTerms: z.boolean().refine(val => val === true, \"You must accept the terms\")\n}).omit({ location: true }); // We'll construct location from city and state\n\ntype FarmFormData = z.infer<typeof farmSetupSchema>;\n\nexport function FarmSetupPage() {\n  const [, setLocation] = useLocation();\n  const [isSuccess, setIsSuccess] = useState(false);\n  const [registeredFarmName, setRegisteredFarmName] = useState(\"\");\n  const [currentStep, setCurrentStep] = useState(1);\n  const { toast } = useToast();\n\n  const form = useForm<FarmFormData>({\n    resolver: zodResolver(farmSetupSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      contactEmail: \"\",\n      contactPhone: \"\",\n      address: \"\",\n      city: \"\",\n      state: \"\",\n      postalCode: \"\",\n      country: \"\",\n      specialization: \"layers\",\n      totalBirds: 0,\n      certifications: \"\",\n      website: \"\",\n      acceptTerms: false\n    }\n  });\n\n  const createFarmMutation = useMutation({\n    mutationFn: (farmData: InsertFarm) =>\n      apiRequest(\"POST\", \"/api/farms\", farmData),\n    onSuccess: (farm) => {\n      // SECURITY FIX: Invalidate both farms and user context to update farmId/role\n      queryClient.invalidateQueries({ queryKey: [\"/api/farms\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      \n      setRegisteredFarmName((farm as any)?.name || 'your farm');\n      setIsSuccess(true);\n      toast({\n        title: \"🎉 Welcome to KukuHub!\",\n        description: `Your farm setup is complete. Let's start managing your poultry operations!`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Setup failed\",\n        description: error.message || \"Failed to set up your farm. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: FarmFormData) => {\n    const { acceptTerms, city, state, postalCode, country, ...farmData } = data;\n    \n    // Construct location from city and state\n    const location = `${city}, ${state}`;\n    \n    // Construct full address\n    const fullAddress = `${data.address}, ${city}, ${state} ${postalCode}, ${country}`;\n    \n    const submitData: InsertFarm = {\n      ...farmData,\n      location,\n      address: fullAddress\n    };\n    \n    createFarmMutation.mutate(submitData);\n  };\n\n  // Success page\n  if (isSuccess) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-blue-50 dark:from-green-900/20 dark:via-emerald-900/20 dark:to-blue-900/20 p-4\">\n        <div className=\"max-w-3xl mx-auto\">\n          <Card className=\"shadow-2xl border-0 bg-white/90 dark:bg-black/90 backdrop-blur-sm\">\n            <CardContent className=\"text-center py-16 space-y-8\">\n              <div className=\"relative\">\n                <div className=\"w-24 h-24 mx-auto bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-4\">\n                  <CheckCircle className=\"h-12 w-12 text-green-600 dark:text-green-400\" />\n                </div>\n                <div className=\"absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-4\">\n                  <div className=\"flex space-x-1\">\n                    {[...Array(3)].map((_, i) => (\n                      <Star key={i} className=\"h-4 w-4 text-yellow-400 fill-current\" />\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <h1 className=\"text-3xl font-bold text-green-600 dark:text-green-400 mb-2\">\n                  🎉 Welcome to Your Farm Dashboard!\n                </h1>\n                <p className=\"text-xl text-gray-700 dark:text-gray-300 mb-4\">\n                  Congratulations! Your farm <span className=\"font-semibold\">\"{registeredFarmName}\"</span> is now set up and ready to go.\n                </p>\n                <p className=\"text-gray-600 dark:text-gray-400\">\n                  You're all set to start managing your poultry operations like a pro.\n                </p>\n              </div>\n              \n              <div className=\"bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-950/50 dark:to-green-950/50 p-6 rounded-xl\">\n                <h3 className=\"font-semibold text-lg mb-4 flex items-center justify-center\">\n                  <Target className=\"h-5 w-5 mr-2\" />\n                  Your Farm Management Toolkit Is Ready\n                </h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\">\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center\">\n                      <Sprout className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                    </div>\n                    <span>Track chick brooding & growth</span>\n                  </div>\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center\">\n                      <BarChart3 className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                    </div>\n                    <span>Monitor egg production & analytics</span>\n                  </div>\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"w-8 h-8 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center\">\n                      <ShoppingCart className=\"h-4 w-4 text-yellow-600 dark:text-yellow-400\" />\n                    </div>\n                    <span>Sell products in marketplace</span>\n                  </div>\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"w-8 h-8 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center\">\n                      <Heart className=\"h-4 w-4 text-purple-600 dark:text-purple-400\" />\n                    </div>\n                    <span>Connect with customers</span>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n                <Button \n                  size=\"lg\" \n                  className=\"bg-green-600 hover:bg-green-700 text-white\"\n                  onClick={() => window.location.href = \"/api/login\"}\n                  data-testid=\"button-login-farm\"\n                >\n                  <ArrowRight className=\"h-4 w-4 mr-2\" />\n                  Enter Your Farm Dashboard\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"lg\" \n                  onClick={() => setLocation(\"/marketplace\")}\n                  data-testid=\"button-browse-marketplace\"\n                >\n                  Browse Marketplace First\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-blue-50 dark:from-green-900/20 dark:via-emerald-900/20 dark:to-blue-900/20 p-4\">\n      <div className=\"max-w-5xl mx-auto\">\n        {/* Welcome Hero Section */}\n        <div className=\"text-center mb-12\">\n          <div className=\"flex items-center justify-center mb-6\">\n            <div className=\"w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mr-4\">\n              <Sprout className=\"h-8 w-8 text-white\" />\n            </div>\n            <div className=\"text-left\">\n              <h1 className=\"text-4xl md:text-5xl font-bold text-gray-900 dark:text-white\">\n                Welcome to KukuHub!\n              </h1>\n              <p className=\"text-xl text-gray-600 dark:text-gray-300 mt-2\">\n                Let's set up your farm and unlock powerful management tools\n              </p>\n            </div>\n          </div>\n\n          {/* Benefits Preview */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 max-w-4xl mx-auto\">\n            <div className=\"bg-white/80 dark:bg-black/80 backdrop-blur-sm p-4 rounded-lg border\">\n              <BarChart3 className=\"h-8 w-8 text-green-600 mx-auto mb-2\" />\n              <h3 className=\"font-semibold mb-1\">Smart Analytics</h3>\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                Track production, identify trends, optimize operations\n              </p>\n            </div>\n            <div className=\"bg-white/80 dark:bg-black/80 backdrop-blur-sm p-4 rounded-lg border\">\n              <ShoppingCart className=\"h-8 w-8 text-blue-600 mx-auto mb-2\" />\n              <h3 className=\"font-semibold mb-1\">Marketplace Ready</h3>\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                Sell directly to customers, manage orders seamlessly\n              </p>\n            </div>\n            <div className=\"bg-white/80 dark:bg-black/80 backdrop-blur-sm p-4 rounded-lg border\">\n              <Users className=\"h-8 w-8 text-purple-600 mx-auto mb-2\" />\n              <h3 className=\"font-semibold mb-1\">Team Management</h3>\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                Collaborate with staff, assign roles, track activities\n              </p>\n            </div>\n          </div>\n\n          {/* Progress Indicator */}\n          <div className=\"max-w-md mx-auto mb-8\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <span className=\"text-sm text-gray-600 dark:text-gray-400\">Farm Setup Progress</span>\n              <span className=\"text-sm text-gray-600 dark:text-gray-400\">Step 1 of 2</span>\n            </div>\n            <Progress value={50} className=\"h-2\" />\n            <p className=\"text-xs text-gray-500 dark:text-gray-500 mt-1\">\n              Just a few details and you'll be ready to manage your farm!\n            </p>\n          </div>\n        </div>\n\n        {/* Main Setup Form */}\n        <Card className=\"shadow-2xl border-0 bg-white/90 dark:bg-black/90 backdrop-blur-sm\">\n          <CardHeader className=\"text-center pb-6\">\n            <CardTitle className=\"flex items-center justify-center text-2xl\">\n              <Building2 className=\"h-6 w-6 mr-3\" />\n              Tell Us About Your Farm\n            </CardTitle>\n            <CardDescription className=\"text-lg\">\n              Help us customize your experience by sharing some details about your poultry operation\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-8\">\n                {/* Farm Identity Section */}\n                <div className=\"space-y-6\">\n                  <div className=\"flex items-center space-x-3 mb-4\">\n                    <div className=\"w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center\">\n                      <Building2 className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n                    </div>\n                    <div>\n                      <h3 className=\"text-lg font-semibold\">Your Farm Identity</h3>\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                        What should we call your farm and what makes it special?\n                      </p>\n                    </div>\n                  </div>\n                  \n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    <FormField\n                      control={form.control}\n                      name=\"name\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>What's your farm called? *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"e.g., Sunrise Poultry Farm\" \n                              data-testid=\"input-farm-name\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"specialization\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>What type of farm do you run? *</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value || \"\"}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-farm-type\">\n                                <SelectValue placeholder=\"Choose your farm's focus\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"layers\">Layer Farm (Focus on Egg Production)</SelectItem>\n                              <SelectItem value=\"broilers\">Broiler Farm (Focus on Meat Production)</SelectItem>\n                              <SelectItem value=\"mixed\">Mixed Farm (Both Eggs & Meat)</SelectItem>\n                              <SelectItem value=\"breeding\">Breeding Farm (Raising Chicks)</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    <FormField\n                      control={form.control}\n                      name=\"totalBirds\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>How many birds can your farm house?</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"number\" \n                              placeholder=\"e.g., 500\"\n                              data-testid=\"input-capacity\"\n                              {...field}\n                              value={field.value || 0}\n                              onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                            />\n                          </FormControl>\n                          <p className=\"text-xs text-gray-500 dark:text-gray-500\">\n                            This helps us scale our analytics to your operation size\n                          </p>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"website\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Farm website (if you have one)</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"url\" \n                              placeholder=\"https://www.yourfarm.com\"\n                              data-testid=\"input-website\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={form.control}\n                    name=\"description\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Tell customers about your farm</FormLabel>\n                        <FormControl>\n                          <Textarea \n                            placeholder=\"What makes your farm special? Share your story, farming practices, or what customers should know...\"\n                            data-testid=\"textarea-description\"\n                            className=\"min-h-[100px]\"\n                            {...field}\n                            value={field.value || \"\"}\n                          />\n                        </FormControl>\n                        <p className=\"text-xs text-gray-500 dark:text-gray-500\">\n                          This will appear on your marketplace profile to help customers connect with your brand\n                        </p>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {/* Contact Information Section */}\n                <div className=\"space-y-6\">\n                  <div className=\"flex items-center space-x-3 mb-4\">\n                    <div className=\"w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center\">\n                      <Phone className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                    </div>\n                    <div>\n                      <h3 className=\"text-lg font-semibold\">How Can Customers Reach You?</h3>\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                        We'll use this to connect you with potential customers\n                      </p>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    <FormField\n                      control={form.control}\n                      name=\"contactEmail\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Your business email *</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"email\" \n                              placeholder=\"contact@yourfarm.com\"\n                              data-testid=\"input-email\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"contactPhone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Phone number for customer contact *</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"tel\" \n                              placeholder=\"+254 712 345 678\"\n                              data-testid=\"input-phone\"\n                              {...field}\n                              value={field.value || \"\"}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Location Section */}\n                <div className=\"space-y-6\">\n                  <div className=\"flex items-center space-x-3 mb-4\">\n                    <div className=\"w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center\">\n                      <MapPin className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n                    </div>\n                    <div>\n                      <h3 className=\"text-lg font-semibold\">Where Is Your Farm Located?</h3>\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                        Help local customers find you and arrange deliveries\n                      </p>\n                    </div>\n                  </div>\n                  \n                  <FormField\n                    control={form.control}\n                    name=\"address\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Street address *</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Your farm's physical address\"\n                            data-testid=\"input-address\"\n                            {...field}\n                            value={field.value || \"\"}\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"city\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>City *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"e.g., Nairobi\"\n                              data-testid=\"input-city\"\n                              {...field} \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"state\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>County/State *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"e.g., Nairobi County\"\n                              data-testid=\"input-state\"\n                              {...field} \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"postalCode\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Postal Code *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"00100\"\n                              data-testid=\"input-postal-code\"\n                              {...field} \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"country\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Country *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"Kenya\"\n                              data-testid=\"input-country\"\n                              {...field} \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Certifications Section */}\n                <div className=\"space-y-6\">\n                  <div className=\"flex items-center space-x-3 mb-4\">\n                    <div className=\"w-10 h-10 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center\">\n                      <Award className=\"h-5 w-5 text-yellow-600 dark:text-yellow-400\" />\n                    </div>\n                    <div>\n                      <h3 className=\"text-lg font-semibold\">Quality Standards & Certifications</h3>\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                        Showcase your farm's quality standards (optional but recommended for customer trust)\n                      </p>\n                    </div>\n                  </div>\n                  \n                  <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\n                    {[\n                      \"Organic Certified\",\n                      \"Free Range\",\n                      \"Cage Free\",\n                      \"Pasture Raised\",\n                      \"Animal Welfare Approved\",\n                      \"Non-GMO Verified\",\n                      \"Humane Certified\",\n                      \"USDA Certified\",\n                      \"ISO 22000\",\n                      \"HACCP Certified\"\n                    ].map((cert) => (\n                      <FormField\n                        key={cert}\n                        control={form.control}\n                        name=\"certifications\"\n                        render={({ field }) => {\n                          const currentCerts = field.value ? field.value.split(', ').filter(Boolean) : [];\n                          const isChecked = currentCerts.includes(cert);\n                          \n                          return (\n                            <FormItem className=\"flex flex-row items-start space-x-3 space-y-0 bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg\">\n                              <FormControl>\n                                <Checkbox\n                                  data-testid={`checkbox-cert-${cert.toLowerCase().replace(/\\s+/g, '-')}`}\n                                  checked={isChecked}\n                                  onCheckedChange={(checked) => {\n                                    if (checked) {\n                                      const newCerts = [...currentCerts, cert];\n                                      field.onChange(newCerts.join(', '));\n                                    } else {\n                                      const newCerts = currentCerts.filter((item) => item !== cert);\n                                      field.onChange(newCerts.join(', '));\n                                    }\n                                  }}\n                                />\n                              </FormControl>\n                              <FormLabel className=\"text-sm font-normal\">\n                                {cert}\n                              </FormLabel>\n                            </FormItem>\n                          );\n                        }}\n                      />\n                    ))}\n                  </div>\n                </div>\n\n                {/* Terms and Conditions */}\n                <div className=\"space-y-4 border-t pt-6\">\n                  <FormField\n                    control={form.control}\n                    name=\"acceptTerms\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex flex-row items-start space-x-3 space-y-0 bg-blue-50 dark:bg-blue-950/50 p-4 rounded-lg\">\n                        <FormControl>\n                          <Checkbox\n                            data-testid=\"checkbox-accept-terms\"\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                          />\n                        </FormControl>\n                        <div className=\"space-y-1 leading-none\">\n                          <FormLabel className=\"text-sm font-normal\">\n                            I'm ready to join KukuHub and accept the Terms of Service and Privacy Policy *\n                          </FormLabel>\n                          <p className=\"text-xs text-gray-500 dark:text-gray-500\">\n                            By setting up your farm, you're agreeing to our marketplace terms and data handling practices\n                          </p>\n                        </div>\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"flex gap-4 pt-6\">\n                  <Button\n                    type=\"submit\"\n                    className=\"flex-1 bg-green-600 hover:bg-green-700 text-white text-lg py-6\"\n                    disabled={createFarmMutation.isPending}\n                    data-testid=\"button-register-farm\"\n                  >\n                    {createFarmMutation.isPending ? (\n                      <>Setting up your farm...</>\n                    ) : (\n                      <>\n                        <ArrowRight className=\"h-5 w-5 mr-2\" />\n                        Complete Farm Setup\n                      </>\n                    )}\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setLocation(\"/\")}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","size_bytes":30834},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/pages/marketplace-products.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Plus, Search, Edit, Package, DollarSign, Archive, Menu } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertProductSchema, type Product } from \"@shared/schema\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport { z } from \"zod\";\n\n// Product form schema - use the actual database schema for consistency\nconst productFormSchema = insertProductSchema.pick({\n  name: true,\n  category: true,\n  description: true,\n  unit: true,\n  currentPrice: true,\n  minOrderQuantity: true,\n  stockQuantity: true,\n  isAvailable: true,\n}).extend({\n  // Override price to handle string input like expense/health record pattern\n  currentPrice: z.string().min(1, \"Price is required\").refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\n    \"Invalid price - must be a positive number\"\n  ),\n});\n\ntype ProductFormData = z.infer<typeof productFormSchema>;\n\n\nexport default function MarketplaceProducts() {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [categoryFilter, setCategoryFilter] = useState(\"all\");\n  const [productDialogOpen, setProductDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [editingProduct, setEditingProduct] = useState<Product | null>(null);\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const { toast } = useToast();\n  const { user, isLoading, isAuthenticated } = useAuth();\n  const { activeFarmId } = useFarmContext();\n  const queryClient = useQueryClient();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: products = [], isLoading: productsLoading, error: productsError } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n    enabled: isAuthenticated,\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if (productsError && isUnauthorizedError(productsError)) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [productsError, toast]);\n\n  const productForm = useForm<ProductFormData>({\n    resolver: zodResolver(productFormSchema),\n    defaultValues: {\n      name: \"\",\n      category: \"eggs\",\n      description: \"\",\n      unit: \"crates\",\n      currentPrice: \"\",\n      minOrderQuantity: 1,\n      stockQuantity: 0,\n      isAvailable: true,\n    },\n  });\n\n  const createProductMutation = useMutation({\n    mutationFn: async (data: ProductFormData) => {\n      // Send data as-is - server will handle type coercion\n      await apiRequest(\"POST\", \"/api/products\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Success\",\n        description: \"Product created successfully\",\n      });\n      productForm.reset();\n      setProductDialogOpen(false);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create product\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmitProduct = (data: ProductFormData) => {\n    // Include farmId from context as required by the API\n    const productData = {\n      ...data,\n      farmId: activeFarmId,\n    };\n    createProductMutation.mutate(productData);\n  };\n\n  // Edit form\n  const editForm = useForm<ProductFormData>({\n    resolver: zodResolver(productFormSchema),\n    defaultValues: {\n      name: \"\",\n      category: \"eggs\",\n      description: \"\",\n      unit: \"crates\",\n      currentPrice: \"\",\n      minOrderQuantity: 1,\n      stockQuantity: 0,\n      isAvailable: true,\n    },\n  });\n\n  const updateProductMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: ProductFormData }) => {\n      await apiRequest(\"PATCH\", `/api/products/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Success\",\n        description: \"Product updated successfully\",\n      });\n      editForm.reset();\n      setEditDialogOpen(false);\n      setEditingProduct(null);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update product\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmitEdit = (data: ProductFormData) => {\n    if (editingProduct) {\n      // Include farmId from context as required by the API\n      const productData = {\n        ...data,\n        farmId: activeFarmId,\n      };\n      updateProductMutation.mutate({ id: editingProduct.id, data: productData });\n    }\n  };\n\n  const handleEditProduct = (product: Product) => {\n    setEditingProduct(product);\n    editForm.reset({\n      name: product.name,\n      category: product.category as any,\n      description: product.description || \"\",\n      unit: product.unit as any,\n      currentPrice: String(product.currentPrice),\n      minOrderQuantity: product.minOrderQuantity || 1,\n      stockQuantity: product.stockQuantity || 0,\n      isAvailable: product.isAvailable ?? true,\n    });\n    setEditDialogOpen(true);\n  };\n\n  const filteredProducts = products.filter((product: Product) => {\n    const matchesSearch = product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      (product.description && product.description.toLowerCase().includes(searchTerm.toLowerCase()));\n    const matchesCategory = categoryFilter === \"all\" || product.category === categoryFilter;\n    return matchesSearch && matchesCategory;\n  });\n\n\n  const getCategoryColor = (category: string) => {\n    switch (category) {\n      case \"eggs\": return \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300\";\n      case \"chickens\": return \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300\";\n      case \"feed\": return \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300\";\n      default: return \"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300\";\n    }\n  };\n\n  const getStockStatusColor = (stock: number) => {\n    if (stock === 0) return \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300\";\n    if (stock < 10) return \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300\";\n    return \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300\";\n  };\n\n  const categories = Array.from(new Set(products.map((p: Product) => p.category)));\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading products...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n          data-testid=\"mobile-overlay\"\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Top Navigation Bar */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Product Management</h2>\n                <p className=\"text-sm text-muted-foreground\">Manage your marketplace products</p>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Product Management</h1>\n            <p className=\"text-muted-foreground\">Manage your marketplace products and inventory</p>\n          </div>\n          \n          <Dialog open={productDialogOpen} onOpenChange={setProductDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-add-product\">\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Add Product\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Add Product</DialogTitle>\n              </DialogHeader>\n              <Form {...productForm}>\n                <form onSubmit={productForm.handleSubmit(onSubmitProduct)} className=\"space-y-4\">\n                  <FormField\n                    control={productForm.control}\n                    name=\"name\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Product Name</FormLabel>\n                        <FormControl>\n                          <Input {...field} data-testid=\"input-product-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={productForm.control}\n                      name=\"category\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Category</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value ?? \"\"}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-product-category\">\n                                <SelectValue placeholder=\"Select category\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"eggs\">Eggs</SelectItem>\n                              <SelectItem value=\"chickens\">Chickens</SelectItem>\n                              <SelectItem value=\"feed\">Feed</SelectItem>\n                              <SelectItem value=\"equipment\">Equipment</SelectItem>\n                              <SelectItem value=\"other\">Other</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={productForm.control}\n                      name=\"unit\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Unit</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value ?? \"\"}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-product-unit\">\n                                <SelectValue placeholder=\"Select unit\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"crates\">Crates</SelectItem>\n                              <SelectItem value=\"pieces\">Pieces</SelectItem>\n                              <SelectItem value=\"kg\">Kilograms</SelectItem>\n                              <SelectItem value=\"bags\">Bags</SelectItem>\n                              <SelectItem value=\"trays\">Trays</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={productForm.control}\n                    name=\"description\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Description</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value ?? \"\"} rows={2} data-testid=\"input-product-description\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={productForm.control}\n                      name=\"currentPrice\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Price (KES)</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"text\" placeholder=\"0.00\" data-testid=\"input-product-price\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={productForm.control}\n                      name=\"stockQuantity\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Stock Quantity</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"number\" min=\"0\" value={field.value ?? \"\"} onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : 0)} data-testid=\"input-product-stock\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={productForm.control}\n                      name=\"minOrderQuantity\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Min Order Qty</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"number\" min=\"1\" value={field.value ?? \"\"} onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : 1)} data-testid=\"input-product-min-order\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={productForm.control}\n                      name=\"isAvailable\"\n                      render={({ field }) => (\n                        <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-3\">\n                          <div className=\"space-y-0.5\">\n                            <FormLabel className=\"text-sm\">Available</FormLabel>\n                            <p className=\"text-xs text-muted-foreground\">\n                              Show in marketplace\n                            </p>\n                          </div>\n                          <FormControl>\n                            <Switch\n                              checked={field.value ?? true}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"switch-product-available\"\n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setProductDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={createProductMutation.isPending} data-testid=\"button-submit-product\">\n                      {createProductMutation.isPending ? \"Adding...\" : \"Add Product\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n\n          {/* Edit Product Dialog */}\n          <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n            <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Edit Product</DialogTitle>\n              </DialogHeader>\n              <Form {...editForm}>\n                <form onSubmit={editForm.handleSubmit(onSubmitEdit)} className=\"space-y-4\">\n                  <FormField\n                    control={editForm.control}\n                    name=\"name\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Product Name</FormLabel>\n                        <FormControl>\n                          <Input {...field} data-testid=\"input-edit-product-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editForm.control}\n                      name=\"category\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Category</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value ?? \"\"}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-edit-product-category\">\n                                <SelectValue placeholder=\"Select category\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"eggs\">Eggs</SelectItem>\n                              <SelectItem value=\"chickens\">Chickens</SelectItem>\n                              <SelectItem value=\"feed\">Feed</SelectItem>\n                              <SelectItem value=\"equipment\">Equipment</SelectItem>\n                              <SelectItem value=\"other\">Other</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={editForm.control}\n                      name=\"unit\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Unit</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value ?? \"\"}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-edit-product-unit\">\n                                <SelectValue placeholder=\"Select unit\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"crates\">Crates</SelectItem>\n                              <SelectItem value=\"pieces\">Pieces</SelectItem>\n                              <SelectItem value=\"kg\">Kilograms</SelectItem>\n                              <SelectItem value=\"bags\">Bags</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={editForm.control}\n                    name=\"description\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Description</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value || \"\"} rows={3} data-testid=\"input-edit-product-description\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editForm.control}\n                      name=\"currentPrice\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Price (KES)</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"text\" placeholder=\"0.00\" data-testid=\"input-edit-product-price\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={editForm.control}\n                      name=\"stockQuantity\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Stock Quantity</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"number\" min=\"0\" value={field.value ?? \"\"} onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : 0)} data-testid=\"input-edit-product-stock\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editForm.control}\n                      name=\"minOrderQuantity\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Min Order Qty</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"number\" min=\"1\" value={field.value ?? \"\"} onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : 1)} data-testid=\"input-edit-product-min-order\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={editForm.control}\n                      name=\"isAvailable\"\n                      render={({ field }) => (\n                        <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-3\">\n                          <div className=\"space-y-0.5\">\n                            <FormLabel className=\"text-sm\">Available</FormLabel>\n                            <p className=\"text-xs text-muted-foreground\">\n                              Show in marketplace\n                            </p>\n                          </div>\n                          <FormControl>\n                            <Switch\n                              checked={field.value ?? true}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"switch-edit-product-available\"\n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setEditDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={updateProductMutation.isPending} data-testid=\"button-update-product\">\n                      {updateProductMutation.isPending ? \"Updating...\" : \"Update Product\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        {/* Filters */}\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex flex-col sm:flex-row gap-4\">\n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search products by name or description...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-8\"\n                  data-testid=\"input-search-products\"\n                />\n              </div>\n              <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n                <SelectTrigger className=\"w-[180px]\" data-testid=\"select-filter-category\">\n                  <SelectValue placeholder=\"Filter by category\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Categories</SelectItem>\n                  {categories.map((category) => (\n                    <SelectItem key={category} value={category}>\n                      {category.charAt(0).toUpperCase() + category.slice(1)}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Product Grid */}\n        <div className=\"grid gap-4\">\n          {productsLoading ? (\n            <Card>\n              <CardContent className=\"flex items-center justify-center py-8\">\n                <p className=\"text-muted-foreground\">Loading products...</p>\n              </CardContent>\n            </Card>\n          ) : filteredProducts.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex items-center justify-center py-8\">\n                <div className=\"text-center\">\n                  <p className=\"text-muted-foreground mb-2\">\n                    {searchTerm || categoryFilter !== \"all\" ? \"No products found matching your criteria\" : \"No products yet\"}\n                  </p>\n                  {!searchTerm && categoryFilter === \"all\" && (\n                    <Button onClick={() => setProductDialogOpen(true)} data-testid=\"button-add-first-product\">\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      Add Your First Product\n                    </Button>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {filteredProducts.map((product: Product) => (\n                <Card key={product.id} data-testid={`card-product-${product.id}`}>\n                  <CardHeader className=\"pb-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle className=\"text-lg\">{product.name}</CardTitle>\n                      <Package className=\"h-5 w-5 text-muted-foreground\" />\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Badge className={getCategoryColor(product.category)}>\n                        {product.category}\n                      </Badge>\n                      {!product.isAvailable && (\n                        <Badge variant=\"secondary\">\n                          <Archive className=\"mr-1 h-3 w-3\" />\n                          Unavailable\n                        </Badge>\n                      )}\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {product.description && (\n                      <p className=\"text-sm text-muted-foreground mb-3\">{product.description}</p>\n                    )}\n                    \n                    <div className=\"grid grid-cols-2 gap-3 mb-4\">\n                      <div className=\"flex items-center space-x-2\">\n                        <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"text-sm font-medium\">KES {parseFloat(product.currentPrice).toLocaleString()}</span>\n                        <span className=\"text-xs text-muted-foreground\">per {product.unit}</span>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <span className=\"text-xs text-muted-foreground\">Min order:</span>\n                        <span className=\"text-sm\">{product.minOrderQuantity} {product.unit}</span>\n                      </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between mb-4\">\n                      <span className=\"text-sm text-muted-foreground\">Stock:</span>\n                      <Badge className={getStockStatusColor(product.stockQuantity || 0)}>\n                        {product.stockQuantity || 0} {product.unit}\n                      </Badge>\n                    </div>\n\n                    <div className=\"flex justify-end\">\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\" \n                        onClick={() => handleEditProduct(product)}\n                        data-testid={`button-edit-product-${product.id}`}\n                      >\n                        <Edit className=\"mr-2 h-4 w-4\" />\n                        Edit\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </div>\n        </div>\n      </main>\n    </div>\n  );\n}","size_bytes":32193},"client/src/components/dashboard/alert-panel.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { AlertTriangle, Skull, Syringe, TrendingDown, X } from \"lucide-react\";\nimport { useFarmAlerts } from \"@/hooks/useFarmAlerts\";\n\ninterface Alert {\n  id: string;\n  type: \"warning\" | \"danger\" | \"info\";\n  icon: \"triangle\" | \"skull\" | \"syringe\" | \"trending-down\";\n  title: string;\n  description: string;\n  priority: \"High\" | \"Medium\" | \"Low\";\n}\n\n\nconst iconMap = {\n  triangle: AlertTriangle,\n  skull: Skull,\n  syringe: Syringe,\n  \"trending-down\": TrendingDown,\n};\n\nconst typeMap = {\n  warning: {\n    bg: \"bg-orange-50 dark:bg-orange-900/20\",\n    border: \"border-orange-200 dark:border-orange-800\",\n    icon: \"text-orange-600 dark:text-orange-400\",\n    text: \"text-orange-600 dark:text-orange-400\",\n  },\n  danger: {\n    bg: \"bg-red-50 dark:bg-red-900/20\",\n    border: \"border-red-200 dark:border-red-800\",\n    icon: \"text-red-600 dark:text-red-400\",\n    text: \"text-red-600 dark:text-red-400\",\n  },\n  info: {\n    bg: \"bg-blue-50 dark:bg-blue-900/20\",\n    border: \"border-blue-200 dark:border-blue-800\",\n    icon: \"text-blue-600 dark:text-blue-400\",\n    text: \"text-blue-600 dark:text-blue-400\",\n  },\n};\n\nexport default function AlertPanel() {\n  const { alerts, isLoading } = useFarmAlerts();\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"card-alerts\">\n        <CardHeader>\n          <CardTitle>Farm Alerts</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-4\">\n            <div className=\"w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2\"></div>\n            <p className=\"text-sm text-muted-foreground\">Loading alerts...</p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card data-testid=\"card-alerts\">\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle>Farm Alerts</CardTitle>\n          <span className=\"text-sm text-muted-foreground\">{alerts.length} active</span>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {alerts.length === 0 ? (\n          <div className=\"text-center py-8\" data-testid=\"no-alerts-message\">\n            <div className=\"flex items-center justify-center mb-3\">\n              <div className=\"w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center\">\n                <svg className=\"w-6 h-6 text-green-600 dark:text-green-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n              </div>\n            </div>\n            <p className=\"text-sm font-medium text-foreground\">All Clear!</p>\n            <p className=\"text-xs text-muted-foreground mt-1\">No alerts at this time. Your farm operations are running smoothly.</p>\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {alerts.map((alert) => {\n              const Icon = iconMap[alert.icon];\n              const styles = typeMap[alert.type];\n\n              return (\n                <div\n                  key={alert.id}\n                  className={`flex items-start space-x-3 p-3 rounded-lg border ${styles.bg} ${styles.border}`}\n                  data-testid={`alert-${alert.id}`}\n                >\n                  <Icon className={`h-4 w-4 mt-0.5 ${styles.icon}`} />\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium text-foreground\">{alert.title}</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">{alert.description}</p>\n                    <p className={`text-xs mt-1 ${styles.text}`}>Priority: {alert.priority}</p>\n                  </div>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className={`p-1 ${styles.text} hover:${styles.text}`}\n                    data-testid={`button-dismiss-alert-${alert.id}`}\n                  >\n                    <X className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":4284},"client/src/pages/marketplace-orders.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Plus, Search, Eye, Truck, Clock, CheckCircle, XCircle, Filter, Menu, MapPin, User as UserIcon, Calendar as CalendarIcon, Package, AlertCircle } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogDescription } from \"@/components/ui/dialog\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertOrderSchema, insertDeliverySchema, type Order, type Customer, type Product, type Delivery, type User } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { z } from \"zod\";\nimport { format } from \"date-fns\";\n\n// COMPLETELY NEW ORDER FORM SCHEMAS\n// Create order schema with proper validation and defensive coercion\nconst createOrderSchema = z.object({\n  customerId: z.string().min(1, \"Customer is required\"),\n  requiredDate: z.string().min(1, \"Required date is required\"),\n  deliveryMethod: z.enum([\"pickup\", \"delivery\"], {\n    required_error: \"Delivery method is required\"\n  }),\n  deliveryAddress: z.string().optional(),\n  notes: z.string().optional(),\n  items: z.array(z.object({\n    productId: z.string().min(1, \"Product is required\"),\n    quantity: z.coerce.number().int().positive(\"Quantity must be a positive number\")\n  })).min(1, \"At least one item is required\"),\n});\n\n// Edit order schema - only fields that can be updated\nconst editOrderSchema = z.object({\n  status: z.enum([\"pending\", \"confirmed\", \"processing\", \"ready\", \"delivered\", \"cancelled\"], {\n    required_error: \"Status is required\"\n  }),\n  paymentStatus: z.enum([\"pending\", \"partial\", \"paid\", \"refunded\"], {\n    required_error: \"Payment status is required\"\n  }),\n  paidAmount: z.coerce.number().nonnegative(),\n  deliveryMethod: z.enum([\"pickup\", \"delivery\"]),\n  deliveryAddress: z.string().optional(),\n  notes: z.string().optional(),\n});\n\n// Delivery form schemas\nconst deliveryFormSchema = insertDeliverySchema.extend({\n  orderId: z.string().min(1, \"Order is required\"),\n  driverId: z.string().optional(),\n  scheduledDate: z.string().min(1, \"Scheduled date is required\"),\n});\n\nconst deliveryUpdateSchema = z.object({\n  status: z.enum([\"scheduled\", \"in_transit\", \"delivered\", \"failed\"]),\n  deliveryNotes: z.string().optional(),\n  recipientName: z.string().optional(),\n  recipientPhone: z.string().optional(),\n  actualDate: z.string().optional(),\n});\n\nexport default function MarketplaceOrders() {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  // Removed old state - using new consolidated state above\n  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);\n  // Removed - using new form-based item management\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [isDeliveryDialogOpen, setIsDeliveryDialogOpen] = useState(false);\n  const [isDeliveryUpdateDialogOpen, setIsDeliveryUpdateDialogOpen] = useState(false);\n  const [selectedDelivery, setSelectedDelivery] = useState<Delivery | null>(null);\n  const [isViewDetailDialogOpen, setIsViewDetailDialogOpen] = useState(false);\n  const [viewDetailOrder, setViewDetailOrder] = useState<Order | null>(null);\n  const { toast } = useToast();\n  const { user, isLoading, isAuthenticated } = useAuth();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: orders = [], isLoading: ordersLoading, error: ordersError } = useQuery<Order[]>({\n    queryKey: [\"/api/orders\"],\n    enabled: isAuthenticated,\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if (ordersError && isUnauthorizedError(ordersError)) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [ordersError, toast]);\n\n  const { data: customers = [] } = useQuery<Customer[]>({\n    queryKey: [\"/api/customers\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: products = [] } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n    enabled: isAuthenticated,\n  });\n\n  // Query for all deliveries\n  const { data: deliveries = [] } = useQuery<Delivery[]>({\n    queryKey: [\"/api/deliveries\"],\n    enabled: isAuthenticated,\n  });\n\n  // Query for users (for driver assignment)\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n    enabled: isAuthenticated && user?.role === 'admin',\n  });\n\n  // Dummy driver data for testing\n  const dummyDrivers = [\n    { id: \"driver-1\", firstName: \"John\", lastName: \"Doe\", role: \"staff\" },\n    { id: \"driver-2\", firstName: \"Jane\", lastName: \"Smith\", role: \"admin\" },\n    { id: \"driver-3\", firstName: \"Mike\", lastName: \"Johnson\", role: \"staff\" },\n    { id: \"driver-4\", firstName: \"Sarah\", lastName: \"Wilson\", role: \"staff\" },\n    { id: \"driver-5\", firstName: \"David\", lastName: \"Brown\", role: \"admin\" },\n  ];\n\n  // Combine real users with dummy drivers\n  const availableDrivers = [...users.filter((u: User) => u.role === 'admin' || u.role === 'staff'), ...dummyDrivers];\n\n  // NEW CREATE MUTATION WITH PROPER LOGGING\n  const createOrderMutation = useMutation({\n    mutationFn: (data: any) => {\n      console.log('Sending order data to API:', data);\n      return apiRequest(\"POST\", \"/api/orders\", data);\n    },\n    onSuccess: (response) => {\n      console.log('Order creation successful:', response);\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      setIsFormDialogOpen(false);\n      createForm.reset();\n      toast({\n        title: \"Success\",\n        description: \"Order created successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create order\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delivery mutations\n  const createDeliveryMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", \"/api/deliveries\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/deliveries\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      setIsDeliveryDialogOpen(false);\n      toast({\n        title: \"Success\",\n        description: \"Delivery scheduled successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to schedule delivery\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateDeliveryMutation = useMutation({\n    mutationFn: ({ id, ...data }: { id: string } & any) => \n      apiRequest(\"PATCH\", `/api/deliveries/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/deliveries\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      setIsDeliveryUpdateDialogOpen(false);\n      toast({\n        title: \"Success\",\n        description: \"Delivery updated successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update delivery\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // COMPLETELY NEW STATE MANAGEMENT\n  // Create/Edit mode state\n  const [mode, setMode] = useState<\"create\" | \"edit\">(\"create\");\n  const [editingOrder, setEditingOrder] = useState<Order | null>(null);\n  const [isFormDialogOpen, setIsFormDialogOpen] = useState(false);\n  \n\n  // Create form\n  const createForm = useForm<z.infer<typeof createOrderSchema>>({\n    resolver: zodResolver(createOrderSchema),\n    defaultValues: {\n      customerId: \"\",\n      requiredDate: \"\",\n      deliveryMethod: \"pickup\",\n      deliveryAddress: \"\",\n      notes: \"\",\n      items: [{ productId: \"\", quantity: 1 }],\n    },\n  });\n\n  // Edit form\n  const editForm = useForm<z.infer<typeof editOrderSchema>>({\n    resolver: zodResolver(editOrderSchema),\n    defaultValues: {\n      status: \"pending\",\n      paymentStatus: \"pending\",\n      paidAmount: 0,\n      deliveryMethod: \"pickup\",\n      deliveryAddress: \"\",\n      notes: \"\",\n    },\n  });\n\n  // Delivery forms\n  const deliveryForm = useForm<z.infer<typeof deliveryFormSchema>>({\n    resolver: zodResolver(deliveryFormSchema),\n    defaultValues: {\n      orderId: \"\",\n      driverId: \"\",\n      vehicleInfo: \"\",\n      scheduledDate: \"\",\n      deliveryNotes: \"\",\n      recipientName: \"\",\n      recipientPhone: \"\",\n    },\n  });\n\n  const deliveryUpdateForm = useForm<z.infer<typeof deliveryUpdateSchema>>({\n    resolver: zodResolver(deliveryUpdateSchema),\n    defaultValues: {\n      status: \"scheduled\",\n      deliveryNotes: \"\",\n      recipientName: \"\",\n      recipientPhone: \"\",\n      actualDate: \"\",\n    },\n  });\n\n  // Removed old duplicate editForm - using new one above\n\n  // NEW MUTATION WITH PROPER TYPE HANDLING\n  const updateOrderMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: z.infer<typeof editOrderSchema> }) => {\n      await apiRequest(\"PATCH\", `/api/orders/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      toast({\n        title: \"Success\",\n        description: \"Order updated successfully\",\n      });\n      editForm.reset();\n      setIsFormDialogOpen(false);\n      setEditingOrder(null);\n      setMode(\"create\");\n    },\n    onError: (error: any) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update order\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Removed old onSubmitEdit - using new onEditSubmit above\n\n  // NEW MODE HANDLERS\n  const handleCreateOrder = () => {\n    setMode(\"create\");\n    createForm.reset();\n    setIsFormDialogOpen(true);\n  };\n\n  const handleEditOrder = (order: Order) => {\n    setMode(\"edit\");\n    setEditingOrder(order);\n    editForm.reset({\n      status: order.status as any,\n      paymentStatus: order.paymentStatus as any,\n      paidAmount: Number(order.paidAmount) || 0,\n      deliveryMethod: order.deliveryMethod as any,\n      deliveryAddress: order.deliveryAddress || undefined,\n      notes: order.notes || undefined,\n    });\n    setIsFormDialogOpen(true);\n  };\n\n  const filteredOrders = orders.filter((order: Order) => {\n    const matchesSearch = order.orderNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      (order.notes && order.notes.toLowerCase().includes(searchTerm.toLowerCase()));\n    const matchesStatus = statusFilter === \"all\" || order.status === statusFilter;\n    return matchesSearch && matchesStatus;\n  });\n\n  // NEW SUBMISSION HANDLERS WITH DEFENSIVE COERCION\n  const onCreateSubmit = (data: z.infer<typeof createOrderSchema>) => {\n    // Defensive coercion and validation\n    const orderData = {\n      customerId: data.customerId,\n      requiredDate: data.requiredDate,\n      deliveryMethod: data.deliveryMethod,\n      deliveryAddress: data.deliveryAddress || undefined,\n      notes: data.notes || undefined,\n      items: data.items.map(item => ({\n        productId: item.productId,\n        quantity: item.quantity // Already transformed to number by schema\n      }))\n    };\n    \n    console.log('Creating order with data:', orderData);\n    createOrderMutation.mutate(orderData);\n  };\n\n  const onEditSubmit = (data: z.infer<typeof editOrderSchema>) => {\n    if (!editingOrder) return;\n    \n    // Defensive coercion for edit data\n    const updateData = {\n      status: data.status,\n      paymentStatus: data.paymentStatus,\n      paidAmount: data.paidAmount, // Already transformed by schema\n      deliveryMethod: data.deliveryMethod,\n      deliveryAddress: data.deliveryAddress || undefined,\n      notes: data.notes || undefined,\n    };\n    \n    console.log('Updating order with data:', updateData);\n    updateOrderMutation.mutate({ id: editingOrder.id, data: updateData });\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"pending\": return \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300\";\n      case \"confirmed\": return \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300\";\n      case \"processing\": return \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300\";\n      case \"ready\": return \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300\";\n      case \"delivered\": return \"bg-green-600 text-white\";\n      case \"cancelled\": return \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300\";\n      default: return \"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300\";\n    }\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case \"pending\": return <Clock className=\"h-4 w-4\" />;\n      case \"confirmed\": return <CheckCircle className=\"h-4 w-4\" />;\n      case \"processing\": return <Clock className=\"h-4 w-4\" />;\n      case \"ready\": return <CheckCircle className=\"h-4 w-4\" />;\n      case \"delivered\": return <Truck className=\"h-4 w-4\" />;\n      case \"cancelled\": return <XCircle className=\"h-4 w-4\" />;\n      default: return <Clock className=\"h-4 w-4\" />;\n    }\n  };\n\n  // Form-controlled order items management for create mode only\n  const watchedItems = createForm.watch(\"items\");\n\n  // NEW ITEM MANAGEMENT FOR CREATE FORM\n  const addOrderItem = () => {\n    const currentItems = createForm.getValues(\"items\");\n    createForm.setValue(\"items\", [...currentItems, { productId: \"\", quantity: 1 }]);\n  };\n\n  const removeOrderItem = (index: number) => {\n    const currentItems = createForm.getValues(\"items\");\n    if (currentItems.length > 1) {\n      createForm.setValue(\"items\", currentItems.filter((_: any, i: number) => i !== index));\n    }\n  };\n\n  const updateOrderItem = (index: number, field: string, value: any) => {\n    const currentItems = createForm.getValues(\"items\");\n    const updated = [...currentItems];\n    updated[index] = { ...updated[index], [field]: value };\n    createForm.setValue(\"items\", updated);\n  };\n\n  const getCustomerName = (customerId: string) => {\n    const customer = customers.find((c: Customer) => c.id === customerId);\n    return customer ? customer.name : \"Unknown\";\n  };\n\n  const getTotalAmount = (order: Order) => {\n    return parseFloat(order.totalAmount).toLocaleString();\n  };\n\n  // Delivery helper functions\n  const getDeliveryForOrder = (orderId: string) => {\n    return deliveries.find((d: Delivery) => d.orderId === orderId);\n  };\n\n  const getDeliveryStatusColor = (status: string) => {\n    switch (status) {\n      case \"scheduled\": return \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300\";\n      case \"in_transit\": return \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300\";\n      case \"delivered\": return \"bg-green-600 text-white\";\n      case \"failed\": return \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300\";\n      default: return \"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300\";\n    }\n  };\n\n  const getDeliveryStatusIcon = (status: string) => {\n    switch (status) {\n      case \"scheduled\": return <CalendarIcon className=\"h-4 w-4\" />;\n      case \"in_transit\": return <Truck className=\"h-4 w-4\" />;\n      case \"delivered\": return <CheckCircle className=\"h-4 w-4\" />;\n      case \"failed\": return <AlertCircle className=\"h-4 w-4\" />;\n      default: return <Package className=\"h-4 w-4\" />;\n    }\n  };\n\n  const getDriverName = (driverId: string | null) => {\n    if (!driverId) return \"Not assigned\";\n    const driver = users.find((u: User) => u.id === driverId);\n    return driver ? `${driver.firstName} ${driver.lastName}` : \"Unknown\";\n  };\n\n  // Form submission handlers\n  const onDeliverySubmit = (data: z.infer<typeof deliveryFormSchema>) => {\n    const deliveryData = {\n      ...data,\n      scheduledDate: new Date(data.scheduledDate).toISOString(),\n    };\n    createDeliveryMutation.mutate(deliveryData);\n  };\n\n  const onDeliveryUpdateSubmit = (data: z.infer<typeof deliveryUpdateSchema>) => {\n    if (!selectedDelivery) return;\n    const updateData = {\n      id: selectedDelivery.id,\n      ...data,\n      actualDate: data.actualDate ? new Date(data.actualDate).toISOString() : undefined,\n    };\n    updateDeliveryMutation.mutate(updateData);\n  };\n\n  const openDeliveryDialog = (order: Order) => {\n    deliveryForm.reset({\n      orderId: order.id,\n      driverId: \"\",\n      vehicleInfo: \"\",\n      scheduledDate: \"\",\n      deliveryNotes: \"\",\n      recipientName: \"\",\n      recipientPhone: \"\",\n    });\n    setSelectedOrder(order);\n    setIsDeliveryDialogOpen(true);\n  };\n\n  const openDeliveryUpdateDialog = (delivery: Delivery) => {\n    deliveryUpdateForm.reset({\n      status: delivery.status as \"scheduled\" | \"in_transit\" | \"delivered\" | \"failed\",\n      deliveryNotes: delivery.deliveryNotes || \"\",\n      recipientName: delivery.recipientName || \"\",\n      recipientPhone: delivery.recipientPhone || \"\",\n      actualDate: delivery.actualDate ? new Date(delivery.actualDate).toISOString().split('T')[0] : \"\",\n    });\n    setSelectedDelivery(delivery);\n    setIsDeliveryUpdateDialogOpen(true);\n  };\n\n  const openViewDetailDialog = (order: Order) => {\n    setViewDetailOrder(order);\n    setIsViewDetailDialogOpen(true);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading orders...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n          data-testid=\"mobile-overlay\"\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Top Navigation Bar */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Order Management</h2>\n                <p className=\"text-sm text-muted-foreground\">Manage customer orders and deliveries</p>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Order Management</h1>\n            <p className=\"text-muted-foreground\">Manage customer orders and deliveries</p>\n          </div>\n          \n          <Button onClick={handleCreateOrder} data-testid=\"button-create-order\">\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Create Order\n          </Button>\n        </div>  {/* Close the toolbar div from line 561 */}\n\n        {/* NEW UNIFIED CREATE/EDIT DIALOG */}\n        <Dialog open={isFormDialogOpen} onOpenChange={setIsFormDialogOpen}>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>\n                {mode === \"create\" ? \"Create New Order\" : \"Edit Order\"}\n              </DialogTitle>\n            </DialogHeader>\n            {mode === \"create\" ? (\n              <Form {...createForm}>\n                <form onSubmit={createForm.handleSubmit(onCreateSubmit, (errors) => {\n                  console.error('Create form validation errors:', errors);\n                  toast({\n                    title: \"Form Validation Error\",\n                    description: \"Please check all required fields\",\n                    variant: \"destructive\"\n                  });\n                })} className=\"space-y-6\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"customerId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Customer</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-order-customer\">\n                                <SelectValue placeholder=\"Select customer\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              {customers.map((customer: Customer) => (\n                                <SelectItem key={customer.id} value={customer.id}>\n                                  {customer.name} - {customer.phone}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={createForm.control}\n                      name=\"requiredDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Required Date</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"date\" data-testid=\"input-order-date\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={createForm.control}\n                      name=\"deliveryMethod\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Delivery Method</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-delivery-method\">\n                                <SelectValue />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"pickup\">Customer Pickup</SelectItem>\n                              <SelectItem value=\"delivery\">Home Delivery</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    {createForm.watch(\"deliveryMethod\") === \"delivery\" && (\n                      <FormField\n                        control={createForm.control}\n                        name=\"deliveryAddress\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Delivery Address</FormLabel>\n                            <FormControl>\n                              <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} data-testid=\"input-delivery-address\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    )}\n                  </div>\n\n                  {/* Order Items */}\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <h3 className=\"text-lg font-medium\">Order Items</h3>\n                      <Button type=\"button\" variant=\"outline\" onClick={addOrderItem} data-testid=\"button-add-item\">\n                        <Plus className=\"mr-2 h-4 w-4\" />\n                        Add Item\n                      </Button>\n                    </div>\n                    \n                    {watchedItems.map((item: any, index: number) => (\n                      <div key={index} className=\"flex items-end space-x-4 p-4 border rounded-lg\">\n                        <div className=\"flex-1\">\n                          <label className=\"text-sm font-medium\">Product</label>\n                          <Select\n                            value={item.productId}\n                            onValueChange={(value) => updateOrderItem(index, \"productId\", value)}\n                          >\n                            <SelectTrigger data-testid={`select-item-product-${index}`}>\n                              <SelectValue placeholder=\"Select product\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {products.filter((p: Product) => p.isAvailable).map((product: Product) => (\n                                <SelectItem key={product.id} value={product.id}>\n                                  {product.name} - KES {parseFloat(product.currentPrice).toLocaleString()} per {product.unit}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        \n                        <div className=\"w-24\">\n                          <label className=\"text-sm font-medium\">Quantity</label>\n                          <Input\n                            type=\"number\"\n                            min=\"1\"\n                            value={item.quantity}\n                            onChange={(e) => updateOrderItem(index, \"quantity\", parseInt(e.target.value) || 1)}\n                            data-testid={`input-item-quantity-${index}`}\n                          />\n                        </div>\n                        \n                        {watchedItems.length > 1 && (\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => removeOrderItem(index)}\n                            data-testid={`button-remove-item-${index}`}\n                          >\n                            Remove\n                          </Button>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n\n                  <FormField\n                    control={createForm.control}\n                    name=\"notes\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Notes (Optional)</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || undefined)} rows={2} data-testid=\"input-order-notes\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setIsFormDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={createOrderMutation.isPending} data-testid=\"button-save-order\">\n                      {createOrderMutation.isPending ? \"Creating...\" : \"Create Order\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            ) : (\n              // EDIT FORM\n              <Form {...editForm}>\n                <form onSubmit={editForm.handleSubmit(onEditSubmit)} className=\"space-y-6\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editForm.control}\n                      name=\"status\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Order Status</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-edit-order-status\">\n                                <SelectValue placeholder=\"Select status\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"pending\">Pending</SelectItem>\n                              <SelectItem value=\"confirmed\">Confirmed</SelectItem>\n                              <SelectItem value=\"processing\">Processing</SelectItem>\n                              <SelectItem value=\"ready\">Ready</SelectItem>\n                              <SelectItem value=\"delivered\">Delivered</SelectItem>\n                              <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={editForm.control}\n                      name=\"paymentStatus\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Payment Status</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-edit-payment-status\">\n                                <SelectValue placeholder=\"Select payment status\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"pending\">Pending</SelectItem>\n                              <SelectItem value=\"partial\">Partial</SelectItem>\n                              <SelectItem value=\"paid\">Paid</SelectItem>\n                              <SelectItem value=\"refunded\">Refunded</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={editForm.control}\n                    name=\"paidAmount\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Paid Amount (KES)</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"text\" placeholder=\"0.00\" data-testid=\"input-edit-paid-amount\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={editForm.control}\n                    name=\"deliveryMethod\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Delivery Method</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-edit-delivery-method\">\n                              <SelectValue placeholder=\"Select method\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"pickup\">Pickup</SelectItem>\n                            <SelectItem value=\"delivery\">Delivery</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  {editForm.watch(\"deliveryMethod\") === \"delivery\" && (\n                    <FormField\n                      control={editForm.control}\n                      name=\"deliveryAddress\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Delivery Address</FormLabel>\n                          <FormControl>\n                            <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || undefined)} rows={2} data-testid=\"input-edit-delivery-address\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  )}\n\n                  <FormField\n                    control={editForm.control}\n                    name=\"notes\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Notes (Optional)</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || undefined)} rows={3} data-testid=\"input-edit-order-notes\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setIsFormDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={updateOrderMutation.isPending} data-testid=\"button-update-order\">\n                      {updateOrderMutation.isPending ? \"Updating...\" : \"Update Order\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            )}\n          </DialogContent>\n        </Dialog>\n\n        {/* Filters */}\n\n        {/* Filters */}\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex flex-col sm:flex-row gap-4\">\n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search orders by order number or notes...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-8\"\n                  data-testid=\"input-search-orders\"\n                />\n              </div>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-[180px]\" data-testid=\"select-filter-status\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Statuses</SelectItem>\n                  <SelectItem value=\"pending\">Pending</SelectItem>\n                  <SelectItem value=\"confirmed\">Confirmed</SelectItem>\n                  <SelectItem value=\"processing\">Processing</SelectItem>\n                  <SelectItem value=\"ready\">Ready</SelectItem>\n                  <SelectItem value=\"delivered\">Delivered</SelectItem>\n                  <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Orders List */}\n        <div className=\"grid gap-4\">\n          {ordersLoading ? (\n            <Card>\n              <CardContent className=\"flex items-center justify-center py-8\">\n                <p className=\"text-muted-foreground\">Loading orders...</p>\n              </CardContent>\n            </Card>\n          ) : filteredOrders.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex items-center justify-center py-8\">\n                <div className=\"text-center\">\n                  <p className=\"text-muted-foreground mb-2\">\n                    {searchTerm || statusFilter !== \"all\" ? \"No orders found matching your criteria\" : \"No orders yet\"}\n                  </p>\n                  {!searchTerm && statusFilter === \"all\" && (\n                    <Button onClick={() => setIsFormDialogOpen(true)} data-testid=\"button-create-first-order\">\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      Create Your First Order\n                    </Button>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ) : (\n            filteredOrders.map((order: Order) => (\n              <Card key={order.id} data-testid={`card-order-${order.id}`}>\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"text-lg\">{order.orderNumber}</CardTitle>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Customer: {getCustomerName(order.customerId)}\n                      </p>\n                    </div>\n                    <Badge className={getStatusColor(order.status)}>\n                      <span className=\"flex items-center space-x-1\">\n                        {getStatusIcon(order.status)}\n                        <span>{order.status}</span>\n                      </span>\n                    </Badge>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4\">\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Order Date</p>\n                      <p className=\"text-sm font-medium\">\n                        {order.orderDate ? new Date(order.orderDate).toLocaleDateString() : '-'}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Required Date</p>\n                      <p className=\"text-sm font-medium\">\n                        {order.requiredDate ? new Date(order.requiredDate).toLocaleDateString() : \"-\"}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Delivery Method</p>\n                      <p className=\"text-sm font-medium capitalize\">{order.deliveryMethod}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Total Amount</p>\n                      <p className=\"text-sm font-medium\">KES {getTotalAmount(order)}</p>\n                    </div>\n                  </div>\n\n                  {order.deliveryAddress && (\n                    <div className=\"mb-4\">\n                      <p className=\"text-sm text-muted-foreground\">Delivery Address</p>\n                      <p className=\"text-sm\">{order.deliveryAddress}</p>\n                    </div>\n                  )}\n\n                  {order.notes && (\n                    <div className=\"mb-4\">\n                      <p className=\"text-sm text-muted-foreground\">Notes</p>\n                      <p className=\"text-sm\">{order.notes}</p>\n                    </div>\n                  )}\n\n                  {/* Delivery Tracking Section */}\n                  {order.deliveryMethod === \"delivery\" && (() => {\n                    const delivery = getDeliveryForOrder(order.id);\n                    return (\n                      <div className=\"mb-4 p-3 bg-muted/30 rounded-lg border\">\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <h4 className=\"text-sm font-medium flex items-center\">\n                            <Truck className=\"mr-2 h-4 w-4\" />\n                            Delivery Tracking\n                          </h4>\n                          {delivery && (\n                            <Badge className={getDeliveryStatusColor(delivery.status)}>\n                              <span className=\"flex items-center space-x-1\">\n                                {getDeliveryStatusIcon(delivery.status)}\n                                <span className=\"capitalize\">{delivery.status.replace('_', ' ')}</span>\n                              </span>\n                            </Badge>\n                          )}\n                        </div>\n                        \n                        {delivery ? (\n                          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm\">\n                            <div>\n                              <p className=\"text-muted-foreground\">Driver</p>\n                              <p className=\"font-medium flex items-center\">\n                                <UserIcon className=\"mr-1 h-3 w-3\" />\n                                {getDriverName(delivery.driverId)}\n                              </p>\n                            </div>\n                            <div>\n                              <p className=\"text-muted-foreground\">Scheduled Date</p>\n                              <p className=\"font-medium\">\n                                {delivery.scheduledDate ? new Date(delivery.scheduledDate).toLocaleDateString() : 'Not scheduled'}\n                              </p>\n                            </div>\n                            <div>\n                              <p className=\"text-muted-foreground\">Vehicle</p>\n                              <p className=\"font-medium\">{delivery.vehicleInfo || 'Not specified'}</p>\n                            </div>\n                            {delivery.actualDate && (\n                              <div>\n                                <p className=\"text-muted-foreground\">Delivered Date</p>\n                                <p className=\"font-medium text-green-600\">\n                                  {new Date(delivery.actualDate).toLocaleDateString()}\n                                </p>\n                              </div>\n                            )}\n                            {delivery.deliveryNotes && (\n                              <div className=\"md:col-span-2\">\n                                <p className=\"text-muted-foreground\">Delivery Notes</p>\n                                <p className=\"font-medium\">{delivery.deliveryNotes}</p>\n                              </div>\n                            )}\n                          </div>\n                        ) : (\n                          <p className=\"text-sm text-muted-foreground\">\n                            <MapPin className=\"inline mr-1 h-3 w-3\" />\n                            Delivery not scheduled yet\n                          </p>\n                        )}\n                      </div>\n                    );\n                  })()}\n\n                  <div className=\"flex justify-end space-x-2 flex-wrap gap-2\">\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      onClick={() => openViewDetailDialog(order)}\n                      data-testid={`button-view-order-${order.id}`}\n                    >\n                      <Eye className=\"mr-2 h-4 w-4\" />\n                      View Details\n                    </Button>\n                    \n                    {/* Delivery Management Buttons */}\n                    {order.deliveryMethod === \"delivery\" && (() => {\n                      const delivery = getDeliveryForOrder(order.id);\n                      return delivery ? (\n                        <Button \n                          variant=\"outline\" \n                          size=\"sm\" \n                          onClick={() => openDeliveryUpdateDialog(delivery)}\n                          data-testid={`button-update-delivery-${order.id}`}\n                        >\n                          <Truck className=\"mr-2 h-4 w-4\" />\n                          Update Delivery\n                        </Button>\n                      ) : (\n                        order.status !== \"cancelled\" && (\n                          <Button \n                            variant=\"outline\" \n                            size=\"sm\" \n                            onClick={() => openDeliveryDialog(order)}\n                            data-testid={`button-schedule-delivery-${order.id}`}\n                          >\n                            <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                            Schedule Delivery\n                          </Button>\n                        )\n                      );\n                    })()}\n                    \n                    {order.status !== \"delivered\" && order.status !== \"cancelled\" && (\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\" \n                        onClick={() => handleEditOrder(order)}\n                        data-testid={`button-update-order-${order.id}`}\n                      >\n                        Update Status\n                      </Button>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            ))\n          )}\n        </div>\n\n        {/* Delivery Management Dialogs */}\n        \n        {/* Schedule Delivery Dialog */}\n        <Dialog open={isDeliveryDialogOpen} onOpenChange={setIsDeliveryDialogOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Schedule Delivery</DialogTitle>\n              <DialogDescription className=\"sr-only\">Form actions</DialogDescription>\n            </DialogHeader>\n            <Form {...deliveryForm}>\n              <form onSubmit={deliveryForm.handleSubmit(onDeliverySubmit)} className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={deliveryForm.control}\n                    name=\"driverId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Driver (Optional)</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-driver\">\n                              <SelectValue placeholder=\"Select driver\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"unassigned\">No driver assigned</SelectItem>\n                            {availableDrivers.map((driver) => (\n                              <SelectItem key={driver.id} value={driver.id}>\n                                {driver.firstName} {driver.lastName}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={deliveryForm.control}\n                    name=\"scheduledDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Scheduled Date</FormLabel>\n                        <FormControl>\n                          <Input type=\"date\" {...field} data-testid=\"input-scheduled-date\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={deliveryForm.control}\n                  name=\"vehicleInfo\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Vehicle Information (Optional)</FormLabel>\n                      <FormControl>\n                        <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} placeholder=\"e.g., Truck KCA 123A\" data-testid=\"input-vehicle-info\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={deliveryForm.control}\n                    name=\"recipientName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Recipient Name (Optional)</FormLabel>\n                        <FormControl>\n                          <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} data-testid=\"input-recipient-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={deliveryForm.control}\n                    name=\"recipientPhone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Recipient Phone (Optional)</FormLabel>\n                        <FormControl>\n                          <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} placeholder=\"e.g., +254...\" data-testid=\"input-recipient-phone\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={deliveryForm.control}\n                  name=\"deliveryNotes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Delivery Notes (Optional)</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} rows={2} placeholder=\"Special instructions...\" data-testid=\"input-delivery-notes\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex justify-end space-x-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setIsDeliveryDialogOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={createDeliveryMutation.isPending} data-testid=\"button-save-delivery\">\n                    {createDeliveryMutation.isPending ? \"Scheduling...\" : \"Schedule Delivery\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n\n        {/* Update Delivery Status Dialog */}\n        <Dialog open={isDeliveryUpdateDialogOpen} onOpenChange={setIsDeliveryUpdateDialogOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Update Delivery Status</DialogTitle>\n            </DialogHeader>\n            <Form {...deliveryUpdateForm}>\n              <form onSubmit={deliveryUpdateForm.handleSubmit(onDeliveryUpdateSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={deliveryUpdateForm.control}\n                  name=\"status\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Delivery Status</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-delivery-status\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"scheduled\">Scheduled</SelectItem>\n                          <SelectItem value=\"in_transit\">In Transit</SelectItem>\n                          <SelectItem value=\"delivered\">Delivered</SelectItem>\n                          <SelectItem value=\"failed\">Failed</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {deliveryUpdateForm.watch(\"status\") === \"delivered\" && (\n                  <FormField\n                    control={deliveryUpdateForm.control}\n                    name=\"actualDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Delivery Date</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"datetime-local\" data-testid=\"input-actual-date\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                )}\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={deliveryUpdateForm.control}\n                    name=\"recipientName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Recipient Name</FormLabel>\n                        <FormControl>\n                          <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} data-testid=\"input-update-recipient-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={deliveryUpdateForm.control}\n                    name=\"recipientPhone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Recipient Phone</FormLabel>\n                        <FormControl>\n                          <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} data-testid=\"input-update-recipient-phone\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={deliveryUpdateForm.control}\n                  name=\"deliveryNotes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Delivery Notes</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} rows={3} placeholder=\"Update notes, delivery status, issues...\" data-testid=\"input-update-delivery-notes\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"flex justify-end space-x-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setIsDeliveryUpdateDialogOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={updateDeliveryMutation.isPending} data-testid=\"button-update-delivery\">\n                    {updateDeliveryMutation.isPending ? \"Updating...\" : \"Update Delivery\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n\n        {/* View Order Details Dialog */}\n        <Dialog open={isViewDetailDialogOpen} onOpenChange={setIsViewDetailDialogOpen}>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Order Details</DialogTitle>\n              <DialogDescription className=\"sr-only\">View complete order information</DialogDescription>\n            </DialogHeader>\n            \n            {viewDetailOrder && (\n              <div className=\"space-y-6\">\n                {/* Basic Order Information */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Order ID</p>\n                    <p className=\"font-mono text-sm\">{viewDetailOrder.id}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Status</p>\n                    <Badge className={getStatusColor(viewDetailOrder.status)}>\n                      {viewDetailOrder.status}\n                    </Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Customer</p>\n                    <p className=\"font-medium\">{getCustomerName(viewDetailOrder.customerId)}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Order Date</p>\n                    <p className=\"font-medium\">{viewDetailOrder.createdAt ? new Date(viewDetailOrder.createdAt).toLocaleDateString() : 'Not available'}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Required Date</p>\n                    <p className=\"font-medium\">{viewDetailOrder.requiredDate ? new Date(viewDetailOrder.requiredDate).toLocaleDateString() : 'Not specified'}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Total Amount</p>\n                    <p className=\"font-medium text-lg\">KSh {getTotalAmount(viewDetailOrder)}</p>\n                  </div>\n                </div>\n\n                {/* Payment Information */}\n                <div>\n                  <h3 className=\"font-semibold mb-2\">Payment Information</h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Payment Status</p>\n                      <Badge className={viewDetailOrder.paymentStatus === 'paid' ? 'bg-green-600 text-white' : 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300'}>\n                        {viewDetailOrder.paymentStatus}\n                      </Badge>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Paid Amount</p>\n                      <p className=\"font-medium\">KSh {viewDetailOrder.paidAmount ? parseFloat(viewDetailOrder.paidAmount).toLocaleString() : '0'}</p>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Order Items */}\n                <div>\n                  <h3 className=\"font-semibold mb-2\">Order Items</h3>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between items-center p-2 bg-muted rounded\">\n                      <div>\n                        <p className=\"font-medium\">Order Items</p>\n                        <p className=\"text-sm text-muted-foreground\">Total Amount: KSh {getTotalAmount(viewDetailOrder)}</p>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">Details available in order management</p>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Delivery Information */}\n                {viewDetailOrder.deliveryMethod === \"delivery\" && (\n                  <div>\n                    <h3 className=\"font-semibold mb-2\">Delivery Information</h3>\n                    <div className=\"space-y-2\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Delivery Address</p>\n                        <p className=\"font-medium\">{viewDetailOrder.deliveryAddress || 'Not specified'}</p>\n                      </div>\n                      {(() => {\n                        const delivery = getDeliveryForOrder(viewDetailOrder.id);\n                        return delivery ? (\n                          <div className=\"space-y-2\">\n                            <div>\n                              <p className=\"text-sm text-muted-foreground\">Delivery Status</p>\n                              <Badge className={getDeliveryStatusColor(delivery.status)}>\n                                {getDeliveryStatusIcon(delivery.status)}\n                                <span className=\"ml-1\">{delivery.status}</span>\n                              </Badge>\n                            </div>\n                            <div>\n                              <p className=\"text-sm text-muted-foreground\">Scheduled Date</p>\n                              <p className=\"font-medium\">{delivery.scheduledDate ? new Date(delivery.scheduledDate).toLocaleDateString() : 'Not scheduled'}</p>\n                            </div>\n                            <div>\n                              <p className=\"text-sm text-muted-foreground\">Driver</p>\n                              <p className=\"font-medium\">{getDriverName(delivery.driverId)}</p>\n                            </div>\n                            {delivery.actualDate && (\n                              <div>\n                                <p className=\"text-sm text-muted-foreground\">Delivered Date</p>\n                                <p className=\"font-medium text-green-600\">{new Date(delivery.actualDate).toLocaleDateString()}</p>\n                              </div>\n                            )}\n                            {delivery.deliveryNotes && (\n                              <div>\n                                <p className=\"text-sm text-muted-foreground\">Delivery Notes</p>\n                                <p className=\"font-medium\">{delivery.deliveryNotes}</p>\n                              </div>\n                            )}\n                          </div>\n                        ) : (\n                          <p className=\"text-sm text-muted-foreground\">Delivery not yet scheduled</p>\n                        );\n                      })()}\n                    </div>\n                  </div>\n                )}\n\n                {/* Order Notes */}\n                {viewDetailOrder.notes && (\n                  <div>\n                    <h3 className=\"font-semibold mb-2\">Order Notes</h3>\n                    <p className=\"text-sm bg-muted p-3 rounded\">{viewDetailOrder.notes}</p>\n                  </div>\n                )}\n              </div>\n            )}\n            \n            <div className=\"flex justify-end\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setIsViewDetailDialogOpen(false)}>\n                Close\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Old duplicate order dialog removed - using unified create/edit dialog above */}\n\n        </div>  {/* Close the content div from line 560 */}\n      </main>\n    </div>\n  );\n}","size_bytes":65216},"client/src/pages/reports.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { BarChart3, TrendingUp, Download, Calendar, Menu, FileText, PieChart, Calculator, DollarSign, AlertCircle, ArrowRight, ShoppingCart, DollarSign as CostsIcon, Package } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Link } from \"wouter\";\nimport {\n  LineChart,\n  Line,\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  ReferenceLine,\n} from \"recharts\";\n\n// Break-even metrics type\ninterface BreakEvenMetrics {\n  hasData: boolean;\n  autoCalculated?: boolean;\n  message?: string;\n  suggestedActions?: Array<{ label: string; route: string }>;\n  dataSource?: {\n    monthsAnalyzed: number;\n    salesRecords: number;\n    expenseRecords: number;\n    dateRange: { startDate: string; endDate: string };\n  };\n  derivedValues?: {\n    price: number;\n    unitVariableCost: number;\n    fixedCostsPerMonth: number;\n    initialUnits: number;\n    growthRate: number;\n    seasonalityFactors: number[];\n  };\n  dataQuality?: {\n    hasSufficientData: boolean;\n    monthsWithSales: number;\n    monthsWithExpenses: number;\n    totalSales: number;\n    totalExpenses: number;\n    warnings: string[];\n  };\n  contributionMargin?: number;\n  contributionMarginRatio?: number;\n  breakEvenUnits?: number;\n  breakEvenRevenue?: number;\n  breakEvenMonth?: number | null;\n  breakEvenDate?: string | null;\n  monthlyProjections?: Array<{\n    month: number;\n    units: number;\n    revenue: number;\n    variableCosts: number;\n    fixedCosts: number;\n    totalCosts: number;\n    profit: number;\n    cumulativeProfit: number;\n  }>;\n}\n\nexport default function Reports() {\n  const { toast } = useToast();\n  const { isLoading, isAuthenticated } = useAuth();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [selectedPeriod, setSelectedPeriod] = useState(\"30\");\n  const [rollingWindow, setRollingWindow] = useState<3 | 6 | 12>(6);\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: dailyRecords, error: recordsError } = useQuery({\n    queryKey: [\"/api/daily-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/daily-records?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch daily records');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: sales, error: salesError } = useQuery({\n    queryKey: [\"/api/sales\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/sales?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch sales');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: expenses, error: expensesError } = useQuery({\n    queryKey: [\"/api/expenses\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/expenses?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch expenses');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: feedInventory, error: feedError } = useQuery({\n    queryKey: [\"/api/feed-inventory\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/feed-inventory?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch feed inventory');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Break-even analysis data\n  const { data: breakEvenMetrics, isLoading: breakEvenLoading } = useQuery<BreakEvenMetrics>({\n    queryKey: [\"/api/breakeven/metrics\", rollingWindow, activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/breakeven/metrics?months=${rollingWindow}&farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch break-even metrics');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n    refetchOnWindowFocus: true,\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    const errors = [recordsError, salesError, expensesError, feedError];\n    if (errors.some(error => error && isUnauthorizedError(error))) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [recordsError, salesError, expensesError, feedError, toast]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading reports...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  // Calculate report data\n  const periodDays = parseInt(selectedPeriod);\n  const periodStart = new Date();\n  periodStart.setDate(periodStart.getDate() - periodDays);\n\n  const periodRecords = (dailyRecords || []).filter((record: any) => \n    new Date(record.recordDate) >= periodStart\n  );\n\n  const periodSales = (sales || []).filter((sale: any) => \n    new Date(sale.saleDate) >= periodStart\n  );\n\n  const periodExpenses = (expenses || []).filter((expense: any) => \n    new Date(expense.expenseDate) >= periodStart\n  );\n\n  // Production metrics\n  const totalEggs = periodRecords.reduce((sum: number, record: any) => \n    sum + (record.eggsCollected || 0), 0);\n  const totalMortality = periodRecords.reduce((sum: number, record: any) => \n    sum + (record.mortalityCount || 0), 0);\n  const totalFeedConsumed = periodRecords.reduce((sum: number, record: any) => \n    sum + parseFloat(record.feedConsumed || '0'), 0);\n\n  // Financial metrics\n  const totalRevenue = periodSales.reduce((sum: number, sale: any) => \n    sum + parseFloat(sale.totalAmount || '0'), 0);\n  const totalExpenseAmount = periodExpenses.reduce((sum: number, expense: any) => \n    sum + parseFloat(expense.amount || '0'), 0);\n  const netProfit = totalRevenue - totalExpenseAmount;\n\n  // Efficiency metrics\n  const averageEggsPerDay = periodRecords.length > 0 ? totalEggs / periodRecords.length : 0;\n  const feedEfficiency = totalEggs > 0 ? (totalEggs / totalFeedConsumed) * 1000 : 0; // eggs per kg of feed * 1000\n  const mortalityRate = periodRecords.length > 0 ? (totalMortality / (periodRecords.length * 5300)) * 100 : 0;\n\n  // Expense breakdown\n  const expenseCategories = (expenses || []).reduce((acc: any, expense: any) => {\n    const category = expense.category || 'other';\n    acc[category] = (acc[category] || 0) + parseFloat(expense.amount || '0');\n    return acc;\n  }, {});\n\n  const handleExportReport = (reportType: string) => {\n    toast({\n      title: \"Export Started\",\n      description: `${reportType} report export will begin shortly`,\n    });\n  };\n\n  // Break-even utility functions\n  const formatCurrency = (value: number | undefined | null) => {\n    // Guard against undefined, null, NaN, and Infinity\n    if (value == null || !isFinite(value)) {\n      return \"N/A\";\n    }\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0,\n    }).format(value);\n  };\n\n  const downloadBreakEvenCSV = () => {\n    if (!breakEvenMetrics?.monthlyProjections) return;\n\n    const headers = [\n      \"Month\", \"Units\", \"Revenue\", \"Variable Costs\", \"Fixed Costs\", \n      \"Total Costs\", \"Profit\", \"Cumulative Profit\"\n    ];\n    const rows = breakEvenMetrics.monthlyProjections.map(m => [\n      m.month,\n      m.units,\n      m.revenue,\n      m.variableCosts,\n      m.fixedCosts,\n      m.totalCosts,\n      m.profit,\n      m.cumulativeProfit,\n    ]);\n\n    const summaryRows = [\n      [\"\"],\n      [\"AUTO-CALCULATED METRICS\"],\n      [\"Data Source\", `${breakEvenMetrics.dataSource?.monthsAnalyzed || 0} months of historical data`],\n      [\"Sales Records\", breakEvenMetrics.dataSource?.salesRecords || 0],\n      [\"Expense Records\", breakEvenMetrics.dataSource?.expenseRecords || 0],\n      [\"\"],\n    ];\n\n    if (breakEvenMetrics.derivedValues) {\n      summaryRows.push(\n        [\"DERIVED VALUES\"],\n        [\"Average Price/Crate\", `${formatCurrency(breakEvenMetrics.derivedValues.price)}`],\n        [\"Avg Variable Cost/Crate\", `${formatCurrency(breakEvenMetrics.derivedValues.unitVariableCost)}`],\n        [\"Avg Fixed Costs/Month\", `${formatCurrency(breakEvenMetrics.derivedValues.fixedCostsPerMonth)}`],\n        [\"Initial Monthly Units\", breakEvenMetrics.derivedValues.initialUnits.toString()],\n        [\"Growth Rate (CAGR)\", `${(breakEvenMetrics.derivedValues.growthRate ?? 0).toFixed(2)}%`]\n      );\n    }\n\n    const csvContent = [\n      ...summaryRows.map(row => row.join(\",\")),\n      [\"\"],\n      headers.join(\",\"),\n      ...rows.map(row => row.join(\",\")),\n    ].join(\"\\n\");\n\n    const blob = new Blob([csvContent], { type: \"text/csv\" });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement(\"a\");\n    link.href = url;\n    link.download = `break-even-analysis-${new Date().toISOString().split('T')[0]}.csv`;\n    link.click();\n    URL.revokeObjectURL(url);\n\n    toast({\n      title: \"Export Successful\",\n      description: \"CSV file downloaded successfully\",\n    });\n  };\n\n  const downloadBreakEvenPDF = () => {\n    window.print();\n    toast({\n      title: \"Print Dialog\",\n      description: \"Use Print > Save as PDF to export\",\n    });\n  };\n\n  // Prepare daily production chart data (last 30 days)\n  const dailyProductionData = (dailyRecords || [])\n    .filter((record: any) => new Date(record.recordDate) >= periodStart)\n    .sort((a: any, b: any) => new Date(a.recordDate).getTime() - new Date(b.recordDate).getTime())\n    .map((record: any) => ({\n      date: new Date(record.recordDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),\n      eggs: record.eggsCollected || 0,\n      crates: record.cratesProduced || 0,\n    }));\n\n  // Prepare monthly trends data (last 12 months)\n  const monthlyData: { [key: string]: { eggs: number; revenue: number; expenses: number; count: number } } = {};\n  \n  // Helper to get stable month key (yyyy-mm format)\n  const getMonthKey = (dateString: string): string => {\n    const date = new Date(dateString);\n    const year = date.getFullYear();\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    return `${year}-${month}`;\n  };\n\n  // Helper to format month for display\n  const formatMonthDisplay = (monthKey: string): string => {\n    const [year, month] = monthKey.split('-');\n    const date = new Date(parseInt(year), parseInt(month) - 1, 1);\n    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });\n  };\n  \n  // Process daily records for monthly aggregation\n  (dailyRecords || []).forEach((record: any) => {\n    const monthKey = getMonthKey(record.recordDate);\n    if (!monthlyData[monthKey]) {\n      monthlyData[monthKey] = { eggs: 0, revenue: 0, expenses: 0, count: 0 };\n    }\n    monthlyData[monthKey].eggs += record.eggsCollected || 0;\n    monthlyData[monthKey].count += 1;\n  });\n\n  // Process sales for monthly revenue\n  (sales || []).forEach((sale: any) => {\n    const monthKey = getMonthKey(sale.saleDate);\n    if (!monthlyData[monthKey]) {\n      monthlyData[monthKey] = { eggs: 0, revenue: 0, expenses: 0, count: 0 };\n    }\n    monthlyData[monthKey].revenue += parseFloat(sale.totalAmount || '0');\n  });\n\n  // Process expenses for monthly costs\n  (expenses || []).forEach((expense: any) => {\n    const monthKey = getMonthKey(expense.expenseDate);\n    if (!monthlyData[monthKey]) {\n      monthlyData[monthKey] = { eggs: 0, revenue: 0, expenses: 0, count: 0 };\n    }\n    monthlyData[monthKey].expenses += parseFloat(expense.amount || '0');\n  });\n\n  // Convert to array and sort by date (last 12 months)\n  const monthlyTrendsData = Object.entries(monthlyData)\n    .map(([monthKey, data]) => ({\n      monthKey,\n      month: formatMonthDisplay(monthKey),\n      eggs: data.eggs,\n      revenue: data.revenue,\n      expenses: data.expenses,\n      profit: data.revenue - data.expenses,\n    }))\n    .sort((a, b) => a.monthKey.localeCompare(b.monthKey))\n    .slice(-12); // Last 12 months\n\n  // Calculate revenue forecast (next 3 months based on average)\n  const avgMonthlyRevenue = monthlyTrendsData.length > 0 \n    ? monthlyTrendsData.reduce((sum, m) => sum + m.revenue, 0) / monthlyTrendsData.length \n    : 0;\n  const avgMonthlyExpenses = monthlyTrendsData.length > 0\n    ? monthlyTrendsData.reduce((sum, m) => sum + m.expenses, 0) / monthlyTrendsData.length\n    : 0;\n  \n  // Guard against division by zero and missing data\n  let growthRate = 0.02; // Default 2% growth\n  if (monthlyTrendsData.length > 3) {\n    const firstRevenue = monthlyTrendsData[0].revenue;\n    const lastRevenue = monthlyTrendsData[monthlyTrendsData.length - 1].revenue;\n    if (firstRevenue > 0 && lastRevenue > firstRevenue) {\n      growthRate = ((lastRevenue - firstRevenue) / firstRevenue) / monthlyTrendsData.length;\n    }\n  }\n\n  const forecastData = [];\n  for (let i = 1; i <= 3; i++) {\n    const forecastMonth = new Date();\n    forecastMonth.setMonth(forecastMonth.getMonth() + i);\n    const year = forecastMonth.getFullYear();\n    const month = String(forecastMonth.getMonth() + 1).padStart(2, '0');\n    const monthKey = `${year}-${month}`;\n    \n    const forecastRevenue = avgMonthlyRevenue * (1 + growthRate * i);\n    const forecastExpenses = avgMonthlyExpenses * (1 + growthRate * i * 0.7); // Expenses grow slower\n    forecastData.push({\n      monthKey,\n      month: formatMonthDisplay(monthKey),\n      eggs: 0, // Not forecasting production\n      revenue: forecastRevenue,\n      expenses: forecastExpenses,\n      profit: forecastRevenue - forecastExpenses,\n      isForecast: true,\n    });\n  }\n\n  // Combine historical and forecast data\n  const trendsWithForecast = [\n    ...monthlyTrendsData.map(d => ({ ...d, isForecast: false })),\n    ...forecastData,\n  ];\n\n  // Calculate trend insights\n  let productionChange = 0;\n  if (monthlyTrendsData.length > 1) {\n    const firstEggs = monthlyTrendsData[0].eggs;\n    const lastEggs = monthlyTrendsData[monthlyTrendsData.length - 1].eggs;\n    // Guard against division by zero - if first month has no eggs, use second month or skip calculation\n    if (firstEggs > 0) {\n      productionChange = ((lastEggs - firstEggs) / firstEggs) * 100;\n    } else if (monthlyTrendsData.length > 2 && monthlyTrendsData[1].eggs > 0) {\n      // Use second month as baseline if first has no production\n      productionChange = ((lastEggs - monthlyTrendsData[1].eggs) / monthlyTrendsData[1].eggs) * 100;\n    }\n  }\n  \n  const avgProfit = monthlyTrendsData.length > 0\n    ? monthlyTrendsData.reduce((sum, m) => sum + m.profit, 0) / monthlyTrendsData.length\n    : 0;\n  const isProfitable = avgProfit > 0;\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Header */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Reports & Analytics</h2>\n                <p className=\"text-sm text-muted-foreground\">Comprehensive farm performance analysis</p>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center space-x-2\">\n              <Select value={selectedPeriod} onValueChange={setSelectedPeriod}>\n                <SelectTrigger className=\"w-32\" data-testid=\"select-period\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"7\">Last 7 days</SelectItem>\n                  <SelectItem value=\"30\">Last 30 days</SelectItem>\n                  <SelectItem value=\"90\">Last 3 months</SelectItem>\n                  <SelectItem value=\"365\">Last year</SelectItem>\n                </SelectContent>\n              </Select>\n              \n              <Button variant=\"outline\" size=\"sm\" data-testid=\"button-export\">\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export\n              </Button>\n            </div>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          {/* Key Metrics */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n            <Card data-testid=\"card-total-eggs\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Total Eggs</p>\n                    <p className=\"text-2xl font-bold text-foreground\">{totalEggs.toLocaleString()}</p>\n                    <p className=\"text-xs text-green-600\">↗ {averageEggsPerDay.toFixed(0)}/day avg</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-chart-3/10 rounded-lg flex items-center justify-center\">\n                    <BarChart3 className=\"h-6 w-6 text-chart-3\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-total-revenue\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Total Revenue</p>\n                    <p className=\"text-2xl font-bold text-foreground\">KSh {totalRevenue.toLocaleString()}</p>\n                    <p className=\"text-xs text-green-600\">Sales income</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n                    <TrendingUp className=\"h-6 w-6 text-green-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-total-expenses\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Total Expenses</p>\n                    <p className=\"text-2xl font-bold text-foreground\">KSh {totalExpenseAmount.toLocaleString()}</p>\n                    <p className=\"text-xs text-orange-600\">Operating costs</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center\">\n                    <FileText className=\"h-6 w-6 text-orange-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-net-profit\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Net Profit</p>\n                    <p className={`text-2xl font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                      KSh {netProfit.toLocaleString()}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Revenue - Expenses</p>\n                  </div>\n                  <div className={`w-12 h-12 ${netProfit >= 0 ? 'bg-green-100' : 'bg-red-100'} rounded-lg flex items-center justify-center`}>\n                    <PieChart className={`h-6 w-6 ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}`} />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs defaultValue=\"production\" className=\"space-y-4\">\n            <TabsList>\n              <TabsTrigger value=\"production\">Production Report</TabsTrigger>\n              <TabsTrigger value=\"financial\">Financial Report</TabsTrigger>\n              <TabsTrigger value=\"efficiency\">Efficiency Analysis</TabsTrigger>\n              <TabsTrigger value=\"trends\">Trends & Forecasts</TabsTrigger>\n              <TabsTrigger value=\"breakeven\">Break-Even Analysis</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"production\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card data-testid=\"card-production-summary\">\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle>Production Summary</CardTitle>\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        onClick={() => handleExportReport(\"Production\")}\n                        data-testid=\"button-export-production\"\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        Export\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Total Eggs Produced</span>\n                        <span className=\"font-medium\">{totalEggs.toLocaleString()}</span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Average Daily Production</span>\n                        <span className=\"font-medium\">{averageEggsPerDay.toFixed(0)}</span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Total Mortality</span>\n                        <span className=\"font-medium text-red-600\">{totalMortality}</span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Mortality Rate</span>\n                        <span className={`font-medium ${mortalityRate > 1 ? 'text-red-600' : 'text-green-600'}`}>\n                          {mortalityRate.toFixed(2)}%\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Feed Consumed</span>\n                        <span className=\"font-medium\">{totalFeedConsumed.toLocaleString()} kg</span>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-production-trends\">\n                  <CardHeader>\n                    <CardTitle>Production Trends</CardTitle>\n                    <CardDescription>Daily egg production over selected period</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {dailyProductionData.length > 0 ? (\n                      <ResponsiveContainer width=\"100%\" height={320}>\n                        <LineChart data={dailyProductionData}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis \n                            dataKey=\"date\" \n                            tick={{ fontSize: 12 }}\n                            interval=\"preserveStartEnd\"\n                          />\n                          <YAxis tick={{ fontSize: 12 }} />\n                          <Tooltip />\n                          <Legend />\n                          <Line \n                            type=\"monotone\" \n                            dataKey=\"eggs\" \n                            stroke=\"#8884d8\" \n                            strokeWidth={2}\n                            name=\"Eggs Collected\"\n                            dot={false}\n                          />\n                          <Line \n                            type=\"monotone\" \n                            dataKey=\"crates\" \n                            stroke=\"#82ca9d\" \n                            strokeWidth={2}\n                            name=\"Crates Produced\"\n                            dot={false}\n                          />\n                        </LineChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"h-80 bg-muted/20 rounded-lg flex items-center justify-center\">\n                        <div className=\"text-center\">\n                          <BarChart3 className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                          <p className=\"text-sm text-muted-foreground\">No production data available</p>\n                          <p className=\"text-xs text-muted-foreground mt-2\">Add daily records to see trends</p>\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"financial\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card data-testid=\"card-financial-summary\">\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle>Financial Summary</CardTitle>\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        onClick={() => handleExportReport(\"Financial\")}\n                        data-testid=\"button-export-financial\"\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        Export\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"flex justify-between items-center p-3 bg-green-50 dark:bg-green-900/20 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Total Revenue</span>\n                        <span className=\"font-medium text-green-600\">KSh {totalRevenue.toLocaleString()}</span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/20 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Total Expenses</span>\n                        <span className=\"font-medium text-red-600\">KSh {totalExpenseAmount.toLocaleString()}</span>\n                      </div>\n                      <div className={`flex justify-between items-center p-3 ${netProfit >= 0 ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'} rounded`}>\n                        <span className=\"text-sm text-muted-foreground\">Net Profit/Loss</span>\n                        <span className={`font-medium ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                          KSh {netProfit.toLocaleString()}\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between items-center p-3 bg-muted/50 rounded\">\n                        <span className=\"text-sm text-muted-foreground\">Profit Margin</span>\n                        <span className=\"font-medium\">\n                          {totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0}%\n                        </span>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-expense-breakdown\">\n                  <CardHeader>\n                    <CardTitle>Expense Breakdown</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-3\">\n                      {Object.entries(expenseCategories).map(([category, amount]) => {\n                        const percentage = totalExpenseAmount > 0 ? ((amount as number) / totalExpenseAmount * 100) : 0;\n                        return (\n                          <div key={category}>\n                            <div className=\"flex justify-between items-center mb-2\">\n                              <span className=\"text-sm capitalize\">{category}</span>\n                              <span className=\"text-sm font-medium\">KSh {(amount as number).toLocaleString()}</span>\n                            </div>\n                            <Progress value={percentage} className=\"h-2\" />\n                            <p className=\"text-xs text-muted-foreground mt-1\">{percentage.toFixed(1)}%</p>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"efficiency\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card data-testid=\"card-efficiency-metrics\">\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle>Efficiency Metrics</CardTitle>\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        onClick={() => handleExportReport(\"Efficiency\")}\n                        data-testid=\"button-export-efficiency\"\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        Export\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div>\n                        <div className=\"flex justify-between items-center mb-2\">\n                          <span className=\"text-sm text-muted-foreground\">Feed Conversion Efficiency</span>\n                          <span className=\"font-medium\">{feedEfficiency.toFixed(1)} eggs/1000kg</span>\n                        </div>\n                        <Progress value={Math.min((feedEfficiency / 2000) * 100, 100)} className=\"h-2\" />\n                        <p className=\"text-xs text-muted-foreground mt-1\">Target: 2000+ eggs per 1000kg feed</p>\n                      </div>\n\n                      <div>\n                        <div className=\"flex justify-between items-center mb-2\">\n                          <span className=\"text-sm text-muted-foreground\">Laying Rate</span>\n                          <span className=\"font-medium\">89.2%</span>\n                        </div>\n                        <Progress value={89.2} className=\"h-2\" />\n                        <p className=\"text-xs text-muted-foreground mt-1\">Target: 90%+</p>\n                      </div>\n\n                      <div>\n                        <div className=\"flex justify-between items-center mb-2\">\n                          <span className=\"text-sm text-muted-foreground\">Mortality Rate</span>\n                          <span className=\"font-medium\">{mortalityRate.toFixed(2)}%</span>\n                        </div>\n                        <Progress value={mortalityRate * 10} className=\"h-2\" />\n                        <p className=\"text-xs text-muted-foreground mt-1\">Target: &lt;0.5%</p>\n                      </div>\n\n                      <div>\n                        <div className=\"flex justify-between items-center mb-2\">\n                          <span className=\"text-sm text-muted-foreground\">Cost per Egg</span>\n                          <span className=\"font-medium\">\n                            KSh {totalEggs > 0 ? (totalExpenseAmount / totalEggs).toFixed(2) : '0.00'}\n                          </span>\n                        </div>\n                        <Progress value={75} className=\"h-2\" />\n                        <p className=\"text-xs text-muted-foreground mt-1\">Competitive range</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-performance-benchmarks\">\n                  <CardHeader>\n                    <CardTitle>Performance Benchmarks</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"font-medium text-green-800 dark:text-green-200\">Excellent Performance</span>\n                          <Badge variant=\"default\">Above Average</Badge>\n                        </div>\n                        <ul className=\"text-sm text-green-700 dark:text-green-300 mt-2 space-y-1\">\n                          <li>• Feed conversion efficiency</li>\n                          <li>• Revenue per bird</li>\n                        </ul>\n                      </div>\n\n                      <div className=\"p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"font-medium text-yellow-800 dark:text-yellow-200\">Good Performance</span>\n                          <Badge variant=\"secondary\">Average</Badge>\n                        </div>\n                        <ul className=\"text-sm text-yellow-700 dark:text-yellow-300 mt-2 space-y-1\">\n                          <li>• Daily production consistency</li>\n                          <li>• Overall profitability</li>\n                        </ul>\n                      </div>\n\n                      <div className=\"p-3 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"font-medium text-orange-800 dark:text-orange-200\">Needs Improvement</span>\n                          <Badge variant=\"outline\">Below Target</Badge>\n                        </div>\n                        <ul className=\"text-sm text-orange-700 dark:text-orange-300 mt-2 space-y-1\">\n                          <li>• Laying rate optimization</li>\n                          <li>• Mortality rate reduction</li>\n                        </ul>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"trends\">\n              <div className=\"grid grid-cols-1 gap-6\">\n                <Card data-testid=\"card-trends-analysis\">\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle>Trends & Forecasts</CardTitle>\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        onClick={() => handleExportReport(\"Trends\")}\n                        data-testid=\"button-export-trends\"\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        Export\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {monthlyTrendsData.length > 0 ? (\n                      <>\n                        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                          <div>\n                            <h4 className=\"text-sm font-medium mb-4\">Production Trend Analysis</h4>\n                            <ResponsiveContainer width=\"100%\" height={280}>\n                              <BarChart data={monthlyTrendsData}>\n                                <CartesianGrid strokeDasharray=\"3 3\" />\n                                <XAxis \n                                  dataKey=\"month\" \n                                  tick={{ fontSize: 11 }}\n                                  angle={-45}\n                                  textAnchor=\"end\"\n                                  height={80}\n                                />\n                                <YAxis tick={{ fontSize: 11 }} />\n                                <Tooltip />\n                                <Legend />\n                                <Bar \n                                  dataKey=\"eggs\" \n                                  fill=\"#8884d8\" \n                                  name=\"Eggs Produced\"\n                                  radius={[4, 4, 0, 0]}\n                                />\n                              </BarChart>\n                            </ResponsiveContainer>\n                          </div>\n\n                          <div>\n                            <h4 className=\"text-sm font-medium mb-4\">Revenue Forecasting</h4>\n                            <ResponsiveContainer width=\"100%\" height={280}>\n                              <LineChart data={trendsWithForecast}>\n                                <CartesianGrid strokeDasharray=\"3 3\" />\n                                <XAxis \n                                  dataKey=\"month\" \n                                  tick={{ fontSize: 11 }}\n                                  angle={-45}\n                                  textAnchor=\"end\"\n                                  height={80}\n                                />\n                                <YAxis tick={{ fontSize: 11 }} />\n                                <Tooltip \n                                  formatter={(value: number) => `KSh ${value.toLocaleString()}`}\n                                />\n                                <Legend />\n                                <Line \n                                  type=\"monotone\" \n                                  dataKey=\"revenue\" \n                                  stroke=\"#10b981\" \n                                  strokeWidth={2}\n                                  name=\"Revenue\"\n                                  strokeDasharray={(entry) => entry.isForecast ? \"5 5\" : \"0\"}\n                                  dot={{ r: 3 }}\n                                />\n                                <Line \n                                  type=\"monotone\" \n                                  dataKey=\"expenses\" \n                                  stroke=\"#ef4444\" \n                                  strokeWidth={2}\n                                  name=\"Expenses\"\n                                  strokeDasharray={(entry) => entry.isForecast ? \"5 5\" : \"0\"}\n                                  dot={{ r: 3 }}\n                                />\n                                <Line \n                                  type=\"monotone\" \n                                  dataKey=\"profit\" \n                                  stroke=\"#3b82f6\" \n                                  strokeWidth={2}\n                                  name=\"Profit\"\n                                  strokeDasharray={(entry) => entry.isForecast ? \"5 5\" : \"0\"}\n                                  dot={{ r: 3 }}\n                                />\n                                <ReferenceLine y={0} stroke=\"#666\" strokeDasharray=\"3 3\" />\n                              </LineChart>\n                            </ResponsiveContainer>\n                          </div>\n                        </div>\n\n                        <div className=\"mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded\">\n                          <h3 className=\"font-semibold text-blue-800 dark:text-blue-200 mb-2\">Key Insights</h3>\n                          <ul className=\"text-sm text-blue-700 dark:text-blue-300 space-y-1\">\n                            <li>• Production has {productionChange >= 0 ? 'increased' : 'decreased'} by {Math.abs(productionChange).toFixed(1)}% compared to the first month</li>\n                            <li>• Average monthly profit: KSh {avgProfit.toLocaleString(undefined, { maximumFractionDigits: 0 })}</li>\n                            <li>• {isProfitable ? 'Farm is operating profitably' : 'Focus on reducing costs to improve profitability'}</li>\n                            <li>• Forecasted revenue shows {growthRate > 0 ? 'positive growth' : 'stable performance'} for next 3 months</li>\n                          </ul>\n                        </div>\n                      </>\n                    ) : (\n                      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                        <div className=\"h-80 bg-muted/20 rounded-lg flex items-center justify-center\">\n                          <div className=\"text-center\">\n                            <TrendingUp className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                            <p className=\"text-sm text-muted-foreground\">No production data available</p>\n                            <p className=\"text-xs text-muted-foreground mt-2\">Add monthly records to see trends</p>\n                          </div>\n                        </div>\n\n                        <div className=\"h-80 bg-muted/20 rounded-lg flex items-center justify-center\">\n                          <div className=\"text-center\">\n                            <Calendar className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                            <p className=\"text-sm text-muted-foreground\">No sales data available</p>\n                            <p className=\"text-xs text-muted-foreground mt-2\">Add sales records to see forecasts</p>\n                          </div>\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"breakeven\">\n              <div className=\"space-y-6\">\n                {/* Rolling Window Selector */}\n                <Card data-testid=\"card-rolling-window\">\n                  <CardHeader>\n                    <CardTitle>Analysis Period</CardTitle>\n                    <CardDescription>\n                      Select historical data timeframe for calculations\n                    </CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <Tabs \n                      value={rollingWindow.toString()} \n                      onValueChange={(v) => setRollingWindow(parseInt(v) as 3 | 6 | 12)}\n                    >\n                      <TabsList className=\"grid w-full grid-cols-3\">\n                        <TabsTrigger value=\"3\" data-testid=\"tab-3months\">3 Months</TabsTrigger>\n                        <TabsTrigger value=\"6\" data-testid=\"tab-6months\">6 Months</TabsTrigger>\n                        <TabsTrigger value=\"12\" data-testid=\"tab-12months\">12 Months</TabsTrigger>\n                      </TabsList>\n                    </Tabs>\n                  </CardContent>\n                </Card>\n\n                {/* No Data State */}\n                {!breakEvenLoading && breakEvenMetrics && !breakEvenMetrics.hasData ? (\n                  <div className=\"space-y-4\">\n                    <Alert data-testid=\"alert-no-data\">\n                      <AlertCircle className=\"h-4 w-4\" />\n                      <AlertDescription>\n                        {breakEvenMetrics.message || \"No data found for analysis\"}\n                      </AlertDescription>\n                    </Alert>\n\n                    <Card>\n                      <CardHeader>\n                        <CardTitle>Get Started</CardTitle>\n                        <CardDescription>\n                          Add sales and expense records to enable break-even analysis\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent className=\"space-y-3\">\n                        {breakEvenMetrics.suggestedActions?.map((action, idx) => (\n                          <Link key={idx} href={action.route}>\n                            <Button \n                              variant=\"outline\" \n                              className=\"w-full justify-between\"\n                              data-testid={`button-${action.route.replace('/', '')}`}\n                            >\n                              {action.label}\n                              <ArrowRight className=\"h-4 w-4\" />\n                            </Button>\n                          </Link>\n                        ))}\n                      </CardContent>\n                    </Card>\n                  </div>\n                ) : (\n                  <>\n                    {/* Data Source Banner */}\n                    {breakEvenMetrics?.dataSource && (\n                      <Alert data-testid=\"alert-data-source\">\n                        <AlertCircle className=\"h-4 w-4\" />\n                        <AlertDescription>\n                          <strong>Auto-Calculated:</strong> Analyzing {breakEvenMetrics.dataSource.monthsAnalyzed} months \n                          ({breakEvenMetrics.dataSource.salesRecords} sales records, {breakEvenMetrics.dataSource.expenseRecords} expense records)\n                          from {new Date(breakEvenMetrics.dataSource.dateRange.startDate).toLocaleDateString()} to {new Date(breakEvenMetrics.dataSource.dateRange.endDate).toLocaleDateString()}\n                        </AlertDescription>\n                      </Alert>\n                    )}\n\n                    {/* Derived Values Summary */}\n                    {breakEvenLoading ? (\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n                        {[1, 2, 3, 4, 5].map((i) => (\n                          <Card key={i}>\n                            <CardHeader className=\"pb-2\">\n                              <Skeleton className=\"h-4 w-24\" />\n                            </CardHeader>\n                            <CardContent>\n                              <Skeleton className=\"h-6 w-20\" />\n                            </CardContent>\n                          </Card>\n                        ))}\n                      </div>\n                    ) : breakEvenMetrics?.derivedValues ? (\n                      <>\n                        <div className=\"text-sm font-semibold text-muted-foreground mb-2\">Calculated from Your Data</div>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n                          <Card data-testid=\"card-avg-price\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                                Avg Price/Crate\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"text-xl font-bold\" data-testid=\"text-avg-price\">\n                                {formatCurrency(breakEvenMetrics.derivedValues.price)}\n                              </div>\n                            </CardContent>\n                          </Card>\n\n                          <Card data-testid=\"card-avg-variable-cost\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                                Avg Variable Cost\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"text-xl font-bold\" data-testid=\"text-avg-variable-cost\">\n                                {formatCurrency(breakEvenMetrics.derivedValues.unitVariableCost)}\n                              </div>\n                            </CardContent>\n                          </Card>\n\n                          <Card data-testid=\"card-avg-fixed-costs\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                                Avg Fixed Costs/Month\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"text-xl font-bold\" data-testid=\"text-avg-fixed-costs\">\n                                {formatCurrency(breakEvenMetrics.derivedValues.fixedCostsPerMonth)}\n                              </div>\n                            </CardContent>\n                          </Card>\n\n                          <Card data-testid=\"card-avg-units\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                                Avg Monthly Units\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"text-xl font-bold\" data-testid=\"text-avg-units\">\n                                {breakEvenMetrics.derivedValues.initialUnits} crates\n                              </div>\n                            </CardContent>\n                          </Card>\n\n                          <Card data-testid=\"card-growth-rate\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                                Growth Rate (CAGR)\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"text-xl font-bold\" data-testid=\"text-growth-rate\">\n                                {(breakEvenMetrics.derivedValues.growthRate ?? 0).toFixed(2)}%\n                              </div>\n                            </CardContent>\n                          </Card>\n                        </div>\n                      </>\n                    ) : null}\n\n                    {/* Interactive Navigation */}\n                    <Card data-testid=\"card-navigation\">\n                      <CardHeader>\n                        <CardTitle>Adjust Your Data</CardTitle>\n                        <CardDescription>\n                          Update sales, expenses, or feed to see real-time changes in your break-even analysis\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n                        <Link href=\"/egg-production\">\n                          <Button \n                            variant=\"outline\" \n                            className=\"w-full justify-between\"\n                            data-testid=\"button-goto-sales\"\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <ShoppingCart className=\"h-4 w-4\" />\n                              Manage Sales\n                            </div>\n                            <ArrowRight className=\"h-4 w-4\" />\n                          </Button>\n                        </Link>\n                        \n                        <Link href=\"/expenses\">\n                          <Button \n                            variant=\"outline\" \n                            className=\"w-full justify-between\"\n                            data-testid=\"button-goto-expenses\"\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <CostsIcon className=\"h-4 w-4\" />\n                              Manage Expenses\n                            </div>\n                            <ArrowRight className=\"h-4 w-4\" />\n                          </Button>\n                        </Link>\n                        \n                        <Link href=\"/feed-management\">\n                          <Button \n                            variant=\"outline\" \n                            className=\"w-full justify-between\"\n                            data-testid=\"button-goto-feed\"\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <Package className=\"h-4 w-4\" />\n                              Feed Management\n                            </div>\n                            <ArrowRight className=\"h-4 w-4\" />\n                          </Button>\n                        </Link>\n                      </CardContent>\n                    </Card>\n\n                    {/* Break-Even Metrics */}\n                    {breakEvenLoading ? (\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                        {[1, 2, 3, 4].map((i) => (\n                          <Card key={i}>\n                            <CardHeader className=\"pb-2\">\n                              <Skeleton className=\"h-4 w-24\" />\n                            </CardHeader>\n                            <CardContent>\n                              <Skeleton className=\"h-8 w-32\" />\n                            </CardContent>\n                          </Card>\n                        ))}\n                      </div>\n                    ) : breakEvenMetrics && breakEvenMetrics.breakEvenUnits !== undefined ? (\n                      <>\n                        <div className=\"text-sm font-semibold text-muted-foreground mb-2\">Break-Even Projections</div>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                          <Card data-testid=\"card-break-even-units\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                                Break-Even Units\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"flex items-center gap-2\">\n                                <Calculator className=\"h-5 w-5 text-blue-500\" />\n                                <span className=\"text-2xl font-bold\" data-testid=\"text-break-even-units\">\n                                  {breakEvenMetrics.breakEvenUnits.toFixed(0)} crates\n                                </span>\n                              </div>\n                              <p className=\"text-xs text-muted-foreground mt-1\">Per month</p>\n                            </CardContent>\n                          </Card>\n\n                          <Card data-testid=\"card-break-even-revenue\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                                Break-Even Revenue\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"flex items-center gap-2\">\n                                <DollarSign className=\"h-5 w-5 text-green-500\" />\n                                <span className=\"text-2xl font-bold\" data-testid=\"text-break-even-revenue\">\n                                  {formatCurrency(breakEvenMetrics.breakEvenRevenue || 0)}\n                                </span>\n                              </div>\n                              <p className=\"text-xs text-muted-foreground mt-1\">Per month</p>\n                            </CardContent>\n                          </Card>\n\n                          <Card data-testid=\"card-break-even-month\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                                Break-Even Month\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"flex items-center gap-2\">\n                                <Calendar className=\"h-5 w-5 text-purple-500\" />\n                                <span className=\"text-2xl font-bold\" data-testid=\"text-break-even-month\">\n                                  {breakEvenMetrics.breakEvenMonth !== null ? `Month ${breakEvenMetrics.breakEvenMonth}` : \"Not Reachable\"}\n                                </span>\n                              </div>\n                              {breakEvenMetrics.breakEvenDate && (\n                                <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"text-break-even-date\">\n                                  {new Date(breakEvenMetrics.breakEvenDate).toLocaleDateString()}\n                                </p>\n                              )}\n                            </CardContent>\n                          </Card>\n\n                          <Card data-testid=\"card-contribution-margin\">\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                                Contribution Margin\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"flex items-center gap-2\">\n                                <TrendingUp className=\"h-5 w-5 text-orange-500\" />\n                                <span className=\"text-2xl font-bold\" data-testid=\"text-contribution-margin\">\n                                  {breakEvenMetrics.contributionMarginRatio?.toFixed(1)}%\n                                </span>\n                              </div>\n                              <p className=\"text-xs text-muted-foreground mt-1\">\n                                {formatCurrency(breakEvenMetrics.contributionMargin || 0)} per unit\n                              </p>\n                            </CardContent>\n                          </Card>\n                        </div>\n\n                        {/* Not Reachable Warning */}\n                        {breakEvenMetrics.breakEvenMonth === null && (\n                          <Alert data-testid=\"alert-not-reachable\">\n                            <AlertCircle className=\"h-4 w-4\" />\n                            <AlertDescription>\n                              Break-even is not reachable within the 12-month projection period with current data trends.\n                              Consider adjusting your prices or reducing costs.\n                            </AlertDescription>\n                          </Alert>\n                        )}\n\n                        {/* Charts */}\n                        {breakEvenMetrics.monthlyProjections && breakEvenMetrics.monthlyProjections.length > 0 && (\n                          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                            {/* Cumulative Profit Chart */}\n                            <Card data-testid=\"card-cumulative-profit-chart\">\n                              <CardHeader>\n                                <CardTitle>Cumulative Profit Over Time</CardTitle>\n                                <CardDescription>Track when you'll reach profitability</CardDescription>\n                              </CardHeader>\n                              <CardContent>\n                                <ResponsiveContainer width=\"100%\" height={300}>\n                                  <LineChart data={breakEvenMetrics.monthlyProjections}>\n                                    <CartesianGrid strokeDasharray=\"3 3\" />\n                                    <XAxis dataKey=\"month\" label={{ value: \"Month\", position: \"insideBottom\", offset: -5 }} />\n                                    <YAxis label={{ value: \"Profit (KES)\", angle: -90, position: \"insideLeft\" }} />\n                                    <Tooltip formatter={(value) => formatCurrency(Number(value))} />\n                                    <Legend />\n                                    <ReferenceLine y={0} stroke=\"#000\" strokeDasharray=\"3 3\" />\n                                    {breakEvenMetrics.breakEvenMonth !== null && (\n                                      <ReferenceLine\n                                        x={breakEvenMetrics.breakEvenMonth}\n                                        stroke=\"#22c55e\"\n                                        strokeDasharray=\"3 3\"\n                                        label={{ value: \"Break-Even\", position: \"top\" }}\n                                      />\n                                    )}\n                                    <Line\n                                      type=\"monotone\"\n                                      dataKey=\"cumulativeProfit\"\n                                      stroke=\"#8b5cf6\"\n                                      strokeWidth={2}\n                                      name=\"Cumulative Profit\"\n                                    />\n                                  </LineChart>\n                                </ResponsiveContainer>\n                              </CardContent>\n                            </Card>\n\n                            {/* Revenue vs Costs Chart */}\n                            <Card data-testid=\"card-revenue-costs-chart\">\n                              <CardHeader>\n                                <CardTitle>Revenue vs Total Costs</CardTitle>\n                                <CardDescription>Monthly comparison</CardDescription>\n                              </CardHeader>\n                              <CardContent>\n                                <ResponsiveContainer width=\"100%\" height={300}>\n                                  <BarChart data={breakEvenMetrics.monthlyProjections}>\n                                    <CartesianGrid strokeDasharray=\"3 3\" />\n                                    <XAxis dataKey=\"month\" label={{ value: \"Month\", position: \"insideBottom\", offset: -5 }} />\n                                    <YAxis label={{ value: \"Amount (KES)\", angle: -90, position: \"insideLeft\" }} />\n                                    <Tooltip formatter={(value) => formatCurrency(Number(value))} />\n                                    <Legend />\n                                    <Bar dataKey=\"revenue\" fill=\"#22c55e\" name=\"Revenue\" />\n                                    <Bar dataKey=\"totalCosts\" fill=\"#ef4444\" name=\"Total Costs\" />\n                                  </BarChart>\n                                </ResponsiveContainer>\n                              </CardContent>\n                            </Card>\n                          </div>\n                        )}\n\n                        {/* Monthly Projections Table */}\n                        {breakEvenMetrics.monthlyProjections && breakEvenMetrics.monthlyProjections.length > 0 && (\n                          <Card data-testid=\"card-monthly-projections\">\n                            <CardHeader>\n                              <div className=\"flex items-center justify-between\">\n                                <div>\n                                  <CardTitle>Monthly Projections</CardTitle>\n                                  <CardDescription>Detailed breakdown of revenue and costs</CardDescription>\n                                </div>\n                                <div className=\"flex gap-2\">\n                                  <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    onClick={downloadBreakEvenCSV}\n                                    data-testid=\"button-download-csv\"\n                                  >\n                                    <Download className=\"h-4 w-4 mr-2\" />\n                                    CSV\n                                  </Button>\n                                  <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    onClick={downloadBreakEvenPDF}\n                                    data-testid=\"button-download-pdf\"\n                                  >\n                                    <FileText className=\"h-4 w-4 mr-2\" />\n                                    PDF\n                                  </Button>\n                                </div>\n                              </div>\n                            </CardHeader>\n                            <CardContent>\n                              <div className=\"overflow-x-auto\">\n                                <table className=\"w-full text-sm\">\n                                  <thead>\n                                    <tr className=\"border-b\">\n                                      <th className=\"text-left p-2\">Month</th>\n                                      <th className=\"text-right p-2\">Units</th>\n                                      <th className=\"text-right p-2\">Revenue</th>\n                                      <th className=\"text-right p-2\">Variable</th>\n                                      <th className=\"text-right p-2\">Fixed</th>\n                                      <th className=\"text-right p-2\">Total Costs</th>\n                                      <th className=\"text-right p-2\">Profit</th>\n                                      <th className=\"text-right p-2\">Cumulative</th>\n                                    </tr>\n                                  </thead>\n                                  <tbody>\n                                    {breakEvenMetrics.monthlyProjections.map((projection, idx) => (\n                                      <tr\n                                        key={idx}\n                                        className={`border-b ${projection.cumulativeProfit >= 0 ? 'bg-green-50 dark:bg-green-950/20' : ''}`}\n                                        data-testid={`row-projection-${idx}`}\n                                      >\n                                        <td className=\"p-2\">{projection.month}</td>\n                                        <td className=\"text-right p-2\">{projection.units.toFixed(0)}</td>\n                                        <td className=\"text-right p-2\">{formatCurrency(projection.revenue)}</td>\n                                        <td className=\"text-right p-2\">{formatCurrency(projection.variableCosts)}</td>\n                                        <td className=\"text-right p-2\">{formatCurrency(projection.fixedCosts)}</td>\n                                        <td className=\"text-right p-2\">{formatCurrency(projection.totalCosts)}</td>\n                                        <td className={`text-right p-2 ${projection.profit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                          {formatCurrency(projection.profit)}\n                                        </td>\n                                        <td className={`text-right p-2 font-semibold ${projection.cumulativeProfit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                          {formatCurrency(projection.cumulativeProfit)}\n                                        </td>\n                                      </tr>\n                                    ))}\n                                  </tbody>\n                                </table>\n                              </div>\n                            </CardContent>\n                          </Card>\n                        )}\n                      </>\n                    ) : null}\n                  </>\n                )}\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":70226},"client/src/contexts/AuthContext.tsx":{"content":"import React, { createContext, useContext, useEffect, useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { useLocation } from 'wouter';\nimport { type User } from '@shared/schema';\nimport WelcomePanel from '@/components/welcome-panel';\nimport { \n  getRoleDashboardRoute, \n  shouldShowWelcomePanel, \n  markWelcomePanelSeen, \n  clearUserRoleIntent \n} from '@/utils/role-router';\n\ninterface AuthContextType {\n  user: User | undefined;\n  isLoading: boolean;\n  isAuthenticated: boolean;\n  showWelcomePanel: boolean;\n  dismissWelcomePanel: () => void;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [, setLocation] = useLocation();\n  const [showWelcomePanel, setShowWelcomePanel] = useState(false);\n  const [hasProcessedAuth, setHasProcessedAuth] = useState(false);\n\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  const isAuthenticated = !!user;\n\n  // Handle post-authentication flow\n  useEffect(() => {\n    if (!isLoading && isAuthenticated && user && !hasProcessedAuth) {\n      setHasProcessedAuth(true);\n      \n      // Check if user should see welcome panel\n      if (shouldShowWelcomePanel(user)) {\n        setShowWelcomePanel(true);\n      } else {\n        // No welcome panel needed, route directly to dashboard\n        const dashboardRoute = getRoleDashboardRoute(user);\n        setLocation(dashboardRoute);\n      }\n    }\n  }, [isLoading, isAuthenticated, user, hasProcessedAuth, setLocation]);\n\n  const dismissWelcomePanel = () => {\n    setShowWelcomePanel(false);\n    markWelcomePanelSeen();\n    clearUserRoleIntent();\n    \n    if (user) {\n      const dashboardRoute = getRoleDashboardRoute(user);\n      setLocation(dashboardRoute);\n    }\n  };\n\n  const contextValue: AuthContextType = {\n    user,\n    isLoading,\n    isAuthenticated,\n    showWelcomePanel,\n    dismissWelcomePanel,\n  };\n\n  return (\n    <AuthContext.Provider value={contextValue}>\n      {children}\n      {showWelcomePanel && user && (\n        <WelcomePanel onDashboardClick={dismissWelcomePanel} />\n      )}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth(): AuthContextType {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}","size_bytes":2434},"client/src/lib/dateUtils.ts":{"content":"/**\n * Safely parse a date string/value and return Date or null\n * @param value - Date string, Date object, or other value\n * @returns Valid Date object or null if invalid\n */\nexport const safeDate = (value?: string | Date | null): Date | null => {\n  if (!value) return null;\n  \n  const date = new Date(value);\n  return isNaN(date.getTime()) ? null : date;\n};\n\n/**\n * Format a date safely with fallback\n * @param value - Date string, Date object, or other value\n * @param fallback - Fallback string if date is invalid\n * @returns Formatted date string or fallback\n */\nexport const formatDateSafe = (value?: string | Date | null, fallback: string = 'N/A'): string => {\n  const date = safeDate(value);\n  return date ? date.toLocaleDateString() : fallback;\n};\n\n/**\n * Format a date with time safely with fallback\n * @param value - Date string, Date object, or other value\n * @param fallback - Fallback string if date is invalid\n * @returns Formatted datetime string or fallback\n */\nexport const formatDateTimeSafe = (value?: string | Date | null, fallback: string = 'N/A'): string => {\n  const date = safeDate(value);\n  return date ? date.toLocaleString() : fallback;\n};\n\n/**\n * Get relative time (e.g., \"2 hours ago\") safely\n * @param value - Date string, Date object, or other value\n * @param fallback - Fallback string if date is invalid\n * @returns Relative time string or fallback\n */\nexport const formatRelativeTime = (value?: string | Date | null, fallback: string = 'Never'): string => {\n  const date = safeDate(value);\n  if (!date) return fallback;\n  \n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\n  const diffDays = Math.floor(diffHours / 24);\n  \n  if (diffHours < 1) {\n    const diffMinutes = Math.floor(diffMs / (1000 * 60));\n    return diffMinutes < 1 ? 'Just now' : `${diffMinutes}m ago`;\n  }\n  \n  if (diffHours < 24) {\n    return `${diffHours}h ago`;\n  }\n  \n  if (diffDays < 7) {\n    return `${diffDays}d ago`;\n  }\n  \n  return date.toLocaleDateString();\n};\n\n/**\n * Check if a date is within the last N days (excludes future dates)\n * @param value - Date to check\n * @param days - Number of days to check within\n * @returns boolean indicating if date is within the last N days\n */\nexport const isWithinDays = (value?: string | Date | null, days: number = 30): boolean => {\n  const date = safeDate(value);\n  if (!date) return false;\n  \n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  \n  // Return false for future dates\n  if (diffMs < 0) return false;\n  \n  const diffDays = diffMs / (1000 * 60 * 60 * 24);\n  \n  return diffDays <= days;\n};","size_bytes":2665},"client/src/pages/marketplace-customers.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Plus, Search, Edit, Phone, Mail, MapPin, Menu } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertCustomerSchema, type Customer } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { z } from \"zod\";\n\nconst customerFormSchema = insertCustomerSchema.extend({\n  phone: z.string().min(1, \"Phone number is required\"),\n  name: z.string().min(1, \"Customer name is required\"),\n});\n\nexport default function MarketplaceCustomers() {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [editingCustomer, setEditingCustomer] = useState<Customer | null>(null);\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const { toast } = useToast();\n  const { user, isLoading, isAuthenticated } = useAuth();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: customers = [], isLoading: customersLoading, error: customersError } = useQuery<Customer[]>({\n    queryKey: [\"/api/customers\"],\n    enabled: isAuthenticated,\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if (customersError && isUnauthorizedError(customersError)) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [customersError, toast]);\n\n  const createCustomerMutation = useMutation({\n    mutationFn: (data: z.infer<typeof customerFormSchema>) => \n      apiRequest(\"POST\", \"/api/customers\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\"] });\n      setIsDialogOpen(false);\n      toast({\n        title: \"Success\",\n        description: \"Customer created successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create customer\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const form = useForm<z.infer<typeof customerFormSchema>>({\n    resolver: zodResolver(customerFormSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      address: \"\",\n      location: \"\",\n      customerType: \"retail\",\n      status: \"active\",\n      notes: \"\",\n    },\n  });\n\n  const filteredCustomers = customers.filter((customer: Customer) =>\n    customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    customer.phone.includes(searchTerm) ||\n    (customer.email && customer.email.toLowerCase().includes(searchTerm.toLowerCase()))\n  );\n\n  const onSubmit = (data: z.infer<typeof customerFormSchema>) => {\n    createCustomerMutation.mutate(data);\n  };\n\n  // Edit form\n  const editForm = useForm<z.infer<typeof customerFormSchema>>({\n    resolver: zodResolver(customerFormSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      phone: \"\",\n      address: \"\",\n      location: \"\",\n      customerType: \"retail\",\n      status: \"active\",\n      notes: \"\",\n    },\n  });\n\n  const updateCustomerMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: z.infer<typeof customerFormSchema> }) => {\n      await apiRequest(\"PATCH\", `/api/customers/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\"] });\n      toast({\n        title: \"Success\",\n        description: \"Customer updated successfully\",\n      });\n      editForm.reset();\n      setEditDialogOpen(false);\n      setEditingCustomer(null);\n    },\n    onError: (error: any) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update customer\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmitEdit = (data: z.infer<typeof customerFormSchema>) => {\n    if (editingCustomer) {\n      updateCustomerMutation.mutate({ id: editingCustomer.id, data });\n    }\n  };\n\n  const handleEditCustomer = (customer: Customer) => {\n    setEditingCustomer(customer);\n    editForm.reset({\n      name: customer.name,\n      email: customer.email || \"\",\n      phone: customer.phone,\n      address: customer.address || \"\",\n      location: customer.location || \"\",\n      customerType: customer.customerType,\n      status: customer.status,\n      notes: customer.notes || \"\",\n    });\n    setEditDialogOpen(true);\n  };\n\n  const getCustomerTypeColor = (type: string) => {\n    switch (type) {\n      case \"wholesale\": return \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300\";\n      case \"distributor\": return \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300\";\n      default: return \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300\";\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading customers...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n          data-testid=\"mobile-overlay\"\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Top Navigation Bar */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Customer Management</h2>\n                <p className=\"text-sm text-muted-foreground\">Manage your marketplace customers</p>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Customer Management</h1>\n            <p className=\"text-muted-foreground\">Manage your marketplace customers and their information</p>\n          </div>\n          \n          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-add-customer\">\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Add Customer\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-2xl\">\n              <DialogHeader>\n                <DialogTitle>Add New Customer</DialogTitle>\n              </DialogHeader>\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"name\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Customer Name</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-customer-name\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"phone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Phone Number</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-customer-phone\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"email\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Email (Optional)</FormLabel>\n                          <FormControl>\n                            <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} type=\"email\" data-testid=\"input-customer-email\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"location\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Location/Area</FormLabel>\n                          <FormControl>\n                            <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} placeholder=\"e.g., Nairobi, Mombasa\" data-testid=\"input-customer-location\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={form.control}\n                    name=\"address\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Address (Optional)</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} rows={2} data-testid=\"input-customer-address\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"customerType\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Customer Type</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-customer-type\">\n                                <SelectValue />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"retail\">Retail</SelectItem>\n                              <SelectItem value=\"wholesale\">Wholesale</SelectItem>\n                              <SelectItem value=\"distributor\">Distributor</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"status\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Status</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-customer-status\">\n                                <SelectValue />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"active\">Active</SelectItem>\n                              <SelectItem value=\"inactive\">Inactive</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={form.control}\n                    name=\"notes\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Notes (Optional)</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} rows={2} data-testid=\"input-customer-notes\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setIsDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={createCustomerMutation.isPending} data-testid=\"button-save-customer\">\n                      {createCustomerMutation.isPending ? \"Creating...\" : \"Create Customer\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n\n          {/* Edit Customer Dialog */}\n          <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n            <DialogContent className=\"max-w-2xl\">\n              <DialogHeader>\n                <DialogTitle>Edit Customer</DialogTitle>\n              </DialogHeader>\n              <Form {...editForm}>\n                <form onSubmit={editForm.handleSubmit(onSubmitEdit)} className=\"space-y-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editForm.control}\n                      name=\"name\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Customer Name</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-edit-customer-name\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editForm.control}\n                      name=\"phone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Phone Number</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-edit-customer-phone\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editForm.control}\n                      name=\"email\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Email (Optional)</FormLabel>\n                          <FormControl>\n                            <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} type=\"email\" data-testid=\"input-edit-customer-email\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editForm.control}\n                      name=\"location\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Location</FormLabel>\n                          <FormControl>\n                            <Input {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} data-testid=\"input-edit-customer-location\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={editForm.control}\n                    name=\"address\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Address (Optional)</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} rows={2} data-testid=\"input-edit-customer-address\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editForm.control}\n                      name=\"customerType\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Customer Type</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-edit-customer-type\">\n                                <SelectValue placeholder=\"Select customer type\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"retail\">Retail</SelectItem>\n                              <SelectItem value=\"wholesale\">Wholesale</SelectItem>\n                              <SelectItem value=\"distributor\">Distributor</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={editForm.control}\n                      name=\"status\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Status</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-edit-customer-status\">\n                                <SelectValue placeholder=\"Select status\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"active\">Active</SelectItem>\n                              <SelectItem value=\"inactive\">Inactive</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={editForm.control}\n                    name=\"notes\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Notes (Optional)</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} value={field.value || ''} onChange={(e) => field.onChange(e.target.value || null)} rows={3} data-testid=\"input-edit-customer-notes\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setEditDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={updateCustomerMutation.isPending} data-testid=\"button-update-customer\">\n                      {updateCustomerMutation.isPending ? \"Updating...\" : \"Update Customer\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        {/* Search */}\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search customers by name, phone, or email...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-8\"\n                data-testid=\"input-search-customers\"\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Customer List */}\n        <div className=\"grid gap-4\">\n          {customersLoading ? (\n            <Card>\n              <CardContent className=\"flex items-center justify-center py-8\">\n                <p className=\"text-muted-foreground\">Loading customers...</p>\n              </CardContent>\n            </Card>\n          ) : filteredCustomers.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex items-center justify-center py-8\">\n                <div className=\"text-center\">\n                  <p className=\"text-muted-foreground mb-2\">\n                    {searchTerm ? \"No customers found matching your search\" : \"No customers yet\"}\n                  </p>\n                  {!searchTerm && (\n                    <Button onClick={() => setIsDialogOpen(true)} data-testid=\"button-add-first-customer\">\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      Add Your First Customer\n                    </Button>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ) : (\n            filteredCustomers.map((customer: Customer) => (\n              <Card key={customer.id} data-testid={`card-customer-${customer.id}`}>\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle className=\"text-lg\">{customer.name}</CardTitle>\n                    <div className=\"flex items-center space-x-2\">\n                      <Badge className={getCustomerTypeColor(customer.customerType)}>\n                        {customer.customerType}\n                      </Badge>\n                      <Badge variant={customer.status === \"active\" ? \"default\" : \"secondary\"}>\n                        {customer.status}\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"text-sm\">{customer.phone}</span>\n                    </div>\n                    {customer.email && (\n                      <div className=\"flex items-center space-x-2\">\n                        <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"text-sm\">{customer.email}</span>\n                      </div>\n                    )}\n                    {customer.location && (\n                      <div className=\"flex items-center space-x-2\">\n                        <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"text-sm\">{customer.location}</span>\n                      </div>\n                    )}\n                  </div>\n                  {customer.address && (\n                    <p className=\"text-sm text-muted-foreground mt-2\">\n                      Address: {customer.address}\n                    </p>\n                  )}\n                  {customer.notes && (\n                    <p className=\"text-sm text-muted-foreground mt-2\">\n                      Notes: {customer.notes}\n                    </p>\n                  )}\n                  <div className=\"flex justify-end mt-4\">\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      onClick={() => handleEditCustomer(customer)}\n                      data-testid={`button-edit-customer-${customer.id}`}\n                    >\n                      <Edit className=\"mr-2 h-4 w-4\" />\n                      Edit\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ))\n          )}\n        </div>\n        </div>\n      </main>\n    </div>\n  );\n}","size_bytes":27373},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/forms/simple-brooding-form.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\n\ninterface SimpleBroodingFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function SimpleBroodingForm({ onSuccess }: SimpleBroodingFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  // Form state\n  const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);\n  const [flockId, setFlockId] = useState(\"\");\n  const [temperature, setTemperature] = useState(\"\");\n  const [lightingHours, setLightingHours] = useState(\"\");\n  const [mortalityCount, setMortalityCount] = useState(\"0\");\n  const [mortalityReason, setMortalityReason] = useState(\"\");\n  const [feedConsumed, setFeedConsumed] = useState(\"\");\n  const [feedType, setFeedType] = useState(\"\");\n  const [averageWeight, setAverageWeight] = useState(\"\");\n  const [sampleSize, setSampleSize] = useState(\"0\");\n  const [notes, setNotes] = useState(\"\");\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  // Calculate chick age and get suggestions based on selected flock and record date\n  const selectedFlock = flocks.find(f => f.id === flockId);\n  const baseDate = recordDate ? new Date(recordDate) : new Date();\n  const chickAge = selectedFlock ? Math.max(0, Math.floor((baseDate.getTime() - new Date(selectedFlock.hatchDate).getTime()) / (1000 * 60 * 60 * 24))) : 0;\n  const weekAge = Math.floor(chickAge / 7);\n\n  // Age-based guidance (matches brooding schedule)\n  const getTemperatureSuggestion = (age: number) => {\n    if (age <= 7) return \"35-32°C (Week 1)\";\n    if (age <= 14) return \"32-29°C (Week 2)\";\n    if (age <= 21) return \"29-26°C (Week 3)\";\n    if (age <= 28) return \"26-23°C (Week 4)\";\n    if (age <= 35) return \"23-21°C (Week 5)\";\n    if (age <= 56) return \"21°C (Weeks 6-8)\";\n    return \"21°C (Week 9+)\";\n  };\n\n  const getLightingSuggestion = (age: number) => {\n    if (age <= 7) return \"24 hours (Week 1)\";\n    if (age <= 14) return \"20 hours (Week 2)\";\n    if (age <= 21) return \"16 hours (Week 3)\";\n    return \"14 hours (Week 4+)\";\n  };\n\n  const getFeedSuggestion = (age: number, currentCount: number = 0) => {\n    let gPerBirdPerDay;\n    if (age <= 7) gPerBirdPerDay = 12;\n    else if (age <= 14) gPerBirdPerDay = 18;\n    else if (age <= 21) gPerBirdPerDay = 25;\n    else if (age <= 28) gPerBirdPerDay = 31;\n    else if (age <= 35) gPerBirdPerDay = 38;\n    else if (age <= 42) gPerBirdPerDay = 41;\n    else if (age <= 49) gPerBirdPerDay = 45;\n    else if (age <= 56) gPerBirdPerDay = 49;\n    else if (age <= 63) gPerBirdPerDay = 52;  // Week 9\n    else if (age <= 70) gPerBirdPerDay = 60;  // Week 10\n    else if (age <= 77) gPerBirdPerDay = 70;  // Week 11\n    else if (age <= 84) gPerBirdPerDay = 75;  // Week 12\n    else if (age <= 91) gPerBirdPerDay = 80;  // Week 13\n    else if (age <= 98) gPerBirdPerDay = 85;  // Week 14\n    else if (age <= 105) gPerBirdPerDay = 92;  // Week 15\n    else if (age <= 112) gPerBirdPerDay = 100; // Week 16\n    else if (age <= 119) gPerBirdPerDay = 107; // Week 17\n    else if (age <= 126) gPerBirdPerDay = 114; // Week 18\n    else if (age <= 133) gPerBirdPerDay = 118; // Week 19\n    else gPerBirdPerDay = 120; // Week 20+\n    \n    const totalKg = (gPerBirdPerDay * currentCount) / 1000;\n    return `~${totalKg.toFixed(1)}kg (${gPerBirdPerDay}g per bird/day)`;\n  };\n\n  const getWeightSuggestion = (age: number) => {\n    if (age <= 7) return \"40-60g (Week 1)\";\n    if (age <= 14) return \"85-120g (Week 2)\";\n    if (age <= 21) return \"150-200g (Week 3)\";\n    if (age <= 28) return \"220-300g (Week 4)\";\n    if (age <= 35) return \"380-400g (Week 5)\";\n    if (age <= 42) return \"470-500g (Week 6)\";\n    if (age <= 49) return \"560-600g (Week 7)\";\n    if (age <= 56) return \"650g (Week 8)\";\n    if (age <= 63) return \"740-780g (Week 9)\";\n    if (age <= 70) return \"830-870g (Week 10)\";\n    if (age <= 77) return \"920-980g (Week 11)\";\n    if (age <= 84) return \"1010-1050g (Week 12)\";\n    if (age <= 91) return \"1100-1140g (Week 13)\";\n    if (age <= 98) return \"1185-1230g (Week 14)\";\n    if (age <= 105) return \"1270-1320g (Week 15)\";\n    if (age <= 112) return \"1355-1410g (Week 16)\";\n    if (age <= 119) return \"1440-1500g (Week 17)\";\n    if (age <= 126) return \"1530-1600g (Week 18)\";\n    if (age <= 133) return \"1580-1680g (Week 19)\";\n    return \"1645-1750g (Week 20+)\";\n  };\n\n  const createRecordMutation = useMutation({\n    mutationFn: async (data: any) => {\n      await apiRequest(\"POST\", \"/api/daily-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Brooding record created successfully\",\n      });\n      resetForm();\n      onSuccess?.();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create brooding record\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setRecordDate(new Date().toISOString().split('T')[0]);\n    setFlockId(\"\");\n    setTemperature(\"\");\n    setLightingHours(\"\");\n    setMortalityCount(\"0\");\n    setMortalityReason(\"\");\n    setFeedConsumed(\"\");\n    setFeedType(\"\");\n    setAverageWeight(\"\");\n    setSampleSize(\"0\");\n    setNotes(\"\");\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select an active farm before submitting records.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // Basic validation\n    if (!flockId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a flock\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!recordDate) {\n      toast({\n        title: \"Error\", \n        description: \"Please select a record date\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Prepare data with proper type coercion - decimal fields need to be strings\n    const payload = {\n      recordDate,\n      flockId,\n      temperature: temperature || undefined, // Keep as string for decimal field\n      lightingHours: lightingHours || undefined, // Keep as string for decimal field\n      mortalityCount: parseInt(mortalityCount) || 0,\n      mortalityReason: mortalityReason || undefined,\n      feedConsumed: feedConsumed || undefined, // Keep as string for decimal field\n      feedType: feedType || undefined,\n      averageWeight: averageWeight || undefined, // Keep as string for decimal field\n      sampleSize: parseInt(sampleSize) || 0,\n      notes: notes || undefined,\n      // Required egg production fields (defaults for brooding records)\n      eggsCollected: 0,\n      brokenEggs: 0,\n      cratesProduced: 0,\n      farmId: activeFarmId,\n    };\n\n    console.log(\"Submitting brooding record:\", payload);\n    createRecordMutation.mutate(payload);\n  };\n\n  return (\n    <Card data-testid=\"card-simple-brooding-form\">\n      <CardHeader>\n        <CardTitle>Brooding Record</CardTitle>\n        <CardDescription>\n          Record daily brooding activities including temperature, lighting, feed consumption, and chick health.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"recordDate\">Record Date</Label>\n              <Input\n                id=\"recordDate\"\n                type=\"date\"\n                value={recordDate}\n                onChange={(e) => setRecordDate(e.target.value)}\n                data-testid=\"input-record-date\"\n                required\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"flockId\">Flock</Label>\n              <Select value={flockId} onValueChange={setFlockId}>\n                <SelectTrigger data-testid=\"select-flock\">\n                  <SelectValue placeholder=\"Select a flock\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {flocks.map((flock: any) => {\n                    const age = Math.floor((new Date().getTime() - new Date(flock.hatchDate).getTime()) / (1000 * 60 * 60 * 24));\n                    return (\n                      <SelectItem key={flock.id} value={flock.id}>\n                        {flock.name} ({age} days old - Week {Math.floor(age / 7)})\n                      </SelectItem>\n                    );\n                  })}\n                </SelectContent>\n              </Select>\n              {selectedFlock && (\n                <p className=\"text-sm text-muted-foreground\">\n                  Selected flock is {chickAge} days old (Week {weekAge})\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Environment Section */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold\">Environment Conditions</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"temperature\">Temperature (°C)</Label>\n                <Input\n                  id=\"temperature\"\n                  type=\"number\"\n                  step=\"0.1\"\n                  value={temperature}\n                  onChange={(e) => setTemperature(e.target.value)}\n                  placeholder={selectedFlock ? getTemperatureSuggestion(chickAge) : \"e.g., 32.5\"}\n                  data-testid=\"input-temperature\"\n                />\n                {selectedFlock && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    Suggested: {getTemperatureSuggestion(chickAge)}\n                  </p>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"lightingHours\">Lighting Hours</Label>\n                <Input\n                  id=\"lightingHours\"\n                  type=\"number\"\n                  step=\"0.5\"\n                  value={lightingHours}\n                  onChange={(e) => setLightingHours(e.target.value)}\n                  placeholder={selectedFlock ? getLightingSuggestion(chickAge) : \"e.g., 18\"}\n                  data-testid=\"input-lighting-hours\"\n                />\n                {selectedFlock && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    Suggested: {getLightingSuggestion(chickAge)}\n                  </p>\n                )}\n              </div>\n            </div>\n          </div>\n\n          {/* Mortality Section */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold\">Mortality</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"mortalityCount\">Mortality Count</Label>\n                <Input\n                  id=\"mortalityCount\"\n                  type=\"number\"\n                  value={mortalityCount}\n                  onChange={(e) => setMortalityCount(e.target.value)}\n                  data-testid=\"input-mortality-count\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"mortalityReason\">Mortality Reason</Label>\n                <Input\n                  id=\"mortalityReason\"\n                  value={mortalityReason}\n                  onChange={(e) => setMortalityReason(e.target.value)}\n                  placeholder=\"e.g., Disease, Injury\"\n                  data-testid=\"input-mortality-reason\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Feed Section */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold\">Feed</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"feedConsumed\">Feed Consumed (kg)</Label>\n                <Input\n                  id=\"feedConsumed\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={feedConsumed}\n                  onChange={(e) => setFeedConsumed(e.target.value)}\n                  placeholder={selectedFlock ? getFeedSuggestion(chickAge, selectedFlock.currentCount) : \"e.g., 125.5\"}\n                  data-testid=\"input-feed-consumed\"\n                />\n                {selectedFlock && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    Suggested: {getFeedSuggestion(chickAge, selectedFlock.currentCount)}\n                  </p>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"feedType\">Feed Type</Label>\n                <Select value={feedType} onValueChange={setFeedType}>\n                  <SelectTrigger data-testid=\"select-feed-type\">\n                    <SelectValue placeholder=\"Select feed type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"chick-starter\">Chick Starter</SelectItem>\n                    <SelectItem value=\"broiler-starter\">Broiler Starter</SelectItem>\n                    <SelectItem value=\"chick-grower\">Chick Grower</SelectItem>\n                    <SelectItem value=\"medicated-starter\">Medicated Starter</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </div>\n\n          {/* Weight Monitoring Section */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold\">Weight Monitoring</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"averageWeight\">Average Weight (g)</Label>\n                <Input\n                  id=\"averageWeight\"\n                  type=\"number\"\n                  step=\"0.1\"\n                  value={averageWeight}\n                  onChange={(e) => setAverageWeight(e.target.value)}\n                  placeholder={selectedFlock ? getWeightSuggestion(chickAge) : \"e.g., 45.5\"}\n                  data-testid=\"input-average-weight\"\n                />\n                {selectedFlock && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    Expected: {getWeightSuggestion(chickAge)}\n                  </p>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"sampleSize\">Sample Size</Label>\n                <Input\n                  id=\"sampleSize\"\n                  type=\"number\"\n                  value={sampleSize}\n                  onChange={(e) => setSampleSize(e.target.value)}\n                  data-testid=\"input-sample-size\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Notes */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Textarea\n              id=\"notes\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              rows={3}\n              placeholder=\"Any additional observations or notes...\"\n              data-testid=\"textarea-notes\"\n            />\n          </div>\n\n          <Button \n            type=\"submit\" \n            disabled={createRecordMutation.isPending}\n            data-testid=\"button-submit-brooding-record\"\n            className=\"w-full\"\n          >\n            {createRecordMutation.isPending ? \"Saving...\" : \"Save Brooding Record\"}\n          </Button>\n        </form>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":16486},"client/src/components/forms/flock-form.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { insertFlockSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { BREED_OPTIONS } from \"@/lib/constants\";\n\n// Create a simple form schema that works with string inputs\nconst flockFormSchema = z.object({\n  name: z.string().min(1, \"Flock name is required\"),\n  breed: z.string().min(1, \"Breed is required\"),\n  initialCount: z.number().min(1, \"Initial count must be at least 1\"),\n  currentCount: z.number().min(0, \"Current count must be at least 0\"),\n  hatchDate: z.string().min(1, \"Hatch date is required\"),\n  status: z.enum([\"brooding\", \"laying\", \"retired\", \"deactivated\"]),\n  farmId: z.string().optional(), // Optional for validation, included for editing\n});\n\ntype FlockFormInputs = z.infer<typeof flockFormSchema>;\n\ninterface FlockFormProps {\n  flock?: any; // For editing existing flock\n  onSuccess?: () => void;\n}\n\nexport default function FlockForm({ flock, onSuccess }: FlockFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const form = useForm<FlockFormInputs>({\n    resolver: zodResolver(flockFormSchema),\n    defaultValues: {\n      name: flock?.name || \"\",\n      breed: flock?.breed || \"\",\n      initialCount: flock?.initialCount || 0,\n      currentCount: flock?.currentCount || 0,\n      hatchDate: flock?.hatchDate ? new Date(flock.hatchDate).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],\n      status: flock?.status || \"brooding\",\n      farmId: flock?.farmId || \"\", // Include farmId for validation (backend will strip it out)\n    },\n  });\n\n  const saveFlockMutation = useMutation({\n    mutationFn: async (data: FlockFormInputs) => {\n      console.log(\"Mutation function called with data:\", data);\n      \n      if (flock) {\n        // Editing existing flock - transform data to match backend expectations\n        const flockData = {\n          name: data.name,\n          breed: data.breed,\n          initialCount: data.initialCount,\n          currentCount: data.currentCount,\n          hatchDate: new Date(data.hatchDate), // Transform string to Date\n          status: data.status,\n        };\n        console.log(\"Making PUT request to:\", `/api/flocks/${flock.id}`);\n        const response = await apiRequest(\"PUT\", `/api/flocks/${flock.id}`, flockData);\n        console.log(\"PUT response:\", response);\n        \n        // Check for silent errors by status\n        if (!response) {\n          throw new Error('Update failed: No response received');\n        }\n        \n        return response;\n      } else {\n        // Creating new flock - transform data to match backend expectations\n        const flockData = {\n          name: data.name,\n          breed: data.breed,\n          initialCount: data.initialCount,\n          currentCount: data.initialCount, // Set current count to initial count for new flocks\n          hatchDate: new Date(data.hatchDate), // Transform string to Date\n          status: data.status,\n        };\n        console.log(\"Making POST request with data:\", flockData);\n        const response = await apiRequest(\"POST\", \"/api/flocks\", flockData);\n        console.log(\"POST response:\", response);\n        return response;\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/flocks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      toast({\n        title: \"Success\",\n        description: flock ? \"Flock updated successfully\" : \"Flock created successfully\",\n      });\n      if (!flock) {\n        form.reset();\n      }\n      onSuccess?.();\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || (flock ? \"Failed to update flock\" : \"Failed to create flock\"),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: FlockFormInputs) => {\n    try {\n      saveFlockMutation.mutate(data);\n    } catch (error) {\n      console.error(\"Error in mutation:\", error);\n    }\n  };\n\n  return (\n    <Card data-testid=\"card-flock-form\">\n      <CardHeader>\n        <CardTitle>{flock ? \"Edit Flock\" : \"Add New Flock\"}</CardTitle>\n        <CardDescription>\n          {flock ? \"Update the details for this flock.\" : \"Create a new flock for your poultry farm. You can track this flock throughout its lifecycle.\"}\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Flock Name</FormLabel>\n                    <FormControl>\n                      <Input \n                        {...field} \n                        placeholder=\"e.g., Batch A 2024\"\n                        data-testid=\"input-flock-name\" \n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"breed\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Breed</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-breed\">\n                          <SelectValue placeholder=\"Select breed\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {BREED_OPTIONS.map((breed) => (\n                          <SelectItem key={breed.value} value={breed.value}>\n                            {breed.label}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"initialCount\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Initial Count</FormLabel>\n                    <FormControl>\n                      <Input \n                        type=\"number\" \n                        {...field} \n                        value={field.value || 0}\n                        onChange={(e) => {\n                          const value = parseInt(e.target.value) || 0;\n                          field.onChange(value);\n                          // Only set current count to initial count for new flocks, not when editing\n                          if (!flock) {\n                            form.setValue(\"currentCount\", value);\n                          }\n                        }}\n                        data-testid=\"input-initial-count\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"hatchDate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Hatch Date</FormLabel>\n                    <FormControl>\n                      <Input type=\"date\" {...field} data-testid=\"input-hatch-date\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <FormField\n              control={form.control}\n              name=\"status\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Status</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"select-status\">\n                        <SelectValue placeholder=\"Select status\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"brooding\">Brooding</SelectItem>\n                      <SelectItem value=\"laying\">Laying</SelectItem>\n                      <SelectItem value=\"retired\">Retired</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <Button \n              type=\"submit\" \n              disabled={saveFlockMutation.isPending}\n              data-testid=\"button-submit-flock\"\n            >\n              {saveFlockMutation.isPending ? (flock ? \"Updating...\" : \"Creating...\") : (flock ? \"Update Flock\" : \"Create Flock\")}\n            </Button>\n          </form>\n        </Form>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":9720},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/pages/home.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport MetricCard from \"@/components/dashboard/metric-card\";\nimport AlertPanel from \"@/components/dashboard/alert-panel\";\nimport SimpleQuickActions from \"@/components/dashboard/simple-quick-actions\";\nimport ActivityFeed from \"@/components/dashboard/activity-feed\";\nimport PerformanceSummary from \"@/components/dashboard/performance-summary\";\nimport ComprehensiveDailyRecordForm from \"@/components/forms/comprehensive-daily-record-form\";\nimport NotificationPanel from \"@/components/dashboard/notification-panel\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Bell, Menu, Plus, ClipboardList, AlertCircle, RefreshCw, Thermometer, Sun, Utensils, Scale } from \"lucide-react\";\nimport { z } from \"zod\";\nimport SimpleQuickEggForm from \"@/components/forms/simple-quick-egg-form\";\nimport SalesForm from \"@/components/forms/SalesForm\";\n\n// Schema for quick egg entry\nconst eggEntrySchema = z.object({\n  flockId: z.string().min(1, \"Flock selection is required\"),\n  eggsCollected: z.number().min(0, \"Eggs collected must be non-negative\"),\n  brokenEggs: z.number().min(0).default(0),\n  recordDate: z.string().min(1, \"Date is required\"),\n  notes: z.string().optional(),\n});\n\ntype EggEntryData = z.infer<typeof eggEntrySchema>;\n\nexport default function Home() {\n  const { toast } = useToast();\n  const { user, isLoading, isAuthenticated } = useAuth();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [eggDialogOpen, setEggDialogOpen] = useState(false);\n  const [salesDialogOpen, setSalesDialogOpen] = useState(false);\n  const [dailyRecordDialogOpen, setDailyRecordDialogOpen] = useState(false);\n  const queryClient = useQueryClient();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: metrics = {}, error: metricsError, isLoading: metricsLoading } = useQuery<any>({\n    queryKey: [\"/api/dashboard/metrics\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/dashboard/metrics?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch metrics');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: activity = [], error: activityError, isLoading: activityLoading } = useQuery<any[]>({\n    queryKey: [\"/api/dashboard/activity\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/dashboard/activity?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch activity');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/flocks?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch flocks');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  const { data: dailyRecords = [] } = useQuery<any[]>({\n    queryKey: [\"/api/daily-records\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/daily-records?farmId=${activeFarmId}`);\n      if (!response.ok) throw new Error('Failed to fetch daily records');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Calculate weekly mortality (last 7 days)\n  const calculateWeeklyMortality = () => {\n    const today = new Date();\n    const sevenDaysAgo = new Date(today);\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\n    \n    const weeklyMortality = dailyRecords\n      .filter(record => {\n        const recordDate = new Date(record.recordDate);\n        return recordDate >= sevenDaysAgo && recordDate <= today;\n      })\n      .reduce((sum, record) => sum + (record.mortalityCount || 0), 0);\n    \n    return weeklyMortality;\n  };\n\n  const weeklyMortality = calculateWeeklyMortality();\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if (metricsError && isUnauthorizedError(metricsError)) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [metricsError, toast]);\n\n  // Egg entry form\n  const eggForm = useForm<EggEntryData>({\n    resolver: zodResolver(eggEntrySchema),\n    defaultValues: {\n      flockId: \"\",\n      eggsCollected: 0,\n      brokenEggs: 0,\n      recordDate: new Date().toISOString().split('T')[0],\n      notes: \"\",\n    },\n  });\n\n  const createEggRecordMutation = useMutation({\n    mutationFn: async (data: EggEntryData) => {\n      const recordData = {\n        flockId: data.flockId,\n        recordDate: data.recordDate,\n        eggsCollected: data.eggsCollected,\n        brokenEggs: data.brokenEggs,\n        cratesProduced: Math.floor(data.eggsCollected / 30),\n        mortalityCount: 0,\n        mortalityReason: null,\n        feedConsumed: null,\n        feedType: null,\n        temperature: null,\n        lightingHours: null,\n        averageWeight: null,\n        sampleSize: 0,\n        notes: data.notes || \"\",\n      };\n      await apiRequest(\"POST\", \"/api/daily-records\", recordData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\", activeFarmId] });\n      toast({\n        title: \"Success\",\n        description: \"Egg collection recorded successfully\",\n      });\n      eggForm.reset();\n      setEggDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to record eggs\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmitEggs = (data: EggEntryData) => {\n    createEggRecordMutation.mutate(data);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading dashboard...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  const currentDate = new Date().toLocaleDateString('en-US', {\n    weekday: 'long',\n    year: 'numeric',\n    month: 'long',\n    day: 'numeric',\n  });\n\n  // Calculate week number (ISO week)\n  const getWeekNumber = (date: Date) => {\n    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\n    const dayNum = d.getUTCDay() || 7;\n    d.setUTCDate(d.getUTCDate() + 4 - dayNum);\n    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n    return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);\n  };\n\n  const weekNumber = getWeekNumber(new Date());\n\n  // Get primary flock (oldest active flock) for age calculation - non-mutating\n  const primaryFlock = flocks.length > 0 \n    ? [...flocks].sort((a, b) => new Date(a.hatchDate).getTime() - new Date(b.hatchDate).getTime())[0]\n    : null;\n\n  const getFlockAge = (hatchDate: string) => {\n    const today = new Date();\n    const hatch = new Date(hatchDate);\n    const diffTime = today.getTime() - hatch.getTime();\n    return Math.floor(diffTime / (1000 * 60 * 60 * 24));\n  };\n\n  const flockAge = primaryFlock ? getFlockAge(primaryFlock.hatchDate) : null;\n  const flockWeekAge = flockAge !== null ? Math.max(1, Math.floor((flockAge - 1) / 7) + 1) : null;\n\n  // Get weekly targets based on flock age (matches brooding schedule)\n  const getWeeklyTargets = (age: number | null) => {\n    if (age === null || age === undefined) return null;\n    \n    // Calculate the current week number with boundary-safe formula\n    const currentWeek = Math.max(1, Math.floor((age - 1) / 7) + 1);\n    \n    // Week-indexed lookup map for specific targets\n    const WEEKLY_TARGETS: Record<number, {\n      temperature: string;\n      lighting: string;\n      feedType: string;\n      feedAmount: string;\n      expectedWeight: string;\n      weekLabel: string;\n    }> = {\n      1: {\n        temperature: \"35-32°C\",\n        lighting: \"24 hours\",\n        feedType: \"Chick and Duck Mash\",\n        feedAmount: \"12g per bird\",\n        expectedWeight: \"40-60g\",\n        weekLabel: \"Week 1: Critical Care\"\n      },\n      2: {\n        temperature: \"32-29°C\",\n        lighting: \"20 hours\",\n        feedType: \"Chick and Duck Mash\",\n        feedAmount: \"18g per bird\",\n        expectedWeight: \"85-120g\",\n        weekLabel: \"Week 2: Rapid Growth\"\n      },\n      3: {\n        temperature: \"29-26°C\",\n        lighting: \"16 hours\",\n        feedType: \"Chick and Duck Mash\",\n        feedAmount: \"25g per bird\",\n        expectedWeight: \"150-200g\",\n        weekLabel: \"Week 3: Development\"\n      },\n      4: {\n        temperature: \"26-23°C\",\n        lighting: \"14 hours\",\n        feedType: \"Chick and Duck Mash\",\n        feedAmount: \"31g per bird\",\n        expectedWeight: \"220-300g\",\n        weekLabel: \"Week 4: Feather Development\"\n      },\n      5: {\n        temperature: \"23-21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Chick and Duck Mash\",\n        feedAmount: \"38g per bird\",\n        expectedWeight: \"380-400g\",\n        weekLabel: \"Week 5: Steady Growth\"\n      },\n      6: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Chick and Duck Mash\",\n        feedAmount: \"41g per bird\",\n        expectedWeight: \"470-500g\",\n        weekLabel: \"Week 6: Grower Prep\"\n      },\n      7: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Chick and Duck Mash\",\n        feedAmount: \"45g per bird\",\n        expectedWeight: \"560-600g\",\n        weekLabel: \"Week 7: Transition Prep\"\n      },\n      8: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Gradual change to Growers Mash\",\n        feedAmount: \"49g per bird\",\n        expectedWeight: \"650g\",\n        weekLabel: \"Week 8: Feed Transition\"\n      },\n      9: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Growers Mash\",\n        feedAmount: \"52g per bird\",\n        expectedWeight: \"740g\",\n        weekLabel: \"Week 9: Growth Phase\"\n      },\n      10: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Growers Mash\",\n        feedAmount: \"60g per bird\",\n        expectedWeight: \"830-870g\",\n        weekLabel: \"Week 10: Growth Phase\"\n      },\n      11: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Growers Mash\",\n        feedAmount: \"65g per bird\",\n        expectedWeight: \"920g\",\n        weekLabel: \"Week 11: Growth Phase\"\n      },\n      12: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Growers Mash\",\n        feedAmount: \"75g per bird\",\n        expectedWeight: \"1050g\",\n        weekLabel: \"Week 12: Growth Phase\"\n      },\n      13: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Growers Mash\",\n        feedAmount: \"80g per bird\",\n        expectedWeight: \"1100g\",\n        weekLabel: \"Week 13: Pre-Layer Development\"\n      },\n      14: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Growers Mash\",\n        feedAmount: \"86g per bird\",\n        expectedWeight: \"1210g\",\n        weekLabel: \"Week 14: Pre-Layer Development\"\n      },\n      15: {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Growers Mash\",\n        feedAmount: \"92g per bird\",\n        expectedWeight: \"1320g\",\n        weekLabel: \"Week 15: Pre-Layer Development\"\n      }\n    };\n    \n    // For week 16+, return a dynamic label based on the actual week\n    if (currentWeek >= 16) {\n      return {\n        temperature: \"21°C\",\n        lighting: \"14 hours\",\n        feedType: \"Layers Mash\",\n        feedAmount: \"100-120g per bird\",\n        expectedWeight: \"1355-1750g\",\n        weekLabel: `Week ${currentWeek}: Layer Phase`\n      };\n    }\n    \n    // Return the specific week's targets\n    return WEEKLY_TARGETS[currentWeek] || null;\n  };\n\n  const weeklyTargets = getWeeklyTargets(flockAge);\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n          data-testid=\"mobile-overlay\"\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Top Navigation Bar */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Farm Dashboard</h2>\n                <p className=\"text-sm text-muted-foreground\">{currentDate}</p>\n                <div className=\"flex items-center gap-3 mt-1\">\n                  <p className=\"text-xs text-muted-foreground\" data-testid=\"text-week-number\">\n                    Week {weekNumber} of {new Date().getFullYear()}\n                  </p>\n                  {flockAge !== null && (\n                    <>\n                      <span className=\"text-xs text-muted-foreground\">•</span>\n                      <p className=\"text-xs text-muted-foreground\" data-testid=\"text-flock-age\">\n                        Flock Age: {flockAge} days (Week {flockWeekAge})\n                      </p>\n                    </>\n                  )}\n                </div>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center space-x-4\">\n              {/* Alerts/Notifications */}\n              <NotificationPanel />\n              \n              {/* Quick Actions */}\n              <div className=\"hidden sm:flex items-center space-x-2\">\n                <Dialog open={eggDialogOpen} onOpenChange={setEggDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button variant=\"secondary\" size=\"sm\" data-testid=\"button-add-eggs\">\n                      <Plus className=\"h-4 w-4 mr-1\" />\n                      Add Eggs\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-md\">\n                    <DialogHeader>\n                      <DialogTitle>Quick Egg Entry</DialogTitle>\n                      <DialogDescription>\n                        Record today's egg collection quickly\n                      </DialogDescription>\n                    </DialogHeader>\n                    <SimpleQuickEggForm onSuccess={() => setEggDialogOpen(false)} />\n                  </DialogContent>\n                </Dialog>\n\n                <Dialog open={salesDialogOpen} onOpenChange={setSalesDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button variant=\"secondary\" size=\"sm\" data-testid=\"button-add-sales\">\n                      <Plus className=\"h-4 w-4 mr-1\" />\n                      Quick Sale\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-md\">\n                    <DialogHeader>\n                      <DialogTitle>Quick Sales Entry</DialogTitle>\n                      <DialogDescription>\n                        Record a sale quickly from the dashboard\n                      </DialogDescription>\n                    </DialogHeader>\n                    <SalesForm \n                      mode=\"dialog\"\n                      compact={true}\n                      customerNameRequired={false}\n                      showNotes={false}\n                      onSuccess={() => {\n                        setSalesDialogOpen(false);\n                        queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\", activeFarmId] });\n                        queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\", activeFarmId] });\n                        queryClient.invalidateQueries({ queryKey: [\"/api/sales\", activeFarmId] });\n                      }}\n                    />\n                  </DialogContent>\n                </Dialog>\n                \n                <Dialog open={dailyRecordDialogOpen} onOpenChange={setDailyRecordDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button size=\"sm\" data-testid=\"button-daily-record\">\n                      <ClipboardList className=\"h-4 w-4 mr-1\" />\n                      Daily Record\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n                    <DialogHeader>\n                      <DialogTitle>Complete Daily Record</DialogTitle>\n                      <DialogDescription>\n                        Record comprehensive daily farm activities including eggs, mortality, feed, and environmental data\n                      </DialogDescription>\n                    </DialogHeader>\n                    <ComprehensiveDailyRecordForm onSuccess={() => setDailyRecordDialogOpen(false)} />\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </div>\n          </div>\n        </header>\n\n        {/* Dashboard Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          {/* Key Metrics Cards */}\n          {metricsLoading ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n              {[1, 2, 3, 4].map((i) => (\n                <Card key={i} data-testid={`card-metric-loading-${i}`}>\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center justify-between animate-pulse\">\n                      <div className=\"space-y-2\">\n                        <div className=\"h-4 w-20 bg-muted rounded\"></div>\n                        <div className=\"h-6 w-16 bg-muted rounded\"></div>\n                        <div className=\"h-3 w-24 bg-muted rounded\"></div>\n                      </div>\n                      <div className=\"w-12 h-12 bg-muted rounded-lg\"></div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : metricsError && !isUnauthorizedError(metricsError) ? (\n            <Card data-testid=\"card-metrics-error\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-center space-x-3 text-center\">\n                  <AlertCircle className=\"h-8 w-8 text-destructive\" />\n                  <div>\n                    <p className=\"text-sm font-medium text-foreground\">Failed to load dashboard metrics</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {metricsError.message || \"Unable to fetch farm data. Please try again.\"}\n                    </p>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      className=\"mt-2\"\n                      onClick={() => queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] })}\n                      data-testid=\"button-retry-metrics\"\n                    >\n                      <RefreshCw className=\"h-4 w-4 mr-1\" />\n                      Retry\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n              <MetricCard\n                title=\"Total Birds\"\n                value={metrics?.totalBirds || 0}\n                subtitle={`${weeklyMortality} mortality this week`}\n                icon=\"dove\"\n                color=\"primary\"\n              />\n              <MetricCard\n                title=\"Today's Eggs\"\n                value={metrics?.todayEggs || 0}\n                subtitle={`↗ ${metrics?.layingRate || 0}% laying rate`}\n                icon=\"egg\"\n                color=\"chart-3\"\n              />\n              <MetricCard\n                title=\"Feed Stock\"\n                value={`${((metrics?.totalFeedStock || 0) / 1000).toFixed(1)} tons`}\n                subtitle={\n                  metrics?.feedDaysRemaining !== undefined\n                    ? metrics.feedDaysRemaining < 7\n                      ? `⚠ ${metrics.feedDaysRemaining} ${metrics.feedDaysRemaining === 1 ? 'day' : 'days'} remaining`\n                      : `${metrics.feedDaysRemaining} ${metrics.feedDaysRemaining === 1 ? 'day' : 'days'} remaining`\n                    : \"No data\"\n                }\n                icon=\"wheat\"\n                color=\"orange\"\n              />\n              <MetricCard\n                title=\"Monthly Revenue\"\n                value={`KSh ${metrics?.monthlyRevenue?.toLocaleString() || 0}`}\n                subtitle={\n                  metrics?.revenueChange \n                    ? `${parseFloat(metrics.revenueChange) >= 0 ? '↗' : '↘'} ${parseFloat(metrics.revenueChange) >= 0 ? '+' : ''}${metrics.revenueChange}% from last month`\n                    : \"No previous data\"\n                }\n                icon=\"coins\"\n                color=\"green\"\n              />\n            </div>\n          )}\n\n          {/* Weekly Targets & Requirements */}\n          {weeklyTargets && (\n            <div>\n              <div className=\"flex items-center justify-between mb-4\">\n                <h3 className=\"text-lg font-semibold text-foreground\">This Week's Targets</h3>\n                <p className=\"text-sm text-muted-foreground\">{weeklyTargets.weekLabel}</p>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <Card data-testid=\"card-target-temperature\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start space-x-3\">\n                      <div className=\"p-2 bg-red-100 dark:bg-red-900/20 rounded-lg\">\n                        <Thermometer className=\"h-5 w-5 text-red-600 dark:text-red-400\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-xs text-muted-foreground\">Temperature</p>\n                        <p className=\"text-sm font-semibold text-foreground mt-1\">{weeklyTargets.temperature}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-target-lighting\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start space-x-3\">\n                      <div className=\"p-2 bg-yellow-100 dark:bg-yellow-900/20 rounded-lg\">\n                        <Sun className=\"h-5 w-5 text-yellow-600 dark:text-yellow-400\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-xs text-muted-foreground\">Lighting</p>\n                        <p className=\"text-sm font-semibold text-foreground mt-1\">{weeklyTargets.lighting}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-target-feed\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start space-x-3\">\n                      <div className=\"p-2 bg-green-100 dark:bg-green-900/20 rounded-lg\">\n                        <Utensils className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-xs text-muted-foreground\">Feed Amount</p>\n                        <p className=\"text-sm font-semibold text-foreground mt-1\">{weeklyTargets.feedAmount}</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">{weeklyTargets.feedType}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-target-weight\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start space-x-3\">\n                      <div className=\"p-2 bg-blue-100 dark:bg-blue-900/20 rounded-lg\">\n                        <Scale className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-xs text-muted-foreground\">Expected Weight</p>\n                        <p className=\"text-sm font-semibold text-foreground mt-1\">{weeklyTargets.expectedWeight}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n          )}\n\n          {/* Alerts & Quick Actions */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            <div className=\"lg:col-span-2\">\n              <AlertPanel />\n            </div>\n            <SimpleQuickActions />\n          </div>\n\n          {/* Charts Section */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            {/* Egg Production Chart */}\n            <Card data-testid=\"card-egg-production-chart\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle>Egg Production Trend</CardTitle>\n                  <select className=\"text-sm border border-border rounded-md px-3 py-1 bg-background\">\n                    <option>Last 7 days</option>\n                    <option>Last 30 days</option>\n                    <option>Last 3 months</option>\n                  </select>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-80 bg-muted/20 rounded-lg flex items-center justify-center\">\n                  <div className=\"text-center\">\n                    <div className=\"text-4xl text-muted-foreground mb-2\">📊</div>\n                    <p className=\"text-sm text-muted-foreground\">Egg Production Chart</p>\n                    <p className=\"text-xs text-muted-foreground\">Daily production: 4,200-4,800 eggs</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Feed Consumption Chart */}\n            <Card data-testid=\"card-feed-consumption-chart\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle>Feed Consumption</CardTitle>\n                  <select className=\"text-sm border border-border rounded-md px-3 py-1 bg-background\">\n                    <option>Last 7 days</option>\n                    <option>Last 30 days</option>\n                  </select>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-80 bg-muted/20 rounded-lg flex items-center justify-center\">\n                  <div className=\"text-center\">\n                    <div className=\"text-4xl text-muted-foreground mb-2\">📊</div>\n                    <p className=\"text-sm text-muted-foreground\">Feed Consumption Chart</p>\n                    <p className=\"text-xs text-muted-foreground\">Daily average: 530kg</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Recent Activity & Performance Summary */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            <div className=\"lg:col-span-2\">\n              {activityLoading ? (\n                <Card data-testid=\"card-activity-loading\">\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle>Recent Activity</CardTitle>\n                      <div className=\"h-6 w-16 bg-muted rounded animate-pulse\"></div>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      {[1, 2, 3].map((i) => (\n                        <div key={i} className=\"flex items-start space-x-3 animate-pulse\">\n                          <div className=\"w-8 h-8 bg-muted rounded-full\"></div>\n                          <div className=\"flex-1 space-y-2\">\n                            <div className=\"h-4 w-3/4 bg-muted rounded\"></div>\n                            <div className=\"h-3 w-20 bg-muted rounded\"></div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              ) : activityError && !isUnauthorizedError(activityError) ? (\n                <Card data-testid=\"card-activity-error\">\n                  <CardHeader>\n                    <CardTitle>Recent Activity</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex items-center justify-center space-x-3 text-center py-8\">\n                      <AlertCircle className=\"h-8 w-8 text-destructive\" />\n                      <div>\n                        <p className=\"text-sm font-medium text-foreground\">Failed to load recent activity</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          {activityError.message || \"Unable to fetch activity data. Please try again.\"}\n                        </p>\n                        <Button \n                          variant=\"outline\" \n                          size=\"sm\" \n                          className=\"mt-2\"\n                          onClick={() => queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] })}\n                          data-testid=\"button-retry-activity\"\n                        >\n                          <RefreshCw className=\"h-4 w-4 mr-1\" />\n                          Retry\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ) : (\n                <ActivityFeed activity={activity || []} />\n              )}\n            </div>\n            <PerformanceSummary />\n          </div>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":32323},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"client/src/components/welcome-panel.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Sprout, Shield, Users, ShoppingCart, Settings } from \"lucide-react\";\nimport { useAuth } from \"@/contexts/AuthContext\";\n\ninterface WelcomePanelProps {\n  onDashboardClick: () => void;\n}\n\nexport default function WelcomePanel({ onDashboardClick }: WelcomePanelProps) {\n  const { user } = useAuth();\n\n  const getRoleInfo = (role: string) => {\n    switch (role) {\n      case 'admin':\n        return {\n          icon: Shield,\n          description: \"You have full system access to manage all farms, users, and system settings across the platform.\",\n          color: \"text-red-600 dark:text-red-400\"\n        };\n      case 'farm_owner':\n        return {\n          icon: Sprout,\n          description: \"You can manage your farm operations, view reports, and oversee staff activities for your poultry farm.\",\n          color: \"text-green-600 dark:text-green-400\"\n        };\n      case 'manager':\n        return {\n          icon: Users,\n          description: \"You can supervise daily operations, manage staff, and monitor farm performance and productivity.\",\n          color: \"text-blue-600 dark:text-blue-400\"\n        };\n      case 'staff':\n        return {\n          icon: Settings,\n          description: \"You can record daily activities, track production data, and manage routine farm operations.\",\n          color: \"text-purple-600 dark:text-purple-400\"\n        };\n      case 'customer':\n        return {\n          icon: ShoppingCart,\n          description: \"You can browse products, place orders, and manage your purchases from our marketplace.\",\n          color: \"text-orange-600 dark:text-orange-400\"\n        };\n      default:\n        return {\n          icon: Users,\n          description: \"Welcome to KukuHub! Your account is being set up.\",\n          color: \"text-gray-600 dark:text-gray-400\"\n        };\n    }\n  };\n\n  const roleInfo = getRoleInfo(user?.role || '');\n  const IconComponent = roleInfo.icon;\n\n  // Get user's display name\n  const userName = user?.firstName && user?.lastName \n    ? `${user.firstName} ${user.lastName}`\n    : user?.email?.split('@')[0] || 'User';\n\n  return (\n    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\" data-testid=\"welcome-panel-overlay\">\n      <Card className=\"max-w-lg mx-4 animate-in fade-in-0 zoom-in-95 duration-300\" data-testid=\"welcome-panel\">\n        <CardHeader className=\"text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <div className={`w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center`}>\n              <IconComponent className={`w-8 h-8 ${roleInfo.color}`} />\n            </div>\n          </div>\n          <CardTitle className=\"text-2xl\">Welcome, {userName}!</CardTitle>\n          <CardDescription className=\"text-base capitalize\">\n            You are signed in as a <span className={`font-medium ${roleInfo.color}`}>{user?.role?.replace('_', ' ')}</span>\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <p className=\"text-sm text-muted-foreground text-center\">\n            {roleInfo.description}\n          </p>\n          \n          <Button \n            onClick={onDashboardClick} \n            className=\"w-full\" \n            size=\"lg\"\n            data-testid=\"button-go-to-dashboard\"\n          >\n            Go to Dashboard\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":3545},"server/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nif (!process.env.REPLIT_DOMAINS) {\n  throw new Error(\"Environment variable REPLIT_DOMAINS not provided\");\n}\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n    role: claims[\"role\"], // Include role from OIDC claims\n  });\n  \n  // Auto-link any existing customer profiles with matching email\n  // This handles cases where customers registered via public endpoint before logging in\n  await storage.linkCustomerByEmail(claims[\"email\"], claims[\"sub\"]);\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  for (const domain of process.env\n    .REPLIT_DOMAINS!.split(\",\")) {\n    const strategy = new Strategy(\n      {\n        name: `replitauth:${domain}`,\n        config,\n        scope: \"openid email profile offline_access\",\n        callbackURL: `https://${domain}/api/callback`,\n      },\n      verify,\n    );\n    passport.use(strategy);\n  }\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    // Store returnTo in session for callback redirect\n    if (req.query.returnTo) {\n      (req.session as any).returnTo = req.query.returnTo;\n    }\n    \n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: (req.session as any)?.returnTo || \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","size_bytes":4695},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/components/dashboard/activity-feed.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Egg, Skull, Wheat, Coins } from \"lucide-react\";\n\ninterface ActivityItem {\n  id: string;\n  type: string;\n  description: string;\n  createdAt: string;\n  userId?: string;\n}\n\ninterface ActivityFeedProps {\n  activity: ActivityItem[];\n}\n\nconst activityIcons = {\n  daily_record: Egg,\n  mortality: Skull,\n  feed: Wheat,\n  sale: Coins,\n};\n\nconst activityColors = {\n  daily_record: \"bg-chart-3/10 text-chart-3\",\n  mortality: \"bg-red-100 text-red-600\",\n  feed: \"bg-orange-100 text-orange-600\",\n  sale: \"bg-green-100 text-green-600\",\n};\n\nexport default function ActivityFeed({ activity }: ActivityFeedProps) {\n  const formatTimeAgo = (dateString: string) => {\n    const date = new Date(dateString);\n    const now = new Date();\n    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));\n    \n    if (diffInMinutes < 60) {\n      return `${diffInMinutes} minutes ago`;\n    }\n    \n    const diffInHours = Math.floor(diffInMinutes / 60);\n    if (diffInHours < 24) {\n      return `${diffInHours} hours ago`;\n    }\n    \n    return date.toLocaleDateString();\n  };\n\n  const getActivityIcon = (type: string) => {\n    return activityIcons[type as keyof typeof activityIcons] || Egg;\n  };\n\n  const getActivityColor = (type: string) => {\n    return activityColors[type as keyof typeof activityColors] || \"bg-muted text-muted-foreground\";\n  };\n\n  return (\n    <Card data-testid=\"card-activity-feed\">\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle>Recent Activity</CardTitle>\n          <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-view-all-activity\">\n            View all\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {activity.length === 0 ? (\n          <div className=\"text-center py-8\">\n            <p className=\"text-muted-foreground\">No recent activity</p>\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\n            {activity.slice(0, 4).map((item) => {\n              const Icon = getActivityIcon(item.type);\n              const colorClass = getActivityColor(item.type);\n\n              return (\n                <div key={item.id} className=\"flex items-start space-x-3\" data-testid={`activity-${item.id}`}>\n                  <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${colorClass}`}>\n                    <Icon className=\"h-4 w-4\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm text-foreground\">{item.description}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatTimeAgo(item.createdAt)}</p>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":2939},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });","size_bytes":482},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1128},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1419},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/pages/expenses.tsx":{"content":"import { useEffect, useState, useMemo } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport Sidebar from \"@/components/layout/sidebar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Receipt, TrendingUp, Calendar, AlertCircle, Plus, Menu, DollarSign } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { insertExpenseSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  AreaChart,\n  Area,\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n} from \"recharts\";\n\n// Expense form schema - use the actual database schema for consistency\nconst expenseFormSchema = insertExpenseSchema.pick({\n  expenseDate: true,\n  category: true, \n  description: true,\n  amount: true,\n  supplier: true,\n  receiptNumber: true,\n  notes: true,\n}).extend({\n  // Override date field to handle string input from HTML date inputs\n  expenseDate: z.string().min(1, \"Expense date is required\"),\n  // Override amount to handle string input like health record pattern\n  amount: z.string().min(1, \"Amount is required\").refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\n    \"Invalid amount - must be a positive number\"\n  ),\n});\n\ntype ExpenseFormData = z.infer<typeof expenseFormSchema>;\n\nexport default function Expenses() {\n  const { toast } = useToast();\n  const { isLoading, isAuthenticated } = useAuth();\n  const { activeFarmId, hasActiveFarm, error: farmError } = useFarmContext();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [expenseDialogOpen, setExpenseDialogOpen] = useState(false);\n  const queryClient = useQueryClient();\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: expenses = [], error: expensesError } = useQuery<any[]>({\n    queryKey: [\"/api/expenses\", activeFarmId],\n    queryFn: async () => {\n      const response = await fetch(`/api/expenses?farmId=${activeFarmId}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch expenses');\n      return response.json();\n    },\n    enabled: isAuthenticated && hasActiveFarm && !!activeFarmId,\n  });\n\n  // Handle unauthorized errors\n  useEffect(() => {\n    if (expensesError && isUnauthorizedError(expensesError)) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [expensesError, toast]);\n\n  const expenseForm = useForm<ExpenseFormData>({\n    resolver: zodResolver(expenseFormSchema),\n    defaultValues: {\n      expenseDate: new Date().toISOString().split('T')[0],\n      category: \"feed\",\n      description: \"\",\n      amount: \"\",\n      supplier: \"\",\n      receiptNumber: \"\",\n      notes: \"\",\n    },\n  });\n\n  const createExpenseMutation = useMutation({\n    mutationFn: async (data: ExpenseFormData) => {\n      // Include farmId for admin users, server will handle type coercion\n      const payload = { ...data, farmId: activeFarmId };\n      await apiRequest(\"POST\", \"/api/expenses\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/expenses\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\", activeFarmId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\", activeFarmId] });\n      toast({\n        title: \"Success\",\n        description: \"Expense recorded successfully\",\n      });\n      expenseForm.reset();\n      setExpenseDialogOpen(false);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to record expense\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading expenses...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  // Calculate expense metrics\n  const totalExpenses = expenses?.reduce((sum: number, expense: any) => sum + parseFloat(expense.amount || '0'), 0) || 0;\n  \n  const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];\n  const monthExpenses = expenses?.filter((expense: any) => expense.expenseDate >= monthStart) || [];\n  const monthlyTotal = monthExpenses.reduce((sum: number, expense: any) => sum + parseFloat(expense.amount || '0'), 0);\n\n  const weekStart = new Date();\n  weekStart.setDate(weekStart.getDate() - 7);\n  const weekExpenses = expenses?.filter((expense: any) => new Date(expense.expenseDate) >= weekStart) || [];\n  const weeklyTotal = weekExpenses.reduce((sum: number, expense: any) => sum + parseFloat(expense.amount || '0'), 0);\n\n  // Category breakdown\n  const categoryTotals = expenses?.reduce((acc: any, expense: any) => {\n    const category = expense.category || 'other';\n    acc[category] = (acc[category] || 0) + parseFloat(expense.amount || '0');\n    return acc;\n  }, {}) || {};\n\n  const topCategories = Object.entries(categoryTotals)\n    .sort(([,a], [,b]) => (b as number) - (a as number))\n    .slice(0, 4);\n\n  const onSubmitExpense = (data: ExpenseFormData) => {\n    // Early guard: Prevent submission without active farm\n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select a farm before adding expenses\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createExpenseMutation.mutate(data);\n  };\n\n  const getCategoryIcon = (category: string) => {\n    switch (category) {\n      case 'feed': return '🌾';\n      case 'medication': return '💊';\n      case 'labor': return '👥';\n      case 'utilities': return '⚡';\n      case 'equipment': return '🔧';\n      default: return '📄';\n    }\n  };\n\n  const getCategoryColor = (category: string) => {\n    switch (category) {\n      case 'feed': return 'bg-orange-100 text-orange-600';\n      case 'medication': return 'bg-red-100 text-red-600';\n      case 'labor': return 'bg-blue-100 text-blue-600';\n      case 'utilities': return 'bg-green-100 text-green-600';\n      case 'equipment': return 'bg-purple-100 text-purple-600';\n      default: return 'bg-gray-100 text-gray-600';\n    }\n  };\n\n  // Monthly expense aggregation for trend chart (last 12 calendar months)\n  const monthlyExpenseTrends = useMemo(() => {\n    // Helper to get stable month key (yyyy-mm format) using UTC\n    const getMonthKey = (date: Date): string => {\n      const year = date.getUTCFullYear();\n      const month = String(date.getUTCMonth() + 1).padStart(2, '0');\n      return `${year}-${month}`;\n    };\n\n    // Helper to format month for display\n    const formatMonthDisplay = (monthKey: string): string => {\n      const [year, month] = monthKey.split('-');\n      const date = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, 1));\n      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', timeZone: 'UTC' });\n    };\n\n    // Calculate trailing 12 calendar months in UTC\n    const now = new Date();\n    const nowUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));\n    \n    // Generate last 12 calendar months using UTC\n    const monthKeys: string[] = [];\n    const startDate = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth() - 11, 1));\n    \n    for (let i = 0; i < 12; i++) {\n      const monthDate = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth() + i, 1));\n      monthKeys.push(getMonthKey(monthDate));\n    }\n    \n    // Date range for filtering (start of first month to end of last month)\n    const startOfTrailingPeriod = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), 1));\n    const endOfCurrentMonth = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth() + 1, 0, 23, 59, 59, 999));\n\n    // Aggregate actual expenses by month with explicit date range filtering\n    const monthlyData: { [key: string]: number } = {};\n    if (expenses && expenses.length > 0) {\n      expenses.forEach((expense: any) => {\n        // Parse expense date - handle both date-only (YYYY-MM-DD) and ISO timestamp formats\n        const dateStr = expense.expenseDate;\n        const expenseDate = dateStr.includes('T') \n          ? new Date(dateStr) // Already has time component\n          : new Date(`${dateStr}T00:00:00Z`); // Add UTC time for date-only strings\n        \n        // Only include if within trailing 12 months date range\n        if (expenseDate >= startOfTrailingPeriod && expenseDate <= endOfCurrentMonth) {\n          const monthKey = getMonthKey(expenseDate);\n          monthlyData[monthKey] = (monthlyData[monthKey] || 0) + parseFloat(expense.amount || '0');\n        }\n      });\n    }\n\n    // Create final dataset with zero-filled months\n    return monthKeys.map(monthKey => ({\n      monthKey,\n      month: formatMonthDisplay(monthKey),\n      amount: monthlyData[monthKey] || 0,\n    }));\n  }, [expenses]);\n\n  // Category trends aggregation (last 6 months by category)\n  const categoryTrendsData = useMemo(() => {\n    const getMonthKey = (date: Date): string => {\n      const year = date.getUTCFullYear();\n      const month = String(date.getUTCMonth() + 1).padStart(2, '0');\n      return `${year}-${month}`;\n    };\n\n    const formatMonthDisplay = (monthKey: string): string => {\n      const [year, month] = monthKey.split('-');\n      const date = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, 1));\n      return date.toLocaleDateString('en-US', { month: 'short', timeZone: 'UTC' });\n    };\n\n    // Calculate last 6 calendar months in UTC\n    const now = new Date();\n    const nowUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));\n    const startDate = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth() - 5, 1));\n    \n    const monthKeys: string[] = [];\n    for (let i = 0; i < 6; i++) {\n      const monthDate = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth() + i, 1));\n      monthKeys.push(getMonthKey(monthDate));\n    }\n    \n    const startOfTrailingPeriod = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), 1));\n    const endOfCurrentMonth = new Date(Date.UTC(nowUTC.getUTCFullYear(), nowUTC.getUTCMonth() + 1, 0, 23, 59, 59, 999));\n\n    // Aggregate by month AND category\n    const monthCategoryData: { [key: string]: { [category: string]: number } } = {};\n    const allCategories = new Set<string>();\n    \n    if (expenses && expenses.length > 0) {\n      expenses.forEach((expense: any) => {\n        const dateStr = expense.expenseDate;\n        const expenseDate = dateStr.includes('T') \n          ? new Date(dateStr)\n          : new Date(`${dateStr}T00:00:00Z`);\n        \n        if (expenseDate >= startOfTrailingPeriod && expenseDate <= endOfCurrentMonth) {\n          const monthKey = getMonthKey(expenseDate);\n          const category = expense.category || 'other';\n          allCategories.add(category);\n          \n          if (!monthCategoryData[monthKey]) {\n            monthCategoryData[monthKey] = {};\n          }\n          monthCategoryData[monthKey][category] = \n            (monthCategoryData[monthKey][category] || 0) + parseFloat(expense.amount || '0');\n        }\n      });\n    }\n\n    // Build final dataset with all categories for each month\n    return monthKeys.map(monthKey => {\n      const dataPoint: any = {\n        monthKey,\n        month: formatMonthDisplay(monthKey),\n      };\n      \n      // Add each category as a separate field\n      allCategories.forEach(category => {\n        dataPoint[category] = monthCategoryData[monthKey]?.[category] || 0;\n      });\n      \n      return dataPoint;\n    });\n  }, [expenses]);\n\n  return (\n    <div className=\"min-h-screen flex bg-background\">\n      <Sidebar isOpen={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />\n      \n      {/* Mobile overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      {/* Main content */}\n      <main className=\"flex-1 flex flex-col min-h-screen\">\n        {/* Header */}\n        <header className=\"bg-card border-b border-border px-4 py-3 md:px-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <button \n                className=\"md:hidden text-muted-foreground hover:text-foreground\"\n                onClick={() => setSidebarOpen(true)}\n                data-testid=\"button-mobile-menu\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </button>\n              <div>\n                <h2 className=\"text-xl font-semibold text-foreground\">Expenses</h2>\n                <p className=\"text-sm text-muted-foreground\">Track farm operating costs and expenses</p>\n              </div>\n            </div>\n            \n            <Dialog open={expenseDialogOpen} onOpenChange={setExpenseDialogOpen}>\n              <DialogTrigger asChild>\n                <Button \n                  data-testid=\"button-add-expense\"\n                  disabled={!hasActiveFarm}\n                  title={!hasActiveFarm ? \"Please select a farm first\" : \"\"}\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Add Expense\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle>Record Expense</DialogTitle>\n                </DialogHeader>\n                <Form {...expenseForm}>\n                  <form onSubmit={expenseForm.handleSubmit(onSubmitExpense)} className=\"space-y-4\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={expenseForm.control}\n                        name=\"expenseDate\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Expense Date</FormLabel>\n                            <FormControl>\n                              <Input type=\"date\" {...field} data-testid=\"input-expense-date\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={expenseForm.control}\n                        name=\"category\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Category</FormLabel>\n                            <Select onValueChange={field.onChange} defaultValue={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-category\">\n                                  <SelectValue placeholder=\"Select category\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"feed\">Feed</SelectItem>\n                                <SelectItem value=\"medication\">Medication</SelectItem>\n                                <SelectItem value=\"labor\">Labor</SelectItem>\n                                <SelectItem value=\"utilities\">Utilities</SelectItem>\n                                <SelectItem value=\"equipment\">Equipment</SelectItem>\n                                <SelectItem value=\"other\">Other</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={expenseForm.control}\n                      name=\"description\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Description</FormLabel>\n                          <FormControl>\n                            <Input {...field} placeholder=\"Brief description of expense\" data-testid=\"input-description\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={expenseForm.control}\n                      name=\"amount\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Amount (KSh)</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"number\" \n                              step=\"0.01\" \n                              {...field} \n                              placeholder=\"0.00\"\n                              data-testid=\"input-amount\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={expenseForm.control}\n                        name=\"supplier\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Supplier (Optional)</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Supplier name\" data-testid=\"input-supplier\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={expenseForm.control}\n                        name=\"receiptNumber\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Receipt # (Optional)</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Receipt number\" data-testid=\"input-receipt-number\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={expenseForm.control}\n                      name=\"notes\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Notes (Optional)</FormLabel>\n                          <FormControl>\n                            <Textarea {...field} rows={2} data-testid=\"textarea-notes\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full\" \n                      disabled={createExpenseMutation.isPending}\n                      data-testid=\"button-submit-expense\"\n                    >\n                      {createExpenseMutation.isPending ? \"Recording...\" : \"Record Expense\"}\n                    </Button>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </header>\n\n        {/* Content */}\n        <div className=\"flex-1 p-4 md:p-6 space-y-6\">\n          {/* Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n            <Card data-testid=\"card-total-expenses\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Total Expenses</p>\n                    <p className=\"text-2xl font-bold text-foreground\">KSh {totalExpenses.toLocaleString()}</p>\n                    <p className=\"text-xs text-muted-foreground\">All time</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center\">\n                    <Receipt className=\"h-6 w-6 text-red-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-monthly-expenses\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">This Month</p>\n                    <p className=\"text-2xl font-bold text-foreground\">KSh {monthlyTotal.toLocaleString()}</p>\n                    <p className=\"text-xs text-muted-foreground\">{monthExpenses.length} transactions</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center\">\n                    <Calendar className=\"h-6 w-6 text-orange-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-weekly-expenses\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">This Week</p>\n                    <p className=\"text-2xl font-bold text-foreground\">KSh {weeklyTotal.toLocaleString()}</p>\n                    <p className=\"text-xs text-green-600\">Weekly spending</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <TrendingUp className=\"h-6 w-6 text-chart-2\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-average-daily\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Daily Average</p>\n                    <p className=\"text-2xl font-bold text-foreground\">KSh {Math.round(weeklyTotal / 7).toLocaleString()}</p>\n                    <p className=\"text-xs text-muted-foreground\">Last 7 days</p>\n                  </div>\n                  <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n                    <DollarSign className=\"h-6 w-6 text-green-600\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs defaultValue=\"recent\" className=\"space-y-4\">\n            <TabsList>\n              <TabsTrigger value=\"recent\">Recent Expenses</TabsTrigger>\n              <TabsTrigger value=\"categories\">By Category</TabsTrigger>\n              <TabsTrigger value=\"analysis\">Expense Analysis</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"recent\">\n              <Card data-testid=\"card-recent-expenses\">\n                <CardHeader>\n                  <CardTitle>Recent Expenses</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {!expenses || expenses.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <Receipt className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">No expenses recorded</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Start tracking your farm expenses</p>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Date</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Category</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Description</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Amount</th>\n                            <th className=\"text-left p-2 font-medium text-muted-foreground\">Supplier</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {expenses.slice(0, 10).map((expense: any) => (\n                            <tr key={expense.id} className=\"border-b border-border/50\" data-testid={`row-expense-${expense.id}`}>\n                              <td className=\"p-2\">{new Date(expense.expenseDate).toLocaleDateString()}</td>\n                              <td className=\"p-2\">\n                                <Badge variant=\"outline\" className={`capitalize ${getCategoryColor(expense.category)}`}>\n                                  {getCategoryIcon(expense.category)} {expense.category}\n                                </Badge>\n                              </td>\n                              <td className=\"p-2 font-medium\">{expense.description}</td>\n                              <td className=\"p-2 font-medium text-red-600\">KSh {parseFloat(expense.amount).toLocaleString()}</td>\n                              <td className=\"p-2\">{expense.supplier || \"-\"}</td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"categories\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <Card data-testid=\"card-category-breakdown\">\n                  <CardHeader>\n                    <CardTitle>Expense by Category</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      {topCategories.map(([category, amount]) => {\n                        const percentage = totalExpenses > 0 ? ((amount as number) / totalExpenses * 100) : 0;\n                        return (\n                          <div key={category} className=\"flex items-center justify-between p-3 bg-muted/50 rounded\">\n                            <div className=\"flex items-center space-x-3\">\n                              <span className=\"text-2xl\">{getCategoryIcon(category)}</span>\n                              <div>\n                                <p className=\"font-medium capitalize\">{category}</p>\n                                <p className=\"text-sm text-muted-foreground\">{percentage.toFixed(1)}% of total</p>\n                              </div>\n                            </div>\n                            <span className=\"font-medium\">KSh {(amount as number).toLocaleString()}</span>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-category-trends\">\n                  <CardHeader>\n                    <CardTitle>Category Trends</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {categoryTrendsData.length > 0 ? (\n                      <ResponsiveContainer width=\"100%\" height={320}>\n                        <BarChart data={categoryTrendsData}>\n                          <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n                          <XAxis \n                            dataKey=\"month\" \n                            className=\"text-xs\"\n                            tick={{ fill: 'hsl(var(--muted-foreground))' }}\n                          />\n                          <YAxis \n                            className=\"text-xs\"\n                            tick={{ fill: 'hsl(var(--muted-foreground))' }}\n                            tickFormatter={(value) => `${(value / 1000).toFixed(0)}k`}\n                          />\n                          <Tooltip \n                            formatter={(value: number) => `KSh ${value.toLocaleString()}`}\n                            contentStyle={{\n                              backgroundColor: 'hsl(var(--background))',\n                              border: '1px solid hsl(var(--border))',\n                              borderRadius: '6px',\n                            }}\n                          />\n                          <Legend \n                            wrapperStyle={{ paddingTop: '20px' }}\n                            formatter={(value) => value.charAt(0).toUpperCase() + value.slice(1)}\n                          />\n                          <Bar dataKey=\"feed\" stackId=\"a\" fill=\"hsl(25, 95%, 53%)\" />\n                          <Bar dataKey=\"medication\" stackId=\"a\" fill=\"hsl(0, 84%, 60%)\" />\n                          <Bar dataKey=\"labor\" stackId=\"a\" fill=\"hsl(221, 83%, 53%)\" />\n                          <Bar dataKey=\"utilities\" stackId=\"a\" fill=\"hsl(142, 76%, 36%)\" />\n                          <Bar dataKey=\"equipment\" stackId=\"a\" fill=\"hsl(262, 83%, 58%)\" />\n                          <Bar dataKey=\"other\" stackId=\"a\" fill=\"hsl(215, 20%, 65%)\" />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"h-80 bg-muted/20 rounded-lg flex items-center justify-center\">\n                        <div className=\"text-center\">\n                          <TrendingUp className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                          <p className=\"text-sm text-muted-foreground\">No expense data available</p>\n                          <p className=\"text-xs text-muted-foreground mt-2\">Add expenses to see category trends</p>\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"analysis\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card data-testid=\"card-spending-analysis\">\n                  <CardHeader>\n                    <CardTitle>Spending Analysis</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded\">\n                        <h3 className=\"font-semibold text-blue-800 dark:text-blue-200 mb-2\">Monthly Comparison</h3>\n                        <p className=\"text-sm text-blue-700 dark:text-blue-300\">\n                          This month's spending: KSh {monthlyTotal.toLocaleString()}\n                        </p>\n                        <p className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                          Average monthly: KSh {Math.round(totalExpenses / 3).toLocaleString()}\n                        </p>\n                      </div>\n\n                      <div className=\"p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded\">\n                        <h3 className=\"font-semibold text-green-800 dark:text-green-200 mb-2\">Cost Efficiency</h3>\n                        <p className=\"text-sm text-green-700 dark:text-green-300\">\n                          Cost per bird per month: KSh {Math.round(monthlyTotal / 5300).toLocaleString()}\n                        </p>\n                        <p className=\"text-xs text-green-600 dark:text-green-400 mt-1\">\n                          Industry benchmark: KSh 45-65 per bird/month\n                        </p>\n                      </div>\n\n                      <div className=\"p-3 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded\">\n                        <h3 className=\"font-semibold text-orange-800 dark:text-orange-200 mb-2\">Top Expense Categories</h3>\n                        <div className=\"space-y-1\">\n                          {topCategories.slice(0, 3).map(([category, amount]) => (\n                            <p key={category} className=\"text-sm text-orange-700 dark:text-orange-300\">\n                              • {category}: KSh {(amount as number).toLocaleString()}\n                            </p>\n                          ))}\n                        </div>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card data-testid=\"card-expense-trends\">\n                  <CardHeader>\n                    <CardTitle>Expense Trends</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {monthlyExpenseTrends.length > 0 ? (\n                      <ResponsiveContainer width=\"100%\" height={320}>\n                        <AreaChart data={monthlyExpenseTrends}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis \n                            dataKey=\"month\" \n                            tick={{ fontSize: 11 }}\n                            angle={-45}\n                            textAnchor=\"end\"\n                            height={80}\n                          />\n                          <YAxis \n                            tick={{ fontSize: 11 }}\n                            tickFormatter={(value) => `${(value / 1000).toFixed(0)}k`}\n                          />\n                          <Tooltip \n                            formatter={(value: number) => [`KSh ${value.toLocaleString()}`, 'Expenses']}\n                            labelStyle={{ color: '#000' }}\n                          />\n                          <Area \n                            type=\"monotone\" \n                            dataKey=\"amount\" \n                            stroke=\"#ef4444\" \n                            fill=\"#fca5a5\" \n                            name=\"Monthly Expenses\"\n                          />\n                        </AreaChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"h-80 bg-muted/20 rounded-lg flex items-center justify-center\">\n                        <div className=\"text-center\">\n                          <Calendar className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                          <p className=\"text-sm text-muted-foreground\">No expense data available</p>\n                          <p className=\"text-xs text-muted-foreground mt-2\">Add expenses to see monthly trends</p>\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":37087},"client/src/components/forms/simple-egg-production-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface SimpleEggProductionFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function SimpleEggProductionForm({ onSuccess }: SimpleEggProductionFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Form state\n  const [recordDate, setRecordDate] = useState(new Date().toISOString().split('T')[0]);\n  const [flockId, setFlockId] = useState(\"\");\n  const [eggsCollected, setEggsCollected] = useState(\"\");\n  const [brokenEggs, setBrokenEggs] = useState(\"\");\n  const [cratesProduced, setCratesProduced] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  // Automatically calculate crates produced (30 eggs per crate)\n  useEffect(() => {\n    const eggs = parseInt(eggsCollected) || 0;\n    const calculatedCrates = Math.floor(eggs / 30);\n    setCratesProduced(calculatedCrates.toString());\n  }, [eggsCollected]);\n\n  const createRecordMutation = useMutation({\n    mutationFn: async (data: any) => {\n      await apiRequest(\"POST\", \"/api/daily-records\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Egg production record created successfully\",\n      });\n      resetForm();\n      onSuccess?.();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create egg production record\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setRecordDate(new Date().toISOString().split('T')[0]);\n    setFlockId(\"\");\n    setEggsCollected(\"\");\n    setBrokenEggs(\"\");\n    setCratesProduced(\"\");\n    setNotes(\"\");\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // Basic validation\n    if (!flockId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a flock\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!recordDate) {\n      toast({\n        title: \"Error\", \n        description: \"Please select a record date\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Prepare data focused only on egg production\n    const payload = {\n      recordDate,\n      flockId,\n      eggsCollected: parseInt(eggsCollected) || 0,\n      brokenEggs: parseInt(brokenEggs) || 0,\n      cratesProduced: parseInt(cratesProduced) || 0,\n      notes: notes || undefined,\n      // Set defaults for other required fields\n      mortalityCount: 0,\n      sampleSize: 0,\n    };\n\n    console.log(\"Submitting egg production record:\", payload);\n    createRecordMutation.mutate(payload);\n  };\n\n  return (\n    <Card data-testid=\"card-simple-egg-production-form\">\n      <CardHeader>\n        <CardTitle>Egg Production Record</CardTitle>\n        <CardDescription>\n          Record daily egg collection data including total eggs, broken eggs, and crates produced.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"recordDate\">Record Date</Label>\n              <Input\n                id=\"recordDate\"\n                type=\"date\"\n                value={recordDate}\n                onChange={(e) => setRecordDate(e.target.value)}\n                data-testid=\"input-record-date\"\n                required\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"flockId\">Flock</Label>\n              <Select value={flockId} onValueChange={setFlockId}>\n                <SelectTrigger data-testid=\"select-flock\">\n                  <SelectValue placeholder=\"Select a flock\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {flocks.map((flock: any) => (\n                    <SelectItem key={flock.id} value={flock.id}>\n                      {flock.name} ({flock.currentCount} birds)\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Egg Production Section */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold\">Egg Production</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"eggsCollected\">Eggs Collected</Label>\n                <Input\n                  id=\"eggsCollected\"\n                  type=\"number\"\n                  value={eggsCollected}\n                  onChange={(e) => setEggsCollected(e.target.value)}\n                  placeholder=\"0\"\n                  data-testid=\"input-eggs-collected\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"brokenEggs\">Broken Eggs</Label>\n                <Input\n                  id=\"brokenEggs\"\n                  type=\"number\"\n                  value={brokenEggs}\n                  onChange={(e) => setBrokenEggs(e.target.value)}\n                  placeholder=\"0\"\n                  data-testid=\"input-broken-eggs\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"cratesProduced\">Crates Produced</Label>\n                <Input\n                  id=\"cratesProduced\"\n                  type=\"number\"\n                  value={cratesProduced}\n                  readOnly\n                  className=\"bg-muted\"\n                  placeholder=\"Auto-calculated\"\n                  data-testid=\"input-crates-produced\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Auto-calculated: 30 eggs = 1 crate\n                </p>\n              </div>\n            </div>\n          </div>\n\n          {/* Notes */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Textarea\n              id=\"notes\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              rows={3}\n              placeholder=\"Any observations about egg quality, collection issues, etc...\"\n              data-testid=\"textarea-notes\"\n            />\n          </div>\n\n          <Button \n            type=\"submit\" \n            disabled={createRecordMutation.isPending}\n            data-testid=\"button-submit-egg-production\"\n            className=\"w-full\"\n          >\n            {createRecordMutation.isPending ? \"Saving...\" : \"Save Egg Production Record\"}\n          </Button>\n        </form>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":7526},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/utils/role-router.ts":{"content":"// Role-based routing utility for directing users to appropriate dashboards\nimport { type User } from '@shared/schema';\n\nexport type UserRole = 'admin' | 'farm_owner' | 'manager' | 'staff' | 'customer';\n\n/**\n * Maps user roles to their appropriate dashboard routes\n */\nexport function getRoleDashboardRoute(user: User): string {\n  const { role, farmId } = user;\n\n  switch (role as UserRole) {\n    case 'admin':\n      return '/'; // Admin gets the main home dashboard with farm selector\n    \n    case 'farm_owner':\n      // Farm owners need a farmId to access their farm dashboard\n      if (!farmId) {\n        return '/farm-setup'; // Redirect to farm setup if no farm associated\n      }\n      return '/'; // Home dashboard for their farm\n    \n    case 'manager':\n      // Managers need a farmId to access farm operations\n      if (!farmId) {\n        return '/farm-setup'; // Redirect to farm setup if no farm associated  \n      }\n      return '/'; // Home dashboard for their assigned farm\n    \n    case 'staff':\n      // Staff need a farmId to access farm operations\n      if (!farmId) {\n        return '/farm-setup'; // Redirect to farm setup if no farm associated\n      }\n      return '/'; // Home dashboard for their assigned farm\n    \n    case 'customer':\n      return '/marketplace'; // Customers go to public marketplace\n    \n    default:\n      return '/'; // Default fallback to home\n  }\n}\n\n/**\n * Checks if a user role requires a farmId to access dashboards\n */\nexport function roleRequiresFarm(role: string): boolean {\n  return ['farm_owner', 'manager', 'staff'].includes(role);\n}\n\n/**\n * Gets user role intent from sessionStorage (set during landing page interaction)\n */\nexport function getUserRoleIntent(): string | null {\n  return sessionStorage.getItem('userRoleIntent');\n}\n\n/**\n * Clears user role intent from sessionStorage\n */\nexport function clearUserRoleIntent(): void {\n  sessionStorage.removeItem('userRoleIntent');\n}\n\n/**\n * Determines if user should see welcome panel based on role intent or first login\n */\nexport function shouldShowWelcomePanel(user: User): boolean {\n  const roleIntent = getUserRoleIntent();\n  const hasSeenWelcome = sessionStorage.getItem('hasSeenWelcome');\n  \n  // Show welcome panel if:\n  // 1. User had role intent (clicked farmer/customer button)\n  // 2. User hasn't seen welcome panel in this session\n  return Boolean(roleIntent) || !hasSeenWelcome;\n}\n\n/**\n * Marks that user has seen the welcome panel\n */\nexport function markWelcomePanelSeen(): void {\n  sessionStorage.setItem('hasSeenWelcome', 'true');\n}","size_bytes":2557},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { relations } from \"drizzle-orm\";\nimport {\n  index,\n  uniqueIndex,\n  check,\n  jsonb,\n  pgTable,\n  timestamp,\n  varchar,\n  integer,\n  decimal,\n  text,\n  boolean,\n  date,\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table (mandatory for Replit Auth)\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User storage table (mandatory for Replit Auth)\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\"), // No unique constraint - OIDC sub (id) is the unique identifier\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  role: varchar(\"role\").notNull().default(\"customer\"), // admin, farm_owner, manager, staff, customer\n  farmId: varchar(\"farm_id\").references(() => farms.id, { onDelete: \"restrict\", onUpdate: \"cascade\" }), // null for customers and global admin\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_users_farm_id\").on(table.farmId),\n  check(\"chk_users_role_farm\", sql`\n    (role in ('customer', 'admin') and farm_id is null) or \n    (role in ('farm_owner', 'manager', 'staff') and farm_id is not null)\n  `),\n]);\n\n// Farms table - multi-tenant support\nexport const farms = pgTable(\"farms\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  location: varchar(\"location\").notNull(), // city, region\n  address: text(\"address\"),\n  contactEmail: varchar(\"contact_email\"),\n  contactPhone: varchar(\"contact_phone\"),\n  website: varchar(\"website\"),\n  \n  // Farm capacity and specialization\n  totalBirds: integer(\"total_birds\").default(0),\n  avgEggsPerDay: integer(\"avg_eggs_per_day\").default(0),\n  specialization: varchar(\"specialization\").default(\"layers\"), // layers, broilers, mixed\n  \n  // Business details\n  businessRegistration: varchar(\"business_registration\"),\n  certifications: text(\"certifications\"), // organic, free-range, etc\n  \n  // Platform status\n  status: varchar(\"status\").notNull().default(\"active\"), // active, inactive, pending\n  isApproved: boolean(\"is_approved\").default(false),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Flocks table\nexport const flocks = pgTable(\"flocks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id, { onDelete: \"restrict\", onUpdate: \"cascade\" }), // Associate with specific farm\n  name: varchar(\"name\").notNull(),\n  breed: varchar(\"breed\"),\n  initialCount: integer(\"initial_count\").notNull(),\n  currentCount: integer(\"current_count\").notNull(),\n  hatchDate: date(\"hatch_date\").notNull(),\n  status: varchar(\"status\").notNull().default(\"brooding\"), // brooding, laying, retired, deactivated\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_flocks_farm_id\").on(table.farmId),\n  check(\"chk_flocks_counts\", sql`initial_count >= 0 and current_count >= 0`),\n]);\n\n// Daily records table\nexport const dailyRecords = pgTable(\"daily_records\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  flockId: varchar(\"flock_id\").notNull().references(() => flocks.id, { onDelete: \"cascade\" }),\n  recordDate: date(\"record_date\").notNull(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  \n  // Egg production\n  eggsCollected: integer(\"eggs_collected\"),\n  brokenEggs: integer(\"broken_eggs\"),\n  cratesProduced: integer(\"crates_produced\"),\n  \n  // Mortality\n  mortalityCount: integer(\"mortality_count\").default(0),\n  mortalityReason: text(\"mortality_reason\"),\n  \n  // Feed\n  feedConsumed: decimal(\"feed_consumed\", { precision: 10, scale: 2 }),\n  feedType: varchar(\"feed_type\"),\n  \n  // Brooding data\n  temperature: decimal(\"temperature\", { precision: 5, scale: 2 }),\n  lightingHours: decimal(\"lighting_hours\", { precision: 4, scale: 2 }),\n  \n  // Weight tracking\n  averageWeight: decimal(\"average_weight\", { precision: 6, scale: 2 }),\n  sampleSize: integer(\"sample_size\"),\n  \n  notes: text(\"notes\"),\n  \n  // Review system\n  reviewStatus: varchar(\"review_status\").notNull().default(\"approved\"), // approved, pending_review, rejected\n  isDuplicate: boolean(\"is_duplicate\").notNull().default(false),\n  duplicateOfId: varchar(\"duplicate_of_id\"), // self-reference - will add constraint later\n  reviewerId: varchar(\"reviewer_id\").references(() => users.id, { onDelete: \"set null\" }),\n  reviewNote: text(\"review_note\"),\n  reviewedAt: timestamp(\"reviewed_at\", { withTimezone: true }),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_daily_records_flock_id\").on(table.flockId),\n  index(\"idx_daily_records_user_id\").on(table.userId),\n  uniqueIndex(\"uniq_daily_records_flock_date_active\").on(table.flockId, table.recordDate).where(sql`is_duplicate = false`),\n  check(\"chk_daily_records_nonneg\", sql`\n    eggs_collected >= 0 and \n    broken_eggs >= 0 and \n    crates_produced >= 0 and \n    mortality_count >= 0\n  `),\n]);\n\n// Sales table\nexport const sales = pgTable(\"sales\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id, { onDelete: \"restrict\", onUpdate: \"cascade\" }), // Associate with specific farm\n  saleDate: date(\"sale_date\").notNull(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  customerName: varchar(\"customer_name\"),\n  cratesSold: integer(\"crates_sold\").notNull(),\n  pricePerCrate: decimal(\"price_per_crate\", { precision: 12, scale: 2 }).notNull(),\n  totalAmount: decimal(\"total_amount\", { precision: 12, scale: 2 }).notNull(),\n  paymentStatus: varchar(\"payment_status\").notNull().default(\"pending\"), // pending, paid, overdue\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_sales_farm_id\").on(table.farmId),\n  index(\"idx_sales_user_id\").on(table.userId),\n  check(\"chk_sales_nonneg\", sql`\n    crates_sold >= 0 and \n    price_per_crate >= 0 and \n    total_amount >= 0\n  `),\n]);\n\n// Feed inventory table\nexport const feedInventory = pgTable(\"feed_inventory\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id, { onDelete: \"restrict\", onUpdate: \"cascade\" }), // Associate with specific farm\n  feedType: varchar(\"feed_type\").notNull(),\n  supplier: varchar(\"supplier\"),\n  quantityKg: decimal(\"quantity_kg\", { precision: 10, scale: 3 }).notNull(), // finer kg fractions\n  unitPrice: decimal(\"unit_price\", { precision: 12, scale: 2 }),\n  purchaseDate: date(\"purchase_date\"),\n  expiryDate: date(\"expiry_date\"),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_feed_inventory_farm_id\").on(table.farmId),\n  index(\"idx_feed_inventory_user_id\").on(table.userId),\n  check(\"chk_feed_inventory_nonneg\", sql`\n    quantity_kg >= 0 and \n    (unit_price is null or unit_price >= 0)\n  `),\n]);\n\n// Health records table\nexport const healthRecords = pgTable(\"health_records\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  flockId: varchar(\"flock_id\").notNull().references(() => flocks.id, { onDelete: \"cascade\" }),\n  recordDate: date(\"record_date\").notNull(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  recordType: varchar(\"record_type\").notNull(), // vaccination, medication, treatment, checkup\n  title: varchar(\"title\").notNull(),\n  description: text(\"description\"),\n  medicationUsed: varchar(\"medication_used\"),\n  dosage: varchar(\"dosage\"),\n  administeredBy: varchar(\"administered_by\"),\n  nextDueDate: date(\"next_due_date\"),\n  cost: decimal(\"cost\", { precision: 12, scale: 2 }),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_health_records_flock_id\").on(table.flockId),\n  index(\"idx_health_records_user_id\").on(table.userId),\n  check(\"chk_health_records_cost\", sql`cost is null or cost >= 0`),\n]);\n\n// Expenses table\nexport const expenses = pgTable(\"expenses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id, { onDelete: \"restrict\", onUpdate: \"cascade\" }), // Associate with specific farm\n  expenseDate: date(\"expense_date\").notNull(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  category: varchar(\"category\").notNull(), // feed, medication, labor, utilities, equipment, other\n  description: varchar(\"description\").notNull(),\n  amount: decimal(\"amount\", { precision: 12, scale: 2 }).notNull(),\n  supplier: varchar(\"supplier\"),\n  receiptNumber: varchar(\"receipt_number\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_expenses_farm_id\").on(table.farmId),\n  index(\"idx_expenses_user_id\").on(table.userId),\n  check(\"chk_expenses_amount\", sql`amount >= 0`),\n]);\n\n// Break-Even Analysis Assumptions table\nexport const breakEvenAssumptions = pgTable(\"break_even_assumptions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id, { onDelete: \"cascade\", onUpdate: \"cascade\" }), // Associate with specific farm\n  productId: varchar(\"product_id\").references(() => products.id, { onDelete: \"cascade\" }), // Optional: for multi-product analysis\n  \n  // Pricing and cost assumptions\n  price: decimal(\"price\", { precision: 12, scale: 2 }).notNull(), // Average selling price per unit\n  unitVariableCost: decimal(\"unit_variable_cost\", { precision: 12, scale: 2 }).notNull(), // Variable cost per unit\n  fixedCostsPerMonth: decimal(\"fixed_costs_per_month\", { precision: 12, scale: 2 }).notNull(), // Monthly fixed costs\n  \n  // Growth and seasonality\n  growthRate: decimal(\"growth_rate\", { precision: 5, scale: 4 }).default('0'), // Monthly growth rate (e.g., 0.05 = 5%)\n  seasonalityFactors: jsonb(\"seasonality_factors\"), // Optional monthly seasonality adjustments { \"1\": 1.0, \"2\": 0.9, ... }\n  \n  // Metadata\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_break_even_farm_id\").on(table.farmId),\n  index(\"idx_break_even_product_id\").on(table.productId),\n  uniqueIndex(\"unique_break_even_farm_product\").on(table.farmId, table.productId), // One set of assumptions per farm-product combo\n  check(\"chk_break_even_positive\", sql`\n    price > 0 and \n    unit_variable_cost >= 0 and \n    fixed_costs_per_month >= 0 and\n    (growth_rate is null or growth_rate >= -1)\n  `),\n]);\n\n// Marketplace tables\n\n// Customers table\nexport const customers = pgTable(\"customers\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").unique().references(() => users.id, { onDelete: \"cascade\" }), // Link to authenticated user\n  name: varchar(\"name\").notNull(),\n  email: varchar(\"email\"),\n  phone: varchar(\"phone\").notNull(),\n  address: text(\"address\"),\n  location: varchar(\"location\"), // area/region\n  customerType: varchar(\"customer_type\").notNull().default(\"retail\"), // retail, wholesale, distributor\n  status: varchar(\"status\").notNull().default(\"active\"), // active, inactive\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_customers_user_id\").on(table.userId),\n]);\n\n// Products table\nexport const products = pgTable(\"products\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id, { onDelete: \"restrict\", onUpdate: \"cascade\" }), // Associate with specific farm\n  name: varchar(\"name\").notNull(),\n  category: varchar(\"category\").notNull(), // eggs, chickens, feed\n  description: text(\"description\"),\n  unit: varchar(\"unit\").notNull(), // crates, pieces, kg\n  currentPrice: decimal(\"current_price\", { precision: 12, scale: 2 }).notNull(),\n  minOrderQuantity: integer(\"min_order_quantity\").default(1),\n  stockQuantity: integer(\"stock_quantity\").default(0),\n  isAvailable: boolean(\"is_available\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_products_farm_id\").on(table.farmId),\n  check(\"chk_products_nonneg\", sql`\n    current_price >= 0 and \n    min_order_quantity >= 0 and \n    stock_quantity >= 0\n  `),\n]);\n\n// Orders table\nexport const orders = pgTable(\"orders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  orderNumber: varchar(\"order_number\").notNull().unique(),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id, { onDelete: \"restrict\", onUpdate: \"cascade\" }), // Associate with specific farm\n  customerId: varchar(\"customer_id\").notNull().references(() => customers.id, { onDelete: \"restrict\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"restrict\" }), // staff who processed the order\n  orderDate: timestamp(\"order_date\", { withTimezone: true }).defaultNow(),\n  requiredDate: date(\"required_date\"),\n  status: varchar(\"status\").notNull().default(\"pending\"), // pending, confirmed, processing, ready, delivered, cancelled\n  totalAmount: decimal(\"total_amount\", { precision: 12, scale: 2 }).notNull(),\n  paidAmount: decimal(\"paid_amount\", { precision: 12, scale: 2 }).default(\"0\"),\n  paymentStatus: varchar(\"payment_status\").notNull().default(\"pending\"), // pending, partial, paid\n  deliveryMethod: varchar(\"delivery_method\").notNull(), // pickup, delivery\n  deliveryAddress: text(\"delivery_address\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_orders_farm_id\").on(table.farmId),\n  index(\"idx_orders_customer_id\").on(table.customerId),\n  index(\"idx_orders_user_id\").on(table.userId),\n  check(\"chk_orders_amounts\", sql`\n    total_amount >= 0 and \n    paid_amount >= 0 and \n    paid_amount <= total_amount\n  `),\n]);\n\n// Order items table\nexport const orderItems = pgTable(\"order_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  orderId: varchar(\"order_id\").notNull().references(() => orders.id, { onDelete: \"cascade\" }),\n  productId: varchar(\"product_id\").notNull().references(() => products.id, { onDelete: \"restrict\" }),\n  quantity: integer(\"quantity\").notNull(),\n  unitPrice: decimal(\"unit_price\", { precision: 12, scale: 2 }).notNull(),\n  totalPrice: decimal(\"total_price\", { precision: 12, scale: 2 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_order_items_order_id\").on(table.orderId),\n  index(\"idx_order_items_product_id\").on(table.productId),\n  check(\"chk_order_items_nonneg\", sql`\n    quantity > 0 and \n    unit_price >= 0 and \n    total_price >= 0\n  `),\n]);\n\n// Deliveries table\nexport const deliveries = pgTable(\"deliveries\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  orderId: varchar(\"order_id\").notNull().references(() => orders.id, { onDelete: \"cascade\" }),\n  driverId: varchar(\"driver_id\").references(() => users.id, { onDelete: \"set null\" }), // could be staff member\n  vehicleInfo: varchar(\"vehicle_info\"),\n  scheduledDate: timestamp(\"scheduled_date\"),\n  actualDate: timestamp(\"actual_date\"),\n  status: varchar(\"status\").notNull().default(\"scheduled\"), // scheduled, in_transit, delivered, failed\n  deliveryNotes: text(\"delivery_notes\"),\n  recipientName: varchar(\"recipient_name\"),\n  recipientPhone: varchar(\"recipient_phone\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_deliveries_order_id\").on(table.orderId),\n  index(\"idx_deliveries_driver_id\").on(table.driverId),\n]);\n\n// Notifications table\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  recipientUserId: varchar(\"recipient_user_id\").notNull(),\n  farmId: varchar(\"farm_id\").notNull(),\n  type: varchar(\"type\").notNull(), // duplicate_entry, system_alert, task_assignment, etc\n  title: varchar(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  meta: jsonb(\"meta\"), // additional data like referenced record IDs\n  isRead: boolean(\"is_read\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Relations\n// Farm relations\nexport const farmsRelations = relations(farms, ({ many }) => ({\n  users: many(users),\n  flocks: many(flocks),\n  sales: many(sales),\n  feedInventory: many(feedInventory),\n  expenses: many(expenses),\n  breakEvenAssumptions: many(breakEvenAssumptions),\n  products: many(products),\n  orders: many(orders),\n}));\n\nexport const flocksRelations = relations(flocks, ({ one, many }) => ({\n  farm: one(farms, {\n    fields: [flocks.farmId],\n    references: [farms.id],\n  }),\n  dailyRecords: many(dailyRecords),\n  healthRecords: many(healthRecords),\n}));\n\nexport const usersRelations = relations(users, ({ one, many }) => ({\n  farm: one(farms, {\n    fields: [users.farmId],\n    references: [farms.id],\n  }),\n  dailyRecords: many(dailyRecords),\n  sales: many(sales),\n  feedInventory: many(feedInventory),\n  healthRecords: many(healthRecords),\n  expenses: many(expenses),\n}));\n\nexport const dailyRecordsRelations = relations(dailyRecords, ({ one }) => ({\n  flock: one(flocks, {\n    fields: [dailyRecords.flockId],\n    references: [flocks.id],\n  }),\n  user: one(users, {\n    fields: [dailyRecords.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const salesRelations = relations(sales, ({ one }) => ({\n  farm: one(farms, {\n    fields: [sales.farmId],\n    references: [farms.id],\n  }),\n  user: one(users, {\n    fields: [sales.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const feedInventoryRelations = relations(feedInventory, ({ one }) => ({\n  farm: one(farms, {\n    fields: [feedInventory.farmId],\n    references: [farms.id],\n  }),\n  user: one(users, {\n    fields: [feedInventory.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const healthRecordsRelations = relations(healthRecords, ({ one }) => ({\n  flock: one(flocks, {\n    fields: [healthRecords.flockId],\n    references: [flocks.id],\n  }),\n  user: one(users, {\n    fields: [healthRecords.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const expensesRelations = relations(expenses, ({ one }) => ({\n  farm: one(farms, {\n    fields: [expenses.farmId],\n    references: [farms.id],\n  }),\n  user: one(users, {\n    fields: [expenses.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const breakEvenAssumptionsRelations = relations(breakEvenAssumptions, ({ one }) => ({\n  farm: one(farms, {\n    fields: [breakEvenAssumptions.farmId],\n    references: [farms.id],\n  }),\n  product: one(products, {\n    fields: [breakEvenAssumptions.productId],\n    references: [products.id],\n  }),\n}));\n\n// Marketplace relations\nexport const customersRelations = relations(customers, ({ one, many }) => ({\n  user: one(users, {\n    fields: [customers.userId],\n    references: [users.id],\n  }),\n  orders: many(orders),\n}));\n\nexport const productsRelations = relations(products, ({ one, many }) => ({\n  farm: one(farms, {\n    fields: [products.farmId],\n    references: [farms.id],\n  }),\n  orderItems: many(orderItems),\n}));\n\nexport const ordersRelations = relations(orders, ({ one, many }) => ({\n  farm: one(farms, {\n    fields: [orders.farmId],\n    references: [farms.id],\n  }),\n  customer: one(customers, {\n    fields: [orders.customerId],\n    references: [customers.id],\n  }),\n  user: one(users, {\n    fields: [orders.userId],\n    references: [users.id],\n  }),\n  orderItems: many(orderItems),\n  delivery: one(deliveries),\n}));\n\nexport const orderItemsRelations = relations(orderItems, ({ one }) => ({\n  order: one(orders, {\n    fields: [orderItems.orderId],\n    references: [orders.id],\n  }),\n  product: one(products, {\n    fields: [orderItems.productId],\n    references: [products.id],\n  }),\n}));\n\nexport const deliveriesRelations = relations(deliveries, ({ one }) => ({\n  order: one(orders, {\n    fields: [deliveries.orderId],\n    references: [orders.id],\n  }),\n  driver: one(users, {\n    fields: [deliveries.driverId],\n    references: [users.id],\n  }),\n}));\n\n// Insert schemas\nexport const insertFarmSchema = createInsertSchema(farms).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertUserSchema = createInsertSchema(users).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertManagerUserSchema = insertUserSchema.omit({ role: true }).extend({\n  role: z.enum([\"staff\", \"customer\"])\n});\nexport const insertFlockSchema = createInsertSchema(flocks).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertDailyRecordSchema = createInsertSchema(dailyRecords).omit({ \n  id: true, \n  createdAt: true, \n  updatedAt: true,\n  // Review system fields - server only\n  reviewStatus: true,\n  isDuplicate: true,\n  duplicateOfId: true,\n  reviewerId: true,\n  reviewNote: true,\n  reviewedAt: true,\n});\nexport const insertSaleSchema = createInsertSchema(sales).omit({ id: true, createdAt: true, updatedAt: true }).extend({\n  saleDate: z.string().min(1, \"Sale date is required\"),\n  pricePerCrate: z.number().positive(\"Price per crate must be positive\"),\n  totalAmount: z.number().positive(\"Total amount must be positive\"),\n});\nexport const insertFeedInventorySchema = createInsertSchema(feedInventory).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertHealthRecordSchema = createInsertSchema(healthRecords).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertExpenseSchema = createInsertSchema(expenses).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertBreakEvenAssumptionsSchema = createInsertSchema(breakEvenAssumptions).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({ id: true, createdAt: true, updatedAt: true });\n\n// Marketplace insert schemas\nexport const insertCustomerSchema = createInsertSchema(customers).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertProductSchema = createInsertSchema(products).omit({ id: true, createdAt: true, updatedAt: true });\n\n// SECURITY: Remove client-supplied pricing fields - these must be server-calculated only\nexport const insertOrderSchema = createInsertSchema(orders).omit({ \n  id: true, \n  createdAt: true, \n  updatedAt: true,\n  totalAmount: true,    // Server-calculated from order items\n  paidAmount: true      // Managed separately for payment tracking\n});\n\n// SECURITY: Remove client-supplied pricing fields - these must be server-calculated only\nexport const insertOrderItemSchema = createInsertSchema(orderItems).omit({ \n  id: true, \n  createdAt: true,\n  unitPrice: true,      // Server-fetched from current product price\n  totalPrice: true      // Server-calculated: quantity * unitPrice\n});\n\nexport const insertDeliverySchema = createInsertSchema(deliveries).omit({ id: true, createdAt: true, updatedAt: true }).extend({\n  scheduledDate: z.union([z.date(), z.string().transform((str) => str ? new Date(str) : undefined)]).optional(),\n  actualDate: z.union([z.date(), z.string().transform((str) => str ? new Date(str) : undefined)]).optional(),\n});\n\n// Types\n// Farm types\nexport type InsertFarm = z.infer<typeof insertFarmSchema>;\nexport type Farm = typeof farms.$inferSelect;\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type InsertManagerUser = z.infer<typeof insertManagerUserSchema>;\nexport type InsertFlock = z.infer<typeof insertFlockSchema>;\nexport type Flock = typeof flocks.$inferSelect;\nexport type InsertDailyRecord = z.infer<typeof insertDailyRecordSchema>;\nexport type DailyRecord = typeof dailyRecords.$inferSelect;\nexport type InsertSale = z.infer<typeof insertSaleSchema>;\nexport type Sale = typeof sales.$inferSelect;\nexport type InsertFeedInventory = z.infer<typeof insertFeedInventorySchema>;\nexport type FeedInventory = typeof feedInventory.$inferSelect;\nexport type InsertHealthRecord = z.infer<typeof insertHealthRecordSchema>;\nexport type HealthRecord = typeof healthRecords.$inferSelect;\nexport type InsertExpense = z.infer<typeof insertExpenseSchema>;\nexport type Expense = typeof expenses.$inferSelect;\nexport type InsertBreakEvenAssumptions = z.infer<typeof insertBreakEvenAssumptionsSchema>;\nexport type BreakEvenAssumptions = typeof breakEvenAssumptions.$inferSelect;\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type Notification = typeof notifications.$inferSelect;\n\n// Weight Records table - for detailed bird weight tracking\nexport const weightRecords = pgTable(\"weight_records\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  flockId: varchar(\"flock_id\").notNull().references(() => flocks.id, { onDelete: \"cascade\" }),\n  weekNumber: integer(\"week_number\").notNull(),\n  recordDate: date(\"record_date\").notNull(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  \n  // Raw weight data\n  weights: jsonb(\"weights\").notNull(), // Array of individual bird weights as numbers\n  sampleSize: integer(\"sample_size\").notNull(),\n  \n  // Calculated statistics\n  averageWeight: decimal(\"average_weight\", { precision: 6, scale: 2 }).notNull(),\n  stdDev: decimal(\"std_dev\", { precision: 6, scale: 2 }).notNull(),\n  uniformity: decimal(\"uniformity\", { precision: 5, scale: 2 }).notNull(), // Percentage\n  cvPercent: decimal(\"cv_percent\", { precision: 5, scale: 2 }), // Coefficient of Variation percentage\n  \n  // Breed standard comparison\n  comparisonResult: varchar(\"comparison_result\"), // \"below_standard\", \"within_standard\", \"above_standard\"\n  expectedWeight: decimal(\"expected_weight\", { precision: 6, scale: 2 }), // From breed standards\n  weightDeviation: decimal(\"weight_deviation\", { precision: 6, scale: 2 }), // Difference from standard\n  \n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_weight_records_flock_id\").on(table.flockId),\n  index(\"idx_weight_records_user_id\").on(table.userId),\n  index(\"idx_weight_records_week\").on(table.weekNumber),\n  uniqueIndex(\"uniq_weight_records_flock_week\").on(table.flockId, table.weekNumber),\n  check(\"chk_weight_records_positive\", sql`\n    week_number > 0 and \n    sample_size > 0 and \n    average_weight > 0 and \n    std_dev >= 0 and \n    uniformity >= 0 and uniformity <= 100\n  `),\n]);\n\n// Breed Standards table - reference data for weight comparisons\nexport const breedStandards = pgTable(\"breed_standards\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  breedName: varchar(\"breed_name\").notNull(),\n  weekNumber: integer(\"week_number\").notNull(),\n  standardWeight: decimal(\"standard_weight\", { precision: 6, scale: 2 }).notNull(), // kg\n  toleranceLower: decimal(\"tolerance_lower\", { precision: 6, scale: 2 }).notNull(), // kg below standard\n  toleranceUpper: decimal(\"tolerance_upper\", { precision: 6, scale: 2 }).notNull(), // kg above standard\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_breed_standards_breed\").on(table.breedName),\n  index(\"idx_breed_standards_week\").on(table.weekNumber),\n  uniqueIndex(\"uniq_breed_standards_breed_week\").on(table.breedName, table.weekNumber),\n  check(\"chk_breed_standards_positive\", sql`\n    week_number > 0 and \n    standard_weight > 0 and \n    tolerance_lower >= 0 and \n    tolerance_upper >= 0\n  `),\n]);\n\n// Weight Records insert schema\nexport const insertWeightRecordSchema = createInsertSchema(weightRecords, {\n  weights: z.array(z.number().positive()).min(1).max(1000), // Array of positive numbers, max 1000 birds\n  sampleSize: z.number().int().positive().max(1000),\n  averageWeight: z.coerce.number().positive(),\n  stdDev: z.coerce.number().min(0),\n  uniformity: z.coerce.number().min(0).max(100),\n  cvPercent: z.coerce.number().min(0).max(999.99).optional(), // CV% can be 0 in edge cases\n  weekNumber: z.number().int().positive().max(100),\n}).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\n// Breed Standards insert schema  \nexport const insertBreedStandardSchema = createInsertSchema(breedStandards, {\n  standardWeight: z.number().positive(),\n  toleranceLower: z.number().min(0),\n  toleranceUpper: z.number().min(0),\n  weekNumber: z.number().int().positive().max(100),\n}).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\n// Marketplace types\nexport type InsertCustomer = z.infer<typeof insertCustomerSchema>;\nexport type Customer = typeof customers.$inferSelect;\nexport type InsertProduct = z.infer<typeof insertProductSchema>;\nexport type Product = typeof products.$inferSelect;\nexport type InsertOrder = z.infer<typeof insertOrderSchema>;\nexport type Order = typeof orders.$inferSelect;\nexport type InsertOrderItem = z.infer<typeof insertOrderItemSchema>;\nexport type OrderItem = typeof orderItems.$inferSelect;\nexport type InsertDelivery = z.infer<typeof insertDeliverySchema>;\nexport type Delivery = typeof deliveries.$inferSelect;\n\n// Weight tracking types\nexport type InsertWeightRecord = z.infer<typeof insertWeightRecordSchema>;\nexport type WeightRecord = typeof weightRecords.$inferSelect;\nexport type InsertBreedStandard = z.infer<typeof insertBreedStandardSchema>;\nexport type BreedStandard = typeof breedStandards.$inferSelect;\n","size_bytes":30634},"client/src/components/layout/sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Sprout, BarChart3, Baby, Scale, Egg, Wheat, Heart, ClipboardList, Receipt, TrendingUp, Users, Settings, LogOut, Store, ShoppingCart, Package2, UserCheck, Building2 } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { FarmSelector } from \"@/components/FarmSelector\";\n\ninterface SidebarProps {\n  isOpen: boolean;\n  onToggle: () => void;\n}\n\nexport default function Sidebar({ isOpen }: SidebarProps) {\n  const [location] = useLocation();\n  const { user } = useAuth();\n\n  const handleLogout = () => {\n    window.location.href = \"/api/logout\";\n  };\n\n  const navigationItems = [\n    { path: \"/\", icon: BarChart3, label: \"Dashboard\", id: \"dashboard\" },\n    { path: \"/chick-brooding\", icon: Baby, label: \"Chick Brooding\", id: \"chick-brooding\" },\n    { path: \"/body-weights\", icon: Scale, label: \"Body Weights\", id: \"body-weights\" },\n    { path: \"/egg-production\", icon: Egg, label: \"Egg Production\", id: \"egg-production\" },\n    { path: \"/feed-management\", icon: Wheat, label: \"Feed Management\", id: \"feed-management\" },\n    { path: \"/health-records\", icon: Heart, label: \"Health Records\", id: \"health-records\" },\n    { path: \"/reports\", icon: ClipboardList, label: \"Reports\", id: \"reports\" },\n    { path: \"/expenses\", icon: Receipt, label: \"Expenses\", id: \"expenses\" },\n  ];\n\n  const marketplaceItems = [\n    { path: \"/marketplace/customers\", icon: UserCheck, label: \"Customers\", id: \"marketplace-customers\" },\n    { path: \"/marketplace/products\", icon: Package2, label: \"Products\", id: \"marketplace-products\" },\n    { path: \"/marketplace/orders\", icon: ShoppingCart, label: \"Orders\", id: \"marketplace-orders\" },\n  ];\n\n  const managementItems = [\n    { path: \"/users\", icon: Users, label: \"Users & Permissions\", id: \"users\", adminOnly: true },\n    { path: \"/farm-registration\", icon: Store, label: \"Farm Registration\", id: \"farm-registration\" },\n    { path: \"/settings\", icon: Settings, label: \"Settings\", id: \"settings\" },\n  ];\n\n  return (\n    <aside \n      className={cn(\n        \"fixed inset-y-0 left-0 z-50 w-64 bg-card border-r border-border transition-transform duration-300 ease-in-out md:relative md:translate-x-0\",\n        isOpen ? \"translate-x-0\" : \"-translate-x-full\"\n      )}\n      data-testid=\"sidebar\"\n    >\n      <div className=\"flex flex-col h-full\">\n        {/* Logo & Farm Info */}\n        <div className=\"p-6 border-b border-border space-y-4\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"w-10 h-10 bg-primary rounded-lg flex items-center justify-center\">\n              <Sprout className=\"text-primary-foreground text-lg\" />\n            </div>\n            <div>\n              <h1 className=\"text-lg font-semibold text-foreground\">KukuHub</h1>\n              <p className=\"text-sm text-muted-foreground\">Track & Grow</p>\n            </div>\n          </div>\n          \n          {/* Farm Selector for Admin Users */}\n          <FarmSelector />\n        </div>\n        \n        {/* Navigation Menu */}\n        <nav className=\"flex-1 px-4 py-6 space-y-2 custom-scrollbar overflow-y-auto\">\n          <div className=\"space-y-1\">\n            {navigationItems.map((item) => {\n              const Icon = item.icon;\n              const isActive = location === item.path;\n              \n              return (\n                <Link\n                  key={item.id}\n                  href={item.path}\n                  className={cn(\n                    \"flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors\",\n                    isActive\n                      ? \"bg-primary text-primary-foreground\"\n                      : \"text-muted-foreground hover:text-foreground hover:bg-muted\"\n                  )}\n                  data-testid={`nav-${item.id}`}\n                >\n                  <Icon className=\"mr-3 h-4 w-4\" />\n                  {item.label}\n                </Link>\n              );\n            })}\n          </div>\n          \n          {/* Marketplace Section */}\n          <div className=\"pt-4 border-t border-border\">\n            <h3 className=\"px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2\">\n              Marketplace\n            </h3>\n            <div className=\"space-y-1\">\n              {marketplaceItems.map((item) => {\n                const Icon = item.icon;\n                const isActive = location === item.path;\n                \n                return (\n                  <Link\n                    key={item.id}\n                    href={item.path}\n                    className={cn(\n                      \"flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors\",\n                      isActive\n                        ? \"bg-primary text-primary-foreground\"\n                        : \"text-muted-foreground hover:text-foreground hover:bg-muted\"\n                    )}\n                    data-testid={`nav-${item.id}`}\n                  >\n                    <Icon className=\"mr-3 h-4 w-4\" />\n                    {item.label}\n                  </Link>\n                );\n              })}\n            </div>\n          </div>\n          \n          {/* Management Section */}\n          <div className=\"pt-4 border-t border-border\">\n            <h3 className=\"px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2\">\n              Management\n            </h3>\n            <div className=\"space-y-1\">\n              {managementItems.map((item) => {\n                if (item.adminOnly && (!user || user.role !== 'admin')) return null;\n                \n                const Icon = item.icon;\n                const isActive = location === item.path;\n                \n                return (\n                  <Link\n                    key={item.id}\n                    href={item.path}\n                    className={cn(\n                      \"flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors\",\n                      isActive\n                        ? \"bg-primary text-primary-foreground\"\n                        : \"text-muted-foreground hover:text-foreground hover:bg-muted\"\n                    )}\n                    data-testid={`nav-${item.id}`}\n                  >\n                    <Icon className=\"mr-3 h-4 w-4\" />\n                    {item.label}\n                  </Link>\n                );\n              })}\n            </div>\n          </div>\n        </nav>\n        \n        {/* User Profile */}\n        <div className=\"p-4 border-t border-border\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"w-8 h-8 bg-primary rounded-full flex items-center justify-center\">\n              <span className=\"text-primary-foreground text-sm font-medium\">\n                {user?.firstName?.[0] || 'U'}{user?.lastName?.[0] || 'U'}\n              </span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-foreground truncate\">\n                {user?.firstName || 'Unknown'} {user?.lastName || 'User'}\n              </p>\n              <p className=\"text-xs text-muted-foreground capitalize\">{user?.role || 'staff'}</p>\n            </div>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={handleLogout}\n              className=\"text-muted-foreground hover:text-foreground p-1\"\n              data-testid=\"button-logout\"\n            >\n              <LogOut className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n      </div>\n    </aside>\n  );\n}\n","size_bytes":7651},"client/src/components/dashboard/quick-actions.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\nimport { Egg, Skull, Wheat, Coins } from \"lucide-react\";\nimport SalesForm from \"@/components/forms/SalesForm\";\nimport { z } from \"zod\";\n\nconst actions = [\n  {\n    id: \"record-eggs\",\n    title: \"Record Eggs\",\n    description: \"Daily egg collection\",\n    icon: Egg,\n    color: \"bg-chart-3/10 text-chart-3\",\n  },\n  {\n    id: \"add-mortality\",\n    title: \"Record Mortality\",\n    description: \"Track bird losses\",\n    icon: Skull,\n    color: \"bg-red-100 text-red-600\",\n  },\n  {\n    id: \"update-feed\",\n    title: \"Update Feed\",\n    description: \"Log feed consumption\",\n    icon: Wheat,\n    color: \"bg-orange-100 text-orange-600\",\n  },\n  {\n    id: \"record-sale\",\n    title: \"Record Sale\",\n    description: \"Log egg sales\",\n    icon: Coins,\n    color: \"bg-green-100 text-green-600\",\n  },\n];\n\n// Quick action schemas\nconst eggRecordSchema = z.object({\n  flockId: z.string().min(1, \"Flock selection is required\"),\n  eggsCollected: z.number().min(0),\n  brokenEggs: z.number().min(0).default(0),\n  recordDate: z.string().min(1),\n  notes: z.string().optional(),\n});\n\nconst mortalitySchema = z.object({\n  flockId: z.string().min(1, \"Flock selection is required\"),\n  recordDate: z.string().min(1),\n  mortalityCount: z.number().min(0),\n  mortalityReason: z.string().min(1, \"Reason is required\"),\n  notes: z.string().optional(),\n});\n\nconst feedUpdateSchema = z.object({\n  flockId: z.string().min(1, \"Flock selection is required\"),\n  recordDate: z.string().min(1),\n  feedConsumed: z.string().min(1),\n  feedType: z.string().min(1),\n  notes: z.string().optional(),\n});\n\n\nexport default function QuickActions() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n  const [eggDialogOpen, setEggDialogOpen] = useState(false);\n  const [mortalityDialogOpen, setMortalityDialogOpen] = useState(false);\n  const [feedDialogOpen, setFeedDialogOpen] = useState(false);\n  const [saleDialogOpen, setSaleDialogOpen] = useState(false);\n\n  const { data: flocks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/flocks\"],\n  });\n\n  // Forms\n  const eggForm = useForm({\n    resolver: zodResolver(eggRecordSchema),\n    defaultValues: { flockId: \"\", eggsCollected: 0, brokenEggs: 0, recordDate: new Date().toISOString().split('T')[0], notes: \"\" },\n  });\n\n  const mortalityForm = useForm({\n    resolver: zodResolver(mortalitySchema),\n    defaultValues: { flockId: \"\", recordDate: new Date().toISOString().split('T')[0], mortalityCount: 0, mortalityReason: \"\", notes: \"\" },\n  });\n\n  const feedForm = useForm({\n    resolver: zodResolver(feedUpdateSchema),\n    defaultValues: { flockId: \"\", recordDate: new Date().toISOString().split('T')[0], feedConsumed: \"\", feedType: \"\", notes: \"\" },\n  });\n\n\n  // Farm context guard helper\n  const handleFormSubmit = (callback: () => void) => {\n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select an active farm before submitting records.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    callback();\n  };\n\n  // Mutations\n  const createEggRecord = useMutation({\n    mutationFn: async (data: z.infer<typeof eggRecordSchema>) => {\n      const recordData = {\n        flockId: data.flockId,\n        recordDate: data.recordDate,\n        eggsCollected: data.eggsCollected,\n        brokenEggs: data.brokenEggs,\n        cratesProduced: Math.floor(data.eggsCollected / 30),\n        mortalityCount: 0, mortalityReason: null, feedConsumed: null, feedType: null,\n        temperature: null, lightingHours: null, averageWeight: null, sampleSize: 0,\n        notes: data.notes || \"\",\n        farmId: activeFarmId,\n      };\n      console.log(\"Submitting quick egg record:\", recordData);\n      await apiRequest(\"POST\", \"/api/daily-records\", recordData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({ title: \"Success\", description: \"Egg record created\" });\n      eggForm.reset(); setEggDialogOpen(false);\n    },\n    onError: (error) => {\n      toast({ \n        title: \"Error\", \n        description: \"Failed to record eggs. Please try again.\", \n        variant: \"destructive\" \n      });\n      console.error(\"Failed to create egg record:\", error);\n    },\n  });\n\n  const createMortalityRecord = useMutation({\n    mutationFn: async (data: z.infer<typeof mortalitySchema>) => {\n      const recordData = {\n        flockId: data.flockId,\n        recordDate: data.recordDate,\n        eggsCollected: 0, brokenEggs: 0, cratesProduced: 0,\n        mortalityCount: data.mortalityCount,\n        mortalityReason: data.mortalityReason,\n        feedConsumed: null, feedType: null, temperature: null, lightingHours: null,\n        averageWeight: null, sampleSize: 0, notes: data.notes || \"\",\n        farmId: activeFarmId,\n      };\n      await apiRequest(\"POST\", \"/api/daily-records\", recordData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({ title: \"Success\", description: \"Mortality record created\" });\n      mortalityForm.reset(); setMortalityDialogOpen(false);\n    },\n    onError: (error) => {\n      toast({ \n        title: \"Error\", \n        description: \"Failed to record mortality. Please try again.\", \n        variant: \"destructive\" \n      });\n      console.error(\"Failed to create mortality record:\", error);\n    },\n  });\n\n  const createFeedRecord = useMutation({\n    mutationFn: async (data: z.infer<typeof feedUpdateSchema>) => {\n      const recordData = {\n        flockId: data.flockId,\n        recordDate: data.recordDate,\n        eggsCollected: 0, brokenEggs: 0, cratesProduced: 0,\n        mortalityCount: 0, mortalityReason: null,\n        feedConsumed: data.feedConsumed,\n        feedType: data.feedType,\n        temperature: null, lightingHours: null, averageWeight: null, sampleSize: 0,\n        notes: data.notes || \"\",\n        farmId: activeFarmId,\n      };\n      await apiRequest(\"POST\", \"/api/daily-records\", recordData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-records\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({ title: \"Success\", description: \"Feed record updated\" });\n      feedForm.reset(); setFeedDialogOpen(false);\n    },\n    onError: (error) => {\n      toast({ \n        title: \"Error\", \n        description: \"Failed to update feed record. Please try again.\", \n        variant: \"destructive\" \n      });\n      console.error(\"Failed to create feed record:\", error);\n    },\n  });\n\n\n\n  return (\n    <Card data-testid=\"card-quick-actions\">\n      <CardHeader>\n        <CardTitle>Quick Actions</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-3\">\n          {actions.map((action) => {\n            const Icon = action.icon;\n            const getDialogContent = () => {\n              switch (action.id) {\n                case \"record-eggs\":\n                  return (\n                    <Dialog open={eggDialogOpen} onOpenChange={setEggDialogOpen}>\n                      <DialogTrigger asChild>\n                        <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                            <Icon className=\"h-5 w-5\" />\n                          </div>\n                          <div className=\"text-left\">\n                            <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                            <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n                          </div>\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Record Eggs</DialogTitle>\n                          <DialogDescription>Record today's egg collection</DialogDescription>\n                        </DialogHeader>\n                        <Form {...eggForm}>\n                          <form onSubmit={eggForm.handleSubmit((data) => handleFormSubmit(() => createEggRecord.mutate(data)))} className=\"space-y-4\">\n                            <FormField control={eggForm.control} name=\"flockId\" render={({ field }) => (\n                              <FormItem><FormLabel>Flock</FormLabel><FormControl>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <SelectTrigger data-testid=\"select-egg-flock\"><SelectValue placeholder=\"Select flock\" /></SelectTrigger>\n                                  <SelectContent>\n                                    {flocks.map((flock) => (\n                                      <SelectItem key={flock.id} value={flock.id}>\n                                        {flock.name} ({flock.currentCount} birds)\n                                      </SelectItem>\n                                    ))}\n                                  </SelectContent>\n                                </Select>\n                              </FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={eggForm.control} name=\"recordDate\" render={({ field }) => (\n                              <FormItem><FormLabel>Date</FormLabel><FormControl><Input type=\"date\" {...field} data-testid=\"input-egg-record-date\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={eggForm.control} name=\"eggsCollected\" render={({ field }) => (\n                              <FormItem><FormLabel>Eggs Collected</FormLabel><FormControl><Input type=\"number\" {...field} onChange={(e) => field.onChange(parseInt(e.target.value) || 0)} data-testid=\"input-eggs-collected\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={eggForm.control} name=\"brokenEggs\" render={({ field }) => (\n                              <FormItem><FormLabel>Broken Eggs</FormLabel><FormControl><Input type=\"number\" {...field} onChange={(e) => field.onChange(parseInt(e.target.value) || 0)} data-testid=\"input-broken-eggs\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={eggForm.control} name=\"notes\" render={({ field }) => (\n                              <FormItem><FormLabel>Notes</FormLabel><FormControl><Input {...field} placeholder=\"Optional notes\" data-testid=\"input-egg-notes\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <Button type=\"submit\" disabled={createEggRecord.isPending} className=\"w-full\" data-testid=\"button-submit-egg-record\">\n                              {createEggRecord.isPending ? \"Recording...\" : \"Record Eggs\"}\n                            </Button>\n                          </form>\n                        </Form>\n                      </DialogContent>\n                    </Dialog>\n                  );\n                case \"add-mortality\":\n                  return (\n                    <Dialog open={mortalityDialogOpen} onOpenChange={setMortalityDialogOpen}>\n                      <DialogTrigger asChild>\n                        <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                            <Icon className=\"h-5 w-5\" />\n                          </div>\n                          <div className=\"text-left\">\n                            <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                            <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n                          </div>\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Record Mortality</DialogTitle>\n                          <DialogDescription>Record bird losses and reason</DialogDescription>\n                        </DialogHeader>\n                        <Form {...mortalityForm}>\n                          <form onSubmit={mortalityForm.handleSubmit((data) => handleFormSubmit(() => createMortalityRecord.mutate(data)))} className=\"space-y-4\">\n                            <FormField control={mortalityForm.control} name=\"flockId\" render={({ field }) => (\n                              <FormItem><FormLabel>Flock</FormLabel><FormControl>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <SelectTrigger data-testid=\"select-mortality-flock\"><SelectValue placeholder=\"Select flock\" /></SelectTrigger>\n                                  <SelectContent>\n                                    {flocks.map((flock) => (\n                                      <SelectItem key={flock.id} value={flock.id}>\n                                        {flock.name} ({flock.currentCount} birds)\n                                      </SelectItem>\n                                    ))}\n                                  </SelectContent>\n                                </Select>\n                              </FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={mortalityForm.control} name=\"recordDate\" render={({ field }) => (\n                              <FormItem><FormLabel>Date</FormLabel><FormControl><Input type=\"date\" {...field} data-testid=\"input-mortality-date\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={mortalityForm.control} name=\"mortalityCount\" render={({ field }) => (\n                              <FormItem><FormLabel>Number of Birds Lost</FormLabel><FormControl><Input type=\"number\" {...field} onChange={(e) => field.onChange(parseInt(e.target.value) || 0)} data-testid=\"input-mortality-count\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={mortalityForm.control} name=\"mortalityReason\" render={({ field }) => (\n                              <FormItem><FormLabel>Reason</FormLabel><FormControl>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <SelectTrigger data-testid=\"select-mortality-reason\"><SelectValue placeholder=\"Select reason\" /></SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"disease\">Disease</SelectItem>\n                                    <SelectItem value=\"predator\">Predator Attack</SelectItem>\n                                    <SelectItem value=\"accident\">Accident</SelectItem>\n                                    <SelectItem value=\"old-age\">Old Age</SelectItem>\n                                    <SelectItem value=\"unknown\">Unknown</SelectItem>\n                                    <SelectItem value=\"other\">Other</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={mortalityForm.control} name=\"notes\" render={({ field }) => (\n                              <FormItem><FormLabel>Additional Notes</FormLabel><FormControl><Textarea {...field} placeholder=\"Additional details\" data-testid=\"textarea-mortality-notes\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <Button type=\"submit\" disabled={createMortalityRecord.isPending} className=\"w-full\" data-testid=\"button-submit-mortality\">\n                              {createMortalityRecord.isPending ? \"Recording...\" : \"Record Mortality\"}\n                            </Button>\n                          </form>\n                        </Form>\n                      </DialogContent>\n                    </Dialog>\n                  );\n                case \"update-feed\":\n                  return (\n                    <Dialog open={feedDialogOpen} onOpenChange={setFeedDialogOpen}>\n                      <DialogTrigger asChild>\n                        <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                            <Icon className=\"h-5 w-5\" />\n                          </div>\n                          <div className=\"text-left\">\n                            <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                            <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n                          </div>\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Update Feed</DialogTitle>\n                          <DialogDescription>Log feed consumption for today</DialogDescription>\n                        </DialogHeader>\n                        <Form {...feedForm}>\n                          <form onSubmit={feedForm.handleSubmit((data) => handleFormSubmit(() => createFeedRecord.mutate(data)))} className=\"space-y-4\">\n                            <FormField control={feedForm.control} name=\"flockId\" render={({ field }) => (\n                              <FormItem><FormLabel>Flock</FormLabel><FormControl>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <SelectTrigger data-testid=\"select-feed-flock\"><SelectValue placeholder=\"Select flock\" /></SelectTrigger>\n                                  <SelectContent>\n                                    {flocks.map((flock) => (\n                                      <SelectItem key={flock.id} value={flock.id}>\n                                        {flock.name} ({flock.currentCount} birds)\n                                      </SelectItem>\n                                    ))}\n                                  </SelectContent>\n                                </Select>\n                              </FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={feedForm.control} name=\"recordDate\" render={({ field }) => (\n                              <FormItem><FormLabel>Date</FormLabel><FormControl><Input type=\"date\" {...field} data-testid=\"input-feed-date\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={feedForm.control} name=\"feedConsumed\" render={({ field }) => (\n                              <FormItem><FormLabel>Feed Consumed (kg)</FormLabel><FormControl><Input {...field} placeholder=\"e.g., 520\" data-testid=\"input-feed-consumed\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={feedForm.control} name=\"feedType\" render={({ field }) => (\n                              <FormItem><FormLabel>Feed Type</FormLabel><FormControl>\n                                <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                  <SelectTrigger data-testid=\"select-feed-type\"><SelectValue placeholder=\"Select feed type\" /></SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"layer-mash\">Layer Mash</SelectItem>\n                                    <SelectItem value=\"layer-pellets\">Layer Pellets</SelectItem>\n                                    <SelectItem value=\"grower-mash\">Grower Mash</SelectItem>\n                                    <SelectItem value=\"starter-mash\">Starter Mash</SelectItem>\n                                    <SelectItem value=\"wheat\">Wheat</SelectItem>\n                                    <SelectItem value=\"maize\">Maize</SelectItem>\n                                    <SelectItem value=\"other\">Other</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </FormControl><FormMessage /></FormItem>\n                            )} />\n                            <FormField control={feedForm.control} name=\"notes\" render={({ field }) => (\n                              <FormItem><FormLabel>Notes</FormLabel><FormControl><Input {...field} placeholder=\"Additional details\" data-testid=\"input-feed-notes\" /></FormControl><FormMessage /></FormItem>\n                            )} />\n                            <Button type=\"submit\" disabled={createFeedRecord.isPending} className=\"w-full\" data-testid=\"button-submit-feed\">\n                              {createFeedRecord.isPending ? \"Updating...\" : \"Update Feed\"}\n                            </Button>\n                          </form>\n                        </Form>\n                      </DialogContent>\n                    </Dialog>\n                  );\n                case \"record-sale\":\n                  return (\n                    <Dialog open={saleDialogOpen} onOpenChange={setSaleDialogOpen}>\n                      <DialogTrigger asChild>\n                        <Button variant=\"ghost\" className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\" data-testid={`button-${action.id}`}>\n                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                            <Icon className=\"h-5 w-5\" />\n                          </div>\n                          <div className=\"text-left\">\n                            <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                            <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n                          </div>\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Record Sale</DialogTitle>\n                          <DialogDescription>Record egg sales with customer details</DialogDescription>\n                        </DialogHeader>\n                        <SalesForm\n                          mode=\"dialog\"\n                          compact={true}\n                          onSuccess={() => setSaleDialogOpen(false)}\n                          customerNameRequired={true}\n                          showNotes={true}\n                        />\n                      </DialogContent>\n                    </Dialog>\n                  );\n                default:\n                  return (\n                    <Button\n                      key={action.id}\n                      variant=\"ghost\"\n                      className=\"w-full flex items-center space-x-3 p-3 h-auto justify-start hover:bg-muted\"\n                      data-testid={`button-${action.id}`}\n                    >\n                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                        <Icon className=\"h-5 w-5\" />\n                      </div>\n                      <div className=\"text-left\">\n                        <p className=\"text-sm font-medium text-foreground\">{action.title}</p>\n                        <p className=\"text-xs text-muted-foreground\">{action.description}</p>\n                      </div>\n                    </Button>\n                  );\n              }\n            };\n            \n            return <div key={action.id}>{getDialogContent()}</div>;\n          })}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":25574},"client/src/components/forms/simple-expense-form.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useFarmContext } from \"@/contexts/FarmContext\";\n\ninterface SimpleExpenseFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function SimpleExpenseForm({ onSuccess }: SimpleExpenseFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { activeFarmId, hasActiveFarm } = useFarmContext();\n\n  // Form state\n  const [expenseDate, setExpenseDate] = useState(new Date().toISOString().split('T')[0]);\n  const [category, setCategory] = useState(\"feed\");\n  const [description, setDescription] = useState(\"\");\n  const [amount, setAmount] = useState(\"\");\n  const [vendor, setVendor] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n\n  const createExpenseMutation = useMutation({\n    mutationFn: async (data: any) => {\n      console.log(\"Submitting expense record:\", data);\n      await apiRequest(\"POST\", \"/api/expenses\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/expenses\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/metrics\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/activity\"] });\n      toast({\n        title: \"Success\",\n        description: \"Expense recorded successfully\"\n      });\n      \n      // Reset form\n      setExpenseDate(new Date().toISOString().split('T')[0]);\n      setCategory(\"feed\");\n      setDescription(\"\");\n      setAmount(\"\");\n      setVendor(\"\");\n      setNotes(\"\");\n      \n      if (onSuccess) onSuccess();\n    },\n    onError: (error: any) => {\n      console.error(\"Failed to create expense:\", error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to record expense. Please try again.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!hasActiveFarm) {\n      toast({\n        title: \"Farm Required\",\n        description: \"Please select an active farm before submitting records.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (!description.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter a description\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!amount || parseFloat(amount) <= 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter valid amount\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const expenseData = {\n      expenseDate,\n      category,\n      description: description.trim(),\n      amount: amount, // Send as string to match decimal field\n      vendor: vendor.trim() || undefined,\n      notes: notes.trim(),\n      farmId: activeFarmId,\n    };\n\n    createExpenseMutation.mutate(expenseData);\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"expenseDate\">Date</Label>\n          <Input\n            id=\"expenseDate\"\n            type=\"date\"\n            value={expenseDate}\n            onChange={(e) => setExpenseDate(e.target.value)}\n            required\n            data-testid=\"input-expense-date\"\n          />\n        </div>\n        \n        <div className=\"space-y-2\">\n          <Label htmlFor=\"category\">Category</Label>\n          <Select value={category} onValueChange={setCategory}>\n            <SelectTrigger data-testid=\"select-expense-category\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"feed\">Feed & Nutrition</SelectItem>\n              <SelectItem value=\"medication\">Medication & Health</SelectItem>\n              <SelectItem value=\"equipment\">Equipment & Supplies</SelectItem>\n              <SelectItem value=\"utilities\">Utilities</SelectItem>\n              <SelectItem value=\"labor\">Labor & Wages</SelectItem>\n              <SelectItem value=\"transport\">Transportation</SelectItem>\n              <SelectItem value=\"maintenance\">Maintenance & Repairs</SelectItem>\n              <SelectItem value=\"other\">Other</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"description\">Description *</Label>\n        <Input\n          id=\"description\"\n          placeholder=\"e.g., Layer feed purchase, Equipment repair\"\n          value={description}\n          onChange={(e) => setDescription(e.target.value)}\n          required\n          data-testid=\"input-expense-description\"\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"amount\">Amount (KSh) *</Label>\n          <Input\n            id=\"amount\"\n            type=\"number\"\n            step=\"0.01\"\n            placeholder=\"0.00\"\n            value={amount}\n            onChange={(e) => setAmount(e.target.value)}\n            required\n            data-testid=\"input-expense-amount\"\n          />\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"vendor\">Vendor/Supplier</Label>\n          <Input\n            id=\"vendor\"\n            placeholder=\"e.g., ABC Feeds Ltd\"\n            value={vendor}\n            onChange={(e) => setVendor(e.target.value)}\n            data-testid=\"input-expense-vendor\"\n          />\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"notes\">Notes</Label>\n        <Textarea\n          id=\"notes\"\n          placeholder=\"Additional notes about this expense\"\n          value={notes}\n          onChange={(e) => setNotes(e.target.value)}\n          rows={2}\n          data-testid=\"textarea-expense-notes\"\n        />\n      </div>\n\n      <Button\n        type=\"submit\"\n        className=\"w-full\"\n        disabled={createExpenseMutation.isPending}\n        data-testid=\"button-submit-expense\"\n      >\n        {createExpenseMutation.isPending ? \"Recording...\" : \"Record Expense\"}\n      </Button>\n    </form>\n  );\n}","size_bytes":6508},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { setupAuth, isAuthenticated } from \"./replitAuth\";\nimport {\n  insertFarmSchema,\n  insertFlockSchema,\n  insertDailyRecordSchema,\n  insertSaleSchema,\n  insertFeedInventorySchema,\n  insertHealthRecordSchema,\n  insertExpenseSchema,\n  insertBreakEvenAssumptionsSchema,\n  insertCustomerSchema,\n  insertProductSchema,\n  insertOrderSchema,\n  insertOrderItemSchema,\n  insertDeliverySchema,\n  insertUserSchema,\n  insertManagerUserSchema,\n  insertWeightRecordSchema,\n  insertBreedStandardSchema\n} from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { normalizeNumericFields } from \"./utils/numbers\";\nimport { safeDate } from \"./utils/dates\";\nimport { aggregateByMonth, calculateBreakEven, autoCalculateBreakEvenParams } from \"./breakEvenUtils\";\n\n// Farm context resolution helper - handles admin vs non-admin users with flockId fallback\nasync function requireFarmContext(req: any, currentUser: any): Promise<string> {\n  if (currentUser.role === 'admin') {\n    // Admin users: try explicit farmId first, then derive from flockId\n    let farmId = req.body.farmId || req.query.farmId;\n    \n    if (!farmId && req.body.flockId) {\n      // Fallback: derive farmId from flockId\n      const flock = await storage.getFlockById(req.body.flockId);\n      if (!flock) {\n        throw new Error(\"Invalid flockId: flock not found\");\n      }\n      farmId = flock.farmId;\n    }\n    \n    if (!farmId) {\n      throw new Error(\"Admin must specify farmId in request body or query parameter\");\n    }\n    return farmId;\n  } else {\n    // Non-admin users must have farmId in their profile\n    if (!currentUser.farmId) {\n      throw new Error(\"User must be associated with a farm\");\n    }\n    \n    // If flockId is provided, validate it belongs to user's farm (tenant isolation)\n    if (req.body.flockId) {\n      const flock = await storage.getFlockById(req.body.flockId);\n      if (!flock) {\n        throw new Error(\"Invalid flockId: flock not found\");\n      }\n      if (flock.farmId !== currentUser.farmId) {\n        throw new Error(\"Access denied: flock does not belong to your farm\");\n      }\n    }\n    \n    return currentUser.farmId;\n  }\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Auth middleware\n  await setupAuth(app);\n\n  // Health check endpoint for deployment verification\n  app.get('/health', (_req, res) => {\n    res.status(200).json({ \n      status: 'ok',\n      timestamp: new Date().toISOString(),\n      environment: process.env.NODE_ENV || 'development'\n    });\n  });\n\n  // Auth routes\n  app.get('/api/auth/user', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  // Users routes\n  app.get('/api/users', isAuthenticated, async (req: any, res) => {\n    try {\n      // Allow admins and managers to view users with proper tenant scoping\n      const currentUser = await storage.getUser(req.user.claims.sub);\n      if (!currentUser || !['admin', 'manager'].includes(currentUser.role || '')) {\n        return res.status(403).json({ message: \"Access denied. Admin or manager role required.\" });\n      }\n      \n      let users;\n      if (currentUser.role === 'admin') {\n        // Admins can see all users\n        users = await storage.getUsers();\n      } else {\n        // Managers can only see users from their farm (excluding admins)\n        if (!currentUser.farmId) {\n          return res.status(400).json({ message: \"Manager must be associated with a farm\" });\n        }\n        users = await storage.getUsersByFarm(currentUser.farmId);\n      }\n      \n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  // Create new user\n  app.post('/api/users', isAuthenticated, async (req: any, res) => {\n    try {\n      const currentUser = await storage.getUser(req.user.claims.sub);\n      if (!currentUser || !['admin', 'manager'].includes(currentUser.role || '')) {\n        return res.status(403).json({ message: \"Access denied. Admin or manager role required.\" });\n      }\n\n      let validatedData;\n      \n      if (currentUser.role === 'manager') {\n        // Managers can only create staff and customers (no managers)\n        validatedData = insertManagerUserSchema.parse(req.body);\n        // Assign to manager's farm ONLY for staff roles, customers get farmId = null\n        if (!currentUser.farmId) {\n          return res.status(400).json({ message: \"Manager must be associated with a farm\" });\n        }\n        \n        if (validatedData.role === 'staff') {\n          validatedData.farmId = currentUser.farmId;\n        } else if (validatedData.role === 'customer') {\n          validatedData.farmId = null;\n        }\n      } else {\n        // Admins can create any role\n        validatedData = insertUserSchema.parse(req.body);\n        \n        // Ensure role is defined before type checking\n        if (!validatedData.role) {\n          return res.status(400).json({ message: \"Role is required\" });\n        }\n        \n        // For admins creating non-customer roles, require valid farmId\n        if (!['admin', 'customer'].includes(validatedData.role)) {\n          if (!validatedData.farmId || typeof validatedData.farmId !== 'string') {\n            return res.status(400).json({ \n              message: \"Farm ID is required for staff, manager, and farm_owner roles\" \n            });\n          }\n          // Verify the farm exists\n          const farm = await storage.getFarmById(validatedData.farmId);\n          if (!farm) {\n            return res.status(400).json({ message: \"Invalid farm ID\" });\n          }\n        } else {\n          // Admin and customer roles don't need farmId\n          validatedData.farmId = null;\n        }\n      }\n\n      const newUser = await storage.upsertUser(validatedData);\n      res.status(201).json(newUser);\n    } catch (error) {\n      console.error(\"Error creating user:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      }\n      if (error instanceof Error && error.message.includes('unique')) {\n        return res.status(400).json({ message: \"Email already exists\" });\n      }\n      res.status(500).json({ message: \"Failed to create user\" });\n    }\n  });\n\n  // Farm routes\n  app.post('/api/farms', isAuthenticated, async (req: any, res) => {\n    try {\n      const farmData = insertFarmSchema.parse(req.body);\n      const userId = req.user.claims.sub;\n      \n      // SECURITY: Use atomic transaction to create farm and bind user\n      const result = await storage.createFarmWithOwner(farmData, userId);\n      \n      res.status(201).json({\n        farm: result.farm,\n        user: result.user,\n        message: \"Farm registered successfully and user promoted to farm owner\"\n      });\n    } catch (error) {\n      console.error(\"Error creating farm:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid farm data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create farm\" });\n    }\n  });\n\n  app.get('/api/farms', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      if (!currentUser) {\n        return res.status(403).json({ message: \"User not found\" });\n      }\n      \n      // SECURITY: Filter farms based on user access permissions\n      const farms = await storage.getFarmsByUserAccess(userId, currentUser.role);\n      res.json(farms);\n    } catch (error) {\n      console.error(\"Error fetching farms:\", error);\n      res.status(500).json({ message: \"Failed to fetch farms\" });\n    }\n  });\n\n  app.get('/api/farms/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      if (!currentUser) {\n        return res.status(403).json({ message: \"User not found\" });\n      }\n      \n      const farm = await storage.getFarmById(req.params.id);\n      if (!farm) {\n        return res.status(404).json({ message: \"Farm not found\" });\n      }\n      \n      // SECURITY: Only allow admin OR users whose farmId matches the farm\n      if (currentUser.role !== 'admin' && currentUser.farmId !== farm.id) {\n        return res.status(403).json({ message: \"Access denied. You can only view your own farm.\" });\n      }\n      \n      res.json(farm);\n    } catch (error) {\n      console.error(\"Error fetching farm:\", error);\n      res.status(500).json({ message: \"Failed to fetch farm\" });\n    }\n  });\n\n  app.patch('/api/farms/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      if (!currentUser) {\n        return res.status(403).json({ message: \"User not found\" });\n      }\n      \n      const farm = await storage.getFarmById(req.params.id);\n      if (!farm) {\n        return res.status(404).json({ message: \"Farm not found\" });\n      }\n      \n      // SECURITY: Only allow admin OR users whose farmId matches the farm\n      if (currentUser.role !== 'admin' && currentUser.farmId !== farm.id) {\n        return res.status(403).json({ message: \"Access denied. You can only update your own farm.\" });\n      }\n      \n      const updates = insertFarmSchema.partial().parse(req.body);\n      \n      let updatedFarm: any;\n      if (currentUser.role === 'admin') {\n        // SECURITY: Admins can update all fields including status and isApproved\n        updatedFarm = await storage.updateFarm(req.params.id, updates);\n      } else {\n        // SECURITY: Farm owners can only update specific fields to prevent privilege escalation\n        updatedFarm = await storage.updateFarmOwnerFields(req.params.id, updates);\n      }\n      \n      res.json(updatedFarm);\n    } catch (error) {\n      console.error(\"Error updating farm:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid farm data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update farm\" });\n    }\n  });\n\n  // SECURITY: Replace vulnerable user-specific endpoint with secure /me endpoint\n  app.get('/api/farms/me', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const farms = await storage.getFarmsByUserId(userId);\n      res.json(farms);\n    } catch (error) {\n      console.error(\"Error fetching user farms:\", error);\n      res.status(500).json({ message: \"Failed to fetch user farms\" });\n    }\n  });\n\n  // Dashboard routes\n  app.get('/api/dashboard/metrics', isAuthenticated, async (req: any, res) => {\n    try {\n      const currentUser = await storage.getUser(req.user.claims.sub);\n      if (!currentUser) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n\n      const farmId = await requireFarmContext(req, currentUser);\n      const metrics = await storage.getDashboardMetrics(farmId);\n      res.json(metrics);\n    } catch (error) {\n      console.error(\"Error fetching dashboard metrics:\", error);\n      res.status(500).json({ message: \"Failed to fetch dashboard metrics\" });\n    }\n  });\n\n  app.get('/api/dashboard/activity', isAuthenticated, async (req: any, res) => {\n    try {\n      const currentUser = await storage.getUser(req.user.claims.sub);\n      if (!currentUser) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n\n      const farmId = await requireFarmContext(req, currentUser);\n      const limit = parseInt(req.query.limit as string) || 10;\n      const activity = await storage.getRecentActivity(farmId, limit);\n      res.json(activity);\n    } catch (error) {\n      console.error(\"Error fetching recent activity:\", error);\n      res.status(500).json({ message: \"Failed to fetch recent activity\" });\n    }\n  });\n\n  // Flock routes\n  app.get('/api/flocks', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      // Parse query parameter for including deactivated flocks\n      const includeDeactivated = req.query.includeDeactivated === 'true';\n      \n      // Only admins can view deactivated flocks\n      if (includeDeactivated && currentUser?.role !== 'admin') {\n        return res.status(403).json({ \n          message: \"Access denied. Administrator role required to view deactivated flocks.\" \n        });\n      }\n      \n      const flocks = await storage.getFlocks(includeDeactivated);\n      res.json(flocks);\n    } catch (error) {\n      console.error(\"Error fetching flocks:\", error);\n      res.status(500).json({ message: \"Failed to fetch flocks\" });\n    }\n  });\n\n  app.post('/api/flocks', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Auto-inject farmId and userId for security\n      const flockData = {\n        ...req.body,\n        farmId,\n      };\n\n      const validatedData = insertFlockSchema.parse(flockData);\n      const flock = await storage.createFlock(validatedData);\n      res.status(201).json(flock);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating flock:\", error);\n        res.status(500).json({ message: \"Failed to create flock\" });\n      }\n    }\n  });\n\n  app.get('/api/flocks/:id', isAuthenticated, async (req, res) => {\n    try {\n      const flock = await storage.getFlockById(req.params.id);\n      if (!flock) {\n        return res.status(404).json({ message: \"Flock not found\" });\n      }\n      res.json(flock);\n    } catch (error) {\n      console.error(\"Error fetching flock:\", error);\n      res.status(500).json({ message: \"Failed to fetch flock\" });\n    }\n  });\n\n  // Update flock\n  app.put('/api/flocks/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      if (!currentUser) {\n        return res.status(403).json({ message: \"User not found\" });\n      }\n\n      // Get the existing flock to verify ownership\n      const existingFlock = await storage.getFlockById(req.params.id);\n      if (!existingFlock) {\n        return res.status(404).json({ message: \"Flock not found\" });\n      }\n\n      // Resource-based authorization: Allow admins to update any flock, others only their farm's flocks\n      if (currentUser.role !== 'admin' && currentUser.farmId !== existingFlock.farmId) {\n        return res.status(403).json({ message: \"Access denied. Flock belongs to different farm.\" });\n      }\n\n      // Remove fields that shouldn't be updated by users\n      const { id, farmId, createdAt, updatedAt, ...updateData } = req.body;\n      \n      const validatedData = insertFlockSchema.partial().strip().parse(updateData);\n      const updatedFlock = await storage.updateFlock(req.params.id, validatedData);\n      res.json(updatedFlock);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error updating flock:\", error);\n        res.status(500).json({ message: \"Failed to update flock\" });\n      }\n    }\n  });\n\n  // Deactivate flock (admin-only)\n  app.patch('/api/flocks/:id/deactivate', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      // Only administrators can deactivate flocks\n      if (currentUser?.role !== 'admin') {\n        return res.status(403).json({ message: \"Access denied. Administrator role required to deactivate flocks.\" });\n      }\n\n      // Get the existing flock\n      const existingFlock = await storage.getFlockById(req.params.id);\n      if (!existingFlock) {\n        return res.status(404).json({ message: \"Flock not found\" });\n      }\n\n      // Update the flock status to deactivated\n      const deactivatedFlock = await storage.updateFlock(req.params.id, { \n        status: 'deactivated' \n      });\n      \n      res.json({ \n        message: \"Flock deactivated successfully\", \n        flock: deactivatedFlock \n      });\n    } catch (error) {\n      console.error(\"Error deactivating flock:\", error);\n      res.status(500).json({ message: \"Failed to deactivate flock\" });\n    }\n  });\n\n  // Reactivate flock (admin-only)\n  app.patch('/api/flocks/:id/reactivate', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      // Only administrators can reactivate flocks\n      if (currentUser?.role !== 'admin') {\n        return res.status(403).json({ message: \"Access denied. Administrator role required to reactivate flocks.\" });\n      }\n\n      // Get the existing flock\n      const existingFlock = await storage.getFlockById(req.params.id);\n      if (!existingFlock) {\n        return res.status(404).json({ message: \"Flock not found\" });\n      }\n\n      // Check if flock is actually deactivated\n      if (existingFlock.status !== 'deactivated') {\n        return res.status(400).json({ message: \"Flock is not currently deactivated and cannot be reactivated.\" });\n      }\n\n      // Update the flock status to brooding (default active state for new flocks)\n      const reactivatedFlock = await storage.updateFlock(req.params.id, { \n        status: 'brooding' \n      });\n      \n      res.json({ \n        message: \"Flock reactivated successfully\", \n        flock: reactivatedFlock \n      });\n    } catch (error) {\n      console.error(\"Error reactivating flock:\", error);\n      res.status(500).json({ message: \"Failed to reactivate flock\" });\n    }\n  });\n\n  // Daily records routes\n  app.get('/api/daily-records', isAuthenticated, async (req, res) => {\n    try {\n      const flockId = req.query.flockId as string;\n      const limit = parseInt(req.query.limit as string) || 50;\n      const records = await storage.getDailyRecords(flockId, limit);\n      res.json(records);\n    } catch (error) {\n      console.error(\"Error fetching daily records:\", error);\n      res.status(500).json({ message: \"Failed to fetch daily records\" });\n    }\n  });\n\n  app.post('/api/daily-records', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      if (!currentUser) {\n        return res.status(403).json({ message: \"User not found\" });\n      }\n\n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      const validatedData = insertDailyRecordSchema.parse({\n        ...req.body,\n        userId\n      });\n\n      // SECURITY: Validate that the flock belongs to user's farm (tenant isolation)\n      const flock = await storage.getFlockById(validatedData.flockId);\n      if (!flock) {\n        return res.status(404).json({ message: \"Flock not found\" });\n      }\n      \n      if (flock.farmId !== farmId) {\n        return res.status(403).json({ message: \"Access denied. You can only create records for your own farm's flocks.\" });\n      }\n\n      // Double-entry detection: Check for existing records with same userId + flockId + recordDate\n      const existingRecord = await storage.findDailyRecordDuplicate(\n        validatedData.userId, \n        validatedData.flockId, \n        validatedData.recordDate\n      );\n\n      let record;\n      if (existingRecord && existingRecord.reviewStatus === 'approved') {\n        // Duplicate found with approved status - flag for review\n        const recordWithReview = {\n          ...validatedData,\n          reviewStatus: 'pending_review' as const,\n          isDuplicate: true,\n          duplicateOfId: existingRecord.id\n        };\n        \n        // Atomic operation: Create record and notify managers in transaction\n        record = await storage.createDailyRecordWithNotification(recordWithReview, farmId, {\n          type: 'duplicate_entry',\n          title: 'Duplicate Daily Record Detected',\n          message: `A potential duplicate daily record has been submitted for ${validatedData.recordDate}. Please review and approve or reject.`,\n          meta: {\n            duplicateOfId: existingRecord.id,\n            flockId: validatedData.flockId,\n            submittedBy: userId\n          }\n        });\n\n        res.status(201).json({ \n          ...record,\n          message: \"Record submitted for manager review due to potential duplicate.\"\n        });\n      } else {\n        // No duplicates or previous record was rejected - create normally\n        const recordWithReview = {\n          ...validatedData,\n          reviewStatus: 'approved' as const,\n          isDuplicate: false\n        };\n        \n        record = await storage.createDailyRecordWithReview(recordWithReview);\n        \n        // Update flock count if mortalities were recorded\n        if (validatedData.mortalityCount && validatedData.mortalityCount > 0) {\n          const newCount = Math.max(0, flock.currentCount - validatedData.mortalityCount);\n          await storage.updateFlock(validatedData.flockId, { currentCount: newCount });\n        }\n        \n        res.status(201).json(record);\n      }\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating daily record:\", error);\n        // Check for duplicate key constraint violation\n        if ((error as any).code === '23505' && (error as any).constraint === 'uniq_daily_records_flock_date_active') {\n          res.status(409).json({ \n            message: \"A daily record already exists for this flock on this date. Please select a different date or edit the existing record.\" \n          });\n        } else {\n          res.status(500).json({ message: \"Failed to create daily record\" });\n        }\n      }\n    }\n  });\n\n  // Sales routes\n  app.get('/api/sales', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      const limit = parseInt(req.query.limit as string) || 50;\n      const sales = await storage.getSalesByFarm(farmId, limit);\n      res.json(sales);\n    } catch (error) {\n      console.error(\"Error fetching sales:\", error);\n      res.status(500).json({ message: \"Failed to fetch sales\" });\n    }\n  });\n\n  app.post('/api/sales', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Auto-inject farmId and userId\n      const input = {\n        ...req.body,\n        userId,\n        farmId\n      };\n\n      const validatedData = insertSaleSchema.parse(input);\n      const sale = await storage.createSale(validatedData);\n      res.status(201).json(sale);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating sale:\", error);\n        res.status(500).json({ message: \"Failed to create sale\" });\n      }\n    }\n  });\n\n  // Feed inventory routes\n  app.get('/api/feed-inventory', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      const inventory = await storage.getFeedInventory(farmId);\n      res.json(inventory);\n    } catch (error) {\n      console.error(\"Error fetching feed inventory:\", error);\n      res.status(500).json({ message: \"Failed to fetch feed inventory\" });\n    }\n  });\n\n  app.post('/api/feed-inventory', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Auto-inject farmId and userId, and coerce numeric fields\n      const input = {\n        ...req.body,\n        userId,\n        farmId\n      };\n\n      // Validate and normalize numeric fields using centralized utilities\n      let normalized;\n      try {\n        normalized = normalizeNumericFields(input, {\n          decimals: { quantityKg: 2, unitPrice: 2 },\n          optional: ['quantityKg', 'unitPrice'],\n          returnStrings: true // Return strings for Drizzle schema compatibility\n        });\n      } catch (error) {\n        return res.status(400).json({ message: \"Validation error\", errors: [(error as Error).message] });\n      }\n\n      // Ensure dates are properly formatted as strings (YYYY-MM-DD)\n      const feedData = {\n        ...normalized,\n        purchaseDate: normalized.purchaseDate ? String(normalized.purchaseDate).slice(0, 10) : null,\n        expiryDate: normalized.expiryDate ? String(normalized.expiryDate).slice(0, 10) : null\n      };\n\n      // Temporary logging for debugging\n      console.log(\"Feed data before validation:\", JSON.stringify(feedData, null, 2));\n\n      const validatedData = insertFeedInventorySchema.parse(feedData);\n      const feed = await storage.createFeedInventory(validatedData);\n      res.status(201).json(feed);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating feed inventory:\", error);\n        res.status(500).json({ message: \"Failed to create feed inventory\" });\n      }\n    }\n  });\n\n  // Health records routes\n  app.get('/api/health-records', isAuthenticated, async (req, res) => {\n    try {\n      const flockId = req.query.flockId as string;\n      const limit = parseInt(req.query.limit as string) || 50;\n      const records = await storage.getHealthRecords(flockId, limit);\n      res.json(records);\n    } catch (error) {\n      console.error(\"Error fetching health records:\", error);\n      res.status(500).json({ message: \"Failed to fetch health records\" });\n    }\n  });\n\n  app.post('/api/health-records', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Validate that flockId belongs to user's farm\n      if (req.body.flockId) {\n        const flock = await storage.getFlockById(req.body.flockId);\n        if (!flock || flock.farmId !== farmId) {\n          return res.status(400).json({ message: \"Invalid flock selection\" });\n        }\n      }\n\n      // Auto-inject userId \n      const input = {\n        ...req.body,\n        userId\n      };\n\n      // Defensive coercion: ensure cost field is string for Drizzle schema\n      if (typeof input.cost === 'number') {\n        input.cost = String(input.cost);\n      }\n      // Handle empty string for optional cost field\n      if (input.cost === '') {\n        input.cost = undefined;\n      }\n\n      const validatedData = insertHealthRecordSchema.parse(input);\n      const record = await storage.createHealthRecord(validatedData);\n      res.status(201).json(record);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"=== HEALTH RECORD ZOD VALIDATION ERRORS ===\");\n        console.error(\"Raw request body:\", JSON.stringify(req.body, null, 2));\n        console.error(\"Cost field details:\", req.body?.cost, \"type:\", typeof req.body?.cost);\n        console.error(\"Zod errors:\", JSON.stringify(error.errors, null, 2));\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating health record:\", error);\n        res.status(500).json({ message: \"Failed to create health record\" });\n      }\n    }\n  });\n\n  // Expense routes\n  app.get('/api/expenses', isAuthenticated, async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const expenses = await storage.getExpenses(limit);\n      res.json(expenses);\n    } catch (error) {\n      console.error(\"Error fetching expenses:\", error);\n      res.status(500).json({ message: \"Failed to fetch expenses\" });\n    }\n  });\n\n  app.post('/api/expenses', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Auto-inject farmId and userId\n      const input = {\n        ...req.body,\n        userId,\n        farmId\n      };\n\n      // Defensive coercion: ensure amount field is string for Drizzle schema\n      if (typeof input.amount === 'number') {\n        input.amount = String(input.amount);\n      }\n      // Handle empty string for required amount field\n      if (input.amount === '') {\n        return res.status(400).json({ message: \"Amount is required\" });\n      }\n\n      const validatedData = insertExpenseSchema.parse(input);\n      const expense = await storage.createExpense(validatedData);\n      res.status(201).json(expense);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"=== EXPENSE ZOD VALIDATION ERRORS ===\");\n        console.error(\"Raw request body:\", JSON.stringify(req.body, null, 2));\n        console.error(\"Amount field details:\", req.body?.amount, \"type:\", typeof req.body?.amount);\n        console.error(\"Zod errors:\", JSON.stringify(error.errors, null, 2));\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating expense:\", error);\n        res.status(500).json({ message: \"Failed to create expense\" });\n      }\n    }\n  });\n\n  // Break-Even Analysis routes\n  app.get('/api/breakeven/assumptions', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      const productId = req.query.productId as string | undefined;\n      const assumptions = await storage.getBreakEvenAssumptionsByFarm(farmId, productId || null);\n      \n      if (!assumptions) {\n        return res.status(404).json({ message: \"Break-even assumptions not found\" });\n      }\n      \n      res.json(assumptions);\n    } catch (error) {\n      console.error(\"Error fetching break-even assumptions:\", error);\n      res.status(500).json({ message: \"Failed to fetch break-even assumptions\" });\n    }\n  });\n\n  app.put('/api/breakeven/assumptions', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Auto-inject farmId\n      const input = {\n        ...req.body,\n        farmId\n      };\n\n      // Defensive coercion: ensure decimal fields are strings for Drizzle schema\n      if (typeof input.price === 'number') {\n        input.price = String(input.price);\n      }\n      if (typeof input.unitVariableCost === 'number') {\n        input.unitVariableCost = String(input.unitVariableCost);\n      }\n      if (typeof input.fixedCostsPerMonth === 'number') {\n        input.fixedCostsPerMonth = String(input.fixedCostsPerMonth);\n      }\n      if (typeof input.growthRate === 'number') {\n        input.growthRate = String(input.growthRate);\n      }\n\n      const validatedData = insertBreakEvenAssumptionsSchema.parse(input);\n      \n      // Check if assumptions already exist (upsert pattern)\n      const existing = await storage.getBreakEvenAssumptionsByFarm(\n        farmId, \n        validatedData.productId || null\n      );\n\n      let result;\n      if (existing) {\n        // Update existing\n        result = await storage.updateBreakEvenAssumptions(\n          farmId,\n          validatedData.productId || null,\n          validatedData\n        );\n      } else {\n        // Create new\n        result = await storage.createBreakEvenAssumptions(validatedData);\n      }\n      \n      res.status(existing ? 200 : 201).json(result);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"=== BREAK-EVEN ASSUMPTIONS ZOD VALIDATION ERRORS ===\");\n        console.error(\"Raw request body:\", JSON.stringify(req.body, null, 2));\n        console.error(\"Zod errors:\", JSON.stringify(error.errors, null, 2));\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error saving break-even assumptions:\", error);\n        res.status(500).json({ message: \"Failed to save break-even assumptions\" });\n      }\n    }\n  });\n\n  app.get('/api/breakeven/history', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Get date range (default to last 12 months)\n      const endDate = req.query.endDate || new Date().toISOString().split('T')[0];\n      const startDate = req.query.startDate || new Date(new Date().setMonth(new Date().getMonth() - 12)).toISOString().split('T')[0];\n\n      // Fetch sales and expenses for the farm\n      const sales = await storage.getSalesByDateRange(startDate, endDate);\n      const expenses = await storage.getExpensesByDateRange(startDate, endDate);\n\n      // Filter by farmId (farm-scoped data)\n      const farmSales = sales.filter(s => s.farmId === farmId);\n      const farmExpenses = expenses.filter(e => e.farmId === farmId);\n\n      // Aggregate by month\n      const monthlyData = aggregateByMonth(farmSales, farmExpenses);\n      \n      res.json(monthlyData);\n    } catch (error) {\n      console.error(\"Error fetching break-even history:\", error);\n      res.status(500).json({ message: \"Failed to fetch break-even history\" });\n    }\n  });\n\n  app.get('/api/breakeven/metrics', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Get rolling window period from query (default to 6 months)\n      const timeframeMonths = parseInt(req.query.months as string) || 6;\n      \n      // Calculate date range for historical data\n      const endDate = new Date().toISOString().split('T')[0];\n      const startDate = new Date(new Date().setMonth(new Date().getMonth() - timeframeMonths)).toISOString().split('T')[0];\n      \n      // Fetch farm-scoped sales and expenses\n      const sales = await storage.getSalesByDateRange(startDate, endDate);\n      const expenses = await storage.getExpensesByDateRange(startDate, endDate);\n      \n      const farmSales = sales.filter(s => s.farmId === farmId);\n      const farmExpenses = expenses.filter(e => e.farmId === farmId);\n\n      // Check if we have sufficient data\n      if (farmSales.length === 0) {\n        return res.status(200).json({\n          hasData: false,\n          message: \"No sales data found. Please add sales records to calculate break-even metrics.\",\n          suggestedActions: [\n            { label: \"Add Sales Record\", route: \"/egg-production\" },\n            { label: \"View Reports\", route: \"/reports\" }\n          ]\n        });\n      }\n\n      // Auto-calculate break-even parameters from historical data\n      const autoParams = autoCalculateBreakEvenParams(farmSales, farmExpenses, timeframeMonths);\n\n      // Calculate break-even metrics using auto-derived values\n      const metrics = calculateBreakEven({\n        price: autoParams.price,\n        unitVariableCost: autoParams.unitVariableCost,\n        fixedCostsPerMonth: autoParams.fixedCostsPerMonth,\n        initialUnits: autoParams.initialUnits,\n        growthRate: autoParams.growthRate,\n        projectionMonths: 12,\n      });\n      \n      res.json({\n        hasData: true,\n        autoCalculated: true,\n        dataSource: {\n          monthsAnalyzed: timeframeMonths,\n          salesRecords: farmSales.length,\n          expenseRecords: farmExpenses.length,\n          dateRange: { startDate, endDate }\n        },\n        derivedValues: {\n          price: Math.round(autoParams.price * 100) / 100,\n          unitVariableCost: Math.round(autoParams.unitVariableCost * 100) / 100,\n          fixedCostsPerMonth: Math.round(autoParams.fixedCostsPerMonth * 100) / 100,\n          initialUnits: Math.round(autoParams.initialUnits),\n          growthRate: Math.round(autoParams.growthRate * 10000) / 100, // As percentage\n          seasonalityFactors: autoParams.seasonalityFactors,\n        },\n        dataQuality: autoParams.dataQuality,\n        ...metrics\n      });\n    } catch (error) {\n      console.error(\"Error calculating break-even metrics:\", error);\n      res.status(500).json({ message: \"Failed to calculate break-even metrics\" });\n    }\n  });\n\n  // Marketplace routes - Customers\n  app.get('/api/customers', isAuthenticated, async (req, res) => {\n    try {\n      const customers = await storage.getCustomers();\n      res.json(customers);\n    } catch (error) {\n      console.error(\"Error fetching customers:\", error);\n      res.status(500).json({ message: \"Failed to fetch customers\" });\n    }\n  });\n\n  app.post('/api/customers', isAuthenticated, async (req: any, res) => {\n    try {\n      const validatedData = insertCustomerSchema.parse(req.body);\n      const customer = await storage.createCustomer(validatedData);\n      res.status(201).json(customer);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating customer:\", error);\n        res.status(500).json({ message: \"Failed to create customer\" });\n      }\n    }\n  });\n\n  app.get('/api/customers/:id', isAuthenticated, async (req, res) => {\n    try {\n      const customer = await storage.getCustomerById(req.params.id);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      res.json(customer);\n    } catch (error) {\n      console.error(\"Error fetching customer:\", error);\n      res.status(500).json({ message: \"Failed to fetch customer\" });\n    }\n  });\n\n  app.patch('/api/customers/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const updates = insertCustomerSchema.partial().parse(req.body);\n      const customer = await storage.updateCustomer(req.params.id, updates);\n      res.json(customer);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error updating customer:\", error);\n        res.status(500).json({ message: \"Failed to update customer\" });\n      }\n    }\n  });\n\n  // Marketplace routes - Products\n  app.get('/api/products', isAuthenticated, async (req: any, res) => {\n    try {\n      // For now, return all products as they may be used in marketplace\n      // Individual farms can filter their own products client-side if needed\n      const products = await storage.getProducts();\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  app.post('/api/products', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Auto-inject farmId\n      const input = {\n        ...req.body,\n        farmId\n      };\n\n      // Defensive coercion: ensure currentPrice field is string for Drizzle schema\n      if (typeof input.currentPrice === 'number') {\n        input.currentPrice = String(input.currentPrice);\n      }\n      // Handle empty string for required currentPrice field\n      if (input.currentPrice === '') {\n        return res.status(400).json({ message: \"Current price is required\" });\n      }\n\n      const validatedData = insertProductSchema.parse(input);\n      const product = await storage.createProduct(validatedData);\n      res.status(201).json(product);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating product:\", error);\n        res.status(500).json({ message: \"Failed to create product\" });\n      }\n    }\n  });\n\n  app.get('/api/products/:id', isAuthenticated, async (req, res) => {\n    try {\n      const product = await storage.getProductById(req.params.id);\n      if (!product) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n      res.json(product);\n    } catch (error) {\n      console.error(\"Error fetching product:\", error);\n      res.status(500).json({ message: \"Failed to fetch product\" });\n    }\n  });\n\n  app.patch('/api/products/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      if (!currentUser?.farmId) {\n        return res.status(400).json({ message: \"User must be associated with a farm to update products\" });\n      }\n\n      // Validate that product belongs to user's farm\n      const existingProduct = await storage.getProductById(req.params.id);\n      if (!existingProduct) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n      if (existingProduct.farmId !== currentUser.farmId) {\n        return res.status(403).json({ message: \"Unauthorized to update this product\" });\n      }\n\n      // Defensive coercion: ensure currentPrice field is string for Drizzle schema\n      const input = { ...req.body };\n      if (typeof input.currentPrice === 'number') {\n        input.currentPrice = String(input.currentPrice);\n      }\n\n      const updates = insertProductSchema.partial().parse(input);\n      const product = await storage.updateProduct(req.params.id, updates);\n      res.json(product);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error updating product:\", error);\n        res.status(500).json({ message: \"Failed to update product\" });\n      }\n    }\n  });\n\n  // Marketplace routes - Orders  \n  app.get('/api/orders', isAuthenticated, async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const orders = await storage.getOrders(limit);\n      res.json(orders);\n    } catch (error) {\n      console.error(\"Error fetching orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch orders\" });\n    }\n  });\n\n  // SECURE: New order creation with server-side pricing and inventory validation\n  app.post('/api/orders', isAuthenticated, async (req: any, res) => {\n    try {\n      const { items, ...orderData } = req.body;\n      \n      const userId = req.user.claims.sub;\n      console.log('Debug - userId:', userId);\n      const currentUser = await storage.getUser(userId);\n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n      \n      // Validate the order data structure\n      if (!items || !Array.isArray(items) || items.length === 0) {\n        return res.status(400).json({ message: \"Order must contain at least one item\" });\n      }\n\n      // Validate required fields\n      if (!orderData.customerId) {\n        return res.status(400).json({ message: \"Customer ID is required\" });\n      }\n      if (!orderData.deliveryMethod) {\n        return res.status(400).json({ message: \"Delivery method is required\" });\n      }\n\n      // Validate items structure\n      for (const item of items) {\n        if (!item.productId || !item.quantity || item.quantity <= 0) {\n          return res.status(400).json({ message: \"Each item must have a valid productId and positive quantity\" });\n        }\n      }\n\n      // Create order with server-side pricing and inventory validation\n      const result = await storage.createOrderWithItems({\n        ...orderData,\n        farmId,\n        userId: userId,\n        items\n      });\n\n      res.status(201).json({\n        message: \"Order created successfully\",\n        order: result.order,\n        orderItems: result.orderItems,\n        totalAmount: result.totalAmount\n      });\n\n    } catch (error) {\n      console.error(\"Error creating order:\", error);\n      \n      if (error instanceof Error) {\n        if (error.message.includes('validation failed') || \n            error.message.includes('Insufficient stock') ||\n            error.message.includes('not found')) {\n          res.status(400).json({ message: error.message });\n        } else {\n          res.status(500).json({ message: \"Failed to create order\" });\n        }\n      } else {\n        res.status(500).json({ message: \"Failed to create order\" });\n      }\n    }\n  });\n\n  app.get('/api/orders/:id', isAuthenticated, async (req, res) => {\n    try {\n      const order = await storage.getOrderById(req.params.id);\n      if (!order) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n      res.json(order);\n    } catch (error) {\n      console.error(\"Error fetching order:\", error);\n      res.status(500).json({ message: \"Failed to fetch order\" });\n    }\n  });\n\n  app.patch('/api/orders/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      // Only allow updating certain fields for security\n      const allowedUpdates = ['status', 'paymentStatus', 'paidAmount', 'deliveryMethod', 'deliveryAddress', 'notes'];\n      const updates = Object.keys(req.body).reduce((acc: any, key) => {\n        if (allowedUpdates.includes(key)) {\n          acc[key] = req.body[key];\n        }\n        return acc;\n      }, {});\n\n      if (Object.keys(updates).length === 0) {\n        return res.status(400).json({ message: \"No valid fields to update\" });\n      }\n\n      const order = await storage.updateOrder(req.params.id, updates);\n      res.json(order);\n    } catch (error) {\n      console.error(\"Error updating order:\", error);\n      res.status(500).json({ message: \"Failed to update order\" });\n    }\n  });\n\n  // Marketplace routes - Order Items\n  app.get('/api/orders/:orderId/items', isAuthenticated, async (req, res) => {\n    try {\n      const orderItems = await storage.getOrderItems(req.params.orderId);\n      res.json(orderItems);\n    } catch (error) {\n      console.error(\"Error fetching order items:\", error);\n      res.status(500).json({ message: \"Failed to fetch order items\" });\n    }\n  });\n\n  // SECURITY: Disabled separate order item creation to prevent pricing manipulation\n  // Order items must now be created through the secure /api/orders endpoint\n  app.post('/api/order-items', isAuthenticated, async (req: any, res) => {\n    res.status(400).json({ \n      message: \"Direct order item creation is disabled for security. Create orders with items using POST /api/orders endpoint.\",\n      error: \"PRICING_SECURITY_POLICY\"\n    });\n  });\n\n  // Marketplace routes - Deliveries\n  app.get('/api/deliveries', isAuthenticated, async (req, res) => {\n    try {\n      const deliveries = await storage.getDeliveries();\n      res.json(deliveries);\n    } catch (error) {\n      console.error(\"Error fetching deliveries:\", error);\n      res.status(500).json({ message: \"Failed to fetch deliveries\" });\n    }\n  });\n\n  app.post('/api/deliveries', isAuthenticated, async (req: any, res) => {\n    try {\n      const validatedData = insertDeliverySchema.parse(req.body);\n      const delivery = await storage.createDelivery(validatedData);\n      res.status(201).json(delivery);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating delivery:\", error);\n        res.status(500).json({ message: \"Failed to create delivery\" });\n      }\n    }\n  });\n\n  app.patch('/api/deliveries/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const updates = insertDeliverySchema.partial().parse(req.body);\n      const delivery = await storage.updateDelivery(req.params.id, updates);\n      res.json(delivery);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error updating delivery:\", error);\n        res.status(500).json({ message: \"Failed to update delivery\" });\n      }\n    }\n  });\n\n  // ========================================\n  // PUBLIC API ENDPOINTS (No Authentication Required)\n  // ========================================\n\n  // Public farms directory - List all active farms\n  app.get('/api/public/farms', async (req, res) => {\n    try {\n      const farms = await storage.getPublicFarms(); // Only approved, active farms\n      res.json(farms);\n    } catch (error) {\n      console.error(\"Error fetching public farms:\", error);\n      res.status(500).json({ message: \"Failed to fetch farms\" });\n    }\n  });\n\n  // Public farm details - Individual farm information\n  app.get('/api/public/farms/:id', async (req, res) => {\n    try {\n      const farm = await storage.getPublicFarmById(req.params.id);\n      if (!farm) {\n        return res.status(404).json({ message: \"Farm not found\" });\n      }\n      res.json(farm);\n    } catch (error) {\n      console.error(\"Error fetching public farm:\", error);\n      res.status(500).json({ message: \"Failed to fetch farm details\" });\n    }\n  });\n\n  // Public products by farm - Products available from a specific farm\n  app.get('/api/public/farms/:farmId/products', async (req, res) => {\n    try {\n      const products = await storage.getPublicProductsByFarm(req.params.farmId);\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching farm products:\", error);\n      res.status(500).json({ message: \"Failed to fetch farm products\" });\n    }\n  });\n\n  // Public products directory - All available products\n  app.get('/api/public/products', async (req, res) => {\n    try {\n      const products = await storage.getPublicProducts();\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching public products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  // Protected customer profile endpoints\n  app.get('/api/customers/me', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const customer = await storage.getCustomerByUserId(userId);\n      \n      if (!customer) {\n        return res.status(404).json({ message: \"Customer profile not found\" });\n      }\n      \n      res.json(customer);\n    } catch (error) {\n      console.error(\"Error fetching customer profile:\", error);\n      res.status(500).json({ message: \"Failed to fetch customer profile\" });\n    }\n  });\n\n  app.post('/api/customers/me', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const userEmail = req.user.claims.email;\n      \n      // SECURITY: Never trust client-provided email/userId - always use authenticated claims\n      const validatedData = insertCustomerSchema.omit({ email: true }).parse({\n        ...req.body,\n        status: 'active'  // Auto-activate authenticated customers\n      });\n      \n      // Force server-side identity from authenticated claims\n      const customerData = {\n        ...validatedData,\n        email: userEmail.toLowerCase(), // Use authenticated user's email (normalized)\n      };\n      \n      // Log for debugging (redact sensitive data in production)\n      console.log(`Creating customer profile for user ${userId} with email domain: ${userEmail.split('@')[1]}`);\n      if (req.body.email && req.body.email !== userEmail) {\n        console.warn(`Client provided email '${req.body.email}' ignored, using claims email for security`);\n      }\n      \n      // Create or update customer profile for authenticated user\n      const customer = await storage.upsertCustomerForUser(userId, customerData);\n      res.status(201).json(customer);\n    } catch (error) {\n      console.error(\"Error creating/updating customer profile:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create customer profile\" });\n      }\n    }\n  });\n\n  app.put('/api/customers/me', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const userEmail = req.user.claims.email;\n      \n      // Check if customer profile exists\n      const existingCustomer = await storage.getCustomerByUserId(userId);\n      if (!existingCustomer) {\n        return res.status(404).json({ message: \"Customer profile not found. Use POST to create.\" });\n      }\n      \n      // Validate customer data but ignore client-provided email/userId\n      const validatedData = insertCustomerSchema.parse({\n        ...req.body,\n        email: userEmail, // Use authenticated user's email\n        status: 'active'  // Maintain active status\n      });\n      \n      // Update customer profile\n      const customer = await storage.updateCustomer(existingCustomer.id, validatedData);\n      res.json(customer);\n    } catch (error) {\n      console.error(\"Error updating customer profile:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update customer profile\" });\n      }\n    }\n  });\n\n  // Customer orders endpoint - Get authenticated customer's orders\n  app.get('/api/customers/orders', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      \n      // Get customer profile first\n      const customer = await storage.getCustomerByUserId(userId);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer profile not found\" });\n      }\n      \n      // Get customer's orders\n      const orders = await storage.getOrdersByCustomer(customer.id);\n      res.json(orders);\n    } catch (error) {\n      console.error(\"Error fetching customer orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch orders\" });\n    }\n  });\n\n  // Customer deliveries endpoint - Get authenticated customer's deliveries  \n  app.get('/api/customers/deliveries', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      \n      // Get customer profile first\n      const customer = await storage.getCustomerByUserId(userId);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer profile not found\" });\n      }\n      \n      // Get customer's orders first, then their deliveries\n      const orders = await storage.getOrdersByCustomer(customer.id);\n      const orderIds = orders.map(order => order.id);\n      \n      // Get deliveries for all customer orders\n      const deliveries = [];\n      for (const orderId of orderIds) {\n        const delivery = await storage.getDeliveryByOrderId(orderId);\n        if (delivery) {\n          deliveries.push(delivery);\n        }\n      }\n      \n      res.json(deliveries);\n    } catch (error) {\n      console.error(\"Error fetching customer deliveries:\", error);\n      res.status(500).json({ message: \"Failed to fetch deliveries\" });\n    }\n  });\n\n  // Customer self-registration endpoint\n  app.post('/api/public/customers/register', async (req, res) => {\n    try {\n      const customerData = insertCustomerSchema.parse({\n        ...req.body,\n        status: 'active', // Auto-activate self-registered customers\n        customerType: req.body.customerType || 'retail' // Default to retail\n      });\n      \n      const customer = await storage.createCustomer(customerData);\n      res.status(201).json({ \n        message: \"Registration successful! You can now browse and place orders.\",\n        customer: {\n          id: customer.id,\n          name: customer.name,\n          email: customer.email\n        }\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error registering customer:\", error);\n        res.status(500).json({ message: \"Registration failed. Please try again.\" });\n      }\n    }\n  });\n\n  // Weight Records routes\n  app.get('/api/weight-records', isAuthenticated, async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const records = await storage.getWeightRecords(limit);\n      res.json(records);\n    } catch (error) {\n      console.error(\"Error fetching weight records:\", error);\n      res.status(500).json({ message: \"Failed to fetch weight records\" });\n    }\n  });\n\n  app.get('/api/weight-records/flock/:flockId', isAuthenticated, async (req, res) => {\n    try {\n      const { flockId } = req.params;\n      const records = await storage.getWeightRecordsByFlock(flockId);\n      res.json(records);\n    } catch (error) {\n      console.error(\"Error fetching weight records by flock:\", error);\n      res.status(500).json({ message: \"Failed to fetch weight records\" });\n    }\n  });\n\n  app.post('/api/weight-records', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const currentUser = await storage.getUser(userId);\n      \n      let farmId;\n      try {\n        farmId = await requireFarmContext(req, currentUser);\n      } catch (error) {\n        return res.status(400).json({ message: (error as Error).message });\n      }\n\n      // Calculate statistics from weights array\n      const weights = req.body.weights;\n      if (!Array.isArray(weights) || weights.length === 0) {\n        return res.status(400).json({ message: \"Weights array is required and must not be empty\" });\n      }\n\n      const statistics = storage.calculateWeightStatistics(weights);\n      \n      // Get flock to determine breed for comparison\n      const flock = await storage.getFlockById(req.body.flockId);\n      if (!flock) {\n        return res.status(404).json({ message: \"Flock not found\" });\n      }\n\n      // Compare with breed standards (assuming Hy-Line Brown for now)\n      const breedComparison = await storage.compareWithBreedStandard(\n        'Hy-Line Brown', \n        req.body.weekNumber, \n        statistics.average\n      );\n\n      // Calculate Coefficient of Variation (CV%)\n      const cvPercent = statistics.average > 0 ? (statistics.stdDev / statistics.average) * 100 : 0;\n\n      // Auto-inject calculated data and user info\n      const input = {\n        ...req.body,\n        userId,\n        sampleSize: weights.length,\n        averageWeight: statistics.average,\n        stdDev: statistics.stdDev,\n        uniformity: statistics.uniformity,\n        cvPercent: Number(cvPercent.toFixed(2)),\n        comparisonResult: breedComparison.comparisonResult,\n        expectedWeight: breedComparison.expectedWeight || null,\n        weightDeviation: breedComparison.weightDeviation || null,\n      };\n\n      const validatedData = insertWeightRecordSchema.parse(input);\n      const record = await storage.createWeightRecord(validatedData);\n      res.status(201).json(record);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        console.error(\"=== WEIGHT RECORD ZOD VALIDATION ERRORS ===\");\n        console.error(\"Raw request body:\", JSON.stringify(req.body, null, 2));\n        console.error(\"Zod errors:\", JSON.stringify(error.errors, null, 2));\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else if ((error as any).code === '23505' && (error as any).constraint === 'uniq_weight_records_flock_week') {\n        // Handle duplicate flock/week constraint violation\n        console.error(\"Duplicate weight record attempted:\", error);\n        res.status(409).json({ \n          message: \"A weight record for this flock and week already exists. Please use a different week number or update the existing record.\" \n        });\n      } else {\n        console.error(\"Error creating weight record:\", error);\n        res.status(500).json({ message: \"Failed to create weight record\" });\n      }\n    }\n  });\n\n  app.put('/api/weight-records/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      \n      // If weights are being updated, recalculate statistics\n      if (req.body.weights) {\n        const weights = req.body.weights;\n        const statistics = storage.calculateWeightStatistics(weights);\n        \n        req.body.sampleSize = weights.length;\n        req.body.averageWeight = statistics.average;\n        req.body.stdDev = statistics.stdDev;\n        req.body.uniformity = statistics.uniformity;\n        req.body.cvPercent = statistics.average > 0 ? Number(((statistics.stdDev / statistics.average) * 100).toFixed(2)) : 0;\n\n        // Recalculate breed comparison if week number changed\n        if (req.body.weekNumber) {\n          const breedComparison = await storage.compareWithBreedStandard(\n            'Hy-Line Brown', \n            req.body.weekNumber, \n            statistics.average\n          );\n          req.body.comparisonResult = breedComparison.comparisonResult;\n          req.body.expectedWeight = breedComparison.expectedWeight || null;\n          req.body.weightDeviation = breedComparison.weightDeviation || null;\n        }\n      }\n\n      const validatedData = insertWeightRecordSchema.partial().parse(req.body);\n      const record = await storage.updateWeightRecord(id, validatedData);\n      res.json(record);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error updating weight record:\", error);\n        res.status(500).json({ message: \"Failed to update weight record\" });\n      }\n    }\n  });\n\n  app.delete('/api/weight-records/:id', isAuthenticated, async (req, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteWeightRecord(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting weight record:\", error);\n      res.status(500).json({ message: \"Failed to delete weight record\" });\n    }\n  });\n\n  // Breed Standards routes\n  app.get('/api/breed-standards', isAuthenticated, async (req, res) => {\n    try {\n      const standards = await storage.getBreedStandards();\n      res.json(standards);\n    } catch (error) {\n      console.error(\"Error fetching breed standards:\", error);\n      res.status(500).json({ message: \"Failed to fetch breed standards\" });\n    }\n  });\n\n  app.get('/api/breed-standards/:breedName', isAuthenticated, async (req, res) => {\n    try {\n      const { breedName } = req.params;\n      const standards = await storage.getBreedStandardsByBreed(breedName);\n      res.json(standards);\n    } catch (error) {\n      console.error(\"Error fetching breed standards by breed:\", error);\n      res.status(500).json({ message: \"Failed to fetch breed standards\" });\n    }\n  });\n\n  app.post('/api/breed-standards', isAuthenticated, async (req, res) => {\n    try {\n      const validatedData = insertBreedStandardSchema.parse(req.body);\n      const standard = await storage.createBreedStandard(validatedData);\n      res.status(201).json(standard);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Validation error\", errors: error.errors });\n      } else {\n        console.error(\"Error creating breed standard:\", error);\n        res.status(500).json({ message: \"Failed to create breed standard\" });\n      }\n    }\n  });\n\n  // Seed breed standards endpoint (one-time setup)\n  app.post('/api/breed-standards/seed', isAuthenticated, async (req, res) => {\n    try {\n      await storage.seedHyLineBrownStandards();\n      res.json({ message: \"Hy-Line Brown breed standards seeded successfully\" });\n    } catch (error) {\n      console.error(\"Error seeding breed standards:\", error);\n      res.status(500).json({ message: \"Failed to seed breed standards\" });\n    }\n  });\n\n  // Weight statistics calculation endpoint (for real-time calculations)\n  app.post('/api/weight-records/calculate', isAuthenticated, async (req, res) => {\n    try {\n      const { weights, weekNumber } = req.body;\n      \n      if (!Array.isArray(weights) || weights.length === 0) {\n        return res.status(400).json({ message: \"Weights array is required and must not be empty\" });\n      }\n\n      const statistics = storage.calculateWeightStatistics(weights);\n      \n      // Compare with breed standards\n      const breedComparison = await storage.compareWithBreedStandard(\n        'Hy-Line Brown', \n        weekNumber, \n        statistics.average\n      );\n\n      res.json({\n        ...statistics,\n        ...breedComparison,\n        sampleSize: weights.length\n      });\n    } catch (error) {\n      console.error(\"Error calculating weight statistics:\", error);\n      res.status(500).json({ message: \"Failed to calculate statistics\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","size_bytes":68041},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/dashboard/metric-card.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Bird, Egg, Wheat, Coins } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface MetricCardProps {\n  title: string;\n  value: string | number;\n  subtitle: string;\n  icon: \"dove\" | \"egg\" | \"wheat\" | \"coins\";\n  color: \"primary\" | \"chart-3\" | \"orange\" | \"green\";\n}\n\nconst iconMap = {\n  dove: Bird,\n  egg: Egg,\n  wheat: Wheat,\n  coins: Coins,\n};\n\nconst colorMap = {\n  primary: {\n    bg: \"bg-primary/10\",\n    text: \"text-primary\",\n  },\n  \"chart-3\": {\n    bg: \"bg-chart-3/10\",\n    text: \"text-chart-3\",\n  },\n  orange: {\n    bg: \"bg-orange-100\",\n    text: \"text-orange-600\",\n  },\n  green: {\n    bg: \"bg-green-100\",\n    text: \"text-green-600\",\n  },\n};\n\nexport default function MetricCard({ title, value, subtitle, icon, color }: MetricCardProps) {\n  const Icon = iconMap[icon];\n  const colors = colorMap[color];\n\n  return (\n    <Card data-testid={`card-metric-${title.toLowerCase().replace(' ', '-')}`}>\n      <CardContent className=\"p-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <p className=\"text-sm font-medium text-muted-foreground\">{title}</p>\n            <p className=\"text-2xl font-bold text-foreground\">{value.toLocaleString()}</p>\n            <p className=\"text-xs text-muted-foreground mt-1\">{subtitle}</p>\n          </div>\n          <div className={cn(\"w-12 h-12 rounded-lg flex items-center justify-center\", colors.bg)}>\n            <Icon className={cn(\"h-6 w-6\", colors.text)} />\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1582},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","size_bytes":1858},"scripts/seed-demo-data.ts":{"content":"import { drizzle } from \"drizzle-orm/neon-http\";\nimport { neon } from \"@neondatabase/serverless\";\nimport {\n  farms,\n  users,\n  flocks,\n  dailyRecords,\n  sales,\n  expenses,\n  feedInventory,\n  healthRecords,\n  products,\n} from \"../shared/schema\";\n\nconst sql = neon(process.env.DATABASE_URL!);\nconst db = drizzle(sql);\n\nconsole.log(\"🌱 Starting demo data seed...\");\n\n// Helper to generate dates\nfunction getDateDaysAgo(days: number): string {\n  const date = new Date();\n  date.setDate(date.getDate() - days);\n  return date.toISOString().split('T')[0];\n}\n\n// Helper to add random variance\nfunction addVariance(value: number, variancePercent: number): number {\n  const variance = value * (variancePercent / 100);\n  return value + (Math.random() * variance * 2 - variance);\n}\n\nasync function seed() {\n  try {\n    console.log(\"📊 Creating Demo Farm...\");\n    \n    // 1. Create Demo Farm\n    const [demoFarm] = await db.insert(farms).values({\n      name: \"🎯 Demo Farm - Sample Data\",\n      description: \"This is sample demonstration data. You can safely delete this farm and all its data when ready.\",\n      location: \"Nairobi, Kenya\",\n      address: \"Sample Address, Nairobi\",\n      contactEmail: \"demo@kukuhub.app\",\n      contactPhone: \"+254700000000\",\n      totalBirds: 5000,\n      avgEggsPerDay: 4200,\n      specialization: \"layers\",\n      status: \"active\",\n      isApproved: true,\n    }).returning();\n\n    console.log(`✅ Demo Farm created: ${demoFarm.id}`);\n\n    // 2. Create Demo Farm Owner User\n    const [demoUser] = await db.insert(users).values({\n      email: \"demo-owner@kukuhub.app\",\n      firstName: \"Demo\",\n      lastName: \"Farm Owner\",\n      role: \"farm_owner\",\n      farmId: demoFarm.id,\n    }).returning();\n\n    console.log(`✅ Demo User created: ${demoUser.id}`);\n\n    // 3. Create Active Flock (started 15 months ago, now in full production)\n    const flockStartDate = getDateDaysAgo(450); // ~15 months ago\n    const initialBirds = 5000;\n    const totalMortality = 250; // 5% cumulative mortality over 15 months\n\n    const [demoFlock] = await db.insert(flocks).values({\n      farmId: demoFarm.id,\n      name: \"Batch A-2024 (Demo)\",\n      breed: \"Hy-Line Brown\",\n      initialCount: initialBirds,\n      currentCount: initialBirds - totalMortality,\n      hatchDate: flockStartDate,\n      status: \"laying\",\n    }).returning();\n\n    console.log(`✅ Demo Flock created: ${demoFlock.id}`);\n\n    // 4. Generate 365 days of Daily Records\n    console.log(\"📝 Generating 365 days of production records...\");\n    \n    const dailyRecordsData: any[] = [];\n    const startDay = 364; // Start from 364 days ago (0-364 = 365 days total)\n    \n    for (let daysAgo = startDay; daysAgo >= 0; daysAgo--) {\n      const recordDate = getDateDaysAgo(daysAgo);\n      const flockAgeInDays = 450 - daysAgo; // Age of flock on this day\n      \n      // Calculate realistic egg production based on flock age\n      let productionRate = 0;\n      const currentBirds = initialBirds - Math.floor((totalMortality / 450) * (450 - daysAgo));\n      \n      if (flockAgeInDays < 120) {\n        // Brooding/Growing phase (0-17 weeks) - no eggs\n        productionRate = 0;\n      } else if (flockAgeInDays < 140) {\n        // Ramp up phase (17-20 weeks) - 0% to 50%\n        productionRate = ((flockAgeInDays - 120) / 20) * 0.50;\n      } else if (flockAgeInDays < 180) {\n        // Early production (20-26 weeks) - 50% to 85%\n        productionRate = 0.50 + ((flockAgeInDays - 140) / 40) * 0.35;\n      } else if (flockAgeInDays < 300) {\n        // Peak production (26-43 weeks) - 85% to 92%\n        productionRate = 0.85 + ((flockAgeInDays - 180) / 120) * 0.07;\n      } else if (flockAgeInDays < 400) {\n        // Declining production (43-57 weeks) - 92% to 82%\n        productionRate = 0.92 - ((flockAgeInDays - 300) / 100) * 0.10;\n      } else {\n        // Late production (57+ weeks) - 82% to 75%\n        productionRate = 0.82 - ((flockAgeInDays - 400) / 100) * 0.07;\n      }\n      \n      // Add daily variance\n      productionRate = Math.max(0, Math.min(1, addVariance(productionRate, 5)));\n      \n      const eggsCollected = Math.floor(currentBirds * productionRate);\n      const brokenEggs = Math.floor(eggsCollected * (Math.random() * 0.03)); // 0-3% broken\n      const cratesProduced = Math.floor((eggsCollected - brokenEggs) / 30); // 30 eggs per crate\n      \n      // Feed consumption: ~110-125g per bird per day\n      const feedPerBird = 0.115 + (Math.random() * 0.01); // kg\n      const feedConsumed = (currentBirds * feedPerBird).toFixed(2);\n      \n      // Temperature and lighting (only relevant during brooding)\n      let temperature: number | null = null;\n      let lightingHours: number | null = null;\n      \n      if (flockAgeInDays < 120) {\n        // Brooding phase temperatures\n        if (flockAgeInDays < 7) temperature = 32 + Math.random() * 2;\n        else if (flockAgeInDays < 14) temperature = 30 + Math.random() * 2;\n        else if (flockAgeInDays < 21) temperature = 28 + Math.random() * 2;\n        else if (flockAgeInDays < 28) temperature = 26 + Math.random() * 2;\n        else temperature = 22 + Math.random() * 3;\n        \n        // Lighting hours increase gradually\n        lightingHours = Math.min(16, 8 + (flockAgeInDays / 120) * 8);\n      } else {\n        // Production phase: 14-16 hours of light\n        lightingHours = 14 + Math.random() * 2;\n      }\n      \n      // Occasional mortality (random, small numbers)\n      const mortalityCount = Math.random() < 0.05 ? Math.floor(Math.random() * 3) : 0;\n      \n      // Weight tracking (sample every 7 days)\n      let averageWeight: number | null = null;\n      let sampleSize: number | null = null;\n      \n      if (daysAgo % 7 === 0 && flockAgeInDays >= 7) {\n        sampleSize = 50;\n        // Weight curve: 40g at hatch, ~1800g at 18 weeks, ~2000g at peak\n        if (flockAgeInDays < 126) {\n          averageWeight = 40 + (flockAgeInDays / 126) * 1760;\n        } else {\n          averageWeight = 1800 + ((flockAgeInDays - 126) / 274) * 200;\n        }\n        averageWeight = addVariance(averageWeight, 3);\n      }\n      \n      dailyRecordsData.push({\n        flockId: demoFlock.id,\n        recordDate,\n        userId: demoUser.id,\n        eggsCollected: eggsCollected > 0 ? eggsCollected : null,\n        brokenEggs: brokenEggs > 0 ? brokenEggs : null,\n        cratesProduced: cratesProduced > 0 ? cratesProduced : null,\n        mortalityCount,\n        mortalityReason: mortalityCount > 0 ? \"Natural causes / health issues\" : null,\n        feedConsumed,\n        feedType: \"Layer Mash\",\n        temperature: temperature !== null ? temperature.toFixed(2) : null,\n        lightingHours: lightingHours !== null ? lightingHours.toFixed(2) : null,\n        averageWeight: averageWeight !== null ? averageWeight.toFixed(2) : null,\n        sampleSize: sampleSize,\n        notes: null,\n        reviewStatus: \"approved\",\n        isDuplicate: false,\n      });\n    }\n    \n    // Insert daily records in batches of 100\n    for (let i = 0; i < dailyRecordsData.length; i += 100) {\n      const batch = dailyRecordsData.slice(i, i + 100);\n      await db.insert(dailyRecords).values(batch);\n      console.log(`  ✅ Inserted daily records ${i + 1} to ${i + batch.length}`);\n    }\n\n    // 5. Generate Sales Records (12 months)\n    console.log(\"💰 Generating 12 months of sales records...\");\n    \n    const salesData: any[] = [];\n    const customers = [\n      \"Metro Supermarket\",\n      \"Naivas Stores\",\n      \"QuickMart\",\n      \"Fresh Foods Ltd\",\n      \"Hotel Intercontinental\",\n      \"Sarova Hotels\",\n      \"Wholesale Distributors Ltd\",\n      \"Jane Kamau\",\n      \"John Mwangi\",\n      \"Grace Wanjiru\",\n    ];\n    \n    // Generate frequent sales for 12 months (52 weeks)\n    // Gradual price increase over time (5-8% growth)\n    const basePrice = 380; // Starting price KES\n    const totalWeeks = 52;\n    \n    for (let weeksAgo = 52; weeksAgo >= 0; weeksAgo--) {\n      const weekStartDay = weeksAgo * 7;\n      const flockAgeAtWeekStart = 450 - weekStartDay;\n      \n      // Skip sales before production starts\n      if (flockAgeAtWeekStart < 140) continue;\n      \n      // Calculate progressive price (5-8% increase over the year)\n      const weekNumber = totalWeeks - weeksAgo;\n      const priceGrowthFactor = 1 + (weekNumber / totalWeeks) * 0.065; // 6.5% average growth\n      const baseWeekPrice = basePrice * priceGrowthFactor;\n      \n      // Number of sales per week (2-4 for better distribution)\n      const salesThisWeek = Math.floor(Math.random() * 3) + 2;\n      \n      for (let s = 0; s < salesThisWeek; s++) {\n        // Spread sales across the week (days 0-6)\n        const dayOffset = Math.floor((s / salesThisWeek) * 7);\n        const saleDate = getDateDaysAgo(weekStartDay + dayOffset);\n        \n        const cratesSold = Math.floor(50 + Math.random() * 150); // 50-200 crates\n        const pricePerCrate = addVariance(baseWeekPrice, 5); // Only 5% variance to keep stable\n        const totalAmount = cratesSold * pricePerCrate;\n        \n        salesData.push({\n          farmId: demoFarm.id,\n          saleDate,\n          userId: demoUser.id,\n          customerName: customers[Math.floor(Math.random() * customers.length)],\n          cratesSold,\n          pricePerCrate: pricePerCrate.toFixed(2),\n          totalAmount: totalAmount.toFixed(2),\n          paymentStatus: Math.random() > 0.1 ? \"paid\" : \"pending\",\n          notes: null,\n        });\n      }\n    }\n    \n    await db.insert(sales).values(salesData);\n    console.log(`✅ Created ${salesData.length} sales records`);\n\n    // 6. Generate Expense Records (13 months for gap-free coverage)\n    console.log(\"💸 Generating 13 months of expense records...\");\n    \n    const expensesData: any[] = [];\n    \n    // Helper to get first day of month N months ago in UTC\n    function getFirstDayOfMonthAgo(monthsAgo: number): string {\n      const date = new Date();\n      date.setUTCMonth(date.getUTCMonth() - monthsAgo);\n      date.setUTCDate(1);\n      return date.toISOString().split('T')[0];\n    }\n    \n    for (let monthsAgo = 13; monthsAgo >= 0; monthsAgo--) {\n      const monthStartDate = getFirstDayOfMonthAgo(monthsAgo);\n      \n      // Feed expenses (weekly) - reduced variance for stability\n      // Generate 4 weekly feed purchases within this calendar month\n      for (let week = 0; week < 4; week++) {\n        // Calculate date offset from month start (week 0, 7, 14, 21 days)\n        const date = new Date(monthStartDate);\n        date.setUTCDate(date.getUTCDate() + (week * 7));\n        const weekDate = date.toISOString().split('T')[0];\n        \n        expensesData.push({\n          farmId: demoFarm.id,\n          expenseDate: weekDate,\n          userId: demoUser.id,\n          category: \"feed\",\n          description: \"Layer Mash - 50kg bags x 100\",\n          amount: (addVariance(220000, 5)).toFixed(2), // ~220,000 KES per week, only 5% variance\n          supplier: \"Unga Feeds Ltd\",\n          receiptNumber: `RCP-${Date.now()}-${week}`,\n          notes: null,\n        });\n      }\n      \n      // Labor costs (monthly)\n      expensesData.push({\n        farmId: demoFarm.id,\n        expenseDate: monthStartDate,\n        userId: demoUser.id,\n        category: \"labor\",\n        description: \"Staff salaries - 5 workers\",\n        amount: \"150000.00\", // 150,000 KES\n        supplier: null,\n        receiptNumber: null,\n        notes: \"Monthly payroll\",\n      });\n      \n      // Utilities (monthly)\n      expensesData.push({\n        farmId: demoFarm.id,\n        expenseDate: monthStartDate,\n        userId: demoUser.id,\n        category: \"utilities\",\n        description: \"Electricity and water bills\",\n        amount: (addVariance(45000, 15)).toFixed(2), // ~45,000 KES\n        supplier: \"Kenya Power & County Water\",\n        receiptNumber: null,\n        notes: null,\n      });\n      \n      // Medication/Veterinary (quarterly)\n      if (monthsAgo % 3 === 0) {\n        expensesData.push({\n          farmId: demoFarm.id,\n          expenseDate: monthStartDate,\n          userId: demoUser.id,\n          category: \"medication\",\n          description: \"Vaccination and veterinary supplies\",\n          amount: (addVariance(85000, 20)).toFixed(2), // ~85,000 KES\n          supplier: \"VetCare Kenya\",\n          receiptNumber: `VET-${Date.now()}`,\n          notes: \"Quarterly vaccination program\",\n        });\n      }\n      \n      // Equipment maintenance (occasional)\n      if (Math.random() < 0.3) {\n        expensesData.push({\n          farmId: demoFarm.id,\n          expenseDate: monthStartDate,\n          userId: demoUser.id,\n          category: \"equipment\",\n          description: \"Equipment repair and maintenance\",\n          amount: (addVariance(35000, 30)).toFixed(2),\n          supplier: \"AgriTech Services\",\n          receiptNumber: null,\n          notes: null,\n        });\n      }\n      \n      // Other operational costs\n      if (Math.random() < 0.4) {\n        expensesData.push({\n          farmId: demoFarm.id,\n          expenseDate: monthStartDate,\n          userId: demoUser.id,\n          category: \"other\",\n          description: \"Miscellaneous operational expenses\",\n          amount: (addVariance(25000, 40)).toFixed(2),\n          supplier: null,\n          receiptNumber: null,\n          notes: \"Transport, cleaning supplies, etc\",\n        });\n      }\n    }\n    \n    await db.insert(expenses).values(expensesData);\n    console.log(`✅ Created ${expensesData.length} expense records`);\n\n    // 7. Feed Inventory\n    console.log(\"🌾 Creating feed inventory records...\");\n    \n    await db.insert(feedInventory).values([\n      {\n        farmId: demoFarm.id,\n        feedType: \"Layer Mash\",\n        supplier: \"Unga Feeds Ltd\",\n        quantityKg: \"2500.000\",\n        unitPrice: \"52.50\",\n        purchaseDate: getDateDaysAgo(7),\n        expiryDate: getDateDaysAgo(-60),\n        userId: demoUser.id,\n      },\n      {\n        farmId: demoFarm.id,\n        feedType: \"Layer Pellets\",\n        supplier: \"Pembe Flour Mills\",\n        quantityKg: \"1200.000\",\n        unitPrice: \"55.00\",\n        purchaseDate: getDateDaysAgo(14),\n        expiryDate: getDateDaysAgo(-45),\n        userId: demoUser.id,\n      },\n    ]);\n    \n    console.log(\"✅ Created feed inventory\");\n\n    // 8. Health Records\n    console.log(\"💉 Creating health records...\");\n    \n    const healthRecordsData: any[] = [\n      {\n        flockId: demoFlock.id,\n        recordDate: getDateDaysAgo(350),\n        userId: demoUser.id,\n        recordType: \"vaccination\",\n        title: \"Marek's Disease Vaccination\",\n        description: \"Day-old chick vaccination\",\n        medicationUsed: \"HVT Vaccine\",\n        dosage: \"1 dose per chick\",\n        administeredBy: \"Dr. Kamau - VetCare Kenya\",\n        nextDueDate: null,\n        cost: \"35000.00\",\n        notes: \"All chicks vaccinated at hatchery\",\n      },\n      {\n        flockId: demoFlock.id,\n        recordDate: getDateDaysAgo(280),\n        userId: demoUser.id,\n        recordType: \"vaccination\",\n        title: \"Newcastle Disease Vaccination\",\n        description: \"Newcastle disease vaccination - Round 1\",\n        medicationUsed: \"LaSota ND Vaccine\",\n        dosage: \"Eye drop method\",\n        administeredBy: \"Dr. Wanjiru\",\n        nextDueDate: getDateDaysAgo(-30),\n        cost: \"28000.00\",\n        notes: \"Booster required in 3 months\",\n      },\n      {\n        flockId: demoFlock.id,\n        recordDate: getDateDaysAgo(190),\n        userId: demoUser.id,\n        recordType: \"vaccination\",\n        title: \"Infectious Bronchitis Vaccination\",\n        description: \"IB vaccination\",\n        medicationUsed: \"IB H120\",\n        dosage: \"Spray application\",\n        administeredBy: \"Dr. Kamau\",\n        nextDueDate: null,\n        cost: \"32000.00\",\n        notes: null,\n      },\n      {\n        flockId: demoFlock.id,\n        recordDate: getDateDaysAgo(120),\n        userId: demoUser.id,\n        recordType: \"treatment\",\n        title: \"Coccidiosis Treatment\",\n        description: \"Preventive treatment for coccidiosis\",\n        medicationUsed: \"Amprolium\",\n        dosage: \"1ml per liter of water for 5 days\",\n        administeredBy: \"Farm staff under vet supervision\",\n        nextDueDate: null,\n        cost: \"15000.00\",\n        notes: \"Prophylactic treatment\",\n      },\n      {\n        flockId: demoFlock.id,\n        recordDate: getDateDaysAgo(45),\n        userId: demoUser.id,\n        recordType: \"checkup\",\n        title: \"Routine Flock Health Check\",\n        description: \"Quarterly veterinary inspection\",\n        medicationUsed: null,\n        dosage: null,\n        administeredBy: \"Dr. Wanjiru - VetCare Kenya\",\n        nextDueDate: getDateDaysAgo(-45),\n        cost: \"25000.00\",\n        notes: \"Flock in good health, production rate excellent\",\n      },\n    ];\n    \n    await db.insert(healthRecords).values(healthRecordsData);\n    console.log(`✅ Created ${healthRecordsData.length} health records`);\n\n    // 9. Products (for marketplace)\n    console.log(\"🥚 Creating product listings...\");\n    \n    await db.insert(products).values([\n      {\n        farmId: demoFarm.id,\n        name: \"Fresh Brown Eggs - Grade A\",\n        category: \"eggs\",\n        description: \"Premium quality brown eggs from free-range layers. Rich in nutrients and freshly collected daily.\",\n        unit: \"crates\",\n        currentPrice: \"400.00\",\n        minOrderQuantity: 1,\n        stockQuantity: 150,\n        isAvailable: true,\n      },\n      {\n        farmId: demoFarm.id,\n        name: \"Fresh Brown Eggs - Retail Tray\",\n        category: \"eggs\",\n        description: \"Retail packaging - 30 eggs per tray. Perfect for households and small retailers.\",\n        unit: \"trays\",\n        currentPrice: \"420.00\",\n        minOrderQuantity: 1,\n        stockQuantity: 200,\n        isAvailable: true,\n      },\n      {\n        farmId: demoFarm.id,\n        name: \"Spent Layers\",\n        category: \"chickens\",\n        description: \"Healthy spent layers suitable for meat. Available upon request.\",\n        unit: \"pieces\",\n        currentPrice: \"350.00\",\n        minOrderQuantity: 10,\n        stockQuantity: 0,\n        isAvailable: false,\n      },\n    ]);\n    \n    console.log(\"✅ Created product listings\");\n\n    console.log(\"\\n🎉 Demo data seed completed successfully!\");\n    console.log(\"\\n📊 Summary:\");\n    console.log(`  - Farm: ${demoFarm.name}`);\n    console.log(`  - Flock: ${demoFlock.name}`);\n    console.log(`  - Daily Records: 365 days`);\n    console.log(`  - Sales: ${salesData.length} records`);\n    console.log(`  - Expenses: ${expensesData.length} records`);\n    console.log(`  - Health Records: ${healthRecordsData.length} records`);\n    console.log(`  - Products: 3 listings`);\n    console.log(\"\\n💡 This farm is clearly tagged with '🎯' and labeled as demo data.\");\n    console.log(\"   You can safely delete it when ready to add real farm data.\\n\");\n\n  } catch (error) {\n    console.error(\"❌ Error seeding demo data:\", error);\n    throw error;\n  }\n}\n\nseed();\n","size_bytes":18925}},"version":2}